# Day007：网络与协议基础 - Wireshark 入门与综合分析

- 日期：2025-12-31
- 周次：第 1 周

## 学习目标

- 熟练使用过滤器（显示/捕获），能快速定位目标流量
- 能在一次抓包里串起来：DNS → TCP 三次握手 → HTTP 请求/响应
- 学会做“分析证据”：标注、书签、导出截图与最终报告

## 学习内容

### 1️⃣ 必须先分清：捕获过滤器 vs 显示过滤器

- **捕获过滤器（Capture Filter）**：在“抓包时”就把不需要的包丢掉（语法更像 BPF）。
  - 优点：文件更小、噪声更少
  - 缺点：抓不到就没了，无法回补
- **显示过滤器（Display Filter）**：抓完以后再筛选展示（Wireshark 最强、最常用）。
  - 优点：灵活、可反复调整
  - 缺点：抓包时噪声可能多

学习阶段建议：**少用捕获过滤器，多用显示过滤器**。

### 2️⃣ 显示过滤器（Display Filter）常用清单

#### 协议/端口

- `dns`
- `http`
- `tcp`
- `tcp.port == 80`
- `udp.port == 53`

#### IP/主机定位

- `ip.addr == 192.168.1.10`（某主机参与的所有流量）
- `ip.src == 192.168.1.10` / `ip.dst == 192.168.1.10`

#### TCP 关键定位

- 三次握手：
  - `tcp.flags.syn == 1 && tcp.flags.ack == 0`
  - `tcp.flags.syn == 1 && tcp.flags.ack == 1`
  - `tcp.flags.ack == 1 && tcp.len == 0`
- 重传/乱序（排障常用）：
  - `tcp.analysis.retransmission`
  - `tcp.analysis.out_of_order`
  - `tcp.analysis.lost_segment`
- 快速看是否有 RST：
  - `tcp.flags.reset == 1`

#### HTTP 关键字段（有时非常好用）

- `http.request.method == "GET"`
- `http.request.method == "POST"`
- `http.host contains "example"`
- `http.response.code == 301 || http.response.code == 302`

### 3️⃣ 分析视角：从“现象”到“证据”

建议你按这个链路写报告：

1. 目标是什么？（访问哪个域名/服务）
2. DNS 解析有没有成功？（Query 类型、RCODE、Answer、TTL）
3. TCP 连接有没有建立？（三次握手、是否重传、RTT 体感）
4. 应用层请求是否正常？（HTTP 方法、路径、状态码、关键头）
5. 异常的话，落在哪一层？（DNS/TCP/HTTP）

## 实践任务（合法授权范围内）

> 目标：产出一份“能复现、能对照、能解释”的综合抓包报告。

### 任务 1：准备可控流量源（本地 HTTP 服务）

在 Windows 上推荐用 Python 的 `http.server`：

1. 新建目录：`D:\projects\Network Security\lab-wireshark`
2. 放一个 `index.html`（写任意内容，比如“Day007 Lab”）
3. 在该目录启动服务（任选一种）：
   - `python -m http.server 8000`
   - `py -m http.server 8000`

### 任务 2：触发一次“DNS + TCP + HTTP”的访问

你需要一次访问里同时出现 DNS、TCP 握手、HTTP。

推荐做法（更稳定看到 DNS）：

1. 访问一个域名（触发 DNS）：例如在浏览器访问 `http://example.com/` 或 `http://www.bing.com/`
2. 访问本地服务（触发 TCP + HTTP）：`http://127.0.0.1:8000/`

> 如果你想在一次访问里同时看到 DNS+HTTP：尽量访问“域名形式”的 HTTP（例如 `http://example.com/`），不要只访问 IP。

### 任务 3：抓包与过滤（推荐流程）

1. 打开 Wireshark，选择你的活动网卡
2. 开始抓包
3. 执行上面的访问动作（至少一次域名 HTTP + 一次本地 HTTP）
4. 停止抓包
5. 用显示过滤器分段分析并截图：

- DNS：`dns`
- TCP 握手：`tcp.flags.syn == 1 || tcp.flags.fin == 1 || tcp.flags.reset == 1`
- HTTP：`http`

### 手动实现要点（不使用任何脚本）

> 目标：你能“亲手触发”并在 Wireshark 里找到 **DNS → TCP 三次握手 → HTTP 请求/响应** 这条证据链。

#### Step 1：先准备一个稳定的 HTTP 目标（本地）

请先完成“任务 1”的本地服务启动，然后用浏览器访问：

- `http://127.0.0.1:8000/`

这一步几乎必定能抓到 HTTP（避免外网网站跳 HTTPS 导致看不到明文 HTTP）。

#### Step 2：再触发一次“域名访问”（更容易看到 DNS）

任选一种：

- 浏览器打开：`http://example.com/`
- 或者先 `nslookup example.com` 再访问 `http://example.com/`

#### Step 3：Wireshark 用过滤器分段截证据

你最终至少要保存/截图这 3 类证据：

1. DNS 证据

- 过滤器：`dns`
- 截图要求：能看到 Query Name/Type、RCODE、Answer 和 TTL（如果有）

2. TCP 三次握手证据

- 过滤器（更聚焦）：
  - `tcp.flags.syn == 1 || tcp.flags.ack == 1`
- 或者用你已写的“握手/关闭/RST”过滤器：
  - `tcp.flags.syn == 1 || tcp.flags.fin == 1 || tcp.flags.reset == 1`

3. HTTP 请求/响应证据

- 过滤器：`http`
- 截图要求：能看到 Request-Line、Host（请求头）、Status-Code、Content-Type（响应头）

#### Step 4：常见问题（看不到 DNS/HTTP 时怎么做）

- 看不到 DNS：可能命中缓存了。
  - 解决：换一个没访问过的域名；或执行 `ipconfig /flushdns` 后再访问一次（可选）。
- 看不到明文 HTTP：很多网站会 301/302 跳到 HTTPS。
  - 解决：用本地 `127.0.0.1:8000` 的 HTTP 输出截图；DNS 证据仍可来自域名解析。

### 任务 4：标注/书签/导出

在 Wireshark 里对关键包做：

- **Comment/注释**：写下“这是 DNS Query/这是 SYN/这是 200 OK…”
- **Mark Packet（标记包）**：把关键包标出来

导出产物：

- 保存抓包文件（建议命名）：`Day007_dns_tcp_http.pcapng`
- 关键截图（至少 3 张）：DNS、SYN/SYN-ACK/ACK、HTTP 请求/响应

## 巩固练习（题与复盘）

### 练习 1：为常见分析场景编写 5 条过滤表达式

参考场景（从中挑 5 个写出过滤器，并解释为什么这么写）：

1. 只看 DNS
2. 只看访问 `127.0.0.1:8000` 的 TCP 流量
3. 只看 TCP 三次握手相关包
4. 只看 HTTP 302 的响应
5. 只看某个 IP 的所有流量
6. 只看重传

### 练习 2：解释一次异常重传与超时的可能原因

从至少 3 个角度回答：

- 信号/链路质量：丢包、Wi-Fi 不稳定
- 端到端负载：服务器繁忙、窗口太小
- 路由/策略：防火墙丢包、QoS 限速

## 评估标准（达成判定）

- 能独立完成：抓包 → 过滤 → 定位关键包 → 标注/截图
- 报告中能清晰串起：DNS 解析证据 + TCP 握手证据 + HTTP 请求/响应证据
- 至少写出 5 条显示过滤器，并能解释用途

## 学习成果达成情况（由学习者填写）

### 截图与证据

- 抓包文件：
  - `Day007_dns_tcp_http.pcapng`（保存位置：）
- 截图（至少 3 张）：
  1.  DNS Query/Response（能看到 Query 类型 + RCODE + Answer/TTL）
  2.  TCP 三次握手（SYN / SYN-ACK / ACK）
  3.  HTTP 请求/响应（Request-Line + Status-Code + 关键头部）

### 报告正文（推荐结构，直接照抄填空）

1. 目标与环境

- 目标域名/URL：
- 本机 IP：
- 抓包网卡：

2. DNS 解析

- Query Name / Type：
- RCODE：
- Answer（IP/记录）：
- TTL：

3. TCP 建连

- Client Port → Server Port：
- 三次握手证据（Frame No.）：
- 是否有重传/乱序：

4. HTTP 交互

- 方法与路径：
- 状态码：
- 关键请求头（Host/User-Agent/Accept/Cookie）：
- 关键响应头（Content-Type/Set-Cookie/Location）：

5. 结论

- 本次访问是否成功：
- 如果失败，失败发生在（DNS/TCP/HTTP）哪一层：

### 关键命令与输出

- ## 本地 HTTP 服务启动命令：
- ## 触发访问的命令（可选）：
- 你常用的 5 条显示过滤器：
http 或 tcp 或 udp：
作用：按协议过滤，显示所有 HTTP、TCP 或 UDP 协议的流量.
示例：输入 http，显示所有 HTTP 协议包.
ip.addr == 192.168.1.100：
作用：显示源或目的 IP 地址为指定 IP 的所有包.
示例：只看和 192.168.1.100 相关的通信.
tcp.port == 80 或 udp.port == 53：
作用：过滤指定端口号的 TCP 或 UDP 流量.
示例：tcp.port == 80 查看 Web (HTTP) 流量，udp.port == 53 查看 DNS 流量.
dns：
作用：专门显示 DNS（域名系统）协议的流量.
示例：快速查看域名解析请求和响应.
tcp.port == 80 && http (组合过滤)
作用：使用逻辑运算符 && (与) 或 || (或) 组合条件.
示例：只显示端口 80 上的 HTTP 流量. 

### 结论与反思

- 今天最有效的一个过滤器（为什么）：
- 今天最花时间的一步（怎么改进）：
