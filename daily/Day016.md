---
title: Day016：操作系统与脚本 - Windows 安全基础
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: f97e6e0d
date: 2026-01-09 00:00:00
updated: 2026-01-09 00:00:00

---
# Day016：操作系统与脚本 - Windows 安全基础

- 日期：2026-01-09
- 周次：第 3 周

## 学习目标

学完今天你应该能做到：

- 掌握 Windows 操作系统安全基础，包括 UAC 原理、用户与组管理、事件日志分析
- **理解并能实施 Windows 安全基线加固（账号/服务/网络/审计）**
- **具备基本的入侵痕迹排查能力（通过日志和进程分析）**
- 学会通过 GUI + PowerShell 双工具进行 Windows 安全审计
- 能输出一份 15 条的 Windows 加固清单

---

<!--more-->

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 3 周：系统安全 (Linux/Windows)
│   ├── Day015：Linux 用户与权限管理
│   └── Day016：Windows 安全基础
│       ├── 核心概念：UAC、ACL、Event Log
│       ├── 实践技能：PowerShell 审计、组策略加固
│       └── 关联知识点：AD 域安全、权限维持
    ├── Day017：Linux 进程与计划任务
```

### 今日关键词

`UAC` · `ACL` · `Event Log (4624/4625)` · `PowerShell` · **`安全基线`** · **`攻击面`**

---

## 一、为什么 Windows 安全是"必修课"？

### 1.1 Windows 在安全运营中的地位

```
企业环境占比
├─ 服务器：Windows Server 占 30-40%（AD/IIS/SQL Server）
├─ 办公终端：Windows 10/11 占 70-80%（Office/OA/邮件客户端）
└─ 攻击者视角：域控（DC）是内网攻击的"皇冠明珠"

攻击链典型路径
1. 钓鱼邮件打开 Excel 宏 → RCE 在用户 PC
2. 获取明文密码/Kerberos 票据 → 横向移动
3. 域管账号劫持 → 控制整个域（GPO/DC）
```

### 1.2 学完今天你能做什么？

| 能力项             | 实战场景                                             |
| ------------------ | ---------------------------------------------------- |
| **识别异常登录**   | 通过事件 4625（失败登录）发现爆破攻击                |
| **审计管理员组**   | 发现"不该在管理员组的账号"（内鬼/残留）              |
| **排查开放端口**   | 用 `netstat`/`Get-NetTCPConnection` 找到可疑监听进程 |
| **配置防火墙规则** | 阻断 RDP 对公网暴露、放通必要服务                    |
| **制作加固方案**   | 输出 15 条 Windows 加固清单（账号/服务/网络/审计）   |

---

## 二、核心知识点详解（傻瓜级讲解）

### 2.1 用户账户控制（UAC）原理

#### 2.1.1 什么是 UAC？

**UAC（User Account Control）** 是 Windows 从 Vista 开始引入的安全机制，目标是：**即使是管理员账号，默认也以普通权限运行程序，需要提升权限时才弹窗确认**。

```
传统模式（XP 时代）             UAC 模式（Vista 后）
管理员登录                      管理员登录
↓                               ↓
直接拥有完整权限                 默认获得"过滤的令牌"（Filtered Token）
↓                               ↓
任意程序都可修改系统             需要提权时弹出"UAC 提示框"
↓                               ↓
恶意软件也能静默提权             用户确认后才获得完整权限
```

#### 2.1.2 UAC 工作流程

```
用户双击"需要管理员权限"的程序（如 regedit）
↓
检查 manifest（是否标记 requireAdministrator）
↓
【是】→ 触发 UAC 提示框（"是否允许此应用更改设备？"）
       ↓
       用户点击"是" → 创建新进程，使用完整令牌（Full Token）
       用户点击"否" → 拒绝运行
↓
【否】→ 直接以普通权限运行（即使是管理员账号）
```

#### 2.1.3 UAC 的 4 个安全级别

| 级别                       | 行为                                 | 安全性      | 适用场景             |
| -------------------------- | ------------------------------------ | ----------- | -------------------- |
| **始终通知**               | 所有程序提权都弹窗，且切换安全桌面   | ⭐⭐⭐⭐⭐  | 高风险环境（如域控） |
| **默认**                   | 程序提权弹窗，Windows 设置更改不弹窗 | ⭐⭐⭐⭐    | 一般办公环境         |
| **仅在应用尝试更改时通知** | 不切换安全桌面（可被劫持）           | ⭐⭐⭐      | 开发测试环境         |
| **从不通知**               | 完全关闭 UAC                         | ⚠️ 极不推荐 | 仅用于兼容老旧软件   |

**安全桌面（Secure Desktop）**：UAC 弹窗时屏幕变暗，此时只有系统进程可绘制界面，防止木马伪造确认按钮。

#### 2.1.4 查看当前 UAC 状态

**方法 1：GUI**

```
控制面板 → 用户账户 → 更改用户账户控制设置
拖动滑块查看当前级别
```

**方法 2：PowerShell**

```powershell
# 查询 UAC 启用状态
Get-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA"

# 返回值：
# 1 = UAC 已启用
# 0 = UAC 已禁用
```

**方法 3：命令行提权测试**

```cmd
# 测试当前 Shell 是否有管理员权限
whoami /groups | findstr "High Mandatory Level"

# 如果有输出 → 当前是高权限 Shell
# 如果无输出 → 当前是普通权限 Shell
```

---

### 2.2 用户与组管理（本地账户）

#### 2.2.1 常见本地用户组

| 组名                     | 权限                     | 典型用途       | 安全要点              |
| ------------------------ | ------------------------ | -------------- | --------------------- |
| **Administrators**       | 完整系统控制             | IT 管理员      | ⚠️ 应最小化成员数量   |
| **Users**                | 运行程序、访问自己的文件 | 普通员工       | ✅ 日常办公应使用此组 |
| **Remote Desktop Users** | 允许 RDP 登录            | 远程运维人员   | ⚠️ 需配合强密码+MFA   |
| **Guests**               | 临时访问，权限极低       | 访客账号       | ⚠️ 应禁用（默认禁用） |
| **Backup Operators**     | 可备份/还原任意文件      | 备份系统管理员 | ⚠️ 可能绕过文件权限   |

#### 2.2.2 管理员组审计实战

**任务：列出所有管理员组成员，识别异常账号**

```powershell
# 方法 1：PowerShell（推荐）
Get-LocalGroupMember -Group "Administrators"

# 输出示例：
# Name                           PrincipalSource
# ----                           ---------------
# PC01\Administrator             Local
# PC01\alice                     Local
# AzureAD\bob@company.com        Azure Active Directory

# 方法 2：命令行
net localgroup Administrators
```

**安全检查清单**：

- [ ] 是否存在"未知账号"（离职员工/外包人员）
- [ ] 是否有"不该有管理员权限的账号"（如前台/访客）
- [ ] 是否有"命名异常"的账号（如 `admin123`、`temp_admin`）
- [ ] 是否有"域账号"在本地管理员组（检查域策略是否符合预期）

#### 2.2.3 创建"安全的本地管理员账号"

**场景**：需要临时授予 IT 外包人员管理员权限，合同到期后收回。

```powershell
# 1. 创建本地用户
$Password = ConvertTo-SecureString "P@ssw0rd!2024" -AsPlainText -Force
New-LocalUser -Name "ITSupport01" -Password $Password -Description "Temporary admin for contractor"

# 2. 添加到管理员组
Add-LocalGroupMember -Group "Administrators" -Member "ITSupport01"

# 3. 设置密码策略
# 强制下次登录修改密码
Set-LocalUser -Name "ITSupport01" -PasswordNeverExpires $false -UserMayChangePassword $true

# 4. 合同到期后移除
Remove-LocalGroupMember -Group "Administrators" -Member "ITSupport01"
Remove-LocalUser -Name "ITSupport01"
```

---

### 2.3 Windows 事件日志（安全审计的"黑匣子"）

#### 2.3.1 事件日志分类

```
Windows 日志
├─ Security（安全日志）← 最重要！记录登录/提权/访问控制
├─ System（系统日志）  ← 记录服务启动/停止、驱动加载
├─ Application（应用日志）← 记录程序错误/崩溃
└─ Setup（安装日志）   ← 记录补丁安装/系统更新

应用程序和服务日志
└─ Microsoft-Windows-Sysmon/Operational ← Sysmon 日志（需单独安装）
```

#### 2.3.2 关键安全事件 ID 详解

| 事件 ID  | 含义             | 威胁指示                          | 查看方法                   |
| -------- | ---------------- | --------------------------------- | -------------------------- |
| **4624** | 登录成功         | 登录类型 10=RDP，3=网络，2=交互式 | 筛选 `Logon Type` 字段     |
| **4625** | 登录失败         | 短时间内大量 4625 → 密码爆破      | 统计失败次数 Top 5         |
| **4672** | 特殊权限登录     | 管理员/域管账号登录               | 审计"不该有管理员权限的人" |
| **4648** | 使用显式凭据登录 | `runas` 或 `psexec`（横向移动）   | 审计"非管理员使用他人凭据" |
| **4688** | 进程创建         | 可疑进程（如 `mimikatz.exe`）     | 需启用"进程创建审计"       |
| **4720** | 创建用户账户     | 后门账户创建                      | 审计"非预期的账户创建"     |
| **7045** | 安装系统服务     | 恶意软件注册服务（如勒索软件）    | 在 System 日志中查看       |

#### 2.3.3 事件 4624 详细解读（登录成功）

**示例事件**：

```
事件 ID: 4624
任务类别: 登录
关键字: 审核成功
主题:
  安全 ID: S-1-5-21-xxx（谁登录）
  账户名: alice
登录类型: 10（RDP）
新登录:
  安全 ID: S-1-5-21-xxx
  账户名: alice
  登录 GUID: {xxx}
进程信息:
  进程 ID: 0x1234
  进程名: C:\Windows\System32\winlogon.exe
网络信息:
  工作站名: DESKTOP-ABC
  源网络地址: 192.168.1.100
  源端口: 54321
```

**登录类型（Logon Type）对照表**：

| 类型   | 含义              | 典型场景                         | 安全关注点           |
| ------ | ----------------- | -------------------------------- | -------------------- |
| **2**  | 交互式登录        | 本地键盘登录、Ctrl+Alt+Del       | 正常物理访问         |
| **3**  | 网络登录          | 访问共享文件夹（\\server\share） | 可能是横向移动       |
| **4**  | 批处理            | 计划任务运行                     | 持久化后门常用       |
| **5**  | 服务登录          | Windows 服务启动                 | 正常，除非服务名可疑 |
| **7**  | 解锁              | 屏保解锁                         | 正常                 |
| **8**  | 网络明文          | IIS 基本认证                     | ⚠️ 密码明文传输      |
| **10** | 远程交互式（RDP） | 远程桌面登录                     | ⚠️ 需审计源 IP       |
| **11** | 缓存交互式        | 域账号离线登录（使用缓存凭据）   | 可能在域控不可达时   |

#### 2.3.4 实战：查找"可疑的 RDP 登录"

**场景**：排查是否有未授权的远程桌面登录（事件 4624，登录类型 10）。

**方法 1：GUI（事件查看器）**

```
1. Win+R → eventvwr.msc
2. Windows 日志 → 安全
3. 右侧"筛选当前日志" → 事件 ID 输入 4624
4. 创建自定义视图 → XML 编辑：
   <QueryList>
     <Query Id="0" Path="Security">
       <Select Path="Security">
         *[System[(EventID=4624)]]
         and
         *[EventData[Data[@Name='LogonType']='10']]
       </Select>
     </Query>
   </QueryList>
5. 查看"源网络地址"字段，检查是否有外网 IP
```

**方法 2：PowerShell（批量导出分析）**

```powershell
# 导出最近 24 小时的 RDP 登录事件
Get-WinEvent -FilterHashtable @{
    LogName='Security'
    ID=4624
    StartTime=(Get-Date).AddDays(-1)
} | Where-Object {
    $_.Properties[8].Value -eq 10  # 登录类型=10（RDP）
} | Select-Object TimeCreated,
    @{Name="User";Expression={$_.Properties[5].Value}},
    @{Name="SourceIP";Expression={$_.Properties[18].Value}},
    @{Name="LogonType";Expression={$_.Properties[8].Value}} |
Format-Table -AutoSize
```

**分析要点**：

- ✅ **正常**：内网 IP（192.168.x.x / 10.x.x.x）+ 已知运维人员账号
- ⚠️ **可疑**：公网 IP + 非运维时间段（如凌晨 3 点）
- 🚨 **高危**：异常地理位置（如来自国外 IP）+ 管理员账号

#### 2.3.5 实战:统计"密码爆破攻击"（事件 4625）

**场景**：检测短时间内大量登录失败（暴力破解 RDP）。

```powershell
# 统计最近 1 小时失败登录的 Top 5 账户
Get-WinEvent -FilterHashtable @{
    LogName='Security'
    ID=4625
    StartTime=(Get-Date).AddHours(-1)
} | Select-Object @{
    Name="User"
    Expression={$_.Properties[5].Value}
} | Group-Object User |
Sort-Object Count -Descending |
Select-Object -First 5 Name, Count
```

**输出示例**：

```
Name          Count
----          -----
Administrator   127
admin            89
root             56
test             34
backup           23
```

**判断标准**：

- 🚨 **单账号 > 50 次失败**：高度疑似爆破
- ⚠️ **多账号均失败 10+ 次**：可能在字典攻击
- ✅ **少量失败**：可能是用户忘记密码

**防御措施**：

1. 启用账户锁定策略（5 次失败锁定 30 分钟）
2. 使用防火墙限制 RDP（3389）仅对内网开放
3. 启用 MFA（多因素认证）

---

### 2.4 Windows 防火墙配置

#### 2.4.1 防火墙工作模式

```
Windows Defender 防火墙配置文件
├─ 域配置文件（Domain Profile）
│   └─ 适用于：主机加入域，且域控可达
├─ 专用配置文件（Private Profile）
│   └─ 适用于：家庭/公司网络（可信）
└─ 公用配置文件（Public Profile）
    └─ 适用于：机场/咖啡厅 Wi-Fi（不可信）

默认策略
├─ 入站：拒绝（除非明确放通）
├─ 出站：允许（所有流量）
└─ 推荐：保持此默认配置！
```

#### 2.4.2 常用防火墙命令

**查看当前防火墙状态**：

```powershell
# 方法 1：PowerShell
Get-NetFirewallProfile | Select-Object Name, Enabled

# 方法 2：命令行
netsh advfirewall show allprofiles
```

**查看所有入站规则**：

```powershell
# 列出所有"允许"的入站规则
Get-NetFirewallRule -Direction Inbound -Enabled True -Action Allow |
Select-Object DisplayName, Profile, LocalPort, RemoteAddress |
Format-Table -AutoSize
```

**创建规则：允许特定程序**：

```powershell
# 场景：允许 Python Web 服务（Flask）监听 5000 端口
New-NetFirewallRule -DisplayName "Allow Flask App" `
    -Direction Inbound `
    -Protocol TCP `
    -LocalPort 5000 `
    -Action Allow `
    -Profile Private
```

**删除规则**：

```powershell
Remove-NetFirewallRule -DisplayName "Allow Flask App"
```

**阻断特定 IP**：

```powershell
# 场景：阻断可疑 IP 的所有流量
New-NetFirewallRule -DisplayName "Block Attacker IP" `
    -Direction Inbound `
    -RemoteAddress 1.2.3.4 `
    -Action Block
```

#### 2.4.3 常见安全配置错误

| 错误配置                  | 风险               | 正确做法             |
| ------------------------- | ------------------ | -------------------- |
| **关闭防火墙**            | 所有端口暴露       | 保持开启，按需放通   |
| **RDP（3389）对公网开放** | 成为暴力破解目标   | 仅允许 VPN/堡垒机 IP |
| **允许"所有配置文件"**    | 公共 Wi-Fi 也放通  | 仅允许"域+专用"      |
| **出站规则"全部允许"**    | 木马可联网下载工具 | 高敏感环境考虑白名单 |

---

### 2.5 本地安全策略（Local Security Policy）

#### 2.5.1 访问本地安全策略

```
方法 1：Win+R → secpol.msc（本地安全策略）
方法 2：gpedit.msc（本地组策略编辑器）→ 计算机配置 → Windows 设置 → 安全设置
```

#### 2.5.2 关键策略配置

**账户策略**：

| 策略                 | 推荐值     | 说明                         |
| -------------------- | ---------- | ---------------------------- |
| **密码最短长度**     | 12 位      | 防止弱密码                   |
| **密码复杂性要求**   | 已启用     | 必须包含大小写+数字+特殊字符 |
| **密码最长使用期限** | 90 天      | 定期更换（争议项）           |
| **强制密码历史**     | 记住 24 个 | 防止重复使用旧密码           |
| **账户锁定阈值**     | 5 次       | 失败 5 次后锁定              |
| **账户锁定时间**     | 30 分钟    | 锁定后自动解锁时间           |

**审核策略**：

| 策略             | 推荐值     | 审计内容                       |
| ---------------- | ---------- | ------------------------------ |
| **审核登录事件** | 成功和失败 | 记录 4624/4625                 |
| **审核账户管理** | 成功和失败 | 记录账户创建/删除（4720/4726） |
| **审核进程跟踪** | 成功       | 记录进程创建（4688）           |
| **审核特权使用** | 成功       | 记录管理员提权（4672）         |

**配置方法（PowerShell）**：

```powershell
# 启用进程创建审计（4688）
auditpol /set /subcategory:"Process Creation" /success:enable

# 查看当前审计策略
auditpol /get /category:*
```

---

### 2.6 监听端口排查

#### 2.6.1 查看监听端口的 3 种方法

**方法 1：netstat（传统命令）**

```cmd
netstat -ano | findstr LISTENING
```

**输出示例**：

```
TCP    0.0.0.0:135      0.0.0.0:0     LISTENING       912
TCP    0.0.0.0:445      0.0.0.0:0     LISTENING       4
TCP    0.0.0.0:3389     0.0.0.0:0     LISTENING       1024
```

**字段解释**：

- `0.0.0.0:135` → 监听所有网卡的 135 端口
- `LISTENING` → 当前正在监听
- `912` → 进程 PID

**方法 2：PowerShell（推荐）**

```powershell
Get-NetTCPConnection -State Listen |
Select-Object LocalAddress, LocalPort,
    @{Name="Process";Expression={(Get-Process -Id $_.OwningProcess).ProcessName}} |
Format-Table -AutoSize
```

**输出示例**：

```
LocalAddress LocalPort Process
------------ --------- -------
0.0.0.0      135       svchost
0.0.0.0      445       System
0.0.0.0      3389      TermService
```

**方法 3：使用 Sysinternals TCPView（GUI 工具）**

```
下载：https://learn.microsoft.com/en-us/sysinternals/downloads/tcpview
功能：实时显示所有 TCP/UDP 连接，颜色标识新建/关闭连接
```

#### 2.6.2 常见端口风险评估表

| 端口          | 服务       | 用途                 | 风险等级 | 建议                     |
| ------------- | ---------- | -------------------- | -------- | ------------------------ |
| **135**       | RPC        | Windows 远程过程调用 | ⚠️ 中    | 仅内网开放               |
| **139/445**   | SMB        | 文件共享             | 🚨 高    | 仅内网开放，禁止公网访问 |
| **3389**      | RDP        | 远程桌面             | 🚨 高    | 仅通过 VPN 访问          |
| **5985/5986** | WinRM      | PowerShell 远程管理  | ⚠️ 中    | 仅管理员网段开放         |
| **80/443**    | HTTP/HTTPS | Web 服务             | ✅ 低    | 确认是否需要对外暴露     |
| **1433**      | MSSQL      | SQL Server           | ⚠️ 中    | 禁止直接暴露，使用跳板机 |
| **3306**      | MySQL      | 数据库               | ⚠️ 中    | 同上                     |
| **22**        | SSH        | Linux 远程管理       | ⚠️ 中    | 需强密码+密钥认证        |

#### 2.6.3 实战：排查"不该监听的端口"

**场景**：发现主机监听了意外的高端口（如 4444、5555），怀疑是木马。

```powershell
# 1. 找到可疑端口的进程
Get-NetTCPConnection -LocalPort 4444 |
Select-Object State, OwningProcess,
    @{Name="Process";Expression={(Get-Process -Id $_.OwningProcess).Path}}

# 输出示例：
# State      : Listen
# OwningProcess : 3456
# Process    : C:\Users\alice\AppData\Roaming\svchost.exe  ← 可疑！

# 2. 查看进程详细信息
Get-Process -Id 3456 | Select-Object *

# 3. 查看进程签名（判断是否为合法程序）
Get-AuthenticodeSignature "C:\Users\alice\AppData\Roaming\svchost.exe"

# 如果返回 NotSigned → 高度可疑
```

**判断恶意进程的技巧**：

- ✅ **合法进程**：位于 `C:\Windows\System32\`，有微软数字签名
- ⚠️ **可疑进程**：位于用户目录（`AppData`）、临时目录（`Temp`）
- 🚨 **恶意进程**：伪装成系统进程名（如 `svchost.exe` 但不在 System32）

---

## 三、实践任务（手把手操作）

### 任务 1：审计本地管理员组成员与异常账号

**目标**：列出所有管理员组成员，识别不合规账号，并检查是否存在隐藏账号（以 `$` 结尾）。

```powershell
# 1. 列出管理员组成员
Get-LocalGroupMember -Group "Administrators" | Select-Object Name, PrincipalSource, ObjectClass

# 2. 检查所有本地用户（包括隐藏/禁用账号）
Get-LocalUser | Select-Object Name, Enabled, LastLogon, Description | Format-Table -AutoSize
```

**检查清单**：

- [ ] 是否有"离职员工"残留账号
- [ ] 是否有"临时账号"未删除（如 `temp_admin`）
- [ ] 是否有"非 IT 人员"在管理员组
- [ ] 是否有"影子账号"（如 `admin$`，通常用于后门，但也可能是系统服务）
- [ ] 域账号是否符合组策略要求

**输出结果**：

```
[你的截图/输出粘贴到这里]

发现的问题：
-
```

---

### 任务 2：导出最近 24 小时的登录事件（4624/4625）

**目标**：导出登录成功/失败事件，检测异常登录。

```powershell
# 导出 RDP 登录（事件 4624，登录类型 10）
Get-WinEvent -FilterHashtable @{
    LogName='Security'
    ID=4624
    StartTime=(Get-Date).AddDays(-1)
} | Where-Object {
    $_.Properties[8].Value -eq 10
} | Select-Object TimeCreated,
    @{Name="User";Expression={$_.Properties[5].Value}},
    @{Name="SourceIP";Expression={$_.Properties[18].Value}} |
Export-Csv -Path "RDP_Logins.csv" -NoTypeInformation

# 导出登录失败事件（4625）
Get-WinEvent -FilterHashtable @{
    LogName='Security'
    ID=4625
    StartTime=(Get-Date).AddDays(-1)
} | Select-Object TimeCreated,
    @{Name="User";Expression={$_.Properties[5].Value}},
    @{Name="FailureReason";Expression={$_.Properties[8].Value}} |
Export-Csv -Path "Failed_Logins.csv" -NoTypeInformation
```

**分析要点**：

1. 打开 `RDP_Logins.csv`，检查是否有"非预期的源 IP"
2. 打开 `Failed_Logins.csv`，统计失败次数最多的账号（可能被爆破）

**输出结果**：

```
[粘贴 CSV 前 10 行或异常记录]

发现的异常：
-
```

---

### 任务 3：检查防火墙入站规则并评估风险

**目标**：列出所有"允许"的入站规则，找出不必要的暴露。

```powershell
# 导出所有允许的入站规则
Get-NetFirewallRule -Direction Inbound -Enabled True -Action Allow |
Select-Object DisplayName, Profile,
    @{Name="LocalPort";Expression={(Get-NetFirewallPortFilter -AssociatedNetFirewallRule $_).LocalPort}},
    @{Name="RemoteAddress";Expression={(Get-NetFirewallAddressFilter -AssociatedNetFirewallRule $_).RemoteAddress}} |
Export-Csv -Path "Firewall_Inbound.csv" -NoTypeInformation
```

**风险评估表**：

| 规则名称                 | 端口 | 远程地址 | 风险等级 | 建议          |
| ------------------------ | ---- | -------- | -------- | ------------- |
| Remote Desktop           | 3389 | Any      | 🚨 高    | 限制为 VPN IP |
| File and Printer Sharing | 445  | Any      | 🚨 高    | 限制为内网    |
| ...                      | ...  | ...      | ...      | ...           |

**输出结果**：

```
[粘贴 CSV 或截图]

需要整改的规则：
-
```

---

### 任务 4：盘点当前监听端口并识别异常进程

**目标**：使用 `netstat` 或 PowerShell 列出所有监听端口，识别可疑服务。

```powershell
# 列出所有监听端口及其进程
Get-NetTCPConnection -State Listen |
Select-Object LocalAddress, LocalPort, State,
    @{Name="ProcessName";Expression={(Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue).ProcessName}},
    @{Name="ProcessPath";Expression={(Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue).Path}} |
Format-Table -AutoSize
```

**检查清单**：

- [ ] 是否有"非预期的高端口监听"（如 4444、5555）
- [ ] 进程路径是否在 `AppData` 或 `Temp`（可疑）
- [ ] 进程名是否伪装成系统进程（如 `svchost.exe` 但不在 System32）

**输出结果**：

```
[粘贴输出或截图]

发现的可疑进程：
-
```

---

### 任务 5：配置账户锁定策略（防爆破）

**目标**：设置"5 次失败锁定 30 分钟"策略。

**方法 1：GUI**

```
1. Win+R → secpol.msc
2. 账户策略 → 账户锁定策略
3. 设置：
   - 账户锁定阈值：5 次无效登录
   - 账户锁定时间：30 分钟
   - 重置账户锁定计数器：30 分钟
4. 点击"应用"
```

**方法 2：PowerShell（需管理员权限）**

```powershell
# 导出当前策略到临时文件
secedit /export /cfg C:\Temp\secpol.cfg

# 编辑文件，添加以下内容：
# [System Access]
# LockoutBadCount = 5
# LockoutDuration = 30
# ResetLockoutCount = 30

# 导入策略
secedit /configure /db C:\Windows\security\local.sdb /cfg C:\Temp\secpol.cfg
```

**验证**：

```powershell
# 查看当前锁定策略
net accounts
```

**输出示例**：

```
强制用户在时间到期之后多久必须注销?:     从不
密码最短使用期限(天):                     0
密码最长使用期限(天):                     42
密码长度最小值:                           0
保持的密码历史记录长度:                   None
锁定阈值:                                 5        ← 确认生效
锁定持续时间(分钟):                       30
锁定观测窗口(分钟):                       30
```

---

## 四、巩固练习（题与复盘）

### 题 1：为什么不建议启用匿名共享？

**思路**：

- 匿名共享 = 不鉴权访问
- 权限边界失效 → 容易数据泄露
- 内网横向移动的跳板

**参考答案**：
匿名共享允许任何人无需身份验证即可访问共享资源，导致：

1. **信息泄露**：敏感文件被未授权用户下载
2. **横向移动**：攻击者利用匿名共享在内网传播恶意软件（如 WannaCry）
3. **合规风险**：违反 GDPR/等保 2.0 对访问控制的要求

**防御措施**：

- 禁用匿名共享：`net share IPC$ /delete`
- 使用 NTFS 权限控制文件访问
- 启用 SMB 签名（防中间人攻击）

---

### 题 2：列出 5 条 Windows 主机加固项并说明原因

**思路**：账号、补丁、防火墙、远程服务、日志审计。

**参考答案**：

| 加固项                    | 原因                                | 实施方法                                   |
| ------------------------- | ----------------------------------- | ------------------------------------------ |
| **1. 最小化管理员组成员** | 减少高权限账号被攻击面              | `Get-LocalGroupMember Administrators` 审计 |
| **2. 启用自动更新**       | 及时修复 CVE 漏洞（如 EternalBlue） | 组策略 → Windows Update                    |
| **3. 限制 RDP 访问**      | 防止暴力破解                        | 防火墙仅允许 VPN IP                        |
| **4. 启用账户锁定策略**   | 5 次失败锁定 30 分钟                | `secpol.msc` 配置                          |
| **5. 启用审计日志**       | 记录 4624/4625/4688 用于事件溯源    | `auditpol /set /category:*`                |

**额外 3 条（进阶）**： 6. 禁用不必要的服务（如 Telnet、FTP） 7. 启用 BitLocker 磁盘加密 8. 配置 AppLocker 白名单（限制可执行程序）

---

### 题 3：如何判断事件 4624 是"正常 RDP 登录"还是"可疑登录"？

**参考答案**：

**需要检查的字段**：

1. **Logon Type**：必须是 10（RDP）
2. **Source Network Address**：检查 IP 是否为：
   - ✅ 内网 IP（192.168.x.x / 10.x.x.x）
   - ⚠️ 公网 IP（需对照 VPN 出口 IP 白名单）
   - 🚨 异常地理位置（如来自国外）
3. **Account Name**：是否为已知运维人员账号
4. **Time Created**：是否在工作时间段

**可疑登录特征**：

- 凌晨 3 点有 RDP 登录（非值班时间）
- 源 IP 来自云服务商（如 AWS/Azure），但公司未使用
- 账号为 `Administrator`（应禁用或重命名）
- 短时间内多次登录失败后成功（可能爆破成功）

**应急响应**：

1. 立即隔离主机（断网）
2. 导出 4624/4625/4672 事件做证据保全
3. 检查是否有 4720（创建账户）/7045（安装服务）
4. 使用 Autoruns 检查持久化

---

### 题 4：如何通过 PowerShell 找出"最近 7 天创建的本地账户"？

**参考答案**：

```powershell
# 方法 1：查询安全日志（事件 4720）
Get-WinEvent -FilterHashtable @{
    LogName='Security'
    ID=4720
    StartTime=(Get-Date).AddDays(-7)
} | ForEach-Object {
    [PSCustomObject]@{
        Time = $_.TimeCreated
        NewAccount = $_.Properties[0].Value
        CreatedBy = $_.Properties[4].Value
    }
} | Format-Table -AutoSize

# 方法 2：查询本地用户（需判断创建时间）
# 注意：Get-LocalUser 没有直接的"创建时间"属性，需结合注册表
Get-LocalUser | ForEach-Object {
    $sid = $_.SID
    $regPath = "HKLM:\SAM\SAM\Domains\Account\Users\$sid"
    # 需要管理员权限+SYSTEM权限才能访问 SAM 注册表
}
```

**为什么优先查事件日志？**

- 事件 4720 明确记录"谁在什么时间创建了账户"
- 包含创建者账号（追溯责任）
- 即使账户被删除，日志仍保留

---

## 五、评估标准（达成判定）

- ✅ 你能列出管理员组成员并解释"谁应该在里面"
- ✅ 你能导出 4624/4625 某一类事件做证据
- ✅ 你能指出 1-2 条"可能不该对外暴露"的入站服务/端口
- ✅ 你能配置账户锁定策略（5 次失败锁定 30 分钟）
- ✅ **你能解释 UAC 绕过的基本原理及防御措施**
- ✅ **你能识别不安全的 PowerShell 执行策略**
- ✅ 你能写出 Windows 加固清单（15 条以上）

---

## 六、Windows 安全加固清单（15 条）

### 账号安全（5 条）

1. ✅ 禁用或重命名默认 `Administrator` 账号
2. ✅ 最小化管理员组成员（定期审计）
3. ✅ 启用密码复杂性（12 位，大小写+数字+符号）
4. ✅ 启用账户锁定策略（5 次失败锁定 30 分钟）
5. ✅ 禁用 Guest 账户

### 补丁与更新（2 条）

6. ✅ 启用 Windows 自动更新
7. ✅ 每月检查未安装的关键更新（`wuauclt /detectnow`）

### 网络安全（4 条）

8. ✅ 防火墙默认拒绝入站，按需放通
9. ✅ RDP（3389）仅允许 VPN/堡垒机 IP
10. ✅ 禁用 SMBv1（`Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol`）
11. ✅ 禁用不必要的服务（Telnet/FTP/IIS）

### 审计与日志（2 条）

12. ✅ 启用安全审计（4624/4625/4688/4720/7045）
13. ✅ 日志至少保留 90 天（组策略配置）

### 高级防护（2 条）

14. ✅ 启用 Windows Defender 实时保护
15. ✅ 配置 AppLocker 白名单（限制可执行程序路径）

---

## 七、学习成果达成情况（由学习者填写）

### 截图与证据

- [ ] `Get-LocalGroupMember Administrators` 输出截图
- [ ] 4624/4625 事件导出 CSV 文件
- [ ] 防火墙入站规则截图
- [ ] 监听端口列表截图

### 关键命令与输出

**管理员组成员**：

```
[粘贴你的输出]
```

**登录事件（4624/4625）关键行**：

```
[粘贴异常记录]
```

**入站规则观察到的"可疑/不需要"项**：

```
[列出具体规则名称和端口]
```

### 结论与反思

- **我今天确认到的 1 个事实证据**：
- **我需要立刻改的 1 个设置（如果是自用电脑）**：
- **我不确定但要查的 1 件事**：

---

## 八、参考资料

### 官方文档

- [Windows 安全审核事件 ID](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor)
- [UAC 工作原理](https://learn.microsoft.com/en-us/windows/security/application-security/application-control/user-account-control/how-it-works)
- [Windows Defender 防火墙最佳实践](https://learn.microsoft.com/en-us/windows/security/operating-system-security/network-security/windows-firewall/best-practices-configuring)

### 工具下载

- [Sysinternals Suite](https://learn.microsoft.com/en-us/sysinternals/)（包含 TCPView/Autoruns/PsExec）
- [Sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)（高级日志记录）

### 安全基线

- [CIS Windows 10 Benchmark](https://www.cisecurity.org/benchmark/microsoft_windows_desktop)
- [Microsoft Security Compliance Toolkit](https://www.microsoft.com/en-us/download/details.aspx?id=55319)

---

## 九、学习成果示例填写（可照抄）

### 结论与反思（示例）

**我今天确认到的 1 个事实证据**：

- 在管理员组中发现了离职员工 `Bob` 的账号残留，已通过 `Remove-LocalUser` 删除。

**我需要立刻改的 1 个设置（如果是自用电脑）**：

- 我的 RDP（3389）端口对所有 IP 开放，需要修改防火墙规则，仅允许家庭网络 IP 段（192.168.1.0/24）访问。

**我不确定但要查的 1 件事**：

- 事件日志中出现了大量事件 ID 4648（使用显式凭据登录），不确定是否为正常运维行为，需要与 IT 部门确认。

---

**恭喜！你已掌握 Windows 安全审计与加固的核心技能。明天我们将学习 PowerShell 脚本，进一步提升自动化能力！** 🎉
