---
title: Day077：红蓝对抗 - 入侵检测与溯源
tags:
  - 网络安全
  - 渗透测试
  - 红蓝对抗
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: 30363
date: 2026-01-28
updated: 2026-01-28
---

# Day077：红蓝对抗 - 入侵检测与溯源

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 13：红蓝对抗与防御 |
| **今日主题** | 入侵检测与溯源 |
| **预计时间** | 3-4 小时 |
| **难度等级** | ⭐⭐⭐⭐ 中高级 |

---

## 🔥 今日痛点场景

> **场景**：安全设备产生了大量告警，你需要判断哪些是真正的攻击，并追踪攻击者的完整路径。
>
> **问题**：如何从海量告警中识别真正的威胁？如何进行攻击溯源？
>
> **今天的任务**：学习入侵检测系统原理和攻击溯源方法。

---

## 🎯 今日目标

- [ ] 理解 IDS/IPS 工作原理
- [ ] 学会分析 IDS 告警
- [ ] 掌握攻击溯源方法
- [ ] 了解威胁情报应用

**闯关条件**：能够分析一次攻击的完整攻击链。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：理解 IDS/IPS（30 分钟）

**IDS vs IPS**：

| 特性 | IDS | IPS |
|------|-----|-----|
| 部署方式 | 旁路镜像 | 串联 |
| 工作模式 | 检测告警 | 检测阻断 |
| 影响流量 | 不影响 | 可能中断 |
| 误报影响 | 仅产生噪音 | 可能阻断正常业务 |

**检测方法**：

```
┌─────────────────────────────────────────┐
│           入侵检测方法                   │
├─────────────────┬───────────────────────┤
│   特征检测      │     异常检测          │
│ (Signature)     │    (Anomaly)          │
├─────────────────┼───────────────────────┤
│ 匹配已知攻击    │ 检测偏离基线的行为    │
│ 准确率高        │ 可发现未知攻击        │
│ 无法检测 0day   │ 误报率高              │
└─────────────────┴───────────────────────┘
```

**主流 IDS 产品**：

| 产品 | 类型 | 特点 |
|------|------|------|
| Snort | 开源 NIDS | 经典，规则丰富 |
| Suricata | 开源 NIDS | 多线程，高性能 |
| Zeek (Bro) | 开源 | 强大的协议分析 |
| OSSEC | 开源 HIDS | 主机入侵检测 |

---

### 任务 2：Suricata 实操（60 分钟）

**安装 Suricata**：

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install suricata -y

# 更新规则
sudo suricata-update

# 查看规则
ls /var/lib/suricata/rules/
```

**基本配置**（/etc/suricata/suricata.yaml）：

```yaml
# 监听接口
af-packet:
  - interface: eth0

# 日志输出
outputs:
  - eve-log:
      enabled: yes
      filename: eve.json
      types:
        - alert
        - http
        - dns
        - tls
```

**启动检测**：

```bash
# 前台运行（测试）
sudo suricata -c /etc/suricata/suricata.yaml -i eth0

# 后台服务运行
sudo systemctl start suricata
sudo systemctl status suricata

# 查看告警
sudo tail -f /var/log/suricata/fast.log
sudo tail -f /var/log/suricata/eve.json | jq
```

**测试规则**：

```bash
# 测试 - 触发告警
curl http://testmynids.org/uid/index.html

# 查看告警
grep "alert" /var/log/suricata/fast.log
```

---

### 任务 3：告警分析与溯源（60 分钟）

**告警分析流程**：

```
┌─────────────────────────────────────────────┐
│ 1. 告警采集 → 2. 告警分类 → 3. 告警验证    │
│      ↓             ↓             ↓          │
│ 4. 威胁情报 → 5. 关联分析 → 6. 溯源报告    │
└─────────────────────────────────────────────┘
```

**分析 Suricata EVE JSON 日志**：

```bash
# 筛选告警
cat /var/log/suricata/eve.json | jq 'select(.event_type=="alert")' | head -20

# 按严重程度分类
cat /var/log/suricata/eve.json | jq 'select(.event_type=="alert") | .alert.severity' | sort | uniq -c

# 提取攻击源 IP
cat /var/log/suricata/eve.json | jq -r 'select(.event_type=="alert") | .src_ip' | sort | uniq -c | sort -rn

# 查看特定规则触发
cat /var/log/suricata/eve.json | jq 'select(.alert.signature_id==2100498)'
```

**溯源分析要素**：

| 要素 | 来源 | 分析内容 |
|------|------|----------|
| 攻击源 IP | IDS 日志 | 地理位置、威胁情报 |
| 攻击时间 | 日志时间戳 | 攻击持续时间 |
| 攻击类型 | 规则分类 | 漏洞利用、扫描等 |
| 目标系统 | 目标 IP/端口 | 影响范围评估 |
| 攻击链 | 关联分析 | 攻击完整路径 |

---

### 任务 4：威胁情报应用（30 分钟）

**威胁情报平台**：

| 平台 | 类型 | 用途 |
|------|------|------|
| VirusTotal | 文件/URL 检测 | 恶意样本分析 |
| AbuseIPDB | IP 信誉 | 恶意 IP 查询 |
| Shodan | 资产搜索 | 攻击者资产分析 |
| ThreatFox | IOC 分享 | 威胁指标查询 |
| AlienVault OTX | 开放情报 | 综合威胁情报 |

**IP 信誉查询示例**：

```bash
# 使用 AbuseIPDB API
curl -s "https://api.abuseipdb.com/api/v2/check?ipAddress=1.2.3.4" \
  -H "Key: YOUR_API_KEY" \
  -H "Accept: application/json" | jq

# 使用 VirusTotal API 查询 IP
curl -s "https://www.virustotal.com/api/v3/ip_addresses/1.2.3.4" \
  -H "x-apikey: YOUR_API_KEY" | jq
```

**IOC 类型**：

| IOC 类型 | 示例 | 应用场景 |
|----------|------|----------|
| IP 地址 | C2 服务器 IP | 网络流量检测 |
| 域名 | 恶意域名 | DNS 日志分析 |
| 文件 Hash | 恶意软件 MD5/SHA256 | 文件检测 |
| URL | 钓鱼链接 | Web 流量检测 |

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 理解 IDS/IPS 原理 | ⬜ |
| Suricata 安装运行成功 | ⬜ |
| 能分析 IDS 告警 | ⬜ |
| 会使用威胁情报平台 | ⬜ |
| 完成一次溯源分析 | ⬜ |

---

## 📖 底层补课（做完实验再看）

### Snort/Suricata 规则语法

```
action protocol src_ip src_port -> dst_ip dst_port (options)

示例：
alert http any any -> any any (msg:"Possible SQLi"; content:"' OR '1'='1"; sid:10001;)
```

**规则组成**：
- action：alert, drop, pass
- protocol：tcp, udp, http, dns
- options：msg, content, pcre, sid

### 攻击链模型（Kill Chain）

```
1. 侦察 → 2. 武器化 → 3. 投递 → 4. 利用 → 5. 安装 → 6. C2 → 7. 目标达成
```

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 告警疲劳 | 太多误报忽视真告警 | 调优规则、分级处理 |
| 规则过时 | 无法检测新攻击 | 定期更新规则 |
| 性能问题 | 丢包、延迟 | 硬件升级或规则优化 |

---

## 💡 知识卡片速查

### Suricata 常用命令

| 命令 | 用途 |
|------|------|
| `suricata-update` | 更新规则 |
| `suricata -T` | 测试配置 |
| `suricata -i eth0` | 监听接口 |
| `tail -f /var/log/suricata/fast.log` | 查看告警 |

---

## 🚀 明日预告

**Day 078：红蓝对抗 - IDS/IPS 绕过技术**

明天你将：
- 学习常见 IDS 绕过技术
- 理解绕过原理
- 掌握检测与绕过的攻防博弈

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> 入侵检测是防御体系的眼睛。
>
> 了解 IDS 的工作原理，对红队意味着知道如何规避；对蓝队意味着知道如何调优。
>
> 溯源分析能力是安全工程师的核心竞争力，多练习，形成自己的分析方法论。

```bash
echo "Day 077 Complete! 入侵检测与溯源掌握！"
```
