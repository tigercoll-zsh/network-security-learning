---
title: Day055：Windows 提权基础 - 信息收集与用户枚举
tags:
  - 网络安全
  - Windows提权
  - 信息收集
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d055
date: 2026-03-18
updated: 2026-01-28
---

# Day055：Windows 提权基础 - 信息收集与用户枚举

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 9：系统提权入门 |
| **今日主题** | Windows 权限模型与提权信息收集 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你通过 Web 漏洞在 Windows 服务器上拿到了一个 shell，用户是 `IIS APPPOOL\DefaultAppPool`。你想读取管理员文件、安装工具，但都显示"访问被拒绝"。
>
> **问题**：Windows 的权限模型是什么？如何从普通用户提升到 SYSTEM 或 Administrator？
>
> **今天的任务**：学习 Windows 提权的第一步——理解权限模型，收集系统信息，为提权做准备。

---

## 今日目标

- [ ] 理解 Windows 权限模型
- [ ] 掌握 Windows 提权信息收集
- [ ] 学会使用自动化枚举工具
- [ ] 识别潜在的提权向量

**闯关条件**：在 Windows 靶机上完成信息收集，找出至少 3 个潜在提权向量。

---

## 实战任务（先动手！）

### 任务 1：理解 Windows 权限模型（30 分钟）

**Windows 用户类型**：
```
SYSTEM（NT AUTHORITY\SYSTEM）
├── 最高权限，超过 Administrator
├── 服务通常以此身份运行
└── 提权目标

Administrator
├── 管理员账户
├── 几乎完全控制
└── 提权目标

普通用户
├── 有限权限
├── 只能访问自己的文件
└── 你拿到的 shell 通常是这个

服务账户
├── IIS APPPOOL\xxx
├── NT SERVICE\xxx
└── 权限受限，通常是 Web Shell 的起点
```

**Windows 权限令牌**：
```
访问令牌（Access Token）：
- 每个进程都有
- 包含用户 SID、组 SID、权限列表
- 决定进程能做什么

令牌类型：
- 主令牌（Primary Token）：进程令牌
- 模拟令牌（Impersonation Token）：临时令牌

重要权限：
- SeDebugPrivilege：调试任何进程
- SeImpersonatePrivilege：模拟其他用户
- SeBackupPrivilege：备份任何文件
- SeRestorePrivilege：恢复任何文件
- SeTakeOwnershipPrivilege：获取文件所有权
```

**查看当前权限**：
```cmd
:: 当前用户
whoami

:: 详细信息
whoami /all

:: 输出包含
:: - 用户名和 SID
:: - 所属组
:: - 权限列表
```

**记录**：
```
当前用户：________________
关键权限：________________
```

---

### 任务 2：系统信息收集（45 分钟）

**系统基本信息**：
```cmd
:: 系统信息
systeminfo

:: 关键信息
:: - OS Name：操作系统
:: - OS Version：版本号
:: - System Type：x64/x86
:: - Hotfix(s)：已安装补丁

:: 简化版本
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"

:: 主机名
hostname

:: 架构
wmic os get osarchitecture
```

**网络信息**：
```cmd
:: 网络配置
ipconfig /all

:: 路由表
route print

:: 监听端口
netstat -ano

:: ARP 缓存
arp -a

:: 防火墙状态
netsh firewall show state
netsh advfirewall show currentprofile
```

**用户和组**：
```cmd
:: 当前用户详情
whoami /all

:: 所有本地用户
net user

:: 用户详情
net user Administrator

:: 本地组
net localgroup

:: 管理员组成员
net localgroup Administrators

:: 域用户（如果在域中）
net user /domain
```

**进程和服务**：
```cmd
:: 运行中的进程
tasklist
tasklist /v  :: 详细版
tasklist /svc  :: 显示服务

:: 高权限进程
tasklist /v | findstr /i "system"

:: 服务列表
sc query

:: 非标准服务
wmic service get name,displayname,pathname,startmode
```

**已安装软件**：
```cmd
:: 32位程序
dir "C:\Program Files (x86)"

:: 64位程序
dir "C:\Program Files"

:: 注册表查询
reg query HKLM\SOFTWARE

:: wmic 查询
wmic product get name,version
```

**计划任务**：
```cmd
:: 计划任务
schtasks /query /fo LIST /v

:: 特定任务
schtasks /query /TN "TaskName" /v
```

**记录**：
```
操作系统版本：________________
已安装补丁数：________________
可疑服务：________________
```

---

### 任务 3：凭据搜索（35 分钟）

**常见凭据位置**：
```cmd
:: 搜索密码文件
dir /s *password* *passwd* *credentials*

:: 搜索配置文件
dir /s *.config *.ini *.xml

:: 搜索敏感内容
findstr /si password *.txt *.xml *.ini *.config

:: Unattend 文件（安装时的凭据）
dir /s C:\*unattend*.xml C:\*sysprep*.xml
```

**注册表凭据**：
```cmd
:: Autologon 凭据
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

:: 保存的凭据
cmdkey /list

:: VNC 密码
reg query "HKCU\Software\ORL\WinVNC3\Password"

:: Putty 保存的会话
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"

:: 保存的 WiFi 密码
netsh wlan show profile
netsh wlan show profile "SSID" key=clear
```

**凭据文件**：
```cmd
:: SAM 和 SYSTEM 文件（需要特殊权限）
:: C:\Windows\System32\config\SAM
:: C:\Windows\System32\config\SYSTEM

:: 备份位置
:: C:\Windows\Repair\SAM
:: C:\Windows\Repair\SYSTEM

:: PowerShell 历史
type %APPDATA%\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

:: IE 保存的密码
reg query "HKCU\Software\Microsoft\Internet Explorer\IntelliForms\Storage2"
```

**内存中的凭据**：
```powershell
# 需要 Mimikatz（后续学习）
# 可以从 LSASS 进程提取
# 需要高权限
```

**记录**：
```
发现的凭据文件：________________
提取的密码：________________
```

---

### 任务 4：自动化枚举工具（40 分钟）

**WinPEAS - Windows 版 LinPEAS**：
```cmd
:: 下载
:: https://github.com/carlospolop/PEASS-ng/releases

:: 运行
winPEASx64.exe

:: 保存输出
winPEASx64.exe > winpeas_output.txt

:: 特定检查
winPEASx64.exe systeminfo
winPEASx64.exe servicesinfo
```

**PowerUp（PowerShell）**：
```powershell
# 导入
. .\PowerUp.ps1

# 运行所有检查
Invoke-AllChecks

# 特定检查
Get-ServiceUnquoted
Get-ModifiableServiceFile
Get-ModifiableService
```

**Windows Exploit Suggester**：
```bash
# 在攻击机上运行

# 导出 systeminfo
systeminfo > systeminfo.txt

# 运行
python windows-exploit-suggester.py --database 2024-01-01-mssb.xls --systeminfo systeminfo.txt
```

**Seatbelt**：
```cmd
:: 全面枚举
Seatbelt.exe -group=all

:: 特定检查
Seatbelt.exe -group=system
Seatbelt.exe -group=user
```

**手动 PowerShell 枚举**：
```powershell
# 系统信息
Get-ComputerInfo

# 用户
Get-LocalUser
Get-LocalGroupMember Administrators

# 进程
Get-Process | Where-Object {$_.Path -notlike "*System32*"}

# 服务
Get-WmiObject win32_service | Select-Object Name, DisplayName, PathName, StartMode

# 计划任务
Get-ScheduledTask
```

**记录**：
```
使用的工具：________________
发现的高风险项：________________
```

---

### 任务 5：整理提权向量（20 分钟）

**Windows 提权向量清单**：
```
1. 内核漏洞
   - Windows 版本和补丁级别
   - 已知漏洞利用

2. 服务配置错误
   - 未引用的服务路径
   - 可修改的服务文件
   - 弱服务权限

3. 注册表权限
   - AlwaysInstallElevated
   - 可写的服务注册表键

4. 文件/目录权限
   - 可写的 PATH 目录
   - DLL 劫持机会

5. 令牌权限
   - SeImpersonatePrivilege
   - SeDebugPrivilege

6. 凭据泄露
   - 明文密码
   - 缓存的凭据

7. 计划任务
   - 可修改的任务文件
   - 弱权限任务
```

**提权向量模板**：
```
系统信息：
- Windows 版本：________________
- 架构：________________
- 补丁级别：________________

潜在向量：
1. 服务：________________
2. 令牌权限：________________
3. 凭据：________________
4. 计划任务：________________
5. 内核漏洞：________________

优先级排序：
1. ________________（最可能成功）
2. ________________
3. ________________
```

**记录**：
```
发现的提权向量数量：________________
最有希望的向量：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解 Windows 权限模型 | 15 分 |
| 完成系统信息收集 | 25 分 |
| 完成凭据搜索 | 20 分 |
| 使用自动化工具 | 25 分 |
| 整理提权向量清单 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### Windows 权限模型

```
访问控制模型：
- 每个对象（文件、注册表键、服务）有安全描述符
- 安全描述符包含 DACL（自由访问控制列表）
- DACL 决定谁能访问、如何访问

进程权限：
- 进程继承父进程的令牌
- 令牌包含 SID 和权限
- 某些权限默认禁用，需要启用

UAC：
- 管理员登录获得两个令牌
- 高权限令牌（完整）
- 低权限令牌（过滤后）
- 需要提权时弹出 UAC 提示
```

### SYSTEM vs Administrator

```
SYSTEM：
- Windows 内核和服务使用
- 不受 UAC 限制
- 可以访问任何文件
- 不能网络认证（本地账户）

Administrator：
- 用户账户
- 受 UAC 限制
- 几乎所有权限
- 可以网络认证
```

### 提权的本质

```
获取更高权限的令牌
       ↓
方法：
1. 利用内核漏洞获取 SYSTEM
2. 利用服务配置错误执行代码
3. 利用令牌权限模拟 SYSTEM
4. 使用泄露的凭据登录管理员
5. 利用 UAC 绕过获取高权限令牌
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| PowerShell 执行策略 | 脚本无法运行 | `powershell -ep bypass` |
| AV 拦截工具 | 工具被删除 | 混淆或使用替代工具 |
| 权限不足读注册表 | 访问被拒绝 | 只查询有权限的键 |
| 输出太长 | 信息丢失 | 重定向到文件 |

---

## 知识卡片速查

### 快速枚举命令

```cmd
:: 一行信息收集
whoami /all & hostname & systeminfo | findstr /B /C:"OS" & net user

:: 查找密码
findstr /si password *.txt *.xml *.ini

:: 服务路径
wmic service get name,pathname | findstr /i /v "C:\Windows"

:: 令牌权限
whoami /priv
```

### 关键位置

```
C:\Windows\System32\config\SAM - 密码哈希
C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\* - PS历史
C:\inetpub\wwwroot\web.config - Web配置
C:\Windows\Panther\unattend.xml - 安装凭据
```

### 工具速查

```
WinPEAS - 全面枚举
PowerUp - PowerShell 提权枚举
Seatbelt - 系统信息收集
Windows Exploit Suggester - 漏洞建议
```

---

## 常见问题

**Q1：工具被 AV 拦截怎么办？**

A1：
- 使用手动命令枚举
- 使用混淆版本的工具
- 在内存中运行（避免落盘）
- 使用 Living off the Land（LOL）技术

**Q2：没有 PowerShell 怎么办？**

A2：
- 使用 cmd 命令
- 使用 wmic
- 上传 exe 版本的工具

**Q3：信息收集后找不到可利用的点？**

A3：
1. 检查是否遗漏
2. 查看内核漏洞
3. 监控进程活动
4. 横向移动到其他主机
5. 等待/触发特定事件

---

## 明日预告

**Day 056：Windows 提权 - 服务配置与令牌权限利用**

明天你将：
- 学习 Windows 服务提权
- 掌握令牌权限滥用
- 了解 AlwaysInstallElevated 利用

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 使用的枚举工具 | |
| 发现的提权向量 | |
| 今日收获 | |

---

> **导师点评**：
>
> 欢迎来到 Windows 提权的世界！
>
> Windows 和 Linux 提权的思路是一样的——信息收集、找漏洞、利用。但 Windows 更复杂：权限模型更复杂、对象类型更多、工具也更多。
>
> 好消息是，Windows 的配置错误也更多。服务、注册表、文件权限、计划任务……每一个都可能是提权入口。
>
> **记住：Windows 提权的关键是理解"谁能做什么"。令牌权限、服务配置、文件 ACL——都是在回答这个问题**。

```bash
echo "Day 055 Complete! Windows 提权之旅开始！"
```
