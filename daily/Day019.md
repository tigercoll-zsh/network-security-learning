---
title: Day019：操作系统与脚本 - Nmap 端口扫描安全使用
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: b5624f93
date: 2026-01-12 00:00:00
updated: 2026-01-12 00:00:00

---
# Day019：操作系统与脚本 - Nmap 端口扫描安全使用

- 日期：2026-01-12
- 周次：第 3 周

## 学习目标

学完今天你应该能做到：

- 明确知道一句底线：**扫描是有"扰动"的行为，只能在自建/明确授权目标上做**
- 能解释 `-sS` (隐蔽) 和 `-sT` (全连接) 的差异及适用场景
- **掌握 Nmap 的版本探测 (-sV) 和操作系统探测 (-O) 原理**
- **理解并能实施规避防火墙/IDS 的基础扫描策略**
- 能输出一份规范的扫描报告（含授权说明、时间窗口、结果风险分析）

---

<!--more-->

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 3 周：系统安全与信息收集
│   ├── Day018：Python 脚本基础
│   └── Day019：Nmap 扫描实战
│       ├── 核心概念：端口状态、TCP 握手
│       ├── 实践技能：主机发现、端口扫描、版本探测
│       └── 关联知识点：防火墙规避、NSE 脚本
    ├── Day020：服务枚举与指纹识别
```

### 今日关键词

`Nmap` · `Port Scan` · `SYN Scan` · `Version Detection` · **`Firewall Evasion`**

---

## 一、为什么端口扫描需要"合法授权"？

### 1.1 端口扫描的法律风险

```
法律视角
├─ 未经授权的端口扫描可能构成"非法侵入计算机系统"
├─ 某些国家/地区的法律明确禁止未授权扫描
└─ 即使是"善意测试"，也可能被视为攻击行为

企业视角
├─ 触发 IDS/IPS 告警，导致安全团队误判
├─ 影响生产系统性能（尤其是全端口扫描）
└─ 违反公司安全政策，可能被开除

技术视角
├─ SYN Flood 扫描可能被识别为 DoS 攻击
├─ 频繁连接可能导致目标系统资源耗尽
└─ 留下大量日志痕迹，容易被溯源
```

### 1.2 合法授权的 3 个层次

| 授权类型 | 说明 | 示例 |
|----------|------|------|
| **自建环境** | 你完全拥有的系统 | 本机、自己的虚拟机、家庭 NAS |
| **书面授权** | 有明确的授权文件 | 渗透测试合同、安全评估委托书 |
| **公开靶场** | 明确允许测试的平台 | HackTheBox、TryHackMe、VulnHub |

**⚠️ 重要提醒**：
- 即使是公司内网，也需要 IT 部门明确授权
- 不要扫描"你认为可能没问题"的目标
- 每次扫描都应记录授权证明和扫描时间

---

## 二、Nmap 核心概念与参数详解

### 2.1 端口状态含义

| 状态 | 含义 | 常见原因 |
|------|------|----------|
| **open** | 端口开放，有服务监听 | 正常服务（SSH/HTTP/MySQL） |
| **closed** | 端口关闭，但主机在线 | 服务未启动或已停止 |
| **filtered** | 被防火墙过滤，无响应 | 防火墙规则拒绝或丢弃数据包 |
| **unfiltered** | 端口可达，但无法确定开放/关闭 | 罕见，通常是 ACK 扫描的结果 |
| **open|filtered** | 无法确定是开放还是被过滤 | UDP 扫描常见 |
| **closed|filtered** | 无法确定是关闭还是被过滤 | IPID 扫描的结果 |

### 2.2 扫描类型对照表

| 参数 | 名称 | 工作原理 | 权限要求 | 隐蔽性 | 速度 |
|------|------|----------|----------|--------|------|
| `-sS` | SYN 扫描（半开扫描） | 发送 SYN，收到 SYN-ACK 后发送 RST | 需要 root/管理员 | ⭐⭐⭐⭐ | 快 |
| `-sT` | TCP Connect 扫描 | 完整三次握手 | 普通用户 | ⭐⭐ | 中等 |
| `-sU` | UDP 扫描 | 发送 UDP 数据包 | 普通用户 | ⭐⭐⭐ | 慢 |
| `-sA` | ACK 扫描 | 发送 ACK 包，用于探测防火墙规则 | 需要 root/管理员 | ⭐⭐⭐⭐ | 快 |
| `-sN/-sF/-sX` | NULL/FIN/Xmas 扫描 | 利用 TCP 标志位绕过防火墙 | 需要 root/管理员 | ⭐⭐⭐⭐⭐ | 中等 |

**推荐**：
- **日常使用**：`-sT`（无需特殊权限，兼容性好）
- **渗透测试**：`-sS`（更快，日志痕迹更少）
- **防火墙探测**：`-sA`（判断是否有状态防火墙）

### 2.3 常用参数详解

#### 端口指定
```bash
# 扫描单个端口
nmap -p 80 192.168.1.1

# 扫描多个端口
nmap -p 22,80,443 192.168.1.1

# 扫描端口范围
nmap -p 1-1000 192.168.1.1

# 扫描所有端口（0-65535）
nmap -p- 192.168.1.1

# 扫描 Top 100 常用端口
nmap --top-ports 100 192.168.1.1
```

#### 服务版本探测
```bash
# 探测服务版本
nmap -sV 192.168.1.1

# 更激进的版本探测
nmap -sV --version-intensity 5 192.168.1.1

# 轻量级版本探测
nmap -sV --version-intensity 0 192.168.1.1
```

#### 操作系统探测
```bash
# 探测操作系统
nmap -O 192.168.1.1

# 激进模式（操作系统+版本+脚本+路由追踪）
nmap -A 192.168.1.1
```

#### 输出格式
```bash
# 正常输出到文件
nmap -oN scan.txt 192.168.1.1

# XML 输出（可用工具解析）
nmap -oX scan.xml 192.168.1.1

# Grepable 输出（方便脚本处理）
nmap -oG scan.gnmap 192.168.1.1

# 输出到所有格式
nmap -oA scan 192.168.1.1
```

#### 速度与时延
```bash
# 最快（容易被检测，可能不准确）
nmap -T5 192.168.1.1

# 正常速度（推荐）
nmap -T3 192.168.1.1

# 慢速（隐蔽扫描）
nmap -T1 192.168.1.1

# 自定义扫描延迟（每个探测间隔 1 秒）
nmap --scan-delay 1s 192.168.1.1
```

---

## 三、实战任务（含完整命令与分析）

### 任务 1：确认授权目标并记录

**目标**：养成"先确认授权"的习惯。

**步骤**：
1. 选择一个合法目标（三选一）：
   - ✅ 本机（`127.0.0.1` 或 `localhost`）
   - ✅ 自己的虚拟机（VMware/VirtualBox）
   - ✅ 家庭 NAS/路由器（确保你拥有）

2. 填写授权记录：
```
目标：127.0.0.1
授权类型：自建环境（本机自查）
扫描窗口：2026-01-12 14:00 - 14:30
目的：学习端口扫描，排查不必要的开放端口
```

---

### 任务 2：基础扫描（Top 1000 端口）

**命令**：
```bash
nmap -sT -sV --top-ports 1000 -oN day019_scan.txt 127.0.0.1
```

**参数说明**：
- `-sT`：TCP Connect 扫描（无需管理员权限）
- `-sV`：探测服务版本
- `--top-ports 1000`：扫描最常见的 1000 个端口
- `-oN day019_scan.txt`：输出到文本文件
- `127.0.0.1`：目标 IP（本机）

**执行时间**：约 1-3 分钟

**预期输出示例**：
```
Starting Nmap 7.94 ( https://nmap.org )
Nmap scan report for localhost (127.0.0.1)
Host is up (0.00010s latency).
Not shown: 996 closed tcp ports (conn-refused)
PORT     STATE SERVICE VERSION
135/tcp  open  msrpc   Microsoft Windows RPC
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server Microsoft Terminal Services
5357/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.34 seconds
```

**结果分析**：
| 端口 | 状态 | 服务 | 版本 | 风险评估 |
|------|------|------|------|----------|
| 135 | open | msrpc | Microsoft Windows RPC | ⚠️ 中等：内网常见，不应对公网开放 |
| 445 | open | microsoft-ds | SMB | 🚨 高：历史上多个严重漏洞（EternalBlue） |
| 3389 | open | ms-wbt-server | RDP | 🚨 高：容易被暴力破解 |
| 5357 | open | http | SSDP/UPnP | ⚠️ 中等：可能被利用做 SSRF |

---

### 任务 3：指定端口范围扫描

**场景**：只扫描 Web 相关端口（80/443/8080/8443）

**命令**：
```bash
nmap -sT -sV -p 80,443,8080,8443 -oN day019_web.txt 127.0.0.1
```

**预期输出**：
```
PORT     STATE  SERVICE VERSION
80/tcp   closed http
443/tcp  closed https
8080/tcp closed http-proxy
8443/tcp closed https-alt
```

**分析**：如果都是 `closed`，说明本机没有运行 Web 服务。

---

### 任务 4：防火墙探测与规避测试（高级）

**目标**：探测目标是否存在防火墙，并尝试绕过（原理验证）。

**1. 探测防火墙规则（ACK 扫描）**：
   - 原理：发送 ACK 包。如果端口未被过滤，应返回 RST；如果被过滤，无响应或返回 ICMP 不可达。
   ```bash
   nmap -sA -p 80,3389 192.168.1.1
   ```
   - **预期输出**：`unfiltered`（未被过滤）或 `filtered`（有防火墙）。

**2. 碎片化扫描（Fragment Scan）**：
   - 原理：将 TCP 头拆分成多个小包发送，尝试绕过简单的包过滤规则。
   ```bash
   sudo nmap -f 192.168.1.1
   ```
   *(注：在某些现代防火墙上可能无效，但值得了解原理)*

**3. 诱饵扫描（Decoy Scan）**：
   - 原理：伪造多个源 IP 同时发起扫描，混淆视听。
   ```bash
   sudo nmap -D RND:5 192.168.1.1
   ```
   *(注：`-D RND:5` 表示随机伪造 5 个 IP)*

**分析**：
- 如果 `-sA` 返回 `filtered`，说明存在状态防火墙。
- 如果碎片化扫描能扫出比正常扫描更多的端口，说明防火墙规则可能存在缺陷。

---

### 任务 5：整理扫描结果为表格

**目标**：从 `day019_scan.txt` 提取关键信息，整理成表格。

**手动方法**：
1. 打开 `day019_scan.txt`
2. 找到类似这样的行：
```
PORT     STATE SERVICE VERSION
135/tcp  open  msrpc   Microsoft Windows RPC
```
3. 整理成 Markdown 表格：

| 端口 | 状态 | 服务 | 版本 |
|------|------|------|------|
| 135 | open | msrpc | Microsoft Windows RPC |
| 445 | open | microsoft-ds | - |
| 3389 | open | ms-wbt-server | Microsoft Terminal Services |

**自动化方法**（Python 脚本，明天 Day020 会详细讲）：
```python
import re

with open("day019_scan.txt", "r") as f:
    for line in f:
        match = re.match(r"(\d+)/tcp\s+(\w+)\s+(\S+)\s+(.*)", line)
        if match:
            port, state, service, version = match.groups()
            print(f"| {port} | {state} | {service} | {version} |")
```

---

## 四、巩固练习（题与复盘）

### 练习 1：解释 -sS 与 -sT 的差异及防御视角

**参考答案**：
- **-sS（SYN 扫描）**：
  - **原理**：发送 SYN -> 收到 SYN/ACK -> 发送 RST。不建立完整连接。
  - **优势**：速度快，日志记录较少（但现代防火墙都能检测到）。
  - **防御**：防火墙检测到大量 SYN 但无后续 ACK 时，会判定为扫描并拦截。

- **-sT（TCP Connect 扫描）**：
  - **原理**：完成三次握手 -> 交换数据/关闭。
  - **优势**：无需 Root 权限，最稳定。
  - **劣势**：会在应用层日志（如 Nginx access.log）留下明显记录。

### 练习 2：设计一套隐蔽的扫描参数组合

**场景**：你需要对授权目标进行扫描，但不想触发 IDS（入侵检测系统）的高频告警。

**推荐参数**：
```bash
nmap -sS -T2 --randomize-hosts -p 80,443 -oN slow_scan.txt 192.168.1.0/24
```

**参数说明**：
- `-sS`：半开扫描，减少应用层日志。
- `-T2`：慢速扫描，降低扫描频率，避免触发速率限制。
- `--randomize-hosts`：打乱扫描目标的顺序，避免对单一网段形成连续流量特征。

### 练习 3：识别潜在的安全风险端口

**场景**：扫描发现以下开放端口，评估风险。

| 端口 | 服务 | 风险等级 | 原因 |
|------|------|----------|------|
| 22 | SSH | ⚠️ 中 | 需检查密码强度、是否禁用 root 登录 |
| 23 | Telnet | 🚨 极高 | 明文传输，必须禁用 |
| 80 | HTTP | ⚠️ 中 | 明文传输，敏感数据应用 HTTPS |
| 3306 | MySQL | 🚨 高 | 数据库不应直接暴露，应通过跳板机 |
| 3389 | RDP | 🚨 高 | 容易被暴力破解，应限制 IP |
| 5900 | VNC | 🚨 高 | 默认无加密，易被劫持 |
| 8080 | HTTP | ⚠️ 中 | 检查是否为测试服务，不应对公网开放 |

---

## 五、评估标准

- ✅ 报告里写清授权范围（目标/窗口/理由）
- ✅ 至少导出一份扫描结果文件（`.txt` 或 `.xml`）
- ✅ 能读懂输出中的"open/closed/filtered"并解释原因
- ✅ **能识别高危端口并给出加固建议**
- ✅ **理解扫描速度（-T 参数）与隐蔽性之间的权衡**

---

## 六、参考资料

### 官方文档
- [Nmap 官方文档](https://nmap.org/book/man.html)
- [Nmap 脚本引擎（NSE）](https://nmap.org/nsedoc/)
- [端口服务对照表](https://www.iana.org/assignments/service-names-port-numbers/)

### 进阶阅读
- 《Nmap Network Scanning》（官方书籍）
- [Nmap Cheat Sheet](https://www.stationx.net/nmap-cheat-sheet/)

---

## 七、学习成果达成情况（由学习者填写）

### 授权记录（必填）

```
目标：
授权类型：
扫描窗口：
目的：
```

### 截图与证据

- [ ] `day019_scan.txt` 文件存在证据
- [ ] 扫描输出截图（至少显示 1 个开放端口）
- [ ] 整理的端口/服务/版本表格

### 关键命令与输出

**执行的命令**：
```
[粘贴你的命令]
```

**关键输出片段**：
```
[粘贴 PORT/STATE/SERVICE/VERSION 部分]
```

### 结论与反思

- **我发现的开放端口**：
  
- **我识别的高风险端口**：
  
- **我下一步要做的枚举验证**：
  

---

**恭喜！你已掌握 Nmap 端口扫描的核心技能。明天我们将学习服务枚举与指纹识别，进一步确认服务类型与版本！** 🎉
