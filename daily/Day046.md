---
title: Day046：越权漏洞 - 垂直越权与权限提升
tags:
  - 网络安全
  - 越权
  - 权限提升
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d046
date: 2026-03-09
updated: 2026-01-28
---

# Day046：越权漏洞 - 垂直越权与权限提升

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 8：认证与逻辑漏洞 |
| **今日主题** | 垂直越权与权限提升 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你是普通用户，只能看自己的数据。但你发现了一个隐藏的 `/admin` 页面，直接访问竟然进去了！
>
> **问题**：普通用户怎么能执行管理员功能？
>
> **今天的任务**：学习垂直越权——从普通用户变成管理员的艺术。

---

## 今日目标

- [ ] 理解垂直越权与水平越权的区别
- [ ] 掌握常见的垂直越权漏洞模式
- [ ] 学会发现隐藏的管理功能
- [ ] 完成权限提升实战

**闯关条件**：以普通用户身份成功执行管理员功能。

---

## 实战任务（先动手！）

### 任务 1：垂直越权原理（20 分钟）

**对比两种越权**：

| 特征 | 水平越权 | 垂直越权 |
|------|----------|----------|
| 权限变化 | 同级别 | 低→高 |
| 攻击目标 | 其他用户的数据 | 更高权限的功能 |
| 典型场景 | A 看 B 的订单 | 普通用户删除文章 |
| 危害程度 | 中 | 高 |

**垂直越权的本质**：
```
前端隐藏了管理功能
≠
后端验证了管理权限

隐藏 ≠ 禁止
不显示 ≠ 不能访问
```

**常见漏洞场景**：
```
1. 直接访问管理 URL
2. 修改请求中的角色参数
3. 前端控制 vs 后端控制
4. 功能授权不完整
```

**记录**：
```
垂直越权的本质：________________
```

---

### 任务 2：发现隐藏的管理功能（40 分钟）

**方法 1：目录扫描**
```bash
# 使用 dirsearch 扫描管理路径
dirsearch -u http://target.com -w /path/to/admin-wordlist.txt

# 常见管理路径
/admin
/administrator
/manage
/dashboard
/console
/backend
/system
/control
```

**方法 2：分析前端代码**
```javascript
// 查看 JavaScript 中是否有隐藏的 API
// 搜索关键词
admin
delete
remove
update
modify
role
permission
```

**方法 3：分析 robots.txt 和 sitemap**
```
# robots.txt 可能泄露敏感路径
Disallow: /admin/
Disallow: /api/internal/
```

**方法 4：查看 HTML 注释**
```html
<!-- TODO: 管理员功能入口 /secret-admin -->
<!-- <a href="/admin/users">用户管理</a> -->
```

**方法 5：观察请求参数**
```http
# 正常请求
POST /api/user/update HTTP/1.1
{"name": "test"}

# 是否有隐藏参数？
{"name": "test", "role": "admin"}
{"name": "test", "is_admin": true}
```

**记录**：
```
发现的隐藏路径：________________
使用的发现方法：________________
```

---

### 任务 3：常见垂直越权模式（45 分钟）

**模式 1：直接访问管理 URL**
```http
# 普通用户访问
GET /admin/users HTTP/1.1
Cookie: session=normal_user_session

# 如果返回 200 和管理页面，存在漏洞
```

**模式 2：修改角色参数**
```http
# 用户注册/更新时
POST /api/user/register HTTP/1.1
{
  "username": "attacker",
  "password": "pass123",
  "role": "admin"  ← 添加角色参数
}
```

**模式 3：修改 Cookie 中的角色**
```http
# 原始 Cookie
Cookie: user=normal; role=user

# 修改为
Cookie: user=normal; role=admin
```

**模式 4：请求方法切换**
```http
# GET 被拦截
GET /admin/delete?id=1 HTTP/1.1
→ 403 Forbidden

# 尝试 POST
POST /admin/delete HTTP/1.1
{"id": 1}
→ 200 OK  # 可能绕过
```

**模式 5：HTTP Header 注入**
```http
# 某些系统通过 Header 判断权限
GET /admin HTTP/1.1
X-Forwarded-For: 127.0.0.1
X-Original-URL: /admin
X-Rewrite-URL: /admin
```

**模式 6：参数覆盖**
```http
# 正常请求
POST /api/action HTTP/1.1
{"user_id": 1001, "action": "view"}

# 添加权限参数
POST /api/action HTTP/1.1
{"user_id": 1001, "action": "delete", "admin": true}
```

**记录**：
```
测试的越权模式：________________
成功的模式：________________
```

---

### 任务 4：权限绕过实战（40 分钟）

**环境**：PortSwigger Web Security Academy - Access Control Labs

**Lab 1：基于 URL 的访问控制绕过**

目标：以普通用户访问 `/admin` 删除用户

**步骤**：
1. 登录普通用户
2. 直接访问 `/admin` → 403
3. 尝试使用 `X-Original-URL` Header
```http
GET / HTTP/1.1
X-Original-URL: /admin
```
4. 如果成功，继续执行删除操作

**Lab 2：基于方法的访问控制绕过**

目标：使用不同 HTTP 方法绕过

**步骤**：
1. 管理员使用 `POST /admin/deleteUser`
2. 普通用户用 `GET /admin/deleteUser?username=carlos`
3. 或尝试 `POSTX`、`HEAD` 等非标准方法

**Lab 3：多步骤功能绕过**

目标：绕过多步骤验证

**场景**：
```
步骤 1：确认删除 → 验证权限
步骤 2：执行删除 → 未验证权限

直接跳到步骤 2！
```

**记录**：
```
完成的 Lab：________________
使用的绕过技术：________________
```

---

### 任务 5：真实案例分析（25 分钟）

**案例 1：某 SaaS 平台垂直越权**
```
漏洞描述：
- 普通用户可以通过修改 API 请求中的 team_id
- 访问其他团队的数据并执行管理操作

利用过程：
1. 抓取正常的团队管理 API
2. 修改 team_id 为其他团队
3. 成功获取管理权限

修复方案：
- 后端验证用户是否属于该团队
- 验证用户在团队中的角色
```

**案例 2：管理后台未鉴权**
```
漏洞描述：
- /admin 路径只在前端隐藏
- 后端未验证管理员身份

利用过程：
1. 目录扫描发现 /admin
2. 直接访问，成功进入
3. 可以管理所有用户

修复方案：
- 后端对所有管理接口进行权限验证
- 使用统一的权限中间件
```

**案例 3：角色参数可控**
```
漏洞描述：
- 用户更新接口允许修改 role 字段
- 后端未过滤敏感字段

利用过程：
1. 正常更新个人信息
2. 添加 "role": "admin" 参数
3. 成功提升为管理员

修复方案：
- 白名单过滤可更新字段
- 角色变更需要额外验证
```

**记录**：
```
最有启发的案例：________________
学到的技巧：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解垂直越权原理 | 20 分 |
| 成功发现隐藏功能 | 20 分 |
| 掌握常见越权模式 | 25 分 |
| 完成 Lab 练习 | 25 分 |
| 分析真实案例 | 10 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 权限控制模型

```
RBAC（基于角色的访问控制）
用户 → 角色 → 权限
例：张三 → 管理员 → 删除用户

ABAC（基于属性的访问控制）
用户属性 + 资源属性 + 环境属性 → 决策
例：部门=财务 + 文档=财务报表 + 时间=工作时间 → 允许访问

ACL（访问控制列表）
资源 → 用户/权限列表
例：文件A → [(张三, 读写), (李四, 只读)]
```

### 前端控制 vs 后端控制

```html
<!-- 前端控制（不安全！）-->
<script>
if (user.role !== 'admin') {
    document.getElementById('deleteBtn').style.display = 'none';
}
</script>

<!-- 问题：直接请求 API 仍然有效 -->
```

```python
# 后端控制（正确做法）
@app.route('/admin/delete')
def delete_user():
    if current_user.role != 'admin':
        return "Forbidden", 403
    # 执行删除
```

### 常见漏洞代码

```python
# 漏洞代码：只验证登录，不验证权限
@app.route('/admin/users')
@login_required  # 只检查是否登录
def admin_users():
    return User.query.all()

# 正确代码：同时验证权限
@app.route('/admin/users')
@login_required
@admin_required  # 额外检查管理员权限
def admin_users():
    return User.query.all()
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 403 不代表安全 | 只拦截了部分请求 | 测试不同方法、不同参数 |
| 需要先成为用户 | 未登录直接 403 | 先注册普通用户再测试 |
| 多层权限 | 绕过一层还有一层 | 分析完整权限架构 |
| 功能分散 | 不同功能权限不一 | 遍历所有管理功能 |

---

## 知识卡片速查

### 垂直越权测试清单

```
1. 扫描管理路径
2. 分析前端 JS
3. 查看 robots.txt
4. 检查 HTML 注释
5. 尝试添加角色参数
6. 修改请求方法
7. 添加特殊 Header
8. 直接访问 API
```

### 常见管理路径

```
/admin, /administrator, /manage
/dashboard, /control, /console
/backend, /system, /panel
/api/admin, /api/internal
/v1/admin, /private
```

### 角色相关参数

```
role, user_role, userRole
is_admin, isAdmin, admin
permission, level, type
group, group_id, access_level
```

---

## 常见问题

**Q1：垂直越权比水平越权更严重吗？**

A1：通常是的：
- 垂直越权涉及权限提升，可能控制整个系统
- 水平越权只影响同级用户数据
- 但具体危害取决于业务场景

**Q2：如何判断是前端控制还是后端控制？**

A2：
1. 查看前端代码是否有权限判断
2. 直接请求被"隐藏"的 API
3. 如果能访问，说明只有前端控制

**Q3：管理后台使用独立域名是否更安全？**

A3：有帮助，但不是根本解决：
- 独立域名可以限制访问范围
- 但后端权限验证仍然必不可少
- 内网管理后台同样需要权限控制

---

## 明日预告

**Day 047：JWT 攻击 - 原理与 none 算法漏洞**

明天你将：
- 理解 JWT 的结构和工作原理
- 学习 JWT none 算法攻击
- 掌握 JWT 伪造技巧

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 成功的越权操作 | |
| 发现的隐藏功能 | |
| 今日收获 | |

---

> **导师点评**：
>
> 垂直越权往往源于一个简单的假设：**"用户不知道这个 URL"**。
>
> 但安全不能依赖"不知道"。目录扫描、JS 分析、API 文档泄露……有太多方式可以发现隐藏功能。
>
> 记住这个原则：**如果你不想让用户访问，就在后端拒绝他，而不是在前端隐藏按钮**。
>
> 很多开发者觉得"前端不显示就安全了"——这是最危险的安全幻觉。

```bash
echo "Day 046 Complete! 权限提升大师！"
```
