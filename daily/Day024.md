# Day024：漏洞扫描与基线 - 系统基线与审计

- 日期：2026-01-17
- 周次：第4周

## 学习目标

学完今天你应该能做到：

- 能说出**什么是基线**以及**为什么需要基线检查**
- 掌握**5条以上常见基线项**（口令策略、补丁管理、服务暴露、权限配置、日志审计）
- 能用脚本**自动化检查本机/靶机的关键基线项**并输出结构化结果
- 能根据检查结果**识别风险并给出加固建议**

---

## 一、什么是基线（Baseline）？

### 1.1 基线定义

**基线（Baseline）**是系统安全配置的"最低安全标准"，就像房子的"地基"：

```
基线检查的重要性
├─ 防止"默认配置"带来的风险（如：默认密码、默认服务）
├─ 确保"合规性"（如：等保、ISO27001、CIS Benchmark）
├─ 减少"攻击面"（关闭不必要的服务/端口）
└─ 便于"审计与追踪"（有标准可对比）
```

### 1.2 常见基线标准

| 标准名称 | 适用范围 | 特点 |
|---------|---------|------|
| **CIS Benchmark** | 通用（Linux/Windows/数据库/云） | 社区维护，可免费使用 |
| **NIST 800-53** | 美国政府/关键基础设施 | 非常详细，覆盖全面 |
| **ISO 27001** | 国际通用信息安全管理体系 | 侧重流程与管理 |
| **等保2.0** | 中国境内重要信息系统 | 强制性合规要求 |

---

## 二、五大基线检查项详解

### 2.1 口令策略基线

**Windows 基线项**：

```powershell
# 查看当前密码策略
net accounts

# 检查项
├─ 密码最小长度（建议 ≥ 12）
├─ 密码最长使用期限（建议 90-180 天）
├─ 密码历史（建议 ≥ 5 个）
└─ 锁定阈值（建议 5 次失败后锁定）
```

**Linux 基线项**：

```bash
# 查看密码策略（PAM配置）
cat /etc/login.defs | grep -E "PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE"

# 检查项
├─ PASS_MAX_DAYS ≤ 90（密码过期时间）
├─ PASS_MIN_DAYS ≥ 1（防止频繁修改密码）
└─ PASS_WARN_AGE ≥ 7（提前7天提醒）
```

**风险评估**：

| 策略 | 不安全配置 | 风险 | 加固建议 |
|------|-----------|------|---------|
| 密码长度 | < 8 位 | 容易被暴力破解 | 最少12位+复杂性 |
| 密码过期 | 永不过期 | 泄露后长期有效 | 90-180天过期 |
| 锁定策略 | 无锁定 | 暴力破解无限制 | 5次失败锁定30分钟 |

---

### 2.2 补丁与更新基线

**Windows 补丁检查**：

```powershell
# 查看已安装的补丁
wmic qfe list brief

# 或使用 PowerShell 模块
Get-HotFix | Select-Object HotFixID, InstalledOn, Description | Sort-Object InstalledOn -Descending
```

**Linux 补丁检查**：

```bash
# Ubuntu/Debian
apt list --upgradable

# CentOS/RHEL
yum check-update
```

**风险评估**：

| 场景 | 风险 | 加固建议 |
|------|------|---------|
| 系统长期未更新 | 存在已知漏洞（如 Log4Shell） | 每月更新，重要漏洞立即补 |
| 关键服务版本过旧 | CVE 评分 ≥ 9.0 | 优先处理严重漏洞 |
| 内核版本过旧 | 权限提升漏洞 | 定期更新内核 |

---

### 2.3 暴露服务基线

**检查开放端口**：

```bash
# Linux
ss -tulnp
# 或
netstat -tulnp

# Windows
netstat -ano | findstr LISTENING
```

**高风险端口清单**：

| 端口 | 服务 | 风险 | 建议 |
|------|------|------|------|
| **21** | FTP | 明文传输 | 使用 SFTP/FTP over TLS |
| **23** | Telnet | 明文传输 | 使用 SSH |
| **139/445** | SMB | 历史漏洞多 | 禁用或限制访问源 |
| **3306** | MySQL | 默认账户风险 | 限制监听IP+强密码 |
| **3389** | RDP | 远程桌面漏洞 | 仅VPN访问+强密码 |
| **6379** | Redis | 无认证风险 | 配置认证+防火墙 |

**加固脚本示例**（Linux）：

```bash
#!/bin/bash
# 检查高风险端口
HIGH_RISK_PORTS=(21 23 3306 3389 6379)

for port in "${HIGH_RISK_PORTS[@]}"; do
    if ss -tulnp | grep -q ":$port "; then
        echo "[警告] 高风险端口 $port 已开放"
    fi
done
```

---

### 2.4 权限配置基线

**SUID/SGID 检查**（Linux）：

```bash
# 查找具有 SUID 位的文件
find / -perm -4000 -type f 2>/dev/null

# 查找具有 SGID 位的文件
find / -perm -2000 -type f 2>/dev/null
```

**常见 SUID 文件风险评估**：

| 文件 | 用途 | 风险 |
|------|------|------|
| `/usr/bin/passwd` | 修改密码 | 正常（需要root权限） |
| `/usr/bin/sudo` | 执行命令 | 正常 |
| `/usr/bin/vim` | 文本编辑 | ⚠️ 不应有SUID（可提权） |
| `/bin/bash` | Shell | ⚠️ 不应有SUID（可提权） |

**Windows 权限检查**：

```powershell
# 检查管理员组成员
Get-LocalGroupMember -Group "Administrators"

# 检查文件权限（如敏感目录）
Get-Acl "C:\inetpub\wwwroot" | Format-List
```

---

### 2.5 日志审计基线

**Linux 日志检查**：

```bash
# 检查日志目录权限（应仅 root 可写）
ls -ld /var/log

# 检查关键日志文件
├─ /var/log/auth.log（认证日志）
├─ /var/log/syslog（系统日志）
└─ /var/log/secure（安全日志）
```

**Windows 日志检查**：

```powershell
# 检查日志配置
wevtutil gl Security

# 检查关键事件ID
├─ 4624/4625（登录成功/失败）
├─ 4720/4726（创建/删除用户）
├─ 4688（进程创建）
└─ 4740（账户锁定）
```

**日志保留策略**：

| 日志类型 | 最短保留时间 | 用途 |
|---------|-------------|------|
| 安全日志 | 6个月 | 取证溯源 |
| 应用日志 | 3个月 | 故障排查 |
| 审计日志 | 1年 | 合规要求 |

---

## 三、实践任务

### 任务 1：Windows 本机基线检查脚本

**目标**：编写 PowerShell 脚本检查 5 大基线项，输出 CSV 报告。

```powershell
# Windows 基线检查脚本
# 保存为 check_windows_baseline.ps1

$report = @()

# 1. 密码策略检查
$passwordPolicy = net accounts
$report += [PSCustomObject]@{
    Item = "密码策略"
    Status = $passwordPolicy -join ";"
    Risk = if ($passwordPolicy -match "Minimum password length: [0-8]") { "高" } else { "低" }
    Recommendation = "密码长度建议 ≥ 12 位"
}

# 2. 补丁检查
$lastPatch = Get-HotFix | Sort-Object InstalledOn -Descending | Select-Object -First 1
$report += [PSCustomObject]@{
    Item = "最近补丁"
    Status = "$($lastPatch.HotFixID) - $($lastPatch.InstalledOn)"
    Risk = if ((Get-Date) - $lastPatch.InstalledOn -gt (New-TimeSpan -Days 90)) { "高" } else { "低" }
    Recommendation = "建议每月更新补丁"
}

# 3. 开放端口检查
$openPorts = netstat -ano | Select-String "LISTENING"
$highRiskPorts = @("3306", "3389", "6379")
$riskPorts = $openPorts | Where-Object {
    foreach ($port in $highRiskPorts) {
        if ($_ -match ":$port ") { return $true }
    }
}

$report += [PSCustomObject]@{
    Item = "开放端口"
    Status = "$($openPorts.Count) 个端口开放"
    Risk = if ($riskPorts) { "高" } else { "低" }
    Recommendation = if ($riskPorts) { "关闭不必要的高风险端口" } else { "符合要求" }
}

# 4. 管理员组成员检查
$admins = Get-LocalGroupMember -Group "Administrators"
$report += [PSCustomObject]@{
    Item = "管理员组成员"
    Status = "$($admins.Count) 个成员"
    Risk = if ($admins.Count -gt 3) { "中" } else { "低" }
    Recommendation = "审查管理员组成员，删除不必要账号"
}

# 5. 日志配置检查
$logConfig = wevtutil gl Security
$report += [PSCustomObject]@{
    Item = "安全日志"
    Status = ($logConfig | Select-String "enabled").ToString().Trim()
    Risk = "低"
    Recommendation = "确保日志保留 ≥ 180 天"
}

# 导出报告
$report | Export-Csv -Path ".\baseline_report_$(Get-Date -Format 'yyyyMMdd').csv" -NoTypeInformation
Write-Output "✅ 基线检查完成，报告已导出"
$report | Format-Table -AutoSize
```

**运行脚本**：

```powershell
# 允许脚本执行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 运行检查
.\check_windows_baseline.ps1
```

---

### 任务 2：Linux 靶机基线检查

**目标**：编写 Shell 脚本检查 Linux 基线项。

```bash
#!/bin/bash
# Linux 基线检查脚本
# 保存为 check_linux_baseline.sh

REPORT="baseline_report_$(date +%Y%m%d).txt"
echo "Linux 基线检查报告 - $(date)" > $REPORT
echo "================================" >> $REPORT

# 1. 密码策略检查
echo "" >> $REPORT
echo "【1】密码策略检查" >> $REPORT
cat /etc/login.defs | grep -E "PASS_MAX_DAYS|PASS_MIN_DAYS" >> $REPORT

# 2. 补丁检查
echo "" >> $REPORT
echo "【2】补丁检查（待更新包）" >> $REPORT
apt list --upgradable 2>/dev/null | wc -l >> $REPORT

# 3. 开放端口检查
echo "" >> $REPORT
echo "【3】开放端口" >> $REPORT
ss -tulnp >> $REPORT

# 4. SUID 文件检查
echo "" >> $REPORT
echo "【4】SUID 文件" >> $REPORT
find / -perm -4000 -type f 2>/dev/null >> $REPORT

# 5. 日志目录权限检查
echo "" >> $REPORT
echo "【5】日志目录权限" >> $REPORT
ls -ld /var/log >> $REPORT

echo "" >> $REPORT
echo "检查完成，报告已保存到: $REPORT" >> $REPORT

cat $REPORT
```

**运行脚本**：

```bash
chmod +x check_linux_baseline.sh
./check_linux_baseline.sh
```

---

### 任务 3：基线结果分析与加固

**目标**：根据基线检查结果，识别 Top 3 风险项并给出加固建议。

**示例报告**：

```
【基线检查结果分析】

高风险项：
1. [密码策略] 密码最小长度为 6 位
   建议：修改为 ≥ 12 位，增加复杂性要求

2. [开放端口] 3306 (MySQL) 对公网开放
   建议：修改 MySQL 配置，仅监听 127.0.0.1

3. [补丁管理] 超过 90 天未更新
   建议：检查重要补丁，优先修复 CVE ≥ 7.0

中风险项：
4. [管理员组] 发现 5 个成员
   建议：审查成员列表，删除临时账号

低风险项：
5. [日志配置] 日志已启用，保留策略合理
   建议：继续保持
```

---

## 四、巩固练习

### 练习 1：列举 5 条常见基线项

**参考答案**：

1. **密码策略**：最小长度、过期时间、历史记录、锁定阈值
2. **补丁管理**：系统更新频率、关键组件版本、已知漏洞修复
3. **服务暴露**：开放端口、监听地址、防火墙规则
4. **权限配置**：SUID/SGID 文件、文件权限、管理员组成员
5. **日志审计**：日志启用状态、保留时间、关键字段

---

### 练习 2：设计检查脚本的可扩展结构

**参考答案**：

```python
# 可扩展的基线检查框架

class BaselineCheck:
    def __init__(self, name):
        self.name = name
        self.items = []

    def add_check(self, item, status, risk, recommendation):
        self.items.append({
            'item': item,
            'status': status,
            'risk': risk,
            'recommendation': recommendation
        })

    def export_csv(self, filename):
        # 导出为 CSV
        pass

# 使用示例
baseline = BaselineCheck("Windows Server 2022")
baseline.add_check("密码策略", "最小长度: 6", "高", "建议 ≥ 12 位")
baseline.add_check("开放端口", "80, 443, 3389", "中", "3389 需限制访问源")
baseline.export_csv("baseline_report.csv")
```

---

### 练习 3：如何定期自动化基线检查？

**参考答案**：

**Windows（任务计划程序）**：

```powershell
# 创建任务计划程序任务
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-File C:\scripts\check_windows_baseline.ps1"
$trigger = New-ScheduledTaskTrigger -Daily -At "02:00AM"
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "每日基线检查" -Description "每日凌晨2点执行基线检查"
```

**Linux（Cron）**：

```bash
# 编辑 crontab
crontab -e

# 每天凌晨 2 点执行
0 2 * * * /home/scripts/check_linux_baseline.sh
```

---

## 五、评估标准

- ✅ 能说出什么是基线及其重要性
- ✅ 掌握 5 条以上常见基线项
- ✅ 能编写脚本检查本机/靶机的关键基线项
- ✅ 能识别风险并给出加固建议
- ✅ 输出结构化报告（CSV/JSON）

---

## 六、参考资料

- [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/)
- [NIST 800-53](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final)
- [Windows Security Baselines](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-security-baselines)

---

## 七、学习成果达成情况（由学习者填写）

### 截图与证据

- [ ] Windows 基线检查脚本运行截图
- [ ] Linux 基线检查脚本运行截图
- [ ] 生成的 CSV 报告文件

### 关键发现

**密码策略**：
- 当前配置：
- 风险等级：
- 改进建议：

**服务暴露**：
- 开放端口：
- 高风险端口：
- 改进建议：

### 结论与反思

**我今天搞清楚了**：
- 基线是系统安全的"最低标准"，必须定期检查
- 常见的 5 大基线项：口令策略、补丁管理、服务暴露、权限配置、日志审计
- 脚本化检查可以大大提高效率，输出结构化报告便于分析

**我差点搞混的是**：
- 最初以为基线只是"检查密码"，实际上包含多个维度
- 没意识到 SUID 文件可能带来的提权风险

**明天我要继续补的是**：
- Web 中间件基线检查（Day025）
- 自动化基线检查脚本优化（Day026）

**本次学习耗时**：约 2.5 小时

**掌握程度自评**：
- [ ] 😐 理解了基本概念，但实践不熟练
- [ ] 😃 完成了所有任务并理解原理
- [ ] 🤩 能独立设计基线检查脚本并优化

---

**恭喜！你已掌握系统基线与审计的核心技能。明天我们将学习 Web 中间件与常见暴露面，继续加固你的安全堡垒！** 🎉
