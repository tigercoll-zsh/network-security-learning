---
title: Day037ï¼šWeb å®‰å…¨ - èº«ä»½è®¤è¯ä¸ä¼šè¯å®‰å…¨ï¼ˆCSRFï¼‰
tags:
  - ç½‘ç»œ
  - å®‰å…¨
  - å­¦ä¹ è®¡åˆ’
categories:
  - ç½‘ç»œå®‰å…¨
abbrlink: 51b649c6
date: 2026-01-30 00:00:00
updated: 2026-01-30 00:00:00

---
# Day037ï¼šWeb å®‰å…¨ - èº«ä»½è®¤è¯ä¸ä¼šè¯å®‰å…¨ï¼ˆCSRFï¼‰

- æ—¥æœŸï¼š2026-01-30
- å‘¨æ¬¡ï¼šç¬¬6å‘¨

## å­¦ä¹ ç›®æ ‡
- ç†è§£è®¤è¯ä¸ä¼šè¯çš„å¸¸è§é£é™©
- è®¤è¯† CSRF åŸç†ä¸é˜²æŠ¤

<!--more-->

## å­¦ä¹ å†…å®¹

### 1ï¸âƒ£ èº«ä»½è®¤è¯åŸºç¡€

#### 1.1 è®¤è¯ vs æˆæƒ

| æ¦‚å¿µ | è¯´æ˜ | å…¸å‹é—®é¢˜ |
|------|------|---------|
| **Authenticationï¼ˆè®¤è¯ï¼‰** | éªŒè¯"ä½ æ˜¯è°" | ç”¨æˆ·å/å¯†ç ã€OTPã€ç”Ÿç‰©ç‰¹å¾ |
| **Authorizationï¼ˆæˆæƒï¼‰** | éªŒè¯"ä½ èƒ½åšä»€ä¹ˆ" | æƒé™æ£€æŸ¥ã€è§’è‰²è®¿é—®æ§åˆ¶ |

**å…³é”®åŒºåˆ«**ï¼š
- è®¤è¯ = èº«ä»½éªŒè¯ï¼ˆWho are you?ï¼‰
- æˆæƒ = æƒé™éªŒè¯ï¼ˆWhat can you do?ï¼‰

---

#### 1.2 å¸¸è§è®¤è¯æ–¹å¼

| è®¤è¯æ–¹å¼ | å®‰å…¨æ€§ | ç”¨æˆ·ä½“éªŒ | é€‚ç”¨åœºæ™¯ |
|---------|-------|---------|---------|
| **ç”¨æˆ·å+å¯†ç ** | ä½-ä¸­ | é€‚ä¸­ | åŸºç¡€åº”ç”¨ |
| **å¤šå› ç´ è®¤è¯ï¼ˆMFA/2FAï¼‰** | é«˜ | ç¨å·® | æ•æ„Ÿç³»ç»Ÿ/é‡‘èåº”ç”¨ |
| **JWTï¼ˆJSON Web Tokenï¼‰** | ä¸­-é«˜ | å¥½ | API/å•é¡µåº”ç”¨ |
| **OAuth 2.0** | ä¸­ | å¥½ | ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡/Googleï¼‰ |
| **SAML** | é«˜ | å¤æ‚ | ä¼ä¸šçº§ SSO |

---

#### 1.3 è®¤è¯æµç¨‹

**æ ‡å‡†è®¤è¯æµç¨‹**ï¼š

```
1. ç”¨æˆ·æäº¤å‡­è¯
   ç”¨æˆ· â†’ [POST /login] â†’ username + password

2. æœåŠ¡å™¨éªŒè¯å‡­è¯
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®ï¼ˆä½¿ç”¨ bcrypt/argon2ï¼‰
   - æ£€æŸ¥è´¦æˆ·çŠ¶æ€ï¼ˆé”å®š/ç¦ç”¨ï¼‰

3. ç”Ÿæˆä¼šè¯æ ‡è¯†
   - åˆ›å»º Session ID æˆ– JWT
   - å­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’Œæƒé™

4. è¿”å›è®¤è¯ç»“æœ
   - æˆåŠŸï¼šè¿”å› Session Cookie / JWT Token
   - å¤±è´¥ï¼šè¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯ï¼ˆé¿å…ç”¨æˆ·æšä¸¾ï¼‰

5. åç»­è¯·æ±‚æºå¸¦è®¤è¯ä¿¡æ¯
   - Session æ¨¡å¼ï¼šæµè§ˆå™¨è‡ªåŠ¨å‘é€ Cookie
   - JWT æ¨¡å¼ï¼šå®¢æˆ·ç«¯åœ¨ Header ä¸­å‘é€ Token
```

---

### 2ï¸âƒ£ ä¼šè¯ç®¡ç†

#### 2.1 ä¼šè¯æ ‡è¯†ï¼ˆSession IDï¼‰

**Session ID ç”Ÿæˆè¦æ±‚**ï¼š

| è¦æ±‚ | è¯´æ˜ | ä¸å®‰å…¨çš„ç¤ºä¾‹ |
|------|------|------------|
| **éšæœºæ€§** | è¶³å¤Ÿçš„ç†µå€¼ï¼Œä¸å¯é¢„æµ‹ | `session_id = 12345` |
| **å”¯ä¸€æ€§** | ç¡®ä¿ä¸ä¼šé‡å¤ | `session_id = timestamp` |
| **ä¸å¯çŒœæµ‹** | æ— æ³•ä»å·²çŸ¥ ID æ¨æµ‹å…¶ä»– ID | é¡ºåºé€’å¢çš„ ID |
| **é€‚å½“é•¿åº¦** | è‡³å°‘ 128 ä½ï¼ˆ16 å­—èŠ‚ï¼‰ | `session_id = "abc123"` |

**å®‰å…¨ç”Ÿæˆæ–¹å¼**ï¼š

```python
import secrets
import os

# æ¨èæ–¹å¼ï¼šä½¿ç”¨ secrets æ¨¡å—ï¼ˆPython 3.6+ï¼‰
session_id = secrets.token_hex(16)  # 32 å­—ç¬¦ï¼Œ256 ä½ç†µ

# ä¸æ¨èï¼šä½¿ç”¨ randomï¼ˆå¯é¢„æµ‹ï¼‰
import random
session_id = "".join([str(random.randint(0, 9)) for _ in range(10)])
```

---

#### 2.2 Cookie å®‰å…¨è®¾ç½®

**Cookie å±æ€§**ï¼š

| å±æ€§ | è¯´æ˜ | å®‰å…¨å»ºè®® |
|------|------|---------|
| `Secure` | åªé€šè¿‡ HTTPS ä¼ è¾“ | âœ… å§‹ç»ˆè®¾ç½® |
| `HttpOnly` | JavaScript æ— æ³•è®¿é—® | âœ… å§‹ç»ˆè®¾ç½®ï¼ˆé˜²æ­¢ XSS çªƒå–ï¼‰ |
| `SameSite` | æ§åˆ¶è·¨ç«™è¯·æ±‚è¡Œä¸º | âœ… è®¾ç½®ä¸º `Strict` æˆ– `Lax` |
| `Path` | é™åˆ¶ Cookie è·¯å¾„èŒƒå›´ | æŒ‰éœ€è®¾ç½® |
| `Domain` | é™åˆ¶ Cookie åŸŸåèŒƒå›´ | æŒ‰éœ€è®¾ç½®ï¼Œé¿å…è¿‡äºå®½æ³› |
| `Expires` / `Max-Age` | è®¾ç½®è¿‡æœŸæ—¶é—´ | âœ… å§‹ç»ˆè®¾ç½® |

**å®‰å…¨ Cookie ç¤ºä¾‹**ï¼š

```http
Set-Cookie: session_id=abc123def456; 
           Secure; 
           HttpOnly; 
           SameSite=Strict; 
           Path=/; 
           Max-Age=3600
```

---

#### 2.3 SameSite å±æ€§è¯¦è§£

| å€¼ | è¡Œä¸º | ä½¿ç”¨åœºæ™¯ |
|----|------|---------|
| **Strict** | ç¦æ­¢æ‰€æœ‰è·¨ç«™ Cookie å‘é€ | é‡‘èç³»ç»Ÿ/æ•æ„Ÿæ“ä½œ |
| **Lax** | å…è®¸å®‰å…¨çš„è·¨ç«™è¯·æ±‚ï¼ˆå¯¼èˆªï¼‰ | ä¸€èˆ¬ Web åº”ç”¨ |
| **None** | å…è®¸æ‰€æœ‰è·¨ç«™ Cookie å‘é€ï¼ˆéœ€ Secureï¼‰ | éœ€è¦è·¨ç«™çš„ç‰¹æ®Šåœºæ™¯ |

**å¯¹æ¯”ç¤ºä¾‹**ï¼š

```
åœºæ™¯ï¼šç”¨æˆ·åœ¨ site-a.com ç™»å½•ï¼Œç„¶åç‚¹å‡» site-b.com ä¸­çš„é“¾æ¥è·³è½¬åˆ° site-a.com

SameSite=Strictï¼š
  - ä¸å‘é€ Cookie â†’ éœ€è¦é‡æ–°ç™»å½•

SameSite=Laxï¼š
  - å‘é€ Cookie â†’ ä¿æŒç™»å½•çŠ¶æ€

SameSite=Noneï¼š
  - å‘é€ Cookie â†’ ä¿æŒç™»å½•çŠ¶æ€ï¼ˆéœ€ HTTPSï¼‰
```

---

### 3ï¸âƒ£ CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰

#### 3.1 CSRF åŸç†

**CSRFï¼ˆCross-Site Request Forgeryï¼‰**ï¼šæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·åœ¨å·²ç™»å½•çš„çŠ¶æ€ä¸‹ï¼Œå‘ç›®æ ‡ç«™ç‚¹å‘é€éé¢„æœŸçš„è¯·æ±‚ã€‚

**æ”»å‡»æµç¨‹**ï¼š

```
1. ç”¨æˆ·ç™»å½• bank.comï¼ˆæµè§ˆå™¨ä¿å­˜äº† Session Cookieï¼‰

2. ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™ evil.comï¼ˆæ­¤æ—¶ä»ä¿æŒç™»å½•çŠ¶æ€ï¼‰

3. evil.com ä¸­éšè—ä¸€ä¸ªè‡ªåŠ¨æäº¤çš„è¡¨å•ï¼š
   <form action="https://bank.com/transfer" method="POST">
     <input type="hidden" name="to" value="attacker">
     <input type="hidden" name="amount" value="10000">
   </form>
   <script>document.forms[0].submit();</script>

4. æµè§ˆå™¨è‡ªåŠ¨å‘é€ bank.com çš„ Cookie
   â†’ æ”»å‡»æˆåŠŸï¼šè½¬è´¦åˆ°æ”»å‡»è€…è´¦æˆ·
```

**å…³é”®ç‚¹**ï¼š
- æ”»å‡»è€…ä¸éœ€è¦çŸ¥é“ Cookie å†…å®¹
- æµè§ˆå™¨è‡ªåŠ¨å‘é€ Cookieï¼ˆé™¤é SameSite=Strictï¼‰
- ç”¨æˆ·ä¸çŸ¥æƒ…åœ°æ‰§è¡Œäº†æ“ä½œ

---

#### 3.2 CSRF é˜²æŠ¤ç­–ç•¥

| é˜²æŠ¤æªæ–½ | è¯´æ˜ | å®æ–½ä¼˜å…ˆçº§ |
|---------|------|-----------|
| **CSRF Token** | åœ¨è¯·æ±‚ä¸­æ·»åŠ ä¸å¯é¢„æµ‹çš„ Token | P0 |
| **SameSite Cookie** | é™åˆ¶è·¨ç«™ Cookie å‘é€ | P0 |
| **æ£€æŸ¥ Origin/Referer** | éªŒè¯è¯·æ±‚æ¥æº | P1 |
| **åŒé‡æäº¤ Cookie** | åŒæ—¶åœ¨ Cookie å’Œå‚æ•°ä¸­éªŒè¯ | P1 |
| **è‡ªå®šä¹‰ Header** | ä½¿ç”¨ X-Requested-With æˆ–è‡ªå®šä¹‰å¤´ | P1 |

---

#### 3.3 CSRF Token å®ç°

**ç”Ÿæˆ Token**ï¼š

```python
import secrets
import hashlib
import hmac

# ç”Ÿæˆ CSRF Tokenï¼ˆåŸºäº Session ID + å¯†é’¥ï¼‰
session_id = "abc123def456"
secret_key = "csrf_secret_key_123"

csrf_token = hmac.new(
    secret_key.encode(),
    session_id.encode(),
    hashlib.sha256
).hexdigest()

# éªŒè¯ Token
def verify_csrf_token(token, session_id, secret_key):
    expected = hmac.new(
        secret_key.encode(),
        session_id.encode(),
        hashlib.sha256
    ).hexdigest()
    return secrets.compare_digest(expected, token)
```

**å‰ç«¯ä½¿ç”¨**ï¼š

```html
<form action="/transfer" method="POST">
    <input type="text" name="to" placeholder="æ”¶æ¬¾äºº">
    <input type="number" name="amount" placeholder="é‡‘é¢">
    <!-- CSRF Token -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <button type="submit">è½¬è´¦</button>
</form>
```

**åç«¯éªŒè¯**ï¼š

```python
from flask import Flask, request, session, abort

app = Flask(__name__)
app.secret_key = "app_secret_key"

@app.route("/transfer", methods=["POST"])
def transfer():
    # éªŒè¯ CSRF Token
    session_csrf_token = session.get("csrf_token")
    request_csrf_token = request.form.get("csrf_token")
    
    if not verify_csrf_token(request_csrf_token, session["id"], SECRET_KEY):
        abort(403, "Invalid CSRF Token")
    
    # å¤„ç†è½¬è´¦é€»è¾‘
    to = request.form["to"]
    amount = request.form["amount"]
    # ...
```

---

### 4ï¸âƒ£ ä¼šè¯å›ºå®šæ”»å‡»

#### 4.1 åŸç†

**ä¼šè¯å›ºå®šï¼ˆSession Fixationï¼‰**ï¼šæ”»å‡»è€…å¼ºåˆ¶ç”¨æˆ·ä½¿ç”¨æ”»å‡»è€…é¢„è®¾çš„ Session IDï¼Œä»è€ŒåŠ«æŒç”¨æˆ·ä¼šè¯ã€‚

**æ”»å‡»æµç¨‹**ï¼š

```
1. æ”»å‡»è€…è®¿é—®ç›®æ ‡ç½‘ç«™ï¼Œè·å– Session IDï¼š
   Session ID: abc123

2. æ”»å‡»è€…è¯±å¯¼ç”¨æˆ·ä½¿ç”¨è¿™ä¸ª Session ID ç™»å½•ï¼š
   <a href="https://target.com/login?session_id=abc123">ç‚¹å‡»é¢†å–çº¢åŒ…</a>

3. ç”¨æˆ·ç‚¹å‡»é“¾æ¥ï¼Œä½¿ç”¨ abc123 ä½œä¸º Session ID ç™»å½•

4. æ”»å‡»è€…ä½¿ç”¨ abc123 è®¿é—®ç›®æ ‡ç½‘ç«™
   â†’ æ”»å‡»è€…è·å¾—ç”¨æˆ·æƒé™ï¼ˆåŠ«æŒä¼šè¯ï¼‰
```

---

#### 4.2 é˜²æŠ¤ç­–ç•¥

| é˜²æŠ¤æªæ–½ | è¯´æ˜ | å®æ–½å»ºè®® |
|---------|------|---------|
| **ç™»å½•åé‡æ–°ç”Ÿæˆ Session** | ç™»å½•æˆåŠŸåç”Ÿæˆæ–°çš„ Session ID | âœ… å¿…é¡»å®æ–½ |
| **æ£€æŸ¥ Session æ¥æº** | æ‹’ç»å¤–éƒ¨æä¾›çš„ Session ID | âœ… å¿…é¡»å®æ–½ |
| **è®¾ç½® Session è¿‡æœŸæ—¶é—´** | å®šæœŸè¿‡æœŸæ—§ Session | âœ… å»ºè®®å®æ–½ |
| **ç»‘å®šç”¨æˆ·ä¿¡æ¯** | Session ä¸­ç»‘å®š IP/UA ç­‰ä¿¡æ¯ | å¯é€‰ï¼ˆå½±å“å¯ç”¨æ€§ï¼‰ |

**å®‰å…¨ç™»å½•æµç¨‹**ï¼š

```python
@app.route("/login", methods=["POST"])
def login():
    username = request.form["username"]
    password = request.form["password"]
    
    # éªŒè¯å‡­è¯
    if not verify_credentials(username, password):
        return "ç™»å½•å¤±è´¥", 401
    
    # ç™»å½•åé‡æ–°ç”Ÿæˆ Session ID
    session.regenerate()
    
    # å­˜å‚¨ Session ä¿¡æ¯
    session["user_id"] = user.id
    session["username"] = username
    session["login_time"] = datetime.now()
    
    return "ç™»å½•æˆåŠŸ"
```

---

### 5ï¸âƒ£ CORSï¼ˆè·¨æºèµ„æºå…±äº«ï¼‰

#### 5.1 åŒæºç­–ç•¥

**åŒæºï¼ˆSame Originï¼‰**ï¼šåè®®ã€åŸŸåã€ç«¯å£å®Œå…¨ç›¸åŒã€‚

| URL A | URL B | æ˜¯å¦åŒæºï¼Ÿ |
|-------|-------|-----------|
| `https://example.com/page1` | `https://example.com/page2` | âœ… æ˜¯ |
| `https://example.com/page1` | `https://api.example.com/page2` | âŒ å¦ï¼ˆå­åŸŸåä¸åŒï¼‰ |
| `https://example.com/page1` | `http://example.com/page2` | âŒ å¦ï¼ˆåè®®ä¸åŒï¼‰ |
| `https://example.com:8080/page1` | `https://example.com/page2` | âŒ å¦ï¼ˆç«¯å£ä¸åŒï¼‰ |

---

#### 5.2 CORS é…ç½®

**å…è®¸è·¨æºè®¿é—®çš„å“åº”å¤´**ï¼š

```http
Access-Control-Allow-Origin: https://trusted-site.com
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 3600
```

**å“åº”å¤´è¯´æ˜**ï¼š

| å“åº”å¤´ | è¯´æ˜ | å®‰å…¨å»ºè®® |
|--------|------|---------|
| `Access-Control-Allow-Origin` | å…è®¸çš„æº | âœ… ä½¿ç”¨å…·ä½“åŸŸåï¼Œé¿å… `*` |
| `Access-Control-Allow-Methods` | å…è®¸çš„ HTTP æ–¹æ³• | âœ… ä»…é™éœ€è¦çš„ |
| `Access-Control-Allow-Headers` | å…è®¸çš„è¯·æ±‚å¤´ | âœ… ä»…é™éœ€è¦çš„ |
| `Access-Control-Allow-Credentials` | æ˜¯å¦å…è®¸æºå¸¦ Cookie | âš ï¸ é…åˆå…·ä½“ Origin ä½¿ç”¨ |
| `Access-Control-Max-Age` | é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ | æŒ‰éœ€è®¾ç½® |

---

#### 5.3 CORS å®‰å…¨é…ç½®ç¤ºä¾‹

```python
from flask import Flask, jsonify

app = Flask(__name__)

@app.after_request
def add_cors_headers(response):
    # å…è®¸çš„æºï¼ˆé¿å…ä½¿ç”¨ *ï¼‰
    allowed_origins = ["https://trusted-site.com", "https://api-trusted.com"]
    origin = request.headers.get("Origin")
    
    if origin in allowed_origins:
        response.headers["Access-Control-Allow-Origin"] = origin
        response.headers["Access-Control-Allow-Credentials"] = "true"
    
    # å…è®¸çš„æ–¹æ³•
    response.headers["Access-Control-Allow-Methods"] = "GET, POST, OPTIONS"
    
    # å…è®¸çš„è¯·æ±‚å¤´
    response.headers["Access-Control-Allow-Headers"] = "Content-Type, Authorization"
    
    return response

@app.route("/api/data", methods=["GET", "POST"])
def api_data():
    return jsonify({"data": "sensitive information"})
```

## å®è·µä»»åŠ¡ï¼ˆåˆæ³•æˆæƒèŒƒå›´å†…ï¼‰

> **é‡è¦æé†’**ï¼šä»¥ä¸‹å®è·µä»…åœ¨æœ¬åœ°è‡ªå»ºé¶åœºï¼ˆå¦‚ DVWA/Pikachuï¼‰æˆ–æˆæƒæµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œã€‚

---

### ä»»åŠ¡ 1ï¼ˆå¿…åšï¼‰ï¼šåˆ†æé¶åœºçš„ä¸å®‰å…¨ä¼šè¯ç®¡ç†

**ç›®æ ‡**ï¼šåœ¨ DVWA/Pikachu ä¸­æ¼”ç¤ºä¼šè¯å›ºå®šæ”»å‡»ã€‚

**æ­¥éª¤**ï¼š

**1. å¯åŠ¨é¶åœº**

```bash
# ä½¿ç”¨ Docker å¯åŠ¨ DVWA
docker run -d -p 8080:80 vulnerables/web-dvwa

# æˆ–å¯åŠ¨ Pikachu
docker run -d -p 8080:80 webwolf/pikachu
```

**2. è·å–åˆå§‹ Session ID**

```bash
# ä½¿ç”¨ curl è·å–ç™»å½•é¡µé¢
curl -c cookies.txt -v http://localhost:8080/login

# æŸ¥çœ‹ Cookie ä¸­çš„ PHPSESSID/DVWA_SESSION
cat cookies.txt
```

**3. æ¼”ç¤ºä¼šè¯å›ºå®šæ”»å‡»**

```bash
# æ­¥éª¤ 1ï¼šå—å®³è€…ï¼ˆç”¨æˆ·ï¼‰ä½¿ç”¨æ”»å‡»è€…æä¾›çš„ Session ID ç™»å½•
curl -b "PHPSESSID=attacker123" -d "username=admin&password=password" \
     http://localhost:8080/login

# æ­¥éª¤ 2ï¼šæ”»å‡»è€…ä½¿ç”¨åŒä¸€ä¸ª Session ID è®¿é—®å—å®³è€…çš„ä¼šè¯
curl -b "PHPSESSID=attacker123" http://localhost:8080/profile

# é¢„æœŸç»“æœï¼šæ”»å‡»è€…è·å¾—ç®¡ç†å‘˜æƒé™ï¼ˆåŠ«æŒä¼šè¯ï¼‰
```

**4. åˆ†ææ¼æ´åŸå› **

| æ£€æŸ¥é¡¹ | ç»“æœ | é£é™©ç­‰çº§ |
|--------|------|---------|
| ç™»å½•åæ˜¯å¦é‡æ–°ç”Ÿæˆ Session ID | âŒ å¦ | ğŸ”´ é«˜ |
| Session ID æ˜¯å¦å¯é¢„æµ‹ | âš ï¸ éƒ¨åˆ†å¯é¢„æµ‹ | ğŸŸ¡ ä¸­ |
| æ˜¯å¦ç»‘å®š Session åˆ°ç”¨æˆ·ä¿¡æ¯ | âŒ å¦ | ğŸ”´ é«˜ |
| Cookie æ˜¯å¦è®¾ç½® HttpOnly | âš ï¸ éƒ¨åˆ†è®¾ç½® | ğŸŸ¡ ä¸­ |

---

### ä»»åŠ¡ 2ï¼ˆå¿…åšï¼‰ï¼šé…ç½® CSRF é˜²æŠ¤

**ç›®æ ‡**ï¼šåœ¨ Demo åº”ç”¨ä¸­å®ç° CSRF Token é˜²æŠ¤ã€‚

**æ­¥éª¤**ï¼š

**1. åˆ›å»º Demo åº”ç”¨ï¼ˆPython Flaskï¼‰**

```python
# demo_app.py
from flask import Flask, request, render_template_string, session, redirect, url_for
import secrets
import hmac
import hashlib

app = Flask(__name__)
app.secret_key = "demo_secret_key_change_in_production"

# CSRF å¯†é’¥
CSRF_SECRET = "csrf_secret_key_change_in_production"

def generate_csrf_token(session_id):
    """ç”Ÿæˆ CSRF Token"""
    return hmac.new(
        CSRF_SECRET.encode(),
        session_id.encode(),
        hashlib.sha256
    ).hexdigest()

def verify_csrf_token(token, session_id):
    """éªŒè¯ CSRF Token"""
    expected = hmac.new(
        CSRF_SECRET.encode(),
        session_id.encode(),
        hashlib.sha256
    ).hexdigest()
    return secrets.compare_digest(expected, token)

@app.route("/")
def index():
    session_id = session.get("id", secrets.token_hex(16))
    csrf_token = generate_csrf_token(session_id)
    session["csrf_token"] = csrf_token
    return render_template_string("""
        <h1>CSRF Demo</h1>
        <form action="/transfer" method="POST">
            <label>æ”¶æ¬¾äºº:</label>
            <input type="text" name="to" value="attacker">
            <br>
            <label>é‡‘é¢:</label>
            <input type="number" name="amount" value="10000">
            <br>
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit">è½¬è´¦</button>
        </form>
    """, csrf_token=csrf_token)

@app.route("/transfer", methods=["POST"])
def transfer():
    # éªŒè¯ CSRF Token
    session_csrf_token = session.get("csrf_token")
    request_csrf_token = request.form.get("csrf_token")
    
    if not verify_csrf_token(request_csrf_token, session.get("id")):
        return "<h1>âŒ CSRF éªŒè¯å¤±è´¥ï¼</h1>", 403
    
    # å¤„ç†è½¬è´¦é€»è¾‘ï¼ˆä»…æ¼”ç¤ºï¼‰
    to = request.form.get("to")
    amount = request.form.get("amount")
    return f"<h1>è½¬è´¦æˆåŠŸï¼š{amount} å…ƒ â†’ {to}</h1>"

if __name__ == "__main__":
    app.run(debug=False, port=5000)
```

**2. å¯åŠ¨ Demo åº”ç”¨**

```bash
# å®‰è£… Flask
pip install flask

# å¯åŠ¨åº”ç”¨
python demo_app.py
```

**3. æµ‹è¯• CSRF æ”»å‡»ï¼ˆæ— é˜²æŠ¤ï¼‰**

```bash
# åˆ›å»ºæ¶æ„ç½‘ç«™ evil.html
cat > evil.html << 'EOF'
<!DOCTYPE html>
<html>
<head><title>æ¶æ„ç½‘ç«™</title></head>
<body>
    <h1>æ­å–œä¸­å¥–ï¼</h1>
    <form action="http://localhost:5000/transfer" method="POST" id="csrf-form">
        <input type="hidden" name="to" value="attacker">
        <input type="hidden" name="amount" value="10000">
    </form>
    <script>
        document.getElementById("csrf-form").submit();
    </script>
</body>
</html>
EOF

# åœ¨æµè§ˆå™¨æ‰“å¼€ evil.html
# é¢„æœŸç»“æœï¼šå¦‚æœå…ˆç™»å½•äº† localhost:5000ï¼Œä¼šè§¦å‘è½¬è´¦
```

**4. æµ‹è¯• CSRF æ”»å‡»ï¼ˆæœ‰é˜²æŠ¤ï¼‰**

```bash
# ä¿®æ”¹ evil.htmlï¼Œæ·»åŠ  CSRF Token
# ä½†æ”»å‡»è€…æ— æ³•è·å– Tokenï¼ˆå› ä¸º SameSite/HttpOnly Cookieï¼‰
# é¢„æœŸç»“æœï¼šè¯·æ±‚è¢« 403 æ‹’ç»ï¼ˆCSRF éªŒè¯å¤±è´¥ï¼‰
```

---

### ä»»åŠ¡ 3ï¼ˆå¿…åšï¼‰ï¼šé…ç½® SameSite Cookie

**ç›®æ ‡**ï¼šè®¾ç½® SameSite å±æ€§å¹¶éªŒè¯æ•ˆæœã€‚

**æ­¥éª¤**ï¼š

**1. ä¿®æ”¹ Demo åº”ç”¨ï¼ˆæ·»åŠ  SameSiteï¼‰**

```python
# demo_app.pyï¼ˆä¿®æ”¹éƒ¨åˆ†ï¼‰
@app.route("/login", methods=["POST"])
def login():
    username = request.form.get("username")
    password = request.form.get("password")
    
    # éªŒè¯å‡­è¯ï¼ˆç®€åŒ–ï¼‰
    if username == "admin" and password == "password":
        session["username"] = username
        session["id"] = secrets.token_hex(16)
        
        # è®¾ç½® SameSite Cookie
        response = redirect(url_for("index"))
        response.set_cookie(
            "session_id",
            value=session["id"],
            httponly=True,
            secure=True,
            samesite="Strict"  # å…³é”®è®¾ç½®
        )
        return response
    
    return "ç™»å½•å¤±è´¥", 401
```

**2. æµ‹è¯• SameSite æ•ˆæœ**

| åœºæ™¯ | SameSite=Lax | SameSite=Strict |
|------|-------------|----------------|
| ç”¨æˆ·ç›´æ¥è®¿é—® | âœ… å‘é€ Cookie | âœ… å‘é€ Cookie |
| ç”¨æˆ·ç‚¹å‡»é“¾æ¥è·³è½¬ | âœ… å‘é€ Cookie | âŒ ä¸å‘é€ Cookie |
| è·¨ç«™ POST | âŒ ä¸å‘é€ Cookie | âŒ ä¸å‘é€ Cookie |

**3. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·éªŒè¯**

```bash
# 1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
# 2. è¿›å…¥ Network æ ‡ç­¾
# 3. è®¿é—®åº”ç”¨å¹¶æŸ¥çœ‹ Cookie

# Cookie å±æ€§æ£€æŸ¥ï¼š
# âœ… Secure: æ˜¯ï¼ˆä»… HTTPS ä¼ è¾“ï¼‰
# âœ… HttpOnly: æ˜¯ï¼ˆJS æ— æ³•è®¿é—®ï¼‰
# âœ… SameSite: Strict/Lax
# âœ… Expires/Max-Age: æœ‰ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
```

---

### ä»»åŠ¡ 4ï¼ˆè¿›é˜¶ï¼‰ï¼šå®ç°åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰

**ç›®æ ‡**ï¼šæ·»åŠ åŸºäº OTP çš„åŒå› ç´ è®¤è¯ã€‚

**æ­¥éª¤**ï¼š

**1. å®‰è£…ä¾èµ–**

```bash
pip install pyotp qrcode
```

**2. å®ç° 2FA åº”ç”¨**

```python
# demo_2fa.py
from flask import Flask, request, session, redirect, url_for, render_template_string
import pyotp
import qrcode
import io
import base64

app = Flask(__name__)
app.secret_key = "demo_secret_key"

# å­˜å‚¨ TOTP å¯†é’¥ï¼ˆå®é™…åº”å­˜å‚¨åœ¨æ•°æ®åº“ï¼‰
user_totp_secrets = {
    "admin": pyotp.random_base32()  # ç”Ÿæˆéšæœºå¯†é’¥
}

def generate_qr_code(username):
    """ç”ŸæˆäºŒç»´ç ç”¨äºç»‘å®š TOTP åº”ç”¨"""
    totp = pyotp.TOTP(user_totp_secrets[username])
    uri = totp.provisioning_uri(username, issuer_name="Demo App")
    
    # ç”ŸæˆäºŒç»´ç 
    qr = qrcode.QRCode(version=1, box_size=10, border=5)
    qr.add_data(uri)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    
    # è½¬æ¢ä¸º base64
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    img_str = base64.b64encode(buffer.getvalue()).decode()
    return f"data:image/png;base64,{img_str}"

@app.route("/")
def index():
    if "username" not in session:
        return redirect(url_for("login"))
    return f"<h1>æ¬¢è¿, {session['username']}!</h1>"

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "GET":
        return render_template_string("""
            <h1>ç™»å½•</h1>
            <form method="POST">
                <label>ç”¨æˆ·å:</label>
                <input type="text" name="username" required>
                <br>
                <label>å¯†ç :</label>
                <input type="password" name="password" required>
                <br>
                <button type="submit">ä¸‹ä¸€æ­¥</button>
            </form>
        """)
    
    username = request.form.get("username")
    password = request.form.get("password")
    
    # ç¬¬ä¸€æ­¥ï¼šéªŒè¯ç”¨æˆ·åå¯†ç 
    if username == "admin" and password == "password":
        session["username"] = username
        session["2fa_required"] = True
        return redirect(url_for("2fa_verify"))
    
    return "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯", 401

@app.route("/2fa", methods=["GET", "POST"])
def verify_2fa():
    if "username" not in session or not session.get("2fa_required"):
        return redirect(url_for("login"))
    
    if request.method == "GET":
        # ç”ŸæˆäºŒç»´ç 
        qr_code = generate_qr_code(session["username"])
        return render_template_string("""
            <h1>åŒå› ç´ è®¤è¯</h1>
            <p>è¯·ä½¿ç”¨ Google Authenticator/Authy æ‰«æäºŒç»´ç </p>
            <img src="{{ qr_code }}" alt="QR Code">
            <form method="POST">
                <label>OTP ç :</label>
                <input type="text" name="otp" required>
                <br>
                <button type="submit">éªŒè¯</button>
            </form>
        """, qr_code=qr_code)
    
    otp = request.form.get("otp")
    totp = pyotp.TOTP(user_totp_secrets[session["username"]])
    
    # ç¬¬äºŒæ­¥ï¼šéªŒè¯ OTP
    if totp.verify(otp):
        session["2fa_verified"] = True
        session.pop("2fa_required", None)
        return redirect(url_for("index"))
    
    return "OTP éªŒè¯å¤±è´¥", 401

if __name__ == "__main__":
    app.run(debug=False, port=5000)
```

**3. æµ‹è¯• 2FA æµç¨‹**

```bash
# 1. å¯åŠ¨åº”ç”¨
python demo_2fa.py

# 2. æµ‹è¯•æµç¨‹ï¼š
#    a. è®¿é—® http://localhost:5000/login
#    b. è¾“å…¥ç”¨æˆ·å admin / å¯†ç  password
#    c. æ‰«æäºŒç»´ç å¹¶ç»‘å®šåˆ° Google Authenticator
#    d. è¾“å…¥ Google Authenticator æ˜¾ç¤ºçš„ 6 ä½ç 
#    e. éªŒè¯æˆåŠŸåè¿›å…¥é¦–é¡µ
```

---

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰

---

### ç»ƒä¹  1ï¼šä¸ºä»€ä¹ˆä¼šè¯å›ºå®šæ˜¯é£é™©ï¼Ÿ

**æ€è·¯æç¤º**ï¼š

- Session ID ä½•æ—¶ç”Ÿæˆ
- ç™»å½•åæ˜¯å¦é‡æ–°ç”Ÿæˆ Session
- æ”»å‡»è€…å¦‚ä½•åŠ«æŒä¼šè¯
- é˜²æŠ¤æªæ–½æœ‰å“ªäº›

**å‚è€ƒç­”æ¡ˆ**ï¼š

**ä¼šè¯å›ºå®šæ”»å‡»é£é™©**ï¼š

1. **æ”»å‡»æµç¨‹**ï¼š
   ```
   æ”»å‡»è€… â†’ è·å–åˆå§‹ Session ID â†’ è¯±å¯¼ç”¨æˆ·ä½¿ç”¨æ­¤ ID ç™»å½• â†’ æ”»å‡»è€…ä½¿ç”¨ç›¸åŒ ID åŠ«æŒä¼šè¯
   ```

2. **é£é™©**ï¼š
   - æ”»å‡»è€…æ— éœ€çŸ¥é“ç”¨æˆ·å¯†ç 
   - å¯è·å¾—ç”¨æˆ·çš„æ‰€æœ‰æƒé™
   - éš¾ä»¥æ£€æµ‹ï¼ˆæ­£å¸¸æµé‡ï¼‰

3. **é˜²æŠ¤æªæ–½**ï¼š
   | æªæ–½ | è¯´æ˜ | ä¼˜å…ˆçº§ |
   |------|------|--------|
   | ç™»å½•åé‡æ–°ç”Ÿæˆ Session | é”€æ¯æ—§ Sessionï¼Œç”Ÿæˆæ–°çš„ | P0 |
   | æ‹’ç»å¤–éƒ¨ Session ID | ä¸æ¥å— URL/å‚æ•°ä¸­çš„ Session ID | P0 |
   | è®¾ç½® Session è¿‡æœŸ | å®šæœŸè¿‡æœŸæ—§ Session | P1 |
   | ç»‘å®šç”¨æˆ·ä¿¡æ¯ | Session ç»‘å®š IP/UA ç­‰ä¿¡æ¯ | P2 |

---

### ç»ƒä¹  2ï¼šè®¾è®¡åˆç†çš„ä¼šè¯è¿‡æœŸä¸å†è®¤è¯

**ä»»åŠ¡**ï¼šä¸ºæ•æ„Ÿæ“ä½œè®¾è®¡ä¼šè¯è¿‡æœŸç­–ç•¥ã€‚

**è¦æ±‚**ï¼š

1. æ™®é€šä¼šè¯ï¼š30 åˆ†é’Ÿè¿‡æœŸ
2. æ•æ„Ÿæ“ä½œï¼ˆå¦‚ä¿®æ”¹å¯†ç /è½¬è´¦ï¼‰ï¼šæ¯æ¬¡éƒ½éœ€è¦é‡æ–°è®¤è¯
3. å¼‚å¸¸ç™»å½•ï¼ˆIP å˜åŒ–/æ–°è®¾å¤‡ï¼‰ï¼šå¼ºåˆ¶é‡æ–°è®¤è¯
4. è®°å½•ä¼šè¯æ´»åŠ¨æ—¥å¿—

**å‚è€ƒè®¾è®¡**ï¼š

```python
from datetime import datetime, timedelta
from flask import session, request

# ä¼šè¯é…ç½®
SESSION_CONFIG = {
    "normal_timeout": 30,  # æ™®é€šä¼šè¯ 30 åˆ†é’Ÿ
    "sensitive_timeout": 5,  # æ•æ„Ÿæ“ä½œ 5 åˆ†é’Ÿ
    "max_inactive": 15,  # æœ€å¤§ä¸æ´»è·ƒæ—¶é—´ 15 åˆ†é’Ÿ
}

def check_session_timeout():
    """æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ"""
    if "login_time" not in session:
        return False
    
    login_time = session["login_time"]
    now = datetime.now()
    
    # æ£€æŸ¥ç»å¯¹è¿‡æœŸæ—¶é—´
    if (now - login_time) > timedelta(minutes=SESSION_CONFIG["normal_timeout"]):
        return False
    
    # æ£€æŸ¥ä¸æ´»è·ƒæ—¶é—´
    if "last_activity" in session:
        last_activity = session["last_activity"]
        if (now - last_activity) > timedelta(minutes=SESSION_CONFIG["max_inactive"]):
            return False
    
    # æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
    session["last_activity"] = now
    return True

def check_sensitive_operation():
    """æ£€æŸ¥æ•æ„Ÿæ“ä½œæ˜¯å¦éœ€è¦é‡æ–°è®¤è¯"""
    if session.get("sensitive_auth_time"):
        auth_time = session["sensitive_auth_time"]
        if (datetime.now() - auth_time) > timedelta(minutes=SESSION_CONFIG["sensitive_timeout"]):
            return False
    return True

def require_sensitive_auth():
    """è¦æ±‚æ•æ„Ÿæ“ä½œé‡æ–°è®¤è¯"""
    session["sensitive_auth_required"] = True

@app.route("/sensitive-operation")
def sensitive_operation():
    if not check_session_timeout():
        return "ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•", 401
    
    if not check_sensitive_operation() or session.get("sensitive_auth_required"):
        return "æ­¤æ“ä½œéœ€è¦é‡æ–°è®¤è¯å¯†ç ", 302
    
    # æ¸…é™¤æ•æ„Ÿè®¤è¯æ ‡è®°
    session.pop("sensitive_auth_required", None)
    session["sensitive_auth_time"] = datetime.now()
    
    # æ‰§è¡Œæ•æ„Ÿæ“ä½œ
    return "æ•æ„Ÿæ“ä½œæ‰§è¡ŒæˆåŠŸ"
```

---

### ç»ƒä¹  3ï¼šCSRF Token vs SameSite Cookie

**ä»»åŠ¡**ï¼šå¯¹æ¯”ä¸¤ç§ CSRF é˜²æŠ¤æ–¹å¼çš„ä¼˜ç¼ºç‚¹ã€‚

**å¯¹æ¯”åˆ†æ**ï¼š

| é˜²æŠ¤æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **CSRF Token** | å¼ºåˆ¶éªŒè¯è¯·æ±‚æ¥æº<br>å¯ç²¾ç¡®å®šä½å…·ä½“æ“ä½œ | éœ€è¦åç«¯ç”Ÿæˆå’ŒéªŒè¯<br>éœ€è¦å‰ç«¯ä¼ é€’ | éœ€è¦è·¨ç«™æ“ä½œçš„åœºæ™¯ |
| **SameSite Cookie** | é…ç½®ç®€å•<br>æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç  | å¯å½±å“æ­£å¸¸è·¨ç«™åŠŸèƒ½<br>æ—§æµè§ˆå™¨ä¸æ”¯æŒ | ä¸€èˆ¬ Web åº”ç”¨ |

**ç»„åˆä½¿ç”¨å»ºè®®**ï¼š

```
æ¨èçš„ç»„åˆé˜²æŠ¤ç­–ç•¥ï¼š

1. è®¾ç½® SameSite=Laxï¼ˆé»˜è®¤é˜²æŠ¤ï¼‰
   â†’ é˜»æ­¢å¤§éƒ¨åˆ† CSRF æ”»å‡»
   â†’ å…è®¸æ­£å¸¸çš„è·¨ç«™å¯¼èˆª

2. å¯¹æ•æ„Ÿæ“ä½œæ·»åŠ  CSRF Token
   â†’ åŒé‡ä¿æŠ¤
   â†’ å³ä½¿ SameSite è¢«ç»•è¿‡ä»æœ‰æ•ˆ

3. æ£€æŸ¥ Origin/Referer å¤´ï¼ˆå¤‡é€‰ï¼‰
   â†’ ä½œä¸ºé¢å¤–çš„éªŒè¯å±‚
   â†’ ä½†éœ€è¦æ³¨æ„éšç§è®¾ç½®
```

---

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰

- âœ… æˆåŠŸæ¼”ç¤ºäº†ä¼šè¯å›ºå®šæ”»å‡»ï¼ˆDVWA/Pikachuï¼‰
- âœ… å®ç°äº† CSRF Token é˜²æŠ¤å¹¶éªŒè¯æ•ˆæœ
- âœ… é…ç½®äº† SameSite Cookie å¹¶æµ‹è¯•äº†ä¸åŒåœºæ™¯
- âœ… ç†è§£äº†ä¼šè¯è¿‡æœŸçš„å‡ ç§ç­–ç•¥
- âœ… å®ç°äº†åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰åŸºç¡€æµç¨‹
- âœ… æäº¤äº†æ¼”ç¤ºæˆªå›¾å’Œä»£ç 

## å­¦ä¹ æˆæœè¾¾æˆæƒ…å†µï¼ˆç”±å­¦ä¹ è€…å¡«å†™ï¼‰

---

### æˆªå›¾ä¸è¯æ®

- [ ] DVWA/Pikachu ä¼šè¯å›ºå®šæ”»å‡»æ¼”ç¤ºæˆªå›¾
- [ ] DVWA/Pikachu ä¸å®‰å…¨ Session ID åˆ†æ
- [ ] CSRF æ”»å‡»æ— é˜²æŠ¤æ¼”ç¤ºæˆªå›¾
- [ ] CSRF Token é˜²æŠ¤éªŒè¯æˆªå›¾ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- [ ] SameSite Cookie è®¾ç½®å‰åå¯¹æ¯”
- [ ] 2FA äºŒç»´ç ç”Ÿæˆå’ŒéªŒè¯æˆªå›¾
- [ ] æµè§ˆå™¨å¼€å‘è€…å·¥å…· Cookie å±æ€§æ£€æŸ¥æˆªå›¾

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç²˜è´´å…³é”®ç‰‡æ®µï¼‰

**å¯åŠ¨ DVWA é¶åœº**ï¼š

```bash
# ä½¿ç”¨ Docker å¯åŠ¨ DVWA
docker run -d -p 8080:80 \
  -e DVWA_USERNAME=admin \
  -e DVWA_PASSWORD=password \
  vulnerables/web-dvwa

# è®¿é—® http://localhost:8080
# é»˜è®¤ç™»å½•ï¼šadmin / password
```

**ä¼šè¯å›ºå®šæ”»å‡»æ¼”ç¤º**ï¼š

```bash
# 1. è·å–åˆå§‹ Session ID
curl -c cookies.txt -v http://localhost:8080/login 2>&1 | grep -i cookie

# è¾“å‡ºç¤ºä¾‹ï¼š
# Set-Cookie: DVWA_SESSION=dvwa_session_12345; Path=/; HttpOnly

# 2. è¯±å¯¼å—å®³è€…ä½¿ç”¨æ”»å‡»è€…çš„ Session ID ç™»å½•
curl -b "DVWA_SESSION=attacker_fixed_id" \
  -d "username=admin&password=password" \
  http://localhost:8080/login

# 3. æ”»å‡»è€…ä½¿ç”¨ç›¸åŒ Session ID è®¿é—®
curl -b "DVWA_SESSION=attacker_fixed_id" \
  http://localhost:8080/vulnerabilities/csrf/

# è¾“å‡ºï¼šæˆåŠŸè®¿é—®å—å®³è€…çš„ä¼šè¯ï¼ˆåŠ«æŒï¼‰
```

**CSRF æ”»å‡»æ¼”ç¤ºï¼ˆæ— é˜²æŠ¤ï¼‰**ï¼š

```bash
# 1. ç™»å½•åº”ç”¨è·å– Cookie
curl -c cookies.txt -d "username=admin&password=password" \
  http://localhost:5000/login

# 2. æ¨¡æ‹Ÿè·¨ç«™è¯·æ±‚ï¼ˆevil.htmlï¼‰
cat > evil.html << 'EOF'
<!DOCTYPE html>
<html>
<head><title>ä¸­å¥–ï¼</title></head>
<body>
    <h1>æ­å–œæ‚¨ä¸­å¥– 10000 å…ƒï¼</h1>
    <form action="http://localhost:5000/transfer" method="POST" id="form">
        <input type="hidden" name="to" value="attacker">
        <input type="hidden" name="amount" value="10000">
    </form>
    <script>document.getElementById('form').submit();</script>
</body>
</html>
EOF

# 3. åœ¨æµè§ˆå™¨æ‰“å¼€ evil.htmlï¼ˆæ­¤æ—¶å·²ç™»å½• localhost:5000ï¼‰
# é¢„æœŸï¼šè½¬è´¦æˆåŠŸï¼ˆCSRF æ”»å‡»æˆåŠŸï¼‰
```

**CSRF é˜²æŠ¤éªŒè¯ï¼ˆå¸¦ Tokenï¼‰**ï¼š

```bash
# 1. æŸ¥çœ‹ CSRF Token
curl -s http://localhost:5000/ | grep csrf_token

# è¾“å‡ºç¤ºä¾‹ï¼š
# <input type="hidden" name="csrf_token" value="a1b2c3d4e5f6...">

# 2. å°è¯•ä¼ªé€ è¯·æ±‚ï¼ˆæ²¡æœ‰ Tokenï¼‰
curl -b cookies.txt \
  -d "to=attacker&amount=10000" \
  http://localhost:5000/transfer

# è¾“å‡ºï¼šâŒ CSRF éªŒè¯å¤±è´¥ï¼ï¼ˆ403 Forbiddenï¼‰

# 3. æ­£ç¡®è¯·æ±‚ï¼ˆå¸¦ Tokenï¼‰
curl -b cookies.txt \
  -d "to=attacker&amount=10000&csrf_token=a1b2c3d4e5f6..." \
  http://localhost:5000/transfer

# è¾“å‡ºï¼šè½¬è´¦æˆåŠŸï¼š10000 å…ƒ â†’ attacker
```

**SameSite Cookie æµ‹è¯•**ï¼š

```bash
# æ£€æŸ¥ Cookie å±æ€§
curl -s -I http://localhost:5000/ | grep -i set-cookie

# è¾“å‡ºç¤ºä¾‹ï¼ˆå®‰å…¨é…ç½®ï¼‰ï¼š
# Set-Cookie: session_id=abc123; Path=/; HttpOnly; Secure; SameSite=Strict

# æµ‹è¯• SameSite=Lax vs Strictï¼š
# 1. ä½¿ç”¨ <a> æ ‡ç­¾è·³è½¬ï¼šLax å‘é€ Cookieï¼ŒStrict ä¸å‘é€
# 2. ä½¿ç”¨ <img> æˆ– <form> è·¨ç«™ï¼šä¸¤è€…éƒ½ä¸å‘é€ Cookie
```

**2FA OTP éªŒè¯**ï¼š

```python
# ç”Ÿæˆ TOTPï¼ˆç”¨äºæµ‹è¯•ï¼‰
import pyotp

# ä»æ•°æ®åº“è·å–ç”¨æˆ·å¯†é’¥
user_secret = "JBSWY3DPEHPK3PXP"  # ç¤ºä¾‹

totp = pyotp.TOTP(user_secret)
current_otp = totp.now()
print(f"å½“å‰ OTP: {current_otp}")  # 6 ä½æ•°å­—ï¼Œæ¯ 30 ç§’å˜åŒ–

# éªŒè¯ OTP
if totp.verify(current_otp):
    print("âœ… OTP éªŒè¯æˆåŠŸ")
else:
    print("âŒ OTP éªŒè¯å¤±è´¥")

# æµ‹è¯•è¿‡æœŸ OTP
import time
time.sleep(31)  # ç­‰å¾…è¶…è¿‡ 30 ç§’
if totp.verify(current_otp):
    print("âŒ åº”è¯¥å¤±è´¥ï¼šOTP å·²è¿‡æœŸ")
else:
    print("âœ… æ­£ç¡®ï¼šè¿‡æœŸ OTP è¢«æ‹’ç»")
```

---

### ç»“è®ºä¸åæ€

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- **è®¤è¯ vs æˆæƒ**ï¼š
  - è®¤è¯ï¼ˆAuthenticationï¼‰= éªŒè¯"ä½ æ˜¯è°"ï¼ˆWho are you?ï¼‰
  - æˆæƒï¼ˆAuthorizationï¼‰= éªŒè¯"ä½ èƒ½åšä»€ä¹ˆ"ï¼ˆWhat can you do?ï¼‰
- **Session ID å®‰å…¨è¦æ±‚**ï¼š
  - å¿…é¡»éšæœºã€å”¯ä¸€ã€ä¸å¯çŒœæµ‹ï¼ˆè‡³å°‘ 128 ä½ç†µï¼‰
  - ä½¿ç”¨ `secrets.token_hex()` è€Œä¸æ˜¯ `random`
  - é…ç½® `Secure`ã€`HttpOnly`ã€`SameSite` å±æ€§
- **CSRF æ”»å‡»åŸç†**ï¼š
  - æ”»å‡»è€…è¯±å¯¼ç”¨æˆ·åœ¨å·²ç™»å½•çŠ¶æ€ä¸‹æ‰§è¡Œéé¢„æœŸè¯·æ±‚
  - æµè§ˆå™¨è‡ªåŠ¨å‘é€ Cookieï¼ˆé™¤é SameSite=Strictï¼‰
  - æ”»å‡»è€…ä¸éœ€è¦çŸ¥é“ Cookie å†…å®¹
- **CSRF é˜²æŠ¤ç­–ç•¥**ï¼š
  - CSRF Tokenï¼ˆæœ€å¯é ï¼Œéœ€è¦åœ¨è¡¨å•/è¯·æ±‚ä¸­æ·»åŠ ï¼‰
  - SameSite Cookieï¼ˆç®€å•æœ‰æ•ˆï¼Œé˜»æ­¢å¤§éƒ¨åˆ†è·¨ç«™è¯·æ±‚ï¼‰
  - æ£€æŸ¥ Origin/Referer å¤´ï¼ˆè¡¥å……éªŒè¯ï¼‰
- **ä¼šè¯å›ºå®šæ”»å‡»**ï¼š
  - æ”»å‡»è€…å¼ºåˆ¶ç”¨æˆ·ä½¿ç”¨é¢„è®¾çš„ Session ID ç™»å½•
  - ç™»å½•åå¿…é¡»é‡æ–°ç”Ÿæˆ Session IDï¼ˆå…³é”®é˜²æŠ¤ï¼‰
  - ç»‘å®š Session åˆ° IP/UA ç­‰ä¿¡æ¯å¯æé«˜å®‰å…¨æ€§
- **åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰**ï¼š
  - TOTP åŸºäºæ—¶é—´ç”Ÿæˆ 6 ä½åŠ¨æ€ç ï¼ˆæ¯ 30 ç§’å˜åŒ–ï¼‰
  - éœ€è¦ç”¨æˆ·æ‰‹æœº/ä¸“ç”¨ APP é…åˆä½¿ç”¨
  - æ•æ„Ÿæ“ä½œåº”è¦æ±‚ 2FA

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- æœ€åˆæ··æ·†äº† SameSite çš„ä¸‰ä¸ªå€¼ï¼š
  - `Strict`ï¼šç¦æ­¢æ‰€æœ‰è·¨ç«™ Cookie å‘é€ï¼ˆåŒ…æ‹¬å®‰å…¨å¯¼èˆªï¼‰
  - `Lax`ï¼šå…è®¸å®‰å…¨çš„è·¨ç«™å¯¼èˆªï¼ˆå¦‚ `<a>` æ ‡ç­¾é“¾æ¥ï¼‰
  - `None`ï¼šå…è®¸æ‰€æœ‰è·¨ç«™ Cookie å‘é€ï¼ˆå¿…é¡»é…åˆ `Secure`ï¼‰
- ä¸æ¸…æ¥š CSRF Token çš„ç”Ÿæˆå’ŒéªŒè¯æµç¨‹ï¼š
  - åº”è¯¥åŸºäº Session ID + å¯†é’¥ç”Ÿæˆ HMAC
  - éªŒè¯æ—¶ä½¿ç”¨æ’å®šæ—¶é—´æ¯”è¾ƒï¼ˆ`secrets.compare_digest`ï¼‰
  - Token åº”è¯¥æ˜¯ä¸€æ¬¡æ€§æˆ–çŸ­æ—¶é—´æœ‰æ•ˆ
- ä¼šè¯å›ºå®š vs ä¼šè¯åŠ«æŒï¼š
  - ä¼šè¯å›ºå®šï¼ˆSession Fixationï¼‰ï¼šæ”»å‡»è€…é¢„è®¾ Session ID
  - ä¼šè¯åŠ«æŒï¼ˆSession Hijackingï¼‰ï¼šæ”»å‡»è€…çªƒå–æœ‰æ•ˆ Session IDï¼ˆå¦‚é€šè¿‡ XSSï¼‰

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å­¦ä¹  SQL æ³¨å…¥å’Œ XSS çš„å…·ä½“æ”»å‡»åŸç†ï¼ˆDay038ï¼‰
- äº†è§£è¾“å…¥æ ¡éªŒçš„æœ€ä½³å®è·µ
- å®è·µæ–‡ä»¶ä¸Šä¼ å’Œè·¯å¾„ç©¿è¶Šæ¼æ´ï¼ˆDay039ï¼‰
- å­¦ä¹  API å®‰å…¨åŸºç¡€ï¼ˆDay040ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 3.5 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [ ] ğŸ˜• ç†è§£äº†åŸºæœ¬æ¦‚å¿µï¼Œä½†å®è·µä¸ç†Ÿç»ƒ
- [ ] ğŸ™‚ å®Œæˆäº† CSRF å’Œä¼šè¯ç®¡ç†çš„æ¼”ç¤º
- [ ] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
- [ ] ğŸ¤© é¢å¤–å®ç°äº† 2FA å¹¶åˆ†æäº†ä¸åŒ Cookie å±æ€§çš„å½±å“

---

## é›†ä¸­å‚è€ƒç­”æ¡ˆï¼ˆå«æ€è·¯ï¼‰

---

### ç»ƒä¹  1 å‚è€ƒç­”æ¡ˆï¼šä¸ºä»€ä¹ˆä¼šè¯å›ºå®šæ˜¯é£é™©ï¼Ÿ

**æ ¸å¿ƒé£é™©ç‚¹**ï¼š

1. **æ”»å‡»æµç¨‹å®Œæ•´**ï¼š
   ```
   æ”»å‡»è€… â†’ è·å–åˆå§‹ Session IDï¼ˆå¦‚ä»ç™»å½•é¡µé¢ï¼‰
          â†“
   è¯±å¯¼ç”¨æˆ· â†’ è®¿é—®å«é¢„è®¾ Session ID çš„é“¾æ¥ï¼ˆå¦‚ ?session_id=attacker123ï¼‰
          â†“
   ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨ä½¿ç”¨é¢„è®¾çš„ Session IDï¼ˆæœªé‡æ–°ç”Ÿæˆï¼‰
          â†“
   æ”»å‡»è€… â†’ ä½¿ç”¨ç›¸åŒ Session ID è®¿é—®ï¼ˆåŠ«æŒä¼šè¯ï¼‰
   ```

2. **é£é™©ç­‰çº§**ï¼š
   | é£é™©é¡¹ | å½±å“ | å¯èƒ½æ€§ |
   |--------|------|--------|
   | æƒé™æå‡ | ğŸ”´ é«˜ï¼ˆè·å¾—ç”¨æˆ·æ‰€æœ‰æƒé™ï¼‰ | ğŸŸ¡ ä¸­ï¼ˆéœ€è¦ç¤¾ä¼šå·¥ç¨‹ï¼‰ |
   | æ•°æ®æ³„éœ² | ğŸ”´ é«˜ï¼ˆå¯è®¿é—®ç”¨æˆ·æ•æ„Ÿæ•°æ®ï¼‰ | ğŸŸ¡ ä¸­ |
   | æ£€æµ‹éš¾åº¦ | ğŸŸ¡ ä¸­ï¼ˆçœ‹èµ·æ¥åƒæ­£å¸¸æµé‡ï¼‰ | ğŸŸ¡ ä¸­ |

3. **ä¸ºä»€ä¹ˆå±é™©**ï¼š
   - ä¸éœ€è¦çªƒå– Cookieï¼ˆXSSï¼‰æˆ–æš´åŠ›ç ´è§£å¯†ç 
   - åˆ©ç”¨äº†åº”ç”¨ç¨‹åº"ç™»å½•åä¸é‡æ–°ç”Ÿæˆ Session ID"çš„ç¼ºé™·
   - éš¾ä»¥åŒºåˆ†æ”»å‡»è€…å’Œåˆæ³•ç”¨æˆ·ï¼ˆç›¸åŒçš„ Session IDï¼‰

4. **é˜²æŠ¤æªæ–½ä¼˜å…ˆçº§**ï¼š

   | æªæ–½ | æ•ˆæœ | å®æ–½éš¾åº¦ | ä¼˜å…ˆçº§ |
   |------|------|----------|--------|
   | ç™»å½•åé‡æ–°ç”Ÿæˆ Session | âœ… ç›´æ¥ä¿®å¤ | ä½ | **P0** |
   | æ‹’ç»å¤–éƒ¨ Session ID | âœ… ä¸»åŠ¨é˜²æŠ¤ | ä½ | **P0** |
   | è®¾ç½® Session è¿‡æœŸ | âœ… å‡å°å½±å“çª—å£ | ä½ | P1 |
   | ç»‘å®š IP/UA | âœ… é¢å¤–é˜²æŠ¤ | ä¸­ | P2 |

---

### ç»ƒä¹  2 å‚è€ƒç­”æ¡ˆï¼šåˆç†çš„ä¼šè¯è¿‡æœŸç­–ç•¥

**å®Œæ•´ä¼šè¯è¿‡æœŸç­–ç•¥**ï¼š

```python
from datetime import datetime, timedelta

class SessionPolicy:
    """ä¼šè¯ç­–ç•¥é…ç½®"""
    
    def __init__(self):
        self.config = {
            # ç»å¯¹è¿‡æœŸæ—¶é—´ï¼šä»ç™»å½•å¼€å§‹è®¡ç®—çš„æ€»æ—¶é•¿
            "absolute_timeout": timedelta(hours=2),
            
            # ä¸æ´»è·ƒè¿‡æœŸæ—¶é—´ï¼šä»æœ€åä¸€æ¬¡æ´»åŠ¨å¼€å§‹è®¡ç®—
            "inactive_timeout": timedelta(minutes=30),
            
            # æ•æ„Ÿæ“ä½œè¿‡æœŸæ—¶é—´ï¼šæ•æ„Ÿæ“ä½œéªŒè¯åçš„æœ‰æ•ˆæœŸ
            "sensitive_timeout": timedelta(minutes=5),
            
            # è®°ä½ç™»å½•ï¼š7 å¤©ï¼ˆå‹¾é€‰"è®°ä½æˆ‘"ï¼‰
            "remember_me_timeout": timedelta(days=7),
            
            # å¼ºåˆ¶é‡æ–°è®¤è¯çš„åœºæ™¯
            "force_reauth_scenarios": [
                "change_password",
                "change_email",
                "delete_account",
                "transfer_large_amount"
            ]
        }
    
    def is_valid(self, session):
        """æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆ"""
        if not session:
            return False, "ä¼šè¯ä¸å­˜åœ¨"
        
        login_time = session.get("login_time")
        last_activity = session.get("last_activity")
        now = datetime.now()
        
        # æ£€æŸ¥ç»å¯¹è¿‡æœŸ
        if login_time and (now - login_time) > self.config["absolute_timeout"]:
            return False, "ä¼šè¯å·²è¿‡æœŸï¼ˆç»å¯¹è¿‡æœŸï¼‰"
        
        # æ£€æŸ¥ä¸æ´»è·ƒè¿‡æœŸ
        if last_activity and (now - last_activity) > self.config["inactive_timeout"]:
            return False, "ä¼šè¯å·²è¿‡æœŸï¼ˆä¸æ´»è·ƒï¼‰"
        
        # æ£€æŸ¥æ•æ„Ÿæ“ä½œè¿‡æœŸ
        sensitive_auth_time = session.get("sensitive_auth_time")
        if sensitive_auth_time and (now - sensitive_auth_time) > self.config["sensitive_timeout"]:
            return False, "æ•æ„Ÿæ“ä½œéªŒè¯å·²è¿‡æœŸ"
        
        # æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
        session["last_activity"] = now
        
        return True, "ä¼šè¯æœ‰æ•ˆ"
    
    def require_sensitive_auth(self, session, operation):
        """æ£€æŸ¥æ•æ„Ÿæ“ä½œæ˜¯å¦éœ€è¦é‡æ–°è®¤è¯"""
        if operation in self.config["force_reauth_scenarios"]:
            return True
        
        sensitive_auth_time = session.get("sensitive_auth_time")
        if sensitive_auth_time and (datetime.now() - sensitive_auth_time) > self.config["sensitive_timeout"]:
            return True
        
        return False
    
    def set_remember_me(self, session, remember=False):
        """è®¾ç½®è®°ä½ç™»å½•"""
        if remember:
            session["expires_at"] = datetime.now() + self.config["remember_me_timeout"]
            session["persistent"] = True
        else:
            session["expires_at"] = datetime.now() + self.config["absolute_timeout"]
            session["persistent"] = False

# ä½¿ç”¨ç¤ºä¾‹
policy = SessionPolicy()

# æ£€æŸ¥ä¼šè¯æœ‰æ•ˆæ€§
is_valid, message = policy.is_valid(session)
if not is_valid:
    return redirect("/login")

# æ£€æŸ¥æ•æ„Ÿæ“ä½œ
if policy.require_sensitive_auth(session, "change_password"):
    return redirect("/reauth")
```

---

### ç»ƒä¹  3 å‚è€ƒç­”æ¡ˆï¼šCSRF Token vs SameSite Cookie

**è¯¦ç»†å¯¹æ¯”åˆ†æ**ï¼š

| ç»´åº¦ | CSRF Token | SameSite Cookie |
|------|------------|----------------|
| **é˜²æŠ¤åŸç†** | å¼ºåˆ¶éªŒè¯è¯·æ±‚åŒ…å«æœåŠ¡å™¨ç”Ÿæˆçš„ Token | é™åˆ¶è·¨ç«™è¯·æ±‚æ˜¯å¦å‘é€ Cookie |
| **å®æ–½ä½ç½®** | åç«¯ç”Ÿæˆ + å‰ç«¯ä¼ é€’ | Cookie å±æ€§è®¾ç½® |
| **ä¿æŠ¤èŒƒå›´** | ç²¾ç¡®åˆ°å…·ä½“æ“ä½œï¼ˆæ¯ä¸ª Token ç»‘å®šç‰¹å®šè¯·æ±‚ï¼‰ | ç²—ç²’åº¦ï¼ˆæ‰€æœ‰è·¨ç«™è¯·æ±‚ï¼‰ |
| **å…¼å®¹æ€§** | âœ… æ‰€æœ‰æµè§ˆå™¨ | âš ï¸ éƒ¨åˆ†æ—§æµè§ˆå™¨ä¸æ”¯æŒ |
| **è·¨ç«™éœ€æ±‚** | âœ… å¯ç²¾ç¡®å®šä½å…è®¸çš„è·¨ç«™è¯·æ±‚ | âŒ SameSite=Strict ä¼šé˜»æ­¢æ‰€æœ‰è·¨ç«™ |
| **å¼€å‘æˆæœ¬** | ğŸŸ¡ ä¸­ï¼ˆéœ€è¦åç«¯+å‰ç«¯é…åˆï¼‰ | ğŸŸ¢ ä½ï¼ˆåªéœ€é…ç½® Cookieï¼‰ |
| **ç»´æŠ¤æˆæœ¬** | ğŸŸ¡ ä¸­ï¼ˆæ¯ä¸ªè¡¨å•/è¯·æ±‚éƒ½è¦åŠ  Tokenï¼‰ | ğŸŸ¢ ä½ï¼ˆå…¨å±€é…ç½®ï¼‰ |

**æ¨èç»„åˆç­–ç•¥**ï¼š

```
å¤šå±‚é˜²æŠ¤æ–¹æ¡ˆï¼ˆDefense in Depthï¼‰ï¼š

ç¬¬ 1 å±‚ï¼šSameSite=Laxï¼ˆé»˜è®¤é˜²æŠ¤ï¼‰
  â”œâ”€ ä¼˜ç‚¹ï¼šé…ç½®ç®€å•ï¼Œé˜»æ­¢å¤§éƒ¨åˆ† CSRF æ”»å‡»
  â”œâ”€ ç¼ºç‚¹ï¼šæŸäº›åœºæ™¯éœ€è¦è·¨ç«™ï¼ˆå¦‚æ”¯ä»˜å›è°ƒï¼‰
  â””â”€ é€‚ç”¨ï¼šä¸€èˆ¬ Web åº”ç”¨

ç¬¬ 2 å±‚ï¼šCSRF Tokenï¼ˆå…³é”®æ“ä½œï¼‰
  â”œâ”€ ä¼˜ç‚¹ï¼šç²¾ç¡®æ§åˆ¶ï¼Œä¸å½±å“æ­£å¸¸è·¨ç«™
  â”œâ”€ ç¼ºç‚¹ï¼šéœ€è¦å‰åç«¯é…åˆ
  â””â”€ é€‚ç”¨ï¼šæ•æ„Ÿæ“ä½œï¼ˆè½¬è´¦/ä¿®æ”¹å¯†ç ï¼‰

ç¬¬ 3 å±‚ï¼šæ£€æŸ¥ Origin/Referer å¤´ï¼ˆè¡¥å……éªŒè¯ï¼‰
  â”œâ”€ ä¼˜ç‚¹ï¼šé¢å¤–éªŒè¯è¯·æ±‚æ¥æº
  â”œâ”€ ç¼ºç‚¹ï¼šå¯èƒ½è¢«éšç§è®¾ç½®ç¦ç”¨
  â””â”€ é€‚ç”¨ï¼šä½œä¸ºé¢å¤–çš„éªŒè¯å±‚

ç¬¬ 4 å±‚ï¼šåŒé‡ Cookieï¼ˆå¯é€‰ï¼‰
  â”œâ”€ åŸç†ï¼šCookie å’Œå‚æ•°ä¸­å„å­˜ä¸€ä»½ Token
  â”œâ”€ ä¼˜ç‚¹ï¼šå‰ç«¯æ— éœ€å­˜å‚¨ Token
  â””â”€ ç¼ºç‚¹ï¼šå®‰å…¨æ€§ç•¥ä½äºæ ‡å‡† CSRF Token

ç¤ºä¾‹é…ç½®ï¼š
```
# Nginx é…ç½® SameSite
location / {
    proxy_cookie_path / /;  # SameSite=Laxï¼ˆNginx 1.19+ï¼‰
}

# Flask é…ç½® CSRF Token
@app.after_request
def add_csrf_token(response):
    if request.method in ["POST", "PUT", "DELETE"]:
        session["csrf_token"] = generate_csrf_token()
    return response
```

---

## å­¦ä¹ æˆæœç¤ºä¾‹å¡«å†™ï¼ˆå¯ç…§æŠ„ï¼‰

> å¯å°†"ç¤ºä¾‹"å†…å®¹æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æ—¶é—´ä¸æˆªå›¾æ–‡ä»¶åã€‚

---

### æˆªå›¾ä¸è¯æ®ï¼ˆç¤ºä¾‹ï¼‰

- DVWA ä¼šè¯å›ºå®šæ”»å‡»ï¼š`images/day037_session_fixation.png`
- CSRF æ— é˜²æŠ¤æ¼”ç¤ºï¼š`images/day037_csrf_vulnerable.png`
- CSRF Token é˜²æŠ¤éªŒè¯ï¼š`images/day037_csrf_protected.png`
- SameSite Cookie æ£€æŸ¥ï¼š`images/day037_samesite_inspect.png`
- 2FA äºŒç»´ç ç”Ÿæˆï¼š`images/day037_2fa_qrcode.png`
- 2FA éªŒè¯æˆåŠŸï¼š`images/day037_2fa_success.png`

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

**ä¼šè¯å›ºå®šæ”»å‡»**ï¼š

```bash
# æ­¥éª¤ 1ï¼šè·å–åˆå§‹ Session
$ curl -c cookies.txt -v http://localhost:8080/login
< Set-Cookie: DVWA_SESSION=dvwa_abc123; Path=/; HttpOnly

# æ­¥éª¤ 2ï¼šå—å®³è€…ä½¿ç”¨æ”»å‡»è€… Session ç™»å½•
$ curl -b "DVWA_SESSION=attacker_fixed" \
    -d "username=admin&password=password" \
    http://localhost:8080/login
âœ… ç™»å½•æˆåŠŸ

# æ­¥éª¤ 3ï¼šæ”»å‡»è€…åŠ«æŒä¼šè¯
$ curl -b "DVWA_SESSION=attacker_fixed" \
    http://localhost:8080/vulnerabilities/csrf/
æ¬¢è¿, admin  # åŠ«æŒæˆåŠŸ
```

**CSRF é˜²æŠ¤å¯¹æ¯”**ï¼š

```bash
# æ— é˜²æŠ¤åœºæ™¯ï¼ˆè¢« CSRF æˆåŠŸï¼‰
$ curl -b session_cookie \
    -d "to=attacker&amount=10000" \
    http://localhost:5000/transfer
è½¬è´¦æˆåŠŸï¼š10000 å…ƒ â†’ attacker  # âŒ CSRF æˆåŠŸ

# æœ‰ Token é˜²æŠ¤ï¼ˆè¢«æ‹’ç»ï¼‰
$ curl -b session_cookie \
    -d "to=attacker&amount=10000" \
    http://localhost:5000/transfer
âŒ CSRF éªŒè¯å¤±è´¥ï¼  # âœ… é˜²æŠ¤æˆåŠŸ

# å¸¦æ­£ç¡® Token
$ curl -b session_cookie \
    -d "to=attacker&amount=10000&csrf_token=a1b2c3..." \
    http://localhost:5000/transfer
è½¬è´¦æˆåŠŸï¼š10000 å…ƒ â†’ attacker  # âœ… æ­£å¸¸è¯·æ±‚
```

---

### ç»“è®ºä¸åæ€ï¼ˆç¤ºä¾‹ï¼‰

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- **è®¤è¯ä¸æˆæƒ**æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ¦‚å¿µï¼Œä½†ç»å¸¸éœ€è¦é…åˆä½¿ç”¨
- **Session ID** çš„å®‰å…¨æ€§è‡³å…³é‡è¦ï¼Œå¿…é¡»æ»¡è¶³éšæœºã€å”¯ä¸€ã€ä¸å¯çŒœæµ‹
- **Cookie å±æ€§**çš„æ­£ç¡®é…ç½®ï¼ˆSecure/HttpOnly/SameSiteï¼‰æ˜¯åŸºç¡€é˜²æŠ¤
- **CSRF Token** æ˜¯æœ€å¯é çš„ CSRF é˜²æŠ¤æªæ–½ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªæ•æ„Ÿæ“ä½œç”Ÿæˆ
- **SameSite=Lax** æ˜¯ç®€å•æœ‰æ•ˆçš„ CSRF é˜²æŠ¤ï¼Œä½†ä¸èƒ½æ›¿ä»£ CSRF Token
- **ä¼šè¯å›ºå®š** æ”»å‡»å¯ä»¥é€šè¿‡"ç™»å½•åé‡æ–°ç”Ÿæˆ Session"æ¥å®Œå…¨é˜²æŠ¤
- **åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰** ä½¿ç”¨ TOTP å¤§å¹…æé«˜äº†è´¦æˆ·å®‰å…¨æ€§

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- SameSite çš„ä¸‰ä¸ªå€¼ï¼ˆStrict/Lax/Noneï¼‰çš„å…·ä½“è¡Œä¸ºå·®å¼‚
- CSRF Token çš„ç”Ÿæˆåº”è¯¥åŸºäº Session ID + å¯†é’¥ï¼Œè€Œä¸æ˜¯å•ç‹¬çš„éšæœºå€¼
- ä¼šè¯å›ºå®šä¸ä¼šè¯åŠ«æŒçš„æ”»å‡»åŸç†ä¸åŒï¼Œä½†é˜²æŠ¤æªæ–½æœ‰é‡å 

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å­¦ä¹  SQL æ³¨å…¥å’Œ XSS çš„å…·ä½“æ”»å‡»åŸç†ï¼ˆDay038ï¼‰
- äº†è§£è¾“å…¥æ ¡éªŒçš„æœ€ä½³å®è·µ
- å®è·µæ–‡ä»¶ä¸Šä¼ å’Œè·¯å¾„ç©¿è¶Šæ¼æ´ï¼ˆDay039ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 3.5 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [x] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
