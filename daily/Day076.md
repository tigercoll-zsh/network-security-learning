---
title: Day076：红蓝对抗 - 日志分析基础
tags:
  - 网络安全
  - 渗透测试
  - 红蓝对抗
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: be359
date: 2026-01-28
updated: 2026-01-28
---

# Day076：红蓝对抗 - 日志分析基础

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 13：红蓝对抗与防御 |
| **今日主题** | 日志分析基础 |
| **预计时间** | 3-4 小时 |
| **难度等级** | ⭐⭐⭐⭐ 中高级 |

---

## 🔥 今日痛点场景

> **场景**：安全团队发现异常告警，需要你分析日志确定是否发生了入侵。你面对海量日志，不知道从何下手。
>
> **问题**：如何快速从日志中找到攻击证据？
>
> **今天的任务**：掌握 Windows 和 Linux 日志分析的核心技能。

---

## 🎯 今日目标

- [ ] 理解 Windows 事件日志结构
- [ ] 理解 Linux 日志系统
- [ ] 掌握关键安全事件分析
- [ ] 学会使用日志分析工具

**闯关条件**：能够从日志中识别出至少 3 种攻击行为。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：Windows 事件日志分析（60 分钟）

**日志位置**：

```
C:\Windows\System32\winevt\Logs\
├── Security.evtx      # 安全日志（最重要）
├── System.evtx        # 系统日志
├── Application.evtx   # 应用日志
└── Microsoft-Windows-PowerShell%4Operational.evtx  # PowerShell 日志
```

**使用 PowerShell 分析日志**：

```powershell
# 查看最近的安全事件
Get-WinEvent -LogName Security -MaxEvents 20 | Format-List

# 筛选登录成功事件 (4624)
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4624} -MaxEvents 10

# 筛选登录失败事件 (4625)
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4625} -MaxEvents 10

# 筛选进程创建事件 (4688)
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4688} -MaxEvents 10

# 导出为 CSV 便于分析
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4624} -MaxEvents 100 |
    Select-Object TimeCreated,Id,Message |
    Export-Csv -Path C:\temp\logins.csv -NoTypeInformation
```

**关键安全事件**：

| 事件 ID | 类别 | 含义 | 攻击关联 |
|---------|------|------|----------|
| 4624 | 登录 | 登录成功 | 横向移动 |
| 4625 | 登录 | 登录失败 | 暴力破解 |
| 4648 | 登录 | 显式凭据 | PTH |
| 4672 | 登录 | 特权分配 | 提权 |
| 4688 | 进程 | 进程创建 | 恶意执行 |
| 4697 | 服务 | 服务安装 | 持久化 |
| 4698 | 任务 | 计划任务创建 | 持久化 |
| 4662 | AD | 对象操作 | DCSync |

---

### 任务 2：分析可疑登录（30 分钟）

**登录类型解析**：

| 类型 | 值 | 说明 | 可疑情况 |
|------|------|------|----------|
| Interactive | 2 | 本地登录 | 服务器不应有 |
| Network | 3 | 网络登录 | 横向移动常见 |
| Batch | 4 | 批处理 | 计划任务 |
| Service | 5 | 服务启动 | 服务后门 |
| RemoteInteractive | 10 | RDP | 远程访问 |
| CachedInteractive | 11 | 缓存凭据 | 离线登录 |

**分析脚本**：

```powershell
# 分析网络登录（类型 3）- 常见于横向移动
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4624} |
    ForEach-Object {
        $xml = [xml]$_.ToXml()
        $LogonType = $xml.Event.EventData.Data | Where-Object {$_.Name -eq 'LogonType'} | Select-Object -ExpandProperty '#text'
        $TargetUser = $xml.Event.EventData.Data | Where-Object {$_.Name -eq 'TargetUserName'} | Select-Object -ExpandProperty '#text'
        $SourceIP = $xml.Event.EventData.Data | Where-Object {$_.Name -eq 'IpAddress'} | Select-Object -ExpandProperty '#text'

        if ($LogonType -eq '3') {
            [PSCustomObject]@{
                Time = $_.TimeCreated
                User = $TargetUser
                SourceIP = $SourceIP
                LogonType = $LogonType
            }
        }
    } | Format-Table
```

---

### 任务 3：Linux 日志分析（40 分钟）

**主要日志文件**：

| 日志文件 | 内容 | 分析重点 |
|----------|------|----------|
| /var/log/auth.log | 认证日志 | SSH 登录、sudo |
| /var/log/secure | 认证日志(RHEL) | 同上 |
| /var/log/syslog | 系统日志 | 服务启动、错误 |
| /var/log/wtmp | 登录记录 | 用 last 命令查看 |
| /var/log/btmp | 失败登录 | 用 lastb 命令查看 |
| ~/.bash_history | 命令历史 | 攻击者操作 |

**常用分析命令**：

```bash
# 查看最近登录
last -n 20

# 查看失败登录
lastb -n 20

# 分析 SSH 登录成功
grep "Accepted" /var/log/auth.log | tail -20

# 分析 SSH 登录失败（暴力破解）
grep "Failed password" /var/log/auth.log | tail -20

# 统计失败登录 IP
grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -rn | head -10

# 查看 sudo 使用
grep "sudo" /var/log/auth.log | tail -20

# 分析 cron 任务执行
grep "CRON" /var/log/syslog | tail -20
```

---

### 任务 4：使用工具进行日志分析（40 分钟）

**Windows：使用 Event Log Explorer 或 LogParser**

```cmd
:: LogParser 查询示例 - 统计登录失败
logparser "SELECT TimeGenerated,SourceName,EventID,Message FROM Security WHERE EventID=4625" -i:EVT

:: 统计各 IP 的登录尝试
logparser "SELECT EXTRACT_TOKEN(Strings,18,'|') AS SourceIP,COUNT(*) AS Count FROM Security WHERE EventID=4625 GROUP BY SourceIP ORDER BY Count DESC" -i:EVT
```

**Linux：使用 journalctl（systemd 系统）**

```bash
# 查看认证相关日志
journalctl -u sshd --since "1 hour ago"

# 查看失败的服务启动
journalctl -p err --since "today"

# 实时跟踪日志
journalctl -f
```

**在线分析平台**：

- Splunk（商业）
- ELK Stack（开源）
- Graylog（开源）

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| Windows 事件日志查询成功 | ⬜ |
| 识别出登录相关事件 | ⬜ |
| Linux 日志分析成功 | ⬜ |
| 能识别暴力破解痕迹 | ⬜ |
| 能识别异常登录行为 | ⬜ |

---

## 📖 底层补课（做完实验再看）

### 日志分析方法论

1. **确定时间范围**：缩小分析范围
2. **关注异常**：非工作时间、非常用 IP
3. **关联分析**：多个事件串联成攻击链
4. **基线对比**：与正常行为对比

### Windows 审计策略

默认情况下很多事件不记录，需要开启审计：

```cmd
:: 查看当前审计策略
auditpol /get /category:*

:: 开启进程创建审计
auditpol /set /subcategory:"Process Creation" /success:enable /failure:enable
```

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 日志被清除 | 关键时间段无日志 | 检查日志清除事件 (1102) |
| 日志量太大 | 无法有效分析 | 使用过滤和工具 |
| 时区不对 | 时间线混乱 | 统一转换为 UTC |

---

## 💡 知识卡片速查

### 快速分析命令

| 目的 | Windows | Linux |
|------|---------|-------|
| 登录成功 | Event 4624 | grep "Accepted" |
| 登录失败 | Event 4625 | grep "Failed password" |
| 进程创建 | Event 4688 | ps aux / journalctl |
| 服务变更 | Event 4697 | systemctl status |

---

## 🚀 明日预告

**Day 077：红蓝对抗 - 入侵检测与溯源**

明天你将：
- 学习 IDS/IPS 工作原理
- 使用 Snort/Suricata 检测攻击
- 进行攻击溯源分析

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> 日志分析是安全工程师的基本功。
>
> 不管是应急响应、溯源取证还是威胁狩猎，都离不开日志分析能力。
>
> 作为红队，你也需要知道自己的行为会在日志中留下什么痕迹。
>
> 多练习，多分析，这个技能会让你受益终身。

```bash
echo "Day 076 Complete! 日志分析基础掌握！"
```
