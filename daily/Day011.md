# Day011：安全协议与加密 - SSH 与密钥认证

- 日期：2026-01-04
- 周次：第 2 周

## 学习目标

学完今天你应该能做到：

- 说清 SSH 连接时至少发生了 3 件事：**加密协商**、**服务器身份验证（HostKey）**、**用户身份验证（密码/密钥/多因素）**
- 能解释：为什么第一次连某台主机会问你 “Are you sure you want to continue connecting (yes/no)?”（本质是 HostKey 信任）
- 能在 Windows 上完成：
  - 生成一对 SSH 密钥（推荐 Ed25519）
  - 理解 `authorized_keys` / `known_hosts` 分别是干什么的
  - 会写一个最小可用的 `~/.ssh/config`（主机别名、用户、端口、IdentityFile）
- 能列出一张“SSH 加固清单”（禁 root、禁密码、限制来源、升级算法、审计）并知道每条在防什么

## 学习内容

### 1️⃣ SSH 解决的是什么问题

SSH（Secure Shell）= 为远程登录/远程执行命令/文件传输提供：

- **加密**：防止明文口令与命令被窃听
- **完整性**：防篡改
- **服务器身份验证**：防止你连到“假服务器”（靠 HostKey）

### 2️⃣ SSH 连接时发生的三步（最重要）

你可以把一次 SSH 连接记成：

1. **协商加密参数**：算法/密钥交换/ MAC 等（你通常不需要背，但要知道它存在）
2. **验证服务器身份（HostKey）**：
   - 服务器给出自己的 Host Public Key（主机公钥）
   - 客户端把它记录到 `known_hosts`（第一次信任）
   - 下次再连，如果 HostKey 变了，就会报警（可能是换机/重装，也可能是 MITM）
3. **验证用户身份（Authentication）**：
   - 密码登录（不推荐）
   - 公钥登录（推荐）
   - 叠加 MFA（更推荐，企业常用）

### 3️⃣ `authorized_keys` vs `known_hosts`：别搞反

- `~/.ssh/authorized_keys`（在 **服务器** 上）：
  - 决定“哪些客户端公钥可以登录我这个账号”
- `~/.ssh/known_hosts`（在 **客户端** 上）：
  - 记录“我信任哪些服务器的 HostKey，防止连错服务器/被中间人冒充”

一句话区分：

- **authorized_keys 管人**（谁能进来）
- **known_hosts 管机**（我连的是不是那台机器）

### 4️⃣ 为什么推荐 Ed25519 密钥

- 生成快、长度短、安全性高、现代默认推荐（比老的 DSA/RSA 更省心）

### 5️⃣ SSH 常见加固项（你今天要掌握的清单）

> 只给你“够用版”，每条都能说出它在防什么。

- 禁止 root 直接登录：避免“高权限账号暴露在入口”
- 禁用密码登录，仅允许公钥：减少弱口令/爆破风险
- 限制允许登录的用户/组：减少攻击面
- 只允许特定来源 IP：减少暴露面（尤其是公网）
- 禁用旧算法/旧协议：避免弱加密
- 开启日志审计：出现问题能追溯

## 实践任务（合法授权范围内）

> 目标：即使你没有 Linux 虚拟机，也能在 Windows 上把“密钥、known_hosts、config”这些核心概念练一遍；有虚拟机就做远程登录验证。

### 任务 1（Windows 本地必做）：生成 Ed25519 密钥对

```powershell
ssh-keygen -t ed25519 -a 64 -C "day011" -f "$env:USERPROFILE\.ssh\id_ed25519_day011"
```

你会得到：

- 私钥：`id_ed25519_day011`（**不要泄露**）
- 公钥：`id_ed25519_day011.pub`（可以发给服务器）

### 任务 2（Windows 本地必做）：理解并查看 known_hosts

查看 `known_hosts` 是否存在：

```powershell
Test-Path "$env:USERPROFILE\.ssh\known_hosts"
```

如果你曾经连过任何 SSH 主机，这里会有记录。你可以理解为：

- “我见过这台服务器的 HostKey，以后再连如果变了就要警惕。”

### 任务 3（Windows 本地必做）：写一个最小 ssh config（主机别名）

文件位置：`$env:USERPROFILE\.ssh\config`

示例（把 `<your-host>` `<your-user>` 替换掉）：

```sshconfig
Host mylab
	HostName <your-host>
	User <your-user>
	Port 22
	IdentityFile ~/.ssh/id_ed25519_day011
```

这样以后你就可以用：

- `ssh mylab`

来代替又长又容易打错的一串参数。

### 任务 4（可选，有自建 Linux/授权主机时）：配置公钥登录

1. 把 `id_ed25519_day011.pub` 的内容追加到服务器的：

- `~/.ssh/authorized_keys`

2. 在服务器上确保权限正确（Linux 上常见要求）：

- `~/.ssh` 目录和 `authorized_keys` 文件权限合理（过宽会被拒绝）

3. 登录验证：

- `ssh -i ~/.ssh/id_ed25519_day011 <user>@<host>`（或用上面的 `ssh mylab`）

### 任务 5（加固记录）：列出 sshd_config 关键项（有服务器时）

把你服务器上的 `sshd_config` 里这些项的当前值记录下来：

- `PermitRootLogin`
- `PasswordAuthentication`
- `PubkeyAuthentication`
- `AllowUsers` / `AllowGroups`
- `PermitEmptyPasswords`

## 巩固练习（题与复盘）

### 题目 1：为何建议禁用 root 直登？

**思路**：入口账号越高权限越危险 → 一旦被爆破/泄露直接拿最高权限 → 应改成低权限登录再提权。

**标准答案**：

- 禁用 root 直登可以把“最高权限账号”从入口移除。
- 即使攻击者拿到 root 口令/猜中弱口令，风险会直达系统最高权限；改为普通用户登录再通过 `sudo` 提权，可以减少攻击面并留下更清晰的审计记录。

### 题目 2：`known_hosts` 里记录的是什么？HostKey 变了意味着什么？

**思路**：`known_hosts` 记录服务器 HostKey 指纹 → 变了通常是“机器换了/重装”或“中间人冒充”。

**标准答案**：

- `known_hosts` 记录的是“服务器的 HostKey（主机公钥）指纹”，用于验证你连到的还是不是那台服务器。
- HostKey 发生变化可能是服务器重装/更换密钥，也可能是被中间人攻击或 DNS 污染导致你连到别的机器，因此必须人工核验。

### 练习：生成 Ed25519 密钥并配置到 ssh config

**思路**：生成密钥 → 指定 IdentityFile → 用 Host alias 简化连接。

**标准答案（参考配置）**：

- 密钥生成命令：
  - `ssh-keygen -t ed25519 -a 64 -C "day011" -f ~/.ssh/id_ed25519_day011`
- `~/.ssh/config` 示例：
  - 见“任务 3”

## 评估标准（达成判定）

- 能解释：加密协商 / HostKey 验证 / 用户认证 3 步分别在干什么
- 能生成 Ed25519 密钥，并说清私钥/公钥如何存放
- 能说清：`authorized_keys` 与 `known_hosts` 的区别
- 能写出一份 SSH 加固清单（至少 6 条）并说明每条在防什么

## 学习成果达成情况（由学习者填写）

### 截图与证据

- 本机 `.ssh` 目录截图或命令输出（隐藏私钥内容，只展示文件名即可）：
  - `id_ed25519_day011` / `id_ed25519_day011.pub`
- （可选）成功公钥登录的终端截图（打码主机/IP）：

### 关键命令与输出

- 命令：
  - `ssh-keygen -t ed25519 ...`
  - `ssh -V`
  - （可选）`ssh -vvv mylab`（仅用于排障，不要贴全量日志到公开仓库）
- 输出关键行摘录：
  - OpenSSH 版本：
  - 首次连接时的 HostKey 指纹提示（如有）：

### 结论与反思

- 今天你确认到的 1 个事实证据（来自命令输出/文件）：
- 你遇到的 1 个坑（例如：权限/路径/HostKey changed）：
- 明天你想继续深挖的 1 个问题（例如：如何限制来源 IP/如何做 MFA）：

---

## 参考答案（含思路，集中作答）

### 题目 1：为何建议禁用 root 直登？

**思路**：减少入口高权限暴露 + 增加审计可追踪性。

**答案**：禁用 root 直登能降低爆破成功的收益与风险，把入口改为普通用户 + sudo，并保留更清晰的操作审计。

### 题目 2：known_hosts 记录什么？HostKey 变化意味着什么？

**思路**：客户端记住服务器“指纹”以防连错；变化要核验。

**答案**：`known_hosts` 记录服务器 HostKey 指纹；变化可能是服务器重装/改密钥，也可能是 MITM/DNS 污染，必须核验。

### 练习：生成密钥并配置 config 的最小步骤

**答案**：

1. `ssh-keygen -t ed25519 -a 64 -f ~/.ssh/id_ed25519_day011`

2. 在 `~/.ssh/config` 写入 Host 别名与 IdentityFile

3. `ssh mylab` 连接验证（仅限自建/授权主机）

（示例填写，给自己一个可参考的“完整答案”）

- 今天你确认到的 1 个事实证据：
  - 我本机生成了 `id_ed25519_day011` 与 `id_ed25519_day011.pub`，并能用 `ssh -V` 显示 OpenSSH 版本（证明环境可用）。
- 我遇到的 1 个坑：
  - 如果服务器 HostKey 变了，客户端会报 `REMOTE HOST IDENTIFICATION HAS CHANGED!`，需要先核验再处理（不能直接忽略）。
- 明天最想验证的问题：
  - 在 SSHD 上关闭密码登录后，如何确保仍可通过公钥登录且不会把自己锁在门外？
