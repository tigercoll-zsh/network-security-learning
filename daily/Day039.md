---
title: Day039：SSRF 深度挖掘 - 绕过技巧与内网穿透利用
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: bd63f
date: 2026-03-02
updated: 2026-03-02
---

# Day039：SSRF 深度挖掘 - 绕过技巧与内网穿透利用

- **日期**：2026-03-02
- **周次**：第 6 周
- **模块**：Web 漏洞进阶
- **主题**：SSRF (服务端请求伪造) 的绕过与实战
- **预计学习时间**：3.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- **突破黑名单限制**：掌握 IP 转换（八进制/十六进制）、短地址、特殊的子域名绕过手段。
- **掌握 DNS Rebinding (DNS 重绑定)**：理解这种“瞬时切换”攻击的底层原理，学会配置并绕过 TTL 校验。
- **实现内网穿透攻击**：学会利用 `gopher` 协议攻击内网 Redis、MySQL、Memcached，实现从 SSRF 到 RCE 的跨越。

<!--more-->

---

## 📚 完整学习内容（必读）

### 一、SSRF 的高级过滤绕过

当后端对 `127.0.0.1` 或 `192.168.x.x` 做了正则黑名单拦截时，我们可以利用协议栈和解析器的差异进行绕过。

#### 1.1 IP 地址的变形术
- **不同进制转换**：
  - `127.0.0.1` (十进制)
  - `0177.0.0.1` (八进制)
  - `0x7f.0.0.1` (十六进制)
  - `2130706433` (整数形式)
- **缺省写法**：`127.1` 在某些环境下会被解析为 `127.0.0.1`。

#### 1.2 利用特殊域名与服务
- **本地回环别名**：`http://localhost` 或 `http://0.0.0.0`。
- **利用 xip.io (已失效) 类的替代服务**：如 `http://127.0.0.1.nip.io`（该域名解析结果永远指向其前缀 IP）。
- **短地址跳转**：利用 `bit.ly` 等服务将内网 IP 包装成外网 URL，绕过第一层的字符串正则。

#### 1.3 协议差异绕过
- **HTTP/S 之外的协议**：`dict://`, `file://`, `gopher://`, `ftp://`。
- **URL 解析不一致**：
  - `http://expected.com@127.0.0.1/`：某些解析器会认为主机是 `expected.com`，但实际请求的是 `127.0.0.1`。

---

### 二、致命幻术：DNS Rebinding (DNS 重绑定)

这是目前最难防范的 SSRF 绕过技术，针对的是“先校验 IP，后发起请求”的防御逻辑。

#### 2.1 攻击流程
1. 攻击者注册一个恶意域名（如 `evil.com`），并自建 DNS 服务器。
2. 目标服务器接收到 `http://evil.com/` 请求，查询 DNS。
3. **第一次解析**：攻击者 DNS 返回一个合法的公网 IP，绕过后端检查。
4. **第二次请求**：由于 TTL（生存时间）极短，后端发起实际数据抓取时重新查询 DNS。
5. **第二次解析**：攻击者 DNS 瞬间切换，返回 `127.0.0.1`。
6. **结果**：后端在不知情的情况下访问了内网服务。

#### 2.2 实战工具
- **rbndr.us**：一个在线生成 DNS 重绑定域名的工具，会自动在两个 IP 之间轮询。

---

### 三、内网横向移动：Gopher 协议万能利用

SSRF 最大的危害不在于看几个网页，而在于**内网协议转换**。

#### 3.1 Gopher 协议格式
`gopher://<host>:<port>/_<TCP数据流>`
- 注意：数据流中的 `\r\n` (0d0a) 必须进行二次 URL 编码为 `%0d%0a`。

#### 3.2 攻击 Redis (获取 RCE)
如果内网 Redis 存在未授权访问，可以通过 SSRF 写入 SSH 公钥或计划任务：
1. 构造 Redis 命令序列。
2. 使用工具（如 `Gopherus`）将命令转换为 Gopher Payload。
3. 示例 Payload 逻辑：
   ```bash
   gopher://127.0.0.1:6379/_*1%0d%0a$8%0d%0aflushall%0d%0a...
   ```

---

## 🗺️ 知识图谱

```
SSRF 进阶矩阵
├── 过滤绕过 (Bypass Filters)
│   ├── IP 进制转换 (Hex/Oct/Dec)
│   ├── URL 解析差异 (@, #, ?)
│   └── 外部重定向 (Redirect 302)
├── 逻辑绕过 (Time/Logic Bypass)
│   ├── DNS Rebinding (TTL 竞争)
│   └── TOCTOU (检查时与使用时差异)
└── 深度利用 (Exploitation)
    ├── 协议扩展 (Dict, Gopher)
    └── 内网打点 (Redis, MySQL, FastCGI)
```

---

## 🔧 实践任务

### 任务 1：DNS Rebinding 绕过实验 (60 分钟)
**环境**：CTFHub - SSRF - DNS 重绑定。
**要求**：
1. 访问 `rbndr.us` 生成一个能在 `127.0.0.1` 和一个外网 IP 间切换的域名。
2. 编写 Python 脚本多次发起请求，直到触发 DNS 解析切换。
3. 成功读取内网 `flag.php` 并分析为什么 TTL 设置对该漏洞至关重要。

### 任务 2：Gopher 协议攻击内网 Redis (60 分钟)
**环境**：本地搭建 SSRF 漏洞点 + 内网未授权 Redis。
**要求**：
1. 使用 `Gopherus` 工具生成反弹 Shell 的 Redis Payload。
2. 通过漏洞点发送生成的 Gopher 链接。
3. 成功获取内网服务器权限并记录攻击链路。

---

## 📝 巩固练习

### 练习 1：综合分析题
**题目**：如果一个应用对 SSRF 的防护是：`if (ip.startsWith("192.168.")) return error;`，请列出 3 种可能的绕过方式。
**参考答案**：
1.  **进制转换**：将 IP 转为十六进制 `0xC0A8...` 或十进制整数。
2.  **DNS 解析**：使用一个 A 记录指向 `192.168.x.x` 的自定义域名。
3.  **URL 解析差异**：`http://attacker.com@192.168.x.x`（视解析库而定）。

### 练习 2：简答题
**题目**：在进行 SSRF 攻击 Redis 时，为什么需要对 Payload 进行二次 URL 编码？
**参考答案**：因为第一次 URL 编码在 Web 服务器接收到请求时会被解码。由于 Gopher 协议需要保留 `%0d%0a` 等控制字符来模拟 TCP 交互，如果只编一次码，解码后会变成原始的换行符，导致 SSRF 链接在传输过程中被截断或失效。

---

## ✅ 评估标准

- [ ] 我理解并能手工构造 IP 地址的进制转换形式。
- [ ] 我能清晰描述 DNS Rebinding 的攻击时序图。
- [ ] 我能熟练使用 Gopherus 生成针对 Redis 的 SSRF Payload。

---

## 💡 知识卡片速查

### SSRF 防御“三原则”
1.  **白名单制**：仅允许协议 (http/https) 和指定的受信任域名。
2.  **禁用非常规协议**：禁用 `gopher`, `dict`, `file` 等。
3.  **二次解析防御**：在解析 DNS 后，对返回的 IP 再次进行合法性检查（注意防止 DNS Rebinding）。

---

> 💬 **老师寄语**：
> SSRF 是连接“外部互联网”与“内部禁区”的桥梁。一个看似微不足道的头像拉取功能，可能是整张内网沦陷的起点。

```bash
git add daily/Day039.md
git commit -m "Day039: 完成 SSRF 深度挖掘与内网穿透利用"
```
