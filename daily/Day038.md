---
title: Day038：高级逻辑漏洞 - 并发、越权与多因素验证突破
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 2g9c4
date: 2026-03-01
updated: 2026-03-01
---

# Day038：高级逻辑漏洞 - 并发、越权与多因素验证突破

- **日期**：2026-03-01
- **周次**：第 6 周
- **模块**：Web 漏洞进阶
- **主题**：高级逻辑漏洞（并发、越权与认证绕过）
- **预计学习时间**：3.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- **深度挖掘 IDOR**：不仅能通过改 ID 查信息，还能掌握复杂的横向/纵向越权链路挖掘。
- **掌握竞争条件 (Race Condition)**：学会利用并发请求（Turbo Intruder）实现余额翻倍、优惠券多领等逻辑利用。
- **突破 2FA/MFA**：了解多因素验证的常见缺陷，掌握绕过二次验证（短信/谷歌验证码）的高级技巧。

<!--more-->

---

## 📚 完整学习内容（必读）

### 一、IDOR (越权漏洞) 的高级挖掘思维

常规 IDOR 是改 `?id=1` 为 `?id=2`。现代应用通常会使用 UUID 或加密 ID 来防范。

#### 1.1 寻找被遗忘的参数
-   **关联参数推导**：如果 `order_id` 是加密的，检查请求中是否有隐藏的 `user_id` 或 `group_id` 是明文递增的。
-   **静态资源越权**：很多 App 的 API 做了校验，但下载发票、导出 PDF 的链接可能是带 ID 的明文 URL。

#### 1.2 参数污染与替换
-   **HPP 绕过**：`GET /api/user/info?id=me&id=1`。WAF 校验了 `me`，但后端处理了 `1`。
-   **覆盖请求**：在 `PUT` 或 `POST` 请求中，在 JSON 体里尝试加入原本不该由用户修改的字段（如 `"role": "admin"`, `"is_verified": true`）。

---

### 二、竞争条件 (Race Condition) 实战

这是由于程序在高并发情况下，“检查状态”和“执行动作”之间存在时间差（Time-of-Check to Time-of-Use, TOCTOU）。

#### 2.1 典型场景
-   **提现/转账**：余额 100 元，同时发送 10 个提现 100 元的请求。如果后端锁机制不严，可能成功提到 1000 元。
-   **积分兑换**：同一秒兑换 5 次同一种限购礼品。

#### 2.2 实战工具：Turbo Intruder (Burp 插件)
-   **核心**：常规 Intruder 请求太慢。Turbo Intruder 使用定制的 HTTP 栈，可以在一秒内发送数百个请求。
-   **关键脚本逻辑**：
    ```python
    def queueRequests(target, wordlists):
        engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30)
        for i in range(30):
            engine.queue(target.req, i, gate='race')
        engine.openGate('race')  # 所有请求同时起跑
    ```

---

### 三、多因素验证 (MFA/2FA) 的突破口

即便有了短信验证码或谷歌验证，逻辑缺陷依然存在。

#### 3.1 流程绕过 (Workflow Bypass)
-   **第一步完成直接跳转**：在输入密码成功后，尝试直接请求“修改密码成功”或“个人中心”的页面，绕过第二步验证码页面。
-   **响应包篡改**：截获验证码校验的响应，将 `{"status": "fail"}` 改为 `{"status": "success"}`（前端校验缺陷）。

#### 3.2 验证码逻辑缺陷
-   **验证码重用**：验证成功后，该验证码未失效，可用于其他账号。
-   **暴力破解**：4 位纯数字验证码，如果没有错误次数限制且没有过期机制，1 分钟内即可爆破。
-   **万能验证码**：某些开发为了调试方便，设置了 `000000` 为万能码。

---

## 🗺️ 知识图谱

```
逻辑漏洞深度矩阵
├── 越权 (Access Control)
│   ├── 横向 (IDOR)
│   ├── 纵向 (Privilege Escalation)
│   └── 跨租户越权 (Multi-tenant)
├── 并发 (Concurrency)
│   ├── 余额/积分套利
│   ├── 抢购/限购绕过
│   └── 逻辑状态锁死
└── 认证 (Authentication)
    ├── MFA 流程绕过
    ├── Session 固定与劫持
    └── 密码重置逻辑缺陷
```

---

## 🔧 实践任务

### 任务 1：利用 Turbo Intruder 挖掘竞争条件 (60 分钟)
**环境**：PortSwigger Academy - "Race conditions" 实验。
**要求**：
1. 安装 Turbo Intruder 插件。
2. 针对“购买礼品卡”功能，编写 Python 脚本实现一次点击多次兑换。
3. 记录成功率并分析为什么普通的 Intruder 无法完成此任务。

### 任务 2：密码重置逻辑 analysis (40 分钟)
**情景**：某网站找回密码分为三步：
1. 输入邮箱 -> 2. 输入 6 位验证码 -> 3. 设置新密码。
**操作**：
1. 分析如果在第 3 步请求中，直接修改 `email` 参数为受害者邮箱，是否能重置他人密码？
2. 如果验证码在响应包里明文返回了，这属于什么漏洞？

---

## 📝 巩固练习

### 练习 1：场景分析
**题目**：你在测试一个社交 App 时发现，虽然好友列表是加密 ID，但“拉黑好友”的接口使用的是明文递增 ID。你能通过这个点实现什么攻击？
**参考答案**：IDOR 攻击。通过遍历明文递增 ID 发送拉黑请求，攻击者可以恶意拉黑全服所有用户，甚至导致管理员账号无法正常操作业务。

### 练习 2：简答题
**题目**：在代码层面，防止“竞争条件”漏洞的最有效手段是什么？
**参考答案**：**数据库行级锁 (Select ... For Update)** 或 **分布式锁 (Redis Lock)**。必须确保在事务执行期间，相关数据状态被锁定，其他并发请求无法进行修改。

---

## ✅ 评估标准

- [ ] 我能熟练使用 Turbo Intruder 发起并发竞争测试。
- [ ] 我理解横向越权与纵向越权的区别，并能举出 3 个真实场景例子。
- [ ] 我掌握了 3 种以上的 MFA 绕过思维。

---

## 💡 知识卡片速查

### 逻辑漏洞挖掘“三字诀”
1.  **看**：看隐藏字段、看流程跳转、看参数特征。
2.  **改**：改 ID、改响应包、改操作权限。
3.  **快**：用并发（Turbo Intruder）突破后端处理时间差。

---

> 💬 **老师寄语**：
> 扫描器只能发现“错误的代码”，而你存在的意义是发现“错误的业务”。

```bash
git add daily/Day038.md
git commit -m "Day038: 完成高级逻辑漏洞与并发利用"
```
