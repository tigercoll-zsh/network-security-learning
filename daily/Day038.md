---
title: Day038ï¼šWeb å®‰å…¨ - è¾“å…¥æ ¡éªŒä¸æ³¨å…¥ï¼ˆSQLi/XSSï¼‰
tags:
  - ç½‘ç»œ
  - å®‰å…¨
  - å­¦ä¹ è®¡åˆ’
categories:
  - ç½‘ç»œå®‰å…¨
abbrlink: 86eeb9f5
date: 2026-01-31 00:00:00
updated: 2026-01-31 00:00:00

---
# Day038ï¼šWeb å®‰å…¨ - è¾“å…¥æ ¡éªŒä¸æ³¨å…¥ï¼ˆSQLi/XSSï¼‰

- æ—¥æœŸï¼š2026-01-31
- å‘¨æ¬¡ï¼šç¬¬6å‘¨

## å­¦ä¹ ç›®æ ‡
- ç†è§£æ³¨å…¥çš„æ ¹å› ä¸é˜²æŠ¤
- èƒ½åœ¨æˆæƒé¶åœºè¿›è¡Œæ¼”ç¤ºä¸ä¿®å¤

<!--more-->

## å­¦ä¹ å†…å®¹

### 1ï¸âƒ£ SQL æ³¨å…¥ï¼ˆSQL Injectionï¼‰

#### 1.1 æ ¹å› ï¼šä»£ç ä¸æ•°æ®æ··æ·†

**SQL æ³¨å…¥çš„æœ¬è´¨**ï¼šåº”ç”¨ç¨‹åºå°†ç”¨æˆ·è¾“å…¥ç›´æ¥æ‹¼æ¥åˆ° SQL æŸ¥è¯¢ä¸­ï¼Œå¯¼è‡´æ•°æ®åº“å¼•æ“æ— æ³•åŒºåˆ†ä»£ç å’Œæ•°æ®ã€‚

**ä¸å®‰å…¨çš„ä»£ç ç¤ºä¾‹**ï¼š

```python
# âŒ ä¸å®‰å…¨ï¼šç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥
username = request.form.get("username")
query = f"SELECT * FROM users WHERE username = '{username}'"
# æ”»å‡»è¾“å…¥ï¼šadmin' OR '1'='1
# å®é™…æŸ¥è¯¢ï¼šSELECT * FROM users WHERE username = 'admin' OR '1'='1'
```

**å®‰å…¨çš„ä»£ç ç¤ºä¾‹**ï¼š

```python
# âœ… å®‰å…¨ï¼šå‚æ•°åŒ–æŸ¥è¯¢
username = request.form.get("username")
query = "SELECT * FROM users WHERE username = ?"
cursor.execute(query, [username])
# æ•°æ®åº“è‡ªåŠ¨å¤„ç†å‚æ•°ï¼Œä¸ä¼šå°†å…¶ä½œä¸º SQL ä»£ç æ‰§è¡Œ
```

---

#### 1.2 SQL æ³¨å…¥ç±»å‹

| ç±»å‹ | è¯´æ˜ | æ”»å‡»ç¤ºä¾‹ | é˜²æŠ¤æªæ–½ |
|------|------|---------|---------|
| **ç»å…¸ SQLi** | æ‹¼æ¥å­—ç¬¦ä¸²æ”¹å˜æŸ¥è¯¢ç»“æ„ | `' OR '1'='1` | å‚æ•°åŒ–æŸ¥è¯¢ |
| **ç›²æ³¨ï¼ˆBlind SQLiï¼‰** | æ— ç›´æ¥é”™è¯¯ï¼Œé€šè¿‡å“åº”æ¨æ–­ | `' AND 1=1` | å‚æ•°åŒ–æŸ¥è¯¢ + é˜²æ­¢ä¿¡æ¯æ³„éœ² |
| **æ—¶é—´ç›²æ³¨** | é€šè¿‡å“åº”æ—¶é—´æ¨æ–­æ•°æ® | `' AND SLEEP(5)` | å‚æ•°åŒ–æŸ¥è¯¢ + é™æŸ¥è¯¢æ—¶é—´ |
| **è”åˆæŸ¥è¯¢æ³¨å…¥** | ä½¿ç”¨ UNION è·å–å…¶ä»–è¡¨æ•°æ® | `' UNION SELECT ...` | å‚æ•°åŒ–æŸ¥è¯¢ |
| **äºŒé˜¶æ³¨å…¥** | æ³¨å…¥å€¼å­˜å‚¨ï¼Œåç»­æŸ¥è¯¢æ—¶æ‰§è¡Œ | `admin'--` (æ³¨å†Œï¼‰ | å‚æ•°åŒ–æŸ¥è¯¢ + è¾“å…¥éªŒè¯ |

---

#### 1.3 SQL æ³¨å…¥æ”»å‡»æµç¨‹

**æ ‡å‡†æ”»å‡»æµç¨‹**ï¼š

```
1. å‘ç°æ³¨å…¥ç‚¹
   â”œâ”€ æœç´¢æ¡†ã€ç™»å½•æ¡†ã€å‚æ•°
   â””â”€ æµ‹è¯•ç‰¹æ®Šå­—ç¬¦ï¼š`' " ) ;`

2. åˆ¤æ–­æ•°æ®åº“ç±»å‹
   â”œâ”€ MySQL: `' AND SLEEP(5)--`
   â”œâ”€ PostgreSQL: `' AND pg_sleep(5)--`
   â”œâ”€ SQL Server: `' AND WAITFOR DELAY '0:0:5'--`
   â””â”€ Oracle: `' AND DBMS_LOCK.SLEEP(5)--`

3. æ³¨å°„æµ‹è¯•
   â”œâ”€ ç¡®å®šåˆ—æ•°ï¼š`' ORDER BY 1--`
   â”œâ”€ ç¡®å®šå›æ˜¾ä½ç½®ï¼š`' UNION SELECT 1,2,3--`
   â”œâ”€ è·å–æ•°æ®åº“ä¿¡æ¯ï¼š`' UNION SELECT database(),2,3--`
   â””â”€ è·å–è¡¨/åˆ—/æ•°æ®ï¼š`' UNION SELECT table_name,2,3 FROM information_schema.tables--`

4. æå–æ•°æ®
   â””â”€ é€è¡Œè¯»å–æ•æ„Ÿæ•°æ®

5. å†™ Web Shellï¼ˆå¦‚å¯ï¼‰
   â””â”€ `'; DROP TABLE users; CREATE TABLE shell(cmd text);--`
```

---

#### 1.4 å‚æ•°åŒ–æŸ¥è¯¢è¯¦è§£

**ä¸åŒè¯­è¨€çš„å‚æ•°åŒ–æ–¹å¼**ï¼š

| è¯­è¨€ | å®‰å…¨æ–¹å¼ | ä¸å®‰å…¨æ–¹å¼ |
|------|---------|-----------|
| **Python** | `cursor.execute("SELECT * FROM users WHERE id = ?", [user_id])` | `cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")` |
| **PHP (PDOï¼‰** | `$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");` | `$query = "SELECT * FROM users WHERE id = " . $_GET['id'];` |
| **Java (JDBCï¼‰** | `PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users WHERE id = ?");` | `Statement stmt = conn.createStatement(); stmt.execute("SELECT * FROM users WHERE id = " + id);` |
| **Node.js** | `db.query("SELECT * FROM users WHERE id = ?", [id]);` | `db.query(`SELECT * FROM users WHERE id = ${id}`);` |

---

### 2ï¸âƒ£ XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰

#### 2.1 æ ¹å› ï¼šæœªè½¬ä¹‰çš„è¾“å‡º

**XSS çš„æœ¬è´¨**ï¼šåº”ç”¨ç¨‹åºå°†ç”¨æˆ·è¾“å…¥ç›´æ¥è¾“å‡ºåˆ° HTML é¡µé¢ï¼Œæµè§ˆå™¨å°†å…¶ä½œä¸º JavaScript æ‰§è¡Œã€‚

**ä¸å®‰å…¨çš„ä»£ç ç¤ºä¾‹**ï¼š

```python
# âŒ ä¸å®‰å…¨ï¼šç›´æ¥è¾“å‡ºç”¨æˆ·è¾“å…¥
name = request.form.get("name")
return f"<h1>æ¬¢è¿, {name}!</h1>"

# æ”»å‡»è¾“å…¥ï¼š<script>alert('XSS')</script>
# å®é™…è¾“å‡ºï¼š<h1>æ¬¢è¿, <script>alert('XSS')</script>!</h1>
```

**å®‰å…¨çš„ä»£ç ç¤ºä¾‹**ï¼š

```python
# âœ… å®‰å…¨ï¼šHTML å®ä½“ç¼–ç 
from html import escape

name = request.form.get("name")
safe_name = escape(name)
return f"<h1>æ¬¢è¿, {safe_name}!</h1>"

# æ”»å‡»è¾“å…¥ï¼š<script>alert('XSS')</script>
# å®é™…è¾“å‡ºï¼š<h1>æ¬¢è¿, &lt;script&gt;alert('XSS')&lt;/script&gt;!</h1>
```

---

#### 2.2 XSS ç±»å‹

| ç±»å‹ | è¯´æ˜ | æ”»å‡»ç¤ºä¾‹ | é˜²æŠ¤æªæ–½ |
|------|------|---------|---------|
| **åå°„ XSS** | æ¶æ„ä»£ç åœ¨ URL ä¸­ï¼Œåå°„åˆ°é¡µé¢ | `http://site.com?q=<script>alert(1)</script>` | è¾“å‡ºç¼–ç  + CSP |
| **å­˜å‚¨ XSS** | æ¶æ„ä»£ç å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œæ‰€æœ‰ç”¨æˆ·è®¿é—®æ—¶æ‰§è¡Œ | åœ¨è¯„è®ºæ¡†ä¸­æäº¤è„šæœ¬ | è¾“å‡ºç¼–ç  + è¾“å…¥éªŒè¯ |
| **DOM XSS** | å®¢æˆ·ç«¯ JavaScript å¤„ç†è¾“å…¥æ—¶è§¦å‘ | `location.hash` / `eval()` | é¿å…ä½¿ç”¨å±é™© API + è¾“å…¥éªŒè¯ |

---

#### 2.3 XSS ä¸Šä¸‹æ–‡ä¸ç¼–ç 

**ä¸åŒä¸Šä¸‹æ–‡éœ€è¦ä¸åŒçš„ç¼–ç **ï¼š

```html
<!-- HTML å†…å®¹ä¸Šä¸‹æ–‡ -->
<div>{{ user_input }}</div>
<!-- æ”»å‡»ï¼š<script>alert(1)</script> -->
<!-- é˜²æŠ¤ï¼šHTML å®ä½“ç¼–ç  &lt; &gt; &amp; -->

<!-- HTML å±æ€§ä¸Šä¸‹æ–‡ -->
<input value="{{ user_input }}">
<!-- æ”»å‡»ï¼š" onmouseover="alert(1) -->
<!-- é˜²æŠ¤ï¼šHTML å±æ€§ç¼–ç  &quot; &apos; -->

<!-- JavaScript ä¸Šä¸‹æ–‡ -->
<script>var name = "{{ user_input }}"</script>
<!-- æ”»å‡»ï¼š";alert(1);// -->
<!-- é˜²æŠ¤ï¼šJavaScript Unicode ç¼–ç  \u003c -->

<!-- URL ä¸Šä¸‹æ–‡ -->
<a href="javascript:{{ user_input }}">ç‚¹å‡»</a>
<!-- æ”»å‡»ï¼šalert(1) -->
<!-- é˜²æŠ¤ï¼šURL ç¼–ç  %3C -->
```

---

#### 2.4 CSPï¼ˆå†…å®¹å®‰å…¨ç­–ç•¥ï¼‰

**CSP ä½œç”¨**ï¼šé™åˆ¶æµè§ˆå™¨å¯åŠ è½½çš„èµ„æºæ¥æºï¼Œé˜»æ­¢å†…è”è„šæœ¬ã€‚

**CSP ç¤ºä¾‹**ï¼š

```http
Content-Security-Policy:
  default-src 'self';
  script-src 'self' https://cdn.trusted.com;
  style-src 'self' 'unsafe-inline';
  img-src 'self' data:;
  frame-src 'none';
  object-src 'none';
  base-uri 'self';
  report-uri /csp-violation-report
```

**æŒ‡ä»¤è¯´æ˜**ï¼š

| æŒ‡ä»¤ | è¯´æ˜ | æ¨èè®¾ç½® |
|------|------|---------|
| `default-src` | é»˜è®¤èµ„æºåŠ è½½æº | `'self'` |
| `script-src` | JavaScript è„šæœ¬æº | `'self'`ï¼ˆé¿å… `'unsafe-inline'`ï¼‰ |
| `style-src` | CSS æ ·å¼æº | `'self'` `'unsafe-inline'`ï¼ˆå¦‚æœéœ€è¦ï¼‰ |
| `img-src` | å›¾ç‰‡æº | `'self'` `data:` |
| `frame-src` | iframe æº | `'none'` æˆ–ç™½åå• |
| `object-src` | object/plugin æº | `'none'` |

---

### 3ï¸âƒ£ è¾“å…¥æ ¡éªŒç­–ç•¥

#### 3.1 ç™½åå• vs é»‘åå•

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **ç™½åå•** | ä¸¥æ ¼ã€å¯é¢„æµ‹ | éœ€è¦ç»´æŠ¤ã€å¯èƒ½é™åˆ¶åŠŸèƒ½ | â­â­â­â­â­ **æ¨è** |
| **é»‘åå•** | çµæ´»ã€å®¹æ˜“å®ç° | éš¾ä»¥è¦†ç›–æ‰€æœ‰æ”»å‡» | â­ **ä¸æ¨è** |

**é»‘åå•çš„é—®é¢˜**ï¼š

```python
# âŒ é»‘åå•ï¼ˆä¸å®‰å…¨ï¼‰
blacklist = ["<script>", "alert", "onerror"]
for word in blacklist:
    user_input = user_input.replace(word, "")

# æ”»å‡»ç»•è¿‡ï¼š
# å¤§å°å†™ï¼š<ScRiPt>alert(1)</ScRiPt>
# ç¼–ç ï¼š<script>&#x61;lert(1)</script>
# å˜ä½“ï¼š<img src=x onerror=alert(1)>
```

**ç™½åå•ç¤ºä¾‹**ï¼š

```python
# âœ… ç™½åå•ï¼ˆå®‰å…¨ï¼‰
import re

# åªå…è®¸å­—æ¯æ•°å­—å’Œä¸‹åˆ’çº¿
if not re.match(r'^[a-zA-Z0-9_]+$', username):
    raise ValueError("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")

# åªå…è®¸æ•°å­—ï¼ˆIDï¼‰
if not user_id.isdigit():
    raise ValueError("ID å¿…é¡»ä¸ºæ•°å­—")

# åªå…è®¸ç‰¹å®šæšä¸¾å€¼ï¼ˆè§’è‰²ï¼‰
valid_roles = ["admin", "user", "guest"]
if role not in valid_roles:
    raise ValueError("æ— æ•ˆçš„è§’è‰²")
```

---

#### 3.2 æ ¡éªŒå±‚æ¬¡

**å¤šå±‚æ ¡éªŒç­–ç•¥**ï¼š

```
ç¬¬ 1 å±‚ï¼šè¾“å…¥éªŒè¯ï¼ˆå‰ç«¯ï¼‰
  â”œâ”€ å®¢æˆ·ç«¯å¿«é€Ÿåé¦ˆ
  â”œâ”€ æ”¹å–„ç”¨æˆ·ä½“éªŒ
  â””â”€ ä¸å¯é ï¼ˆå¯ç»•è¿‡ï¼‰

ç¬¬ 2 å±‚ï¼šè¾“å…¥éªŒè¯ï¼ˆåç«¯ï¼‰
  â”œâ”€ ç™½åå•è¿‡æ»¤
  â”œâ”€ ç±»å‹æ£€æŸ¥
  â”œâ”€ é•¿åº¦æ£€æŸ¥
  â””â”€ æ ¼å¼éªŒè¯

ç¬¬ 3 å±‚ï¼šè¾“å‡ºç¼–ç ï¼ˆé˜² XSSï¼‰
  â”œâ”€ HTML å®ä½“ç¼–ç 
  â”œâ”€ JavaScript Unicode ç¼–ç 
  â”œâ”€ URL ç¼–ç 
  â””â”€ ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç¼–ç 

ç¬¬ 4 å±‚ï¼šSQL å®‰å…¨ï¼ˆé˜² SQLiï¼‰
  â”œâ”€ å‚æ•°åŒ–æŸ¥è¯¢
  â”œâ”€ ORM ä½¿ç”¨
  â”œâ”€ è¾“å…¥éªŒè¯ï¼ˆè¾…åŠ©ï¼‰
  â””â”€ æœ€å°æƒé™æ•°æ®åº“ç”¨æˆ·

ç¬¬ 5 å±‚ï¼šCSPï¼ˆæ·±åº¦é˜²å¾¡ï¼‰
  â”œâ”€ é™åˆ¶è„šæœ¬æ¥æº
  â”œâ”€ ç¦ç”¨ eval
  â””â”€ è¿è§„æŠ¥å‘Š
```

---

#### 3.3 å¸¸è§æ ¡éªŒæ¨¡å¼

**ç”¨æˆ·åæ ¡éªŒ**ï¼š

```python
import re

def validate_username(username):
    """éªŒè¯ç”¨æˆ·åï¼ˆç™½åå•ï¼‰"""
    # é•¿åº¦ï¼š3-20 å­—ç¬¦
    if len(username) < 3 or len(username) > 20:
        raise ValueError("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨ 3-20 å­—ç¬¦ä¹‹é—´")
    
    # åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
    if not re.match(r'^[a-zA-Z0-9_-]+$', username):
        raise ValueError("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦")
    
    # ä¸å…è®¸ä¿ç•™å­—
    reserved_names = ["admin", "root", "system"]
    if username.lower() in reserved_names:
        raise ValueError("æ­¤ç”¨æˆ·åä¸å¯ç”¨")
    
    return username
```

**é‚®ç®±æ ¡éªŒ**ï¼š

```python
import re
from email.utils import parseaddr

def validate_email(email):
    """éªŒè¯é‚®ç®±åœ°å€"""
    # åŸºæœ¬æ ¼å¼æ£€æŸ¥
    if not re.match(r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$', email):
        raise ValueError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    
    # è§£æé‚®ç®±
    name, addr = parseaddr(email)
    if not addr:
        raise ValueError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    
    # é•¿åº¦é™åˆ¶
    if len(email) > 254:
        raise ValueError("é‚®ç®±åœ°å€è¿‡é•¿")
    
    return email.lower()  # è½¬å°å†™å­˜å‚¨
```

**æ—¥æœŸæ ¡éªŒ**ï¼š

```python
from datetime import datetime

def validate_date(date_str, format="%Y-%m-%d"):
    """éªŒè¯æ—¥æœŸæ ¼å¼å’ŒèŒƒå›´"""
    try:
        date = datetime.strptime(date_str, format)
        
        # æ—¥æœŸèŒƒå›´æ£€æŸ¥
        min_date = datetime(1900, 1, 1)
        max_date = datetime.now()
        
        if date < min_date or date > max_date:
            raise ValueError("æ—¥æœŸè¶…å‡ºæœ‰æ•ˆèŒƒå›´")
        
        return date
    except ValueError:
        raise ValueError("æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®")
```

---

### 4ï¸âƒ£ æ·±åº¦é˜²å¾¡ï¼ˆDefense in Depthï¼‰

#### 4.1 å®‰å…¨ç¼–ç åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **è¾“å…¥éªŒè¯** | æ‰€æœ‰è¾“å…¥å¿…é¡»éªŒè¯å’Œæ¸…ç† | ç™½åå•è¿‡æ»¤ |
| **è¾“å‡ºç¼–ç ** | æ‰€æœ‰è¾“å‡ºå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡ç¼–ç  | HTML/JS/URL ç¼–ç  |
| **å‚æ•°åŒ–æŸ¥è¯¢** | SQL å¿…é¡»ä½¿ç”¨å‚æ•°åŒ– | PreparedStatement |
| **æœ€å°æƒé™** | æ•°æ®åº“/æ–‡ä»¶ç³»ç»Ÿæƒé™æœ€å°åŒ– | è¯»å†™ç‰¹å®šç›®å½• |
| **æ·±åº¦é˜²å¾¡** | å¤šå±‚é˜²æŠ¤ï¼Œä»»ä½•ä¸€å±‚å¤±è´¥ä¸å½±å“æ•´ä½“ | è¾“å…¥éªŒè¯ + è¾“å‡ºç¼–ç  + CSP |

---

#### 4.2 å®‰å…¨ç¼–ç æ¸…å•

```markdown
# Web åº”ç”¨å®‰å…¨ç¼–ç æ¸…å•

## è¾“å…¥éªŒè¯
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯
- [ ] ä½¿ç”¨ç™½åå•è€Œéé»‘åå•
- [ ] éªŒè¯æ•°æ®ç±»å‹ã€é•¿åº¦ã€æ ¼å¼
- [ ] æ‹’ç»æ— æ•ˆè¾“å…¥è€Œéä¿®å¤

## è¾“å‡ºç¼–ç 
- [ ] HTML å†…å®¹ä½¿ç”¨ HTML å®ä½“ç¼–ç 
- [ ] HTML å±æ€§ä½¿ç”¨å±æ€§ç¼–ç 
- [ ] JavaScript ä½¿ç”¨ Unicode ç¼–ç 
- [ ] URL ä½¿ç”¨ URL ç¼–ç 
- [ ] JSON ä½¿ç”¨ JSON ç¼–ç 

## SQL å®‰å…¨
- [ ] æ‰€æœ‰ SQL æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- [ ] é¿å…ä½¿ç”¨ ORM çš„ä¸å®‰å…¨æ–¹æ³•
- [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
- [ ] æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨

## XSS é˜²æŠ¤
- [ ] é…ç½® CSP ç­–ç•¥
- [ ] é¿å…ä½¿ç”¨ eval/new Function
- [ ] è®¾ç½® Cookie HttpOnly å’Œ Secure
- [ ] ä½¿ç”¨ SameSite å±æ€§

## æ—¥å¿—å’Œç›‘æ§
- [ ] è®°å½•æ‰€æœ‰å®‰å…¨äº‹ä»¶
- [ ] ä¸è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç /å¡å·ï¼‰
- [ ] å®šæœŸæ£€æŸ¥æ—¥å¿—å¼‚å¸¸
- [ ] é…ç½®å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ
```

## å®è·µä»»åŠ¡ï¼ˆåˆæ³•æˆæƒèŒƒå›´å†…ï¼‰

> **é‡è¦æé†’**ï¼šä»¥ä¸‹å®è·µä»…åœ¨æœ¬åœ°è‡ªå»ºé¶åœºï¼ˆå¦‚ DVWA/Pikachuï¼‰æˆ–æˆæƒæµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œã€‚

---

### ä»»åŠ¡ 1ï¼ˆå¿…åšï¼‰ï¼šåœ¨ DVWA ä¸­æ¼”ç¤º SQL æ³¨å…¥

**ç›®æ ‡**ï¼šä½¿ç”¨ SQL æ³¨å…¥ç»•è¿‡ç™»å½•å¹¶è·å–æ•°æ®ã€‚

**æ­¥éª¤**ï¼š

**1. å¯åŠ¨ DVWA é¶åœº**

```bash
# ä½¿ç”¨ Docker å¯åŠ¨ DVWA
docker run -d -p 8080:80 \
  -e DVWA_USERNAME=admin \
  -e DVWA_PASSWORD=password \
  vulnerables/web-dvwa

# è®¿é—® http://localhost:8080
# é»˜è®¤ç™»å½•ï¼šadmin / password
# å®‰å…¨çº§åˆ«è®¾ç½®ä¸º Lowï¼ˆä¾¿äºæ¼”ç¤ºï¼‰
```

**2. æ¼”ç¤º SQL æ³¨å…¥ï¼ˆLow çº§åˆ«ï¼‰**

```bash
# ä¸å®‰å…¨æŸ¥è¯¢ï¼šç›´æ¥æ‹¼æ¥è¾“å…¥
# PHP ä»£ç ï¼šSELECT * FROM users WHERE user = '$user'

# æµ‹è¯•æ³¨å…¥
# è¾“å…¥ï¼šadmin' OR '1'='1
# å®é™…æŸ¥è¯¢ï¼šSELECT * FROM users WHERE user = 'admin' OR '1'='1'
# ç»“æœï¼šè¿”å›æ‰€æœ‰ç”¨æˆ·ï¼ˆç»•è¿‡å¯†ç éªŒè¯ï¼‰

# ä½¿ç”¨ curl æµ‹è¯•
curl -X POST http://localhost:8080/vulnerabilities/sqli/ \
  -d "id=1' OR '1'='1" \
  -v

# é¢„æœŸç»“æœï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·æ•°æ®
```

**3. æ¼”ç¤ºè”åˆæŸ¥è¯¢æ³¨å…¥**

```bash
# è·å–æ•°æ®åº“ä¿¡æ¯
# è¾“å…¥ï¼š1' UNION SELECT database(),2,3--

# è·å–è¡¨å
# è¾“å…¥ï¼š1' UNION SELECT table_name,2,3 FROM information_schema.tables--

# è·å–åˆ—å
# è¾“å…¥ï¼š1' UNION SELECT column_name,2,3 FROM information_schema.columns--

# è·å–ç”¨æˆ·æ•°æ®
# è¾“å…¥ï¼š1' UNION SELECT user,password,3 FROM users--
```

**4. åˆ†ææ¼æ´ä»£ç **

```php
// Low çº§åˆ«ä»£ç ï¼ˆDVWAï¼‰
$id = $_GET["id"];
$query  = "SELECT first_name, last_name FROM users WHERE user_id = '$id';";  // âŒ ç›´æ¥æ‹¼æ¥
$result = mysql_query($query);
```

---

### ä»»åŠ¡ 2ï¼ˆå¿…åšï¼‰ï¼šä¿®å¤ SQL æ³¨å…¥æ¼æ´

**ç›®æ ‡**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ä¿®å¤ SQL æ³¨å…¥ã€‚

**æ­¥éª¤**ï¼š

**1. PHP ä¿®å¤ç¤ºä¾‹ï¼ˆPDOï¼‰**

```php
// âœ… å®‰å…¨ä»£ç ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
$id = $_GET["id"];

// åˆ›å»º PDO è¿æ¥
$pdo = new PDO("mysql:host=localhost;dbname=dvwa", "root", "password");

// é¢„å¤„ç†è¯­å¥
$stmt = $pdo->prepare("SELECT first_name, last_name FROM users WHERE user_id = :id");

// ç»‘å®šå‚æ•°
$stmt->bindParam(":id", $id, PDO::PARAM_INT);

// æ‰§è¡ŒæŸ¥è¯¢
$stmt->execute();
$result = $stmt->fetchAll();

// ç°åœ¨è¾“å…¥ï¼š1' OR '1'='1 ä¼šè¢«è§†ä¸ºå­—ç¬¦ä¸²ï¼Œä¸ä¼šæ”¹å˜æŸ¥è¯¢ç»“æ„
```

**2. Python ä¿®å¤ç¤ºä¾‹ï¼ˆSQLiteï¼‰**

```python
import sqlite3

def get_user(user_id):
    # âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    conn = sqlite3.connect("database.db")
    cursor = conn.cursor()
    
    # ä½¿ç”¨ ? å ä½ç¬¦
    query = "SELECT * FROM users WHERE user_id = ?"
    cursor.execute(query, [user_id])
    
    result = cursor.fetchall()
    conn.close()
    return result

# æµ‹è¯•
print(get_user(1))  # æ­£å¸¸æŸ¥è¯¢
print(get_user("1' OR '1'='1"))  # ä¸ä¼šæ³¨å…¥ï¼Œè¿”å›ç©ºç»“æœ
```

**3. Java ä¿®å¤ç¤ºä¾‹ï¼ˆJDBCï¼‰**

```java
import java.sql.*;

public class SafeQuery {
    public User getUser(int userId) throws SQLException {
        // âœ… å®‰å…¨ï¼šä½¿ç”¨ PreparedStatement
        String query = "SELECT * FROM users WHERE user_id = ?";
        
        Connection conn = DriverManager.getConnection(url, user, password);
        PreparedStatement stmt = conn.prepareStatement(query);
        
        // ç»‘å®šå‚æ•°
        stmt.setInt(1, userId);
        
        ResultSet rs = stmt.executeQuery();
        
        if (rs.next()) {
            return new User(rs.getInt("id"), rs.getString("username"));
        }
        
        return null;
    }
}
```

**4. éªŒè¯ä¿®å¤**

```bash
# ä¿®å¤åæµ‹è¯•
curl "http://localhost:8080/vulnerabilities/sqli/?id=1' OR '1'='1"

# é¢„æœŸç»“æœï¼šæŸ¥è¯¢å¤±è´¥æˆ–è¿”å›ç©ºç»“æœï¼ˆä¸å†æ³¨å…¥ï¼‰
```

---

### ä»»åŠ¡ 3ï¼ˆå¿…åšï¼‰ï¼šåœ¨ DVWA ä¸­æ¼”ç¤º XSS

**ç›®æ ‡**ï¼šåœ¨ DVWA ä¸­æ¼”ç¤ºåå°„ XSS æ”»å‡»ã€‚

**æ­¥éª¤**ï¼š

**1. è®¿é—® DVWA XSS æ¨¡å—**

```bash
# è®¿é—®åå°„ XSS æ¨¡å—
# http://localhost:8080/vulnerabilities/xss_r/?name=test

# å®‰å…¨çº§åˆ«è®¾ç½®ä¸º Low
```

**2. æ¼”ç¤ºåå°„ XSS**

```bash
# æ„é€ æ¶æ„ URL
# http://localhost:8080/vulnerabilities/xss_r/?name=<script>alert('XSS')</script>

# ä½¿ç”¨ curl æµ‹è¯•
curl "http://localhost:8080/vulnerabilities/xss_r/?name=<script>alert('XSS')</script>"

# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šè¿° URL
# é¢„æœŸç»“æœï¼šå¼¹å‡º alert å¯¹è¯æ¡†ï¼ˆXSS æ‰§è¡ŒæˆåŠŸï¼‰
```

**3. æ¼”ç¤ºå­˜å‚¨ XSS**

```bash
# è®¿é—®å­˜å‚¨ XSS æ¨¡å—ï¼ˆç•™è¨€æ¿ï¼‰
# http://localhost:8080/vulnerabilities/xss_s/

# æäº¤æ¶æ„ç•™è¨€
# Message: <script>alert('Stored XSS')</script>

# åˆ·æ–°é¡µé¢
# é¢„æœŸç»“æœï¼šæ¯æ¬¡è®¿é—®éƒ½ä¼šå¼¹å‡º alertï¼ˆXSS æŒä¹…åŒ–ï¼‰
```

**4. åˆ†ææ¼æ´ä»£ç **

```php
// Low çº§åˆ«ä»£ç ï¼ˆåå°„ XSSï¼‰
$name = $_GET["name"];
echo "<pre>Hello {$name}</pre>";  // âŒ ç›´æ¥è¾“å‡ºç”¨æˆ·è¾“å…¥

// Low çº§åˆ«ä»£ç ï¼ˆå­˜å‚¨ XSSï¼‰
$message = $_POST["message"];
$query  = "INSERT INTO guestbook (message) VALUES ('$message')";  // âŒ ç›´æ¥å­˜å‚¨
$query  = "SELECT message FROM guestbook";
echo $message;  // âŒ ç›´æ¥è¾“å‡º
```

---

### ä»»åŠ¡ 4ï¼ˆå¿…åšï¼‰ï¼šä¿®å¤ XSS æ¼æ´

**ç›®æ ‡**ï¼šä½¿ç”¨è¾“å‡ºç¼–ç ä¿®å¤ XSSã€‚

**æ­¥éª¤**ï¼š

**1. PHP ä¿®å¤ç¤ºä¾‹ï¼ˆhtmlspecialcharsï¼‰**

```php
// âœ… å®‰å…¨ä»£ç ï¼šHTML å®ä½“ç¼–ç 
$name = $_GET["name"];

// ä½¿ç”¨ htmlspecialchars ç¼–ç 
$safe_name = htmlspecialchars($name, ENT_QUOTES, "UTF-8");

echo "<pre>Hello {$safe_name}</pre>";

// æµ‹è¯•
// è¾“å…¥ï¼š<script>alert('XSS')</script>
// è¾“å‡ºï¼š<pre>Hello &lt;script&gt;alert('XSS')&lt;/script&gt;</pre>
// ç»“æœï¼šä¸ä¼šæ‰§è¡Œ JavaScript
```

**2. PHP å­˜å‚¨ XSS ä¿®å¤**

```php
// âœ… å®‰å…¨ä»£ç ï¼šè¾“å‡ºæ—¶ç¼–ç 
$query  = "SELECT message FROM guestbook";
$result = mysql_query($query);

while ($row = mysql_fetch_assoc($result)) {
    // è¾“å‡ºæ—¶ç¼–ç 
    $safe_message = htmlspecialchars($row["message"], ENT_QUOTES, "UTF-8");
    echo "<div>{$safe_message}</div>";
}
```

**3. Python Flask ä¿®å¤ç¤ºä¾‹**

```python
from flask import Flask, request, render_template_string
from markupsafe import escape

app = Flask(__name__)

@app.route("/xss_demo")
def xss_demo():
    name = request.args.get("name", "")
    
    # âŒ ä¸å®‰å…¨ï¼šç›´æ¥è¾“å‡º
    # return f"<h1>Hello, {name}!</h1>"
    
    # âœ… å®‰å…¨ï¼šä½¿ç”¨ escape ç¼–ç 
    safe_name = escape(name)
    return render_template_string("<h1>Hello, {{ name }}!</h1>", name=safe_name)

# æµ‹è¯•
# http://localhost:5000/xss_demo?name=<script>alert(1)</script>
# è¾“å‡ºï¼š&lt;script&gt;alert(1)&lt;/script&gt;
```

**4. é…ç½® CSP**

```php
// æ·»åŠ  CSP å“åº”å¤´
header("Content-Security-Policy: "
    . "default-src 'self'; "
    . "script-src 'self' 'unsafe-inline'; "
    . "style-src 'self' 'unsafe-inline';"
);

// æ›´ä¸¥æ ¼çš„ CSPï¼ˆæ¨èï¼‰
header("Content-Security-Policy: "
    . "default-src 'self'; "
    . "script-src 'self'; "  // ç¦æ­¢å†…è”è„šæœ¬
    . "style-src 'self' 'unsafe-inline';"
);

// ç¦ç”¨å†…è”è„šæœ¬åï¼Œ<script>alert(1)</script> ä¸ä¼šæ‰§è¡Œ
```

**5. éªŒè¯ä¿®å¤**

```bash
# ä¿®å¤åæµ‹è¯•
curl "http://localhost:8080/vulnerabilities/xss_r/?name=<script>alert('XSS')</script>"

# é¢„æœŸç»“æœï¼šè¾“å‡ºç¼–ç åçš„å­—ç¬¦ä¸²ï¼Œä¸ä¼šæ‰§è¡Œ JavaScript
```

---

### ä»»åŠ¡ 5ï¼ˆè¿›é˜¶ï¼‰ï¼šè‡ªåŠ¨åŒ– SQL æ³¨å…¥æ£€æµ‹ï¼ˆSQLMapï¼‰

**ç›®æ ‡**ï¼šä½¿ç”¨ SQLMap è‡ªåŠ¨æ£€æµ‹ SQL æ³¨å…¥æ¼æ´ã€‚

**æ­¥éª¤**ï¼š

**1. å®‰è£… SQLMap**

```bash
# å…‹éš† SQLMap
git clone https://github.com/sqlmapproject/sqlmap.git
cd sqlmap

# æˆ–ä½¿ç”¨ pip
pip install sqlmap
```

**2. åŸºç¡€æ‰«æ**

```bash
# æ‰«æ GET è¯·æ±‚
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1"

# æ‰«æ POST è¯·æ±‚
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/" \
  --data="id=1&submit=Submit"

# æ‰«æå¸¦ Cookie çš„è¯·æ±‚
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/" \
  --cookie="security=low; PHPSESSID=dvwa_session_123"

# æŒ‡å®šæ•°æ®åº“ç±»å‹
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  --dbms=mysql
```

**3. é«˜çº§æ‰«æ**

```bash
# è·å–æ•°æ®åº“åˆ—è¡¨
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  --dbs

# è·å–è¡¨åˆ—è¡¨
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  -D dvwa --tables

# è·å–åˆ—å
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  -D dvwa -T users --columns

# è½¬å‚¨æ•°æ®
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  -D dvwa -T users --dump

# è·å– Shellï¼ˆå¦‚æœå¯èƒ½ï¼‰
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  --os-shell
```

**4. ç»•è¿‡æŠ€æœ¯**

```bash
# ä½¿ç”¨éšæœº User-Agent
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  --random-agent

# ä½¿ç”¨ä»£ç†
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  --proxy=http://127.0.0.1:8080

# ä½¿ç”¨å»¶è¿Ÿï¼ˆé¿å…è§¦å‘ WAFï¼‰
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  --delay=3

# ä½¿ç”¨ Tamper è„šæœ¬ç»•è¿‡
sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" \
  --tamper=space2comment
```

---

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰

---

### ç»ƒä¹  1ï¼šä¸ºä»€ä¹ˆé»‘åå•æ ¡éªŒä¸å¯é ï¼Ÿ

**æ€è·¯æç¤º**ï¼š

- ç¼–ç ç»•è¿‡ï¼ˆURL ç¼–ç ã€Unicodeã€åå…­è¿›åˆ¶ï¼‰
- å¤§å°å†™ç»•è¿‡
- æ³¨é‡Šç»•è¿‡
- å˜ä½“ç»•è¿‡

**å‚è€ƒç­”æ¡ˆ**ï¼š

**é»‘åå•çš„é—®é¢˜**ï¼š

1. **æ— æ³•è¦†ç›–æ‰€æœ‰æ”»å‡»å‘é‡**ï¼š
   ```python
   # âŒ é»‘åå•ï¼ˆä¸å®‰å…¨ï¼‰
   blacklist = ["<script>", "alert", "onerror", "onclick"]
   
   # ç»•è¿‡æ–¹å¼
   # 1. å¤§å°å†™ï¼š<ScRiPt>alert(1)</ScRiPt>
   # 2. ç¼–ç ï¼š<script>&#x61;lert(1)</script>
   # 3. å˜ä½“ï¼š<img src=x onerror=alert(1)>
   ```

2. **æ”»å‡»è€…æ€»æœ‰æ–°æ–¹æ³•**ï¼š
   | ç»•è¿‡æ–¹å¼ | ç¤ºä¾‹ |
   |---------|------|
   | å¤§å°å†™ | `<SCRIPT>alert(1)</SCRIPT>` |
   | URL ç¼–ç  | `<script>%3calert%3e(1)` |
   | Unicode ç¼–ç  | `<scr\u0069pt>alert(1)</scr\u0069pt>` |
   | æ··æ·† | `<scr<script>ipt>alert(1)</scr</script>ipt>` |
   | HTML æ ‡ç­¾å˜ä½“ | `<img src=x onerror=alert(1)>` |
   | äº‹ä»¶å¤„ç†å™¨ | `<body onload=alert(1)>` |

3. **ç™½åå•çš„ä¼˜åŠ¿**ï¼š
   ```python
   # âœ… ç™½åå•ï¼ˆå®‰å…¨ï¼‰
   # åªå…è®¸å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼
   if not re.match(r'^[a-zA-Z0-9 ]+$', user_input):
       raise ValueError("è¾“å…¥åŒ…å«éæ³•å­—ç¬¦")
   
   # å³ä½¿æ”»å‡»è€…å°è¯•ç¼–ç ï¼Œä¹Ÿä¼šè¢«æ‹’ç»
   ```

---

### ç»ƒä¹  2ï¼šç¼–å†™è¾“å…¥æ ¡éªŒç­–ç•¥

**ä»»åŠ¡**ï¼šä¸ºä»¥ä¸‹åœºæ™¯ç¼–å†™å®‰å…¨çš„è¾“å…¥æ ¡éªŒã€‚

**åœºæ™¯ 1ï¼šç”¨æˆ·åæ ¡éªŒ**

```python
import re

def validate_username(username):
    """ç™½åå•æ ¡éªŒç”¨æˆ·å"""
    # é•¿åº¦ï¼š3-20 å­—ç¬¦
    if len(username) < 3 or len(username) > 20:
        raise ValueError("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨ 3-20 å­—ç¬¦ä¹‹é—´")
    
    # ç™½åå•ï¼šåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
    if not re.match(r'^[a-zA-Z0-9_]+$', username):
        raise ValueError("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    
    # ä¿ç•™å­—æ£€æŸ¥
    reserved = ["admin", "root", "system", "api"]
    if username.lower() in reserved:
        raise ValueError("æ­¤ç”¨æˆ·åä¸å¯ç”¨")
    
    return username.lower()
```

**åœºæ™¯ 2ï¼šå¹´é¾„æ ¡éªŒ**

```python
def validate_age(age_str):
    """ç™½åå•æ ¡éªŒå¹´é¾„"""
    # å¿…é¡»æ˜¯æ•°å­—
    if not age_str.isdigit():
        raise ValueError("å¹´é¾„å¿…é¡»æ˜¯æ•°å­—")
    
    age = int(age_str)
    
    # èŒƒå›´ï¼š18-120
    if age < 18 or age > 120:
        raise ValueError("å¹´é¾„å¿…é¡»åœ¨ 18-120 ä¹‹é—´")
    
    return age
```

**åœºæ™¯ 3ï¼šURL æ ¡éªŒ**

```python
import re
from urllib.parse import urlparse

def validate_url(url):
    """ç™½åå•æ ¡éªŒ URL"""
    try:
        parsed = urlparse(url)
        
        # å¿…é¡»æ˜¯ HTTP æˆ– HTTPS
        if parsed.scheme not in ["http", "https"]:
            raise ValueError("URL å¿…é¡»ä½¿ç”¨ HTTP æˆ– HTTPS")
        
        # æ£€æŸ¥åŸŸåç™½åå•
        allowed_domains = ["example.com", "trusted-site.com"]
        if parsed.netloc not in allowed_domains:
            raise ValueError("ä¸å…è®¸çš„åŸŸå")
        
        return url
    except Exception:
        raise ValueError("URL æ ¼å¼ä¸æ­£ç¡®")
```

**åœºæ™¯ 4ï¼šJSON è¾“å…¥æ ¡éªŒ**

```python
import json

def validate_json_input(json_str, schema):
    """æ ¡éªŒ JSON è¾“å…¥"""
    try:
        data = json.loads(json_str)
    except json.JSONDecodeError:
        raise ValueError("JSON æ ¼å¼ä¸æ­£ç¡®")
    
    # ç™½åå•æ ¡éªŒå­—æ®µ
    required_fields = schema["required"]
    for field in required_fields:
        if field not in data:
            raise ValueError(f"ç¼ºå°‘å¿…éœ€å­—æ®µ: {field}")
    
    # æ ¡éªŒæ¯ä¸ªå­—æ®µçš„ç±»å‹å’ŒèŒƒå›´
    for field, rules in schema["fields"].items():
        if field not in data:
            continue
        
        value = data[field]
        
        # ç±»å‹æ ¡éªŒ
        if rules["type"] == "string":
            if not isinstance(value, str):
                raise ValueError(f"å­—æ®µ {field} å¿…é¡»æ˜¯å­—ç¬¦ä¸²")
            if len(value) < rules.get("min_length", 0):
                raise ValueError(f"å­—æ®µ {field} é•¿åº¦è¿‡çŸ­")
            if len(value) > rules.get("max_length", 1000):
                raise ValueError(f"å­—æ®µ {field} é•¿åº¦è¿‡é•¿")
        elif rules["type"] == "integer":
            if not isinstance(value, int):
                raise ValueError(f"å­—æ®µ {field} å¿…é¡»æ˜¯æ•´æ•°")
            if value < rules.get("min_value", 0):
                raise ValueError(f"å­—æ®µ {field} å€¼è¿‡å°")
            if value > rules.get("max_value", 1000000):
                raise ValueError(f"å­—æ®µ {field} å€¼è¿‡å¤§")
    
    return data

# ä½¿ç”¨ç¤ºä¾‹
schema = {
    "required": ["username", "age"],
    "fields": {
        "username": {"type": "string", "min_length": 3, "max_length": 20},
        "age": {"type": "integer", "min_value": 18, "max_value": 120}
    }
}

validate_json_input('{"username":"admin","age":25}', schema)
```

---

### ç»ƒä¹  3ï¼šè®¾è®¡å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•

**ä»»åŠ¡**ï¼šä¸º Web åº”ç”¨å¼€å‘å›¢é˜Ÿè®¾è®¡å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•ã€‚

**å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•**ï¼š

```markdown
# Web åº”ç”¨å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•

## è¾“å…¥éªŒè¯
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯
- [ ] ä½¿ç”¨ç™½åå•è€Œéé»‘åå•
- [ ] éªŒè¯æ•°æ®ç±»å‹ã€é•¿åº¦ã€æ ¼å¼
- [ ] æ‹’ç»æ— æ•ˆè¾“å…¥è€Œéå°è¯•ä¿®å¤
- [ ] åœ¨æœåŠ¡ç«¯éªŒè¯ï¼ˆä¸ä¾èµ–å‰ç«¯ï¼‰

## è¾“å‡ºç¼–ç 
- [ ] HTML å†…å®¹ä½¿ç”¨ HTML å®ä½“ç¼–ç 
- [ ] HTML å±æ€§ä½¿ç”¨å±æ€§ç¼–ç 
- [ ] JavaScript ä½¿ç”¨ Unicode ç¼–ç 
- [ ] URL ä½¿ç”¨ URL ç¼–ç 
- [ ] JSON ä½¿ç”¨ JSON ç¼–ç 
- [ ] é¿å…ä½¿ç”¨ `innerHTML`ï¼Œä½¿ç”¨ `textContent`

## SQL å®‰å…¨
- [ ] æ‰€æœ‰ SQL æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- [ ] é¿å…ä½¿ç”¨ ORM çš„ä¸å®‰å…¨æ–¹æ³•ï¼ˆå¦‚ `raw()`ï¼‰
- [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
- [ ] æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
- [ ] å®šæœŸå®¡è®¡ SQL æŸ¥è¯¢æ—¥å¿—

## XSS é˜²æŠ¤
- [ ] é…ç½® CSP ç­–ç•¥
- [ ] é¿å…ä½¿ç”¨ `eval()` / `new Function()`
- [ ] è®¾ç½® Cookie `HttpOnly` å’Œ `Secure`
- [ ] ä½¿ç”¨ `SameSite` å±æ€§
- [ ] è¾“å‡ºå‰å¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥ç¼–ç 

## è®¤è¯ä¸æˆæƒ
- [ ] å¯†ç ä½¿ç”¨ bcrypt/argon2 å“ˆå¸Œ
- [ ] å®ç°ç™»å½•é€Ÿç‡é™åˆ¶
- [ ] ç™»å½•åé‡æ–°ç”Ÿæˆ Session ID
- [ ] æ•æ„Ÿæ“ä½œè¦æ±‚é‡æ–°è®¤è¯
- [ ] æ£€æŸ¥æƒé™åœ¨æ¯æ¬¡è¯·æ±‚

## æ—¥å¿—ä¸ç›‘æ§
- [ ] è®°å½•æ‰€æœ‰å®‰å…¨äº‹ä»¶
- [ ] ä¸è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç /å¡å·ï¼‰
- [ ] æ—¥å¿—åŒ…å«æ—¶é—´æˆ³ã€ç”¨æˆ·ã€IPã€æ“ä½œ
- [ ] å®šæœŸæ£€æŸ¥æ—¥å¿—å¼‚å¸¸
- [ ] é…ç½®å…¥ä¾µæ£€æµ‹è§„åˆ™
```

---

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰

- âœ… æˆåŠŸåœ¨ DVWA ä¸­æ¼”ç¤ºäº† SQL æ³¨å…¥ï¼ˆLow çº§åˆ«ï¼‰
- âœ… æˆåŠŸä¿®å¤äº† SQL æ³¨å…¥æ¼æ´ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- âœ… æˆåŠŸåœ¨ DVWA ä¸­æ¼”ç¤ºäº† XSSï¼ˆåå°„/å­˜å‚¨ï¼‰
- âœ… æˆåŠŸä¿®å¤äº† XSS æ¼æ´ï¼ˆè¾“å‡ºç¼–ç  + CSPï¼‰
- âœ… ä½¿ç”¨ SQLMap è¿›è¡Œäº†è‡ªåŠ¨åŒ–æ‰«æ
- âœ… ç¼–å†™äº†è¾“å…¥æ ¡éªŒç­–ç•¥ï¼ˆç™½åå•ï¼‰
- âœ… æäº¤äº†æ¼æ´ä»£ç å’Œä¿®å¤ä»£ç å¯¹æ¯”

## å­¦ä¹ æˆæœè¾¾æˆæƒ…å†µï¼ˆç”±å­¦ä¹ è€…å¡«å†™ï¼‰

---

### æˆªå›¾ä¸è¯æ®

- [ ] DVWA SQL æ³¨å…¥ Low çº§åˆ«æ¼æ´æ¼”ç¤ºæˆªå›¾
- [ ] DVWA SQL æ³¨å…¥ä¿®å¤åéªŒè¯æˆªå›¾
- [ ] DVWA åå°„ XSS æ¼æ´æ¼”ç¤ºæˆªå›¾ï¼ˆæµè§ˆå™¨ alertï¼‰
- [ ] DVWA å­˜å‚¨ XSS æ¼æ´æ¼”ç¤ºæˆªå›¾
- [ ] DVWA XSS ä¿®å¤åéªŒè¯æˆªå›¾ï¼ˆç¼–ç è¾“å‡ºï¼‰
- [ ] CSP é…ç½®å‰åå¯¹æ¯”æˆªå›¾
- [ ] SQLMap æ‰«æç»“æœæˆªå›¾ï¼ˆæ•°æ®åº“/è¡¨/æ•°æ®ï¼‰
- [ ] è¾“å…¥æ ¡éªŒä»£ç æˆªå›¾ï¼ˆç™½åå• vs é»‘åå•ï¼‰

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç²˜è´´å…³é”®ç‰‡æ®µï¼‰

**å¯åŠ¨ DVWA é¶åœº**ï¼š

```bash
# ä½¿ç”¨ Docker å¯åŠ¨
docker run -d -p 8080:80 \
  -e DVWA_USERNAME=admin \
  -e DVWA_PASSWORD=password \
  vulnerables/web-dvwa

# è®¿é—®å¹¶è®¾ç½®
# http://localhost:8080/setup.php
# 1. ç‚¹å‡» "Create / Reset Database"
# 2. ç™»å½•ï¼šadmin / password
# 3. è®¾ç½®å®‰å…¨çº§åˆ«ä¸º Low
```

**SQL æ³¨å…¥æ”»å‡»æ¼”ç¤º**ï¼š

```bash
# ä¸å®‰å…¨æŸ¥è¯¢ï¼šç›´æ¥æ‹¼æ¥
# URL: http://localhost:8080/vulnerabilities/sqli/?id=1

# æ³¨å…¥ Payload 1ï¼šç™»å½•ç»•è¿‡
curl -s "http://localhost:8080/vulnerabilities/sqli/?id=1' OR '1'='1"
# è¾“å‡ºï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ï¼ˆç»•è¿‡å¯†ç éªŒè¯ï¼‰

# æ³¨å…¥ Payload 2ï¼šè”åˆæŸ¥è¯¢
curl -s "http://localhost:8080/vulnerabilities/sqli/?id=1' UNION SELECT database(),2,3--"
# è¾“å‡ºï¼šæ˜¾ç¤ºæ•°æ®åº“åï¼ˆdvwaï¼‰

# æ³¨å…¥ Payload 3ï¼šè·å–è¡¨å
curl -s "http://localhost:8080/vulnerabilities/sqli/?id=1' UNION SELECT table_name,2,3 FROM information_schema.tables--"
# è¾“å‡ºï¼šæ˜¾ç¤ºæ‰€æœ‰è¡¨åï¼ˆusers, guestbook, ...ï¼‰

# æ³¨å…¥ Payload 4ï¼šè·å–ç”¨æˆ·æ•°æ®
curl -s "http://localhost:8080/vulnerabilities/sqli/?id=1' UNION SELECT user,password,3 FROM users--"
# è¾“å‡ºï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·åå’Œå¯†ç å“ˆå¸Œ
```

**XSS åå°„æ”»å‡»æ¼”ç¤º**ï¼š

```bash
# æ„é€ æ¶æ„ URL
# http://localhost:8080/vulnerabilities/xss_r/?name=<script>alert('XSS')</script>

# ä½¿ç”¨ curl æµ‹è¯•
curl -s "http://localhost:8080/vulnerabilities/xss_r/?name=<script>alert('XSS')</script>"
# è¾“å‡ºï¼š<pre>Hello <script>alert('XSS')</script>!</pre>

# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šè¿° URL
# é¢„æœŸï¼šå¼¹å‡º alert å¯¹è¯æ¡†ï¼ˆXSS æ‰§è¡ŒæˆåŠŸï¼‰
```

**XSS å­˜å‚¨æ”»å‡»æ¼”ç¤º**ï¼š

```bash
# æäº¤æ¶æ„ç•™è¨€
curl -X POST "http://localhost:8080/vulnerabilities/xss_s/" \
  -d "name=test&message=<script>alert('Stored XSS')</script>&sign=guestbook"

# è®¿é—®ç•™è¨€æ¿
curl -s "http://localhost:8080/vulnerabilities/xss_s/"

# é¢„æœŸï¼šæ¯æ¬¡åˆ·æ–°éƒ½ä¼šå¼¹å‡º alertï¼ˆæŒä¹…åŒ– XSSï¼‰
```

**SQLMap è‡ªåŠ¨åŒ–æ‰«æ**ï¼š

```bash
# åŸºç¡€æ‰«æ
$ sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1"
...
sqlmap identified the following injection point(s) with a total of 32 HTTP(s) requests:
---
Parameter: id (GET)
    Type: boolean-based blind
    Payload: 1' AND 4943=4943
    Title: AND boolean-based blind - WHERE or HAVING clause
...

# è·å–æ•°æ®åº“åˆ—è¡¨
$ sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" --dbs
available databases [2]:
[*] dvwa
[*] information_schema

# è·å–è¡¨åˆ—è¡¨
$ sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" -D dvwa --tables
Database: dvwa
[2 tables]
+-----------+
| guestbook |
| users      |
+-----------+

# è·å–åˆ—å
$ sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" -D dvwa -T users --columns
Database: dvwa
Table: users
[8 columns]
+--------------+
| Column       |
| user_id      |
| first_name   |
| last_name    |
| user         |
| password     |
| avatar       |
| last_login   |
+--------------+

# è½¬å‚¨æ•°æ®
$ sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" -D dvwa -T users --dump
...
Database: dvwa
Table: users
[5 entries]
+---------+------------+-----------+----------+
| user_id | first_name | last_name | user     |
+---------+------------+-----------+----------+
| 1       | admin      | admin     | admin    |
| 2       | Gordon     | Brown     | 1337     |
| 3       | Hack       | Me        | pablo    |
| 4       | Thomas    | O'Connor  | paco     |
| 5       | user1     | user1     | user1    |
+---------+------------+-----------+----------+
```

**è¾“å…¥æ ¡éªŒä»£ç **ï¼š

```python
# ç”¨æˆ·åç™½åå•æ ¡éªŒ
import re

def validate_username(username):
    """ç™½åå•æ ¡éªŒç”¨æˆ·å"""
    # é•¿åº¦ï¼š3-20 å­—ç¬¦
    if len(username) < 3 or len(username) > 20:
        raise ValueError("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨ 3-20 å­—ç¬¦ä¹‹é—´")
    
    # ç™½åå•ï¼šåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
    if not re.match(r'^[a-zA-Z0-9_]+$', username):
        raise ValueError("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    
    # ä¿ç•™å­—æ£€æŸ¥
    reserved = ["admin", "root", "system", "api"]
    if username.lower() in reserved:
        raise ValueError("æ­¤ç”¨æˆ·åä¸å¯ç”¨")
    
    return username.lower()

# æµ‹è¯•
print(validate_username("test_user_123"))  # âœ… é€šè¿‡
print(validate_username("<script>alert(1)</script>"))  # âŒ æ‹’ç»ï¼ˆç‰¹æ®Šå­—ç¬¦ï¼‰
print(validate_username("admin"))  # âŒ æ‹’ç»ï¼ˆä¿ç•™å­—ï¼‰
```

**CSP é…ç½®ç¤ºä¾‹**ï¼š

```nginx
# Nginx CSP é…ç½®
location / {
    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.trusted.com;
        style-src 'self' 'unsafe-inline' https://cdn.trusted.com;
        img-src 'self' data: https:;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://api.example.com;
        media-src 'self';
        object-src 'none';
        frame-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
        report-uri /csp-report;
    " always;

    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
}
```

---

### ç»“è®ºä¸åæ€

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- **SQL æ³¨å…¥æœ¬è´¨**ï¼šä»£ç ä¸æ•°æ®æ··æ·†ï¼Œæ•°æ®åº“å°†ç”¨æˆ·è¾“å…¥ä½œä¸º SQL ä»£ç æ‰§è¡Œ
- **SQL æ³¨å…¥ç±»å‹**ï¼šç»å…¸ SQLiã€ç›²æ³¨ã€è”åˆæŸ¥è¯¢æ³¨å…¥ã€äºŒé˜¶æ³¨å…¥ç­‰
- **SQL æ³¨å…¥é˜²æŠ¤**ï¼šå‚æ•°åŒ–æŸ¥è¯¢ï¼ˆæœ€å¯é ï¼‰ã€è¾“å…¥éªŒè¯ã€æœ€å°æƒé™æ•°æ®åº“ç”¨æˆ·
- **XSS æœ¬è´¨**ï¼šæœªè½¬ä¹‰çš„è¾“å‡ºè¢«æµè§ˆå™¨ä½œä¸º JavaScript æ‰§è¡Œ
- **XSS ç±»å‹**ï¼šåå°„ XSSã€å­˜å‚¨ XSSã€DOM XSS
- **XSS é˜²æŠ¤**ï¼šè¾“å‡ºç¼–ç ï¼ˆHTML/JS/URL ä¸Šä¸‹æ–‡ï¼‰ã€CSPã€HttpOnly Cookieã€SameSite
- **è¾“å…¥æ ¡éªŒåŸåˆ™**ï¼šç™½åå•ä¼˜äºé»‘åå•ï¼ˆæ”»å‡»è€…æ€»æœ‰æ–°ç»•è¿‡æ–¹æ³•ï¼‰
- **è¾“å…¥æ ¡éªŒå±‚æ¬¡**ï¼šå‰ç«¯éªŒè¯ï¼ˆç”¨æˆ·ä½“éªŒï¼‰+ åç«¯éªŒè¯ï¼ˆå®‰å…¨ï¼‰+ è¾“å‡ºç¼–ç ï¼ˆXSSï¼‰+ å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆSQLiï¼‰
- **è‡ªåŠ¨åŒ–æ£€æµ‹**ï¼šSQLMap å¯ä»¥è‡ªåŠ¨å‘ç° SQL æ³¨å…¥æ¼æ´å¹¶è·å–æ•°æ®
- **æ·±åº¦é˜²å¾¡**ï¼šå¤šå±‚é˜²æŠ¤ï¼Œä»»ä½•ä¸€å±‚å¤±è´¥ä¸å½±å“æ•´ä½“å®‰å…¨æ€§

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- æœ€åˆæ··æ·†äº†"å‚æ•°åŒ–æŸ¥è¯¢"å’Œ"é¢„ç¼–è¯‘è¯­å¥"ï¼š
  - å‚æ•°åŒ–æŸ¥è¯¢æ˜¯å®‰å…¨åŸåˆ™ï¼Œé¢„ç¼–è¯‘æ˜¯å®ç°æ–¹å¼ä¹‹ä¸€
  - ä¸åŒè¯­è¨€çš„å®ç°æ–¹å¼ä¸åŒï¼ˆPHP/PDOã€Java/JDBCã€Python/DB-APIï¼‰
- ä¸æ¸…æ¥š XSS çš„ä¸Šä¸‹æ–‡ç¼–ç ï¼š
  - HTML å†…å®¹ã€HTML å±æ€§ã€JavaScriptã€URL éœ€è¦ä¸åŒçš„ç¼–ç æ–¹å¼
  - ç»Ÿä¸€ä½¿ç”¨ `htmlspecialchars` å¯èƒ½å¯¼è‡´æŸäº›ä¸Šä¸‹æ–‡ä¸å®‰å…¨
- å¯¹ CSP çš„æŒ‡ä»¤ç†è§£ä¸å‡†ç¡®ï¼š
  - `script-src 'self'` åªå…è®¸æ¥è‡ªåŒæºçš„è„šæœ¬
  - `script-src 'unsafe-inline'` å…è®¸å†…è”è„šæœ¬ï¼ˆä¸æ¨èï¼‰
  - `default-src` ä½œä¸ºé»˜è®¤ç­–ç•¥ï¼Œå…¶ä»–æŒ‡ä»¤æœªæŒ‡å®šæ—¶ä½¿ç”¨

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å­¦ä¹ æ–‡ä»¶ä¸Šä¼ å’Œè·¯å¾„ç©¿è¶Šæ¼æ´ï¼ˆDay039ï¼‰
- äº†è§£é…ç½®ç±»å®‰å…¨é£é™©
- å­¦ä¹  API å®‰å…¨åŸºç¡€ï¼ˆDay040ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 4 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [ ] ğŸ˜• ç†è§£äº†åŸºæœ¬æ¦‚å¿µï¼Œä½†å®è·µä¸ç†Ÿç»ƒ
- [ ] ğŸ™‚ å®Œæˆäº† SQLi å’Œ XSS çš„æ¼”ç¤º
- [ ] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
- [ ] ğŸ¤© é¢å¤–ä½¿ç”¨ SQLMap è¿›è¡Œäº†æ·±åº¦æ‰«æ

---

## é›†ä¸­å‚è€ƒç­”æ¡ˆï¼ˆå«æ€è·¯ï¼‰

---

### ç»ƒä¹  1 å‚è€ƒç­”æ¡ˆï¼šä¸ºä»€ä¹ˆé»‘åå•æ ¡éªŒä¸å¯é ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜**ï¼š

1. **æ”»å‡»è€…æ€»èƒ½æ‰¾åˆ°æ–°ç»•è¿‡æ–¹æ³•**ï¼š

   | ç»•è¿‡ç±»å‹ | ç¤ºä¾‹ |
   |---------|------|
   | å¤§å°å†™ | `<SCRIPT>alert(1)</SCRIPT>` |
   | URL ç¼–ç  | `%3Cscript%3Ealert(1)%3C/script%3E` |
   | Unicode ç¼–ç  | `\u003cscript\u003ealert(1)\u003c/script\u003e` |
   | HTML å®ä½“ç¼–ç  | `&lt;script&gt;alert(1)&lt;/script&gt;` |
   | æ··æ·† | `<scr<script>ipt>alert(1)</scr<script>ipt>` |
   | HTML æ ‡ç­¾å˜ä½“ | `<img src=x onerror=alert(1)>` |
   | äº‹ä»¶å¤„ç†å™¨ | `<body onload=alert(1)>` |
   | åŒé‡ç¼–ç  | `%253Cscript%253Ealert(1)` |

2. **é»‘åå•æ— æ³•é¢„æµ‹æ‰€æœ‰æ”»å‡»æ–¹å¼**ï¼š

   ```python
   # âŒ é»‘åå•ï¼ˆä¸å®‰å…¨ï¼‰
   blacklist = ["<script>", "alert", "onerror", "onclick", "onload"]
   
   for word in blacklist:
       user_input = user_input.replace(word, "")
   
   # ç»•è¿‡ç¤ºä¾‹
   # <img src=x onmouseover=alert(1)>  # onmouseover ä¸åœ¨é»‘åå•
   # <svg onload=alert(1)>          # svg ä¸åœ¨é»‘åå•
   # javascript:alert(1)            # å†’å·ä¸åœ¨é»‘åå•
   ```

3. **ç™½åå•çš„ä¼˜åŠ¿**ï¼š

   ```python
   # âœ… ç™½åå•ï¼ˆå®‰å…¨ï¼‰
   # åªå…è®¸å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼ã€å¸¸è§æ ‡ç‚¹
   if not re.match(r'^[a-zA-Z0-9 .,!?]+$', user_input):
       raise ValueError("è¾“å…¥åŒ…å«éæ³•å­—ç¬¦")
   
   # æ”»å‡»è€…æ— æ³•ç»•è¿‡
   # <script>alert(1)</script>  # âŒ åŒ…å« < > ( è¢«æ‹’ç»)
   # javascript:alert(1)        # âŒ åŒ…å« : ( è¢«æ‹’ç»ï¼‰
   ```

**å¯¹æ¯”æ€»ç»“**ï¼š

| æ–¹é¢ | é»‘åå• | ç™½åå• |
|------|-------|-------|
| ç»´æŠ¤æˆæœ¬ | é«˜ï¼ˆéœ€è¦ä¸æ–­æ›´æ–°ï¼‰ | ä½ï¼ˆå®šä¹‰æ˜ç¡®ï¼‰ |
| å¯é¢„æµ‹æ€§ | ä½ï¼ˆæ€»æœ‰æ–°ç»•è¿‡ï¼‰ | é«˜ï¼ˆæ¸…æ™°å®šä¹‰ï¼‰ |
| é˜²æŠ¤å¼ºåº¦ | å¼±ï¼ˆè¢«åŠ¨å“åº”ï¼‰ | å¼ºï¼ˆä¸»åŠ¨é˜²å¾¡ï¼‰ |
| ç”¨æˆ·ä½“éªŒ | å¯èƒ½è¯¯æ€ | æ˜ç¡®è§„åˆ™ |

---

### ç»ƒä¹  2 å‚è€ƒç­”æ¡ˆï¼šè¾“å…¥æ ¡éªŒç­–ç•¥

**å®Œæ•´æ ¡éªŒç­–ç•¥**ï¼š

```python
import re
from datetime import datetime
from urllib.parse import urlparse
import json

class InputValidator:
    """è¾“å…¥éªŒè¯å™¨"""
    
    # ç™½åå•è§„åˆ™
    RULES = {
        "username": {
            "pattern": r'^[a-zA-Z0-9_]{3,20}$',
            "min_length": 3,
            "max_length": 20,
            "reserved": ["admin", "root", "system", "api"]
        },
        "email": {
            "pattern": r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$',
            "max_length": 254
        },
        "age": {
            "pattern": r'^\d+$',
            "min_value": 18,
            "max_value": 120
        },
        "url": {
            "allowed_schemes": ["http", "https"],
            "allowed_domains": ["example.com", "trusted-site.com"]
        }
    }
    
    @classmethod
    def validate_username(cls, username):
        """éªŒè¯ç”¨æˆ·å"""
        # é•¿åº¦æ£€æŸ¥
        if len(username) < cls.RULES["username"]["min_length"] or \
           len(username) > cls.RULES["username"]["max_length"]:
            raise ValueError(f"ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨ {cls.RULES['username']['min_length']}-{cls.RULES['username']['max_length']} å­—ç¬¦ä¹‹é—´")
        
        # ç™½åå•æ¨¡å¼åŒ¹é…
        if not re.match(cls.RULES["username"]["pattern"], username):
            raise ValueError("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
        
        # ä¿ç•™å­—æ£€æŸ¥
        if username.lower() in cls.RULES["username"]["reserved"]:
            raise ValueError("æ­¤ç”¨æˆ·åä¸å¯ç”¨")
        
        return username.lower()
    
    @classmethod
    def validate_email(cls, email):
        """éªŒè¯é‚®ç®±åœ°å€"""
        # é•¿åº¦æ£€æŸ¥
        if len(email) > cls.RULES["email"]["max_length"]:
            raise ValueError("é‚®ç®±åœ°å€è¿‡é•¿")
        
        # æ¨¡å¼åŒ¹é…
        if not re.match(cls.RULES["email"]["pattern"], email):
            raise ValueError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
        
        # è§£æéªŒè¯
        from email.utils import parseaddr
        name, addr = parseaddr(email)
        if not addr or "@" not in addr:
            raise ValueError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
        
        return email.lower()
    
    @classmethod
    def validate_age(cls, age_str):
        """éªŒè¯å¹´é¾„"""
        # å¿…é¡»æ˜¯æ•°å­—
        if not age_str.isdigit():
            raise ValueError("å¹´é¾„å¿…é¡»æ˜¯æ•°å­—")
        
        age = int(age_str)
        
        # èŒƒå›´æ£€æŸ¥
        if age < cls.RULES["age"]["min_value"] or \
           age > cls.RULES["age"]["max_value"]:
            raise ValueError(f"å¹´é¾„å¿…é¡»åœ¨ {cls.RULES['age']['min_value']}-{cls.RULES['age']['max_value']} ä¹‹é—´")
        
        return age
    
    @classmethod
    def validate_url(cls, url):
        """éªŒè¯ URL"""
        try:
            parsed = urlparse(url)
            
            # åè®®ç™½åå•
            if parsed.scheme not in cls.RULES["url"]["allowed_schemes"]:
                raise ValueError(f"åªå…è®¸ä»¥ä¸‹åè®®: {', '.join(cls.RULES['url']['allowed_schemes'])}")
            
            # åŸŸåç™½åå•
            if parsed.netloc not in cls.RULES["url"]["allowed_domains"]:
                raise ValueError(f"åªå…è®¸è®¿é—®ä»¥ä¸‹åŸŸå: {', '.join(cls.RULES['url']['allowed_domains'])}")
            
            return url
        except Exception:
            raise ValueError("URL æ ¼å¼ä¸æ­£ç¡®")
    
    @classmethod
    def sanitize_html(cls, html):
        """HTML è¾“å‡ºç¼–ç """
        from html import escape
        return escape(html)
    
    @classmethod
    def sanitize_js(cls, js):
        """JavaScript Unicode ç¼–ç """
        result = ""
        for char in js:
            code = ord(char)
            if code > 127:
                result += f"\\u{code:04x}"
            else:
                result += char
        return result

# ä½¿ç”¨ç¤ºä¾‹
validator = InputValidator()

# éªŒè¯ç”¨æˆ·å
try:
    print(validator.validate_username("test_user_123"))  # âœ… é€šè¿‡
    print(validator.validate_username("<script>alert(1)</script>"))  # âŒ æ‹’ç»
except ValueError as e:
    print(f"éªŒè¯å¤±è´¥: {e}")

# éªŒè¯é‚®ç®±
try:
    print(validator.validate_email("user@example.com"))  # âœ… é€šè¿‡
    print(validator.validate_email("<script>@evil.com"))  # âœ… é€šè¿‡ï¼ˆå…è®¸åœ¨@å‰ï¼‰
except ValueError as e:
    print(f"éªŒè¯å¤±è´¥: {e}")

# HTML è¾“å‡ºç¼–ç 
html_input = "<script>alert('XSS')</script>"
safe_output = validator.sanitize_html(html_input)
print(f"å®‰å…¨è¾“å‡º: {safe_output}")
# è¾“å‡º: &lt;script&gt;alert('XSS')&lt;/script&gt;
```

---

### ç»ƒä¹  3 å‚è€ƒç­”æ¡ˆï¼šå®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•

**å®Œæ•´æ£€æŸ¥æ¸…å•**ï¼š

```markdown
# Web åº”ç”¨å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•

## Phase 1: å¼€å‘é˜¶æ®µ

### è¾“å…¥éªŒè¯
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯
- [ ] ä½¿ç”¨ç™½åå•è€Œéé»‘åå•
- [ ] éªŒè¯æ•°æ®ç±»å‹ã€é•¿åº¦ã€æ ¼å¼
- [ ] æ‹’ç»æ— æ•ˆè¾“å…¥è€Œéå°è¯•ä¿®å¤
- [ ] åœ¨æœåŠ¡ç«¯éªŒè¯ï¼ˆä¸ä¾èµ–å‰ç«¯ï¼‰

### è¾“å‡ºç¼–ç 
- [ ] HTML å†…å®¹ä½¿ç”¨ HTML å®ä½“ç¼–ç 
- [ ] HTML å±æ€§ä½¿ç”¨å±æ€§ç¼–ç 
- [ ] JavaScript ä½¿ç”¨ Unicode ç¼–ç 
- [ ] URL ä½¿ç”¨ URL ç¼–ç 
- [ ] JSON ä½¿ç”¨ JSON ç¼–ç 
- [ ] é¿å…ä½¿ç”¨ `innerHTML`ï¼Œä½¿ç”¨ `textContent`
- [ ] é¿å…ä½¿ç”¨ `eval()` / `new Function()`

### SQL å®‰å…¨
- [ ] æ‰€æœ‰ SQL æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- [ ] é¿å…ä½¿ç”¨ ORM çš„ä¸å®‰å…¨æ–¹æ³•ï¼ˆå¦‚ `raw()`ï¼‰
- [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
- [ ] æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
- [ ] å®šæœŸå®¡è®¡ SQL æŸ¥è¯¢æ—¥å¿—

### XSS é˜²æŠ¤
- [ ] é…ç½® CSP ç­–ç•¥
- [ ] è®¾ç½® Cookie `HttpOnly` å’Œ `Secure`
- [ ] ä½¿ç”¨ `SameSite` å±æ€§
- [ ] è¾“å‡ºå‰å¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥ç¼–ç 
- [ ] é¿å…ä½¿ç”¨å±é™© APIï¼ˆ`eval`, `innerHTML`ï¼‰

### è®¤è¯ä¸æˆæƒ
- [ ] å¯†ç ä½¿ç”¨ bcrypt/argon2 å“ˆå¸Œ
- [ ] å®ç°ç™»å½•é€Ÿç‡é™åˆ¶
- [ ] ç™»å½•åé‡æ–°ç”Ÿæˆ Session ID
- [ ] æ•æ„Ÿæ“ä½œè¦æ±‚é‡æ–°è®¤è¯
- [ ] æ£€æŸ¥æƒé™åœ¨æ¯æ¬¡è¯·æ±‚

## Phase 2: æµ‹è¯•é˜¶æ®µ

### è‡ªåŠ¨åŒ–æµ‹è¯•
- [ ] ä½¿ç”¨ SQLMap æ‰«æ SQL æ³¨å…¥
- [ ] ä½¿ç”¨ XSSer æ‰«æ XSS æ¼æ´
- [ ] ä½¿ç”¨ OWASP ZAP è¿›è¡Œç»¼åˆæ‰«æ
- [ ] é…ç½® CI/CD è‡ªåŠ¨å®‰å…¨æµ‹è¯•

### æ‰‹åŠ¨æµ‹è¯•
- [ ] æµ‹è¯•æ‰€æœ‰è¾“å…¥ç‚¹ï¼ˆè¡¨å•ã€URLã€Headerï¼‰
- [ ] æµ‹è¯•æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- [ ] æµ‹è¯•è®¤è¯å’Œæˆæƒè¾¹ç•Œ
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†å’Œæ—¥å¿—

## Phase 3: éƒ¨ç½²é˜¶æ®µ

### é…ç½®å®‰å…¨
- [ ] ç¦ç”¨è°ƒè¯•æ¨¡å¼
- [ ] é…ç½®å®‰å…¨å“åº”å¤´ï¼ˆCSPã€HSTSã€X-Frame-Optionsï¼‰
- [ ] é…ç½® HTTPS é‡å®šå‘
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™

### æ—¥å¿—ä¸ç›‘æ§
- [ ] è®°å½•æ‰€æœ‰å®‰å…¨äº‹ä»¶
- [ ] ä¸è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¡å·ï¼‰
- [ ] æ—¥å¿—åŒ…å«æ—¶é—´æˆ³ã€ç”¨æˆ·ã€IPã€æ“ä½œ
- [ ] å®šæœŸæ£€æŸ¥æ—¥å¿—å¼‚å¸¸
- [ ] é…ç½®å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ

## Phase 4: ç»´æŠ¤é˜¶æ®µ

### å®šæœŸå®¡è®¡
- [ ] æ¯å‘¨æ£€æŸ¥å®‰å…¨æ—¥å¿—
- [ ] æ¯æœˆè¿›è¡Œä»£ç å®¡è®¡
- [ ] æ¯å­£åº¦è¿›è¡Œæ¸—é€æµ‹è¯•
- [ ] å®šæœŸæ›´æ–°ä¾èµ–åº“

### äº‹ä»¶å“åº”
- [ ] å‡†å¤‡åº”æ€¥å“åº”è®¡åˆ’
- [ ] å®šæœŸæ¼”ç»ƒäº‹ä»¶å“åº”æµç¨‹
- [ ] å»ºç«‹å®‰å…¨äº‹ä»¶æŠ¥å‘Šæœºåˆ¶
```

**ä¼˜å…ˆçº§æ ‡è®°**ï¼š

| ä¼˜å…ˆçº§ | è¯´æ˜ | æ£€æŸ¥é¡¹ç¤ºä¾‹ |
|-------|------|-----------|
| **P0ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰** | ä¸¥é‡å®‰å…¨æ¼æ´ | SQL æ³¨å…¥ã€å­˜å‚¨ XSS |
| **P1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰** | é«˜é£é™©æ¼æ´ | åå°„ XSSã€CSRF |
| **P2ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰** | ä¸­é£é™©æ¼æ´ | ä¿¡æ¯æ³„éœ²ã€ä¼šè¯å›ºå®š |
| **P3ï¼ˆä½ä¼˜å…ˆçº§ï¼‰** | ä½é£é™©é—®é¢˜ | ç¼ºå°‘æ—¥å¿—ã€é…ç½®ä¼˜åŒ– |

---

## å­¦ä¹ æˆæœç¤ºä¾‹å¡«å†™ï¼ˆå¯ç…§æŠ„ï¼‰

> å¯å°†"ç¤ºä¾‹"å†…å®¹æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æ—¶é—´ä¸æˆªå›¾æ–‡ä»¶åã€‚

---

### æˆªå›¾ä¸è¯æ®ï¼ˆç¤ºä¾‹ï¼‰

- DVWA SQL æ³¨å…¥æ¼æ´ï¼š`images/day038_sqli_vulnerable.png`
- DVWA SQL æ³¨å…¥ä¿®å¤ï¼š`images/day038_sqli_fixed.png`
- DVWA åå°„ XSSï¼š`images/day038_xss_reflected.png`
- DVWA å­˜å‚¨ XSSï¼š`images/day038_xss_stored.png`
- CSP é…ç½®ï¼š`images/day038_csp_config.png`
- SQLMap æ‰«æï¼š`images/day038_sqlmap_scan.png`

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

**SQL æ³¨å…¥æ”»å‡»**ï¼š

```bash
$ curl -s "http://localhost:8080/vulnerabilities/sqli/?id=1' OR '1'='1"
ID: 1' OR '1'='1<br>First name: admin<br>Surname: admin<br>ID: 2' OR '1'='1<br>First name: Gordon<br>Surname: Brown
```

**XSS åå°„æ”»å‡»**ï¼š

```bash
# æµè§ˆå™¨è®¿é—®åå¼¹å‡º alert å¯¹è¯æ¡†
http://localhost:8080/vulnerabilities/xss_r/?name=<script>alert('XSS')</script>
```

**SQLMap æ‰«æ**ï¼š

```bash
$ sqlmap -u "http://localhost:8080/vulnerabilities/sqli/?id=1" --dbs
[*] starting @ 12:00:00 /2026-01-31
...
available databases [2]:
[*] dvwa
[*] information_schema
```

---

### ç»“è®ºä¸åæ€ï¼ˆç¤ºä¾‹ï¼‰

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- SQL æ³¨å…¥æ˜¯ä»£ç ä¸æ•°æ®æ··æ·†ï¼Œé€šè¿‡å‚æ•°åŒ–æŸ¥è¯¢å¯ä»¥å®Œå…¨é˜²æŠ¤
- XSS æ˜¯è¾“å‡ºç¼–ç ä¸å½“ï¼Œéœ€è¦æ ¹æ®ä¸åŒä¸Šä¸‹æ–‡ä½¿ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼
- ç™½åå•éªŒè¯ä¼˜äºé»‘åå•ï¼Œå› ä¸ºæ”»å‡»è€…æ€»èƒ½æ‰¾åˆ°æ–°ç»•è¿‡æ–¹æ³•
- CSP æ˜¯æœ‰æ•ˆçš„ XSS é˜²æŠ¤æªæ–½ï¼Œä½†éœ€è¦åˆç†é…ç½®
- è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆå¦‚ SQLMapï¼‰å¯ä»¥å¿«é€Ÿå‘ç° SQL æ³¨å…¥æ¼æ´
- å®‰å…¨ç¼–ç éœ€è¦å¤šå±‚é˜²æŠ¤ï¼ˆè¾“å…¥éªŒè¯ + è¾“å‡ºç¼–ç  + SQL å®‰å…¨ï¼‰

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- XSS çš„ä¸Šä¸‹æ–‡ç¼–ç ï¼ˆHTML å†…å®¹ vs å±æ€§ vs JavaScript vs URLï¼‰
- CSP çš„ `script-src 'unsafe-inline'` å’Œ `script-src 'self'` çš„åŒºåˆ«
- å‚æ•°åŒ–æŸ¥è¯¢åœ¨ä¸åŒè¯­è¨€ä¸­çš„å…·ä½“å®ç°æ–¹å¼

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å­¦ä¹ æ–‡ä»¶ä¸Šä¼ å’Œè·¯å¾„ç©¿è¶Šæ¼æ´ï¼ˆDay039ï¼‰
- äº†è§£é…ç½®ç±»å®‰å…¨é£é™©
- å­¦ä¹  API å®‰å…¨åŸºç¡€ï¼ˆDay040ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 4 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [x] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
