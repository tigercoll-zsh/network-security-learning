---
title: Day062：内网渗透 - 代理隧道入门（frp 实战）
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: a99cf
date: 2026-01-28
updated: 2026-01-28
---

# Day062：内网渗透 - 代理隧道入门（frp 实战）

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | 代理隧道入门（frp 实战） |
| **预计时间** | 3-4 小时 |
| **难度等级** | ⭐⭐⭐ 中级 |

---

## 🔥 今日痛点场景

> **场景**：你通过 Web 漏洞拿到了一台 DMZ 服务器的 shell，但这台机器在内网，你的攻击机无法直接访问内网其他机器。
>
> **问题**：如何让你的 Kali 能够「穿透」这台跳板机，访问内网的其他目标？
>
> **今天的任务**：搭建 frp 隧道，实现从外网访问内网资源。

---

## 🎯 今日目标

完成今天的学习后，你应该能够：

- [ ] 理解正向代理与反向代理的区别
- [ ] 在跳板机上部署 frp 服务端/客户端
- [ ] 配置 socks5 代理隧道
- [ ] 通过 proxychains 让工具走代理访问内网

**闯关条件**：通过 frp 隧道，用 nmap 扫描到内网另一台机器的开放端口。

---

## ⚔️ 实战任务（先动手！）

> 💡 **原则**：先做再说，遇到问题再查资料。别一开始就去背理论。

### 任务 1：环境准备（20 分钟）

**实验拓扑**：

```
┌─────────────────────────────────────────────────────────┐
│  攻击机 (Kali)                                          │
│  IP: 192.168.1.100 (外网)                               │
│                                                          │
│            ↓ frp 反向连接                                │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │  跳板机 (Linux)                                  │    │
│  │  外网 IP: 192.168.1.50                          │    │
│  │  内网 IP: 10.0.0.1                              │    │
│  │                                                  │    │
│  │       ↓ 可访问内网                               │    │
│  │                                                  │    │
│  │  目标机 (Windows)                               │    │
│  │  内网 IP: 10.0.0.100                            │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

**操作步骤**：

1. 下载 frp（在 Kali 上）：
   ```bash
   wget https://github.com/fatedier/frp/releases/download/v0.51.3/frp_0.51.3_linux_amd64.tar.gz
   tar -xzf frp_0.51.3_linux_amd64.tar.gz
   cd frp_0.51.3_linux_amd64
   ```

2. 准备跳板机环境（模拟 DMZ 服务器）

3. 确认网络拓扑可达

**预期结果**：frp 二进制文件准备就绪，实验网络拓扑搭建完成。

---

### 任务 2：配置 frp 服务端（15 分钟）

**在攻击机（Kali）上配置 frps**：

```bash
# 编辑 frps.toml
cat > frps.toml << 'EOF'
bindPort = 7000
EOF

# 启动服务端
./frps -c frps.toml
```

**预期结果**：看到 `frps started successfully` 提示。

---

### 任务 3：配置 frp 客户端建立 socks5 隧道（20 分钟）

**在跳板机上配置 frpc**：

```bash
# 编辑 frpc.toml
cat > frpc.toml << 'EOF'
serverAddr = "192.168.1.100"
serverPort = 7000

[[proxies]]
name = "socks5"
type = "tcp"
remotePort = 1080
[proxies.plugin]
type = "socks5"
EOF

# 启动客户端
./frpc -c frpc.toml
```

**预期结果**：
- frpc 连接成功
- 攻击机 1080 端口开启 socks5 代理

**验证命令**：
```bash
# 在 Kali 上检查端口
ss -tlnp | grep 1080
```

---

### 任务 4：配置 proxychains 并扫描内网（30 分钟）

**配置 proxychains**：

```bash
# 编辑配置文件
sudo vim /etc/proxychains4.conf

# 在最后添加（替换原有的 socks4 行）
socks5 127.0.0.1 1080
```

**通过代理扫描内网**：

```bash
# 通过代理执行 nmap
proxychains4 nmap -sT -Pn 10.0.0.100 -p 22,80,445,3389

# 注意：proxychains 只支持 TCP 连接
# 所以要用 -sT（TCP 连接扫描）而不是 -sS（SYN 扫描）
```

**预期结果**：成功扫描到内网目标机的开放端口。

---

### 任务 5：实战应用 - 通过隧道访问内网服务（20 分钟）

**场景**：内网目标机开放了 80 端口的 Web 服务

```bash
# 通过代理访问内网 Web
proxychains4 curl http://10.0.0.100/

# 配置浏览器走 socks5 代理访问内网 Web
# Firefox: 设置 → 网络设置 → 手动配置代理 → SOCKS 主机: 127.0.0.1:1080
```

**预期结果**：能够访问内网的 Web 服务页面。

---

## ✅ 今日闯关检查

完成以下所有项目，今天的任务就算通过：

| 检查项 | 状态 |
|--------|------|
| frps 在攻击机上运行 | ⬜ |
| frpc 成功连接到 frps | ⬜ |
| 1080 端口开启 socks5 代理 | ⬜ |
| proxychains 配置正确 | ⬜ |
| 通过代理成功扫描内网机器 | ⬜ |

**全部打勾 = Day 62 通关！**

---

## 📖 底层补课（做完实验再看）

> 动手做完了？现在来理解"为什么"。

### 为什么需要代理隧道？

**内网渗透的困境**：

```
攻击机 (外网) ─────✗────→ 内网目标
                  ↑
              防火墙阻断

攻击机 (外网) ──→ 跳板机 (DMZ) ──→ 内网目标
                  ↑
              已被攻陷
```

跳板机可以访问内网，但攻击机不行。代理隧道的作用就是让攻击机的流量「借道」跳板机。

### 正向代理 vs 反向代理

| 类型 | 方向 | 场景 |
|------|------|------|
| **正向代理** | 客户端 → 代理 → 服务端 | 跳板机能出网，主动连攻击机 |
| **反向代理** | 服务端 → 代理 → 客户端 | 跳板机不能出网，攻击机主动连 |

**frp 的典型用法是反向代理**：跳板机（frpc）主动连接攻击机（frps），建立反向隧道。

### socks5 代理原理

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   nmap      │────→│ socks5 代理 │────→│  内网目标   │
│ (proxychains)     │ (frp 隧道)  │     │ 10.0.0.100  │
└─────────────┘     └─────────────┘     └─────────────┘
```

SOCKS5 是应用层代理协议，支持 TCP 和 UDP（frp 目前主要支持 TCP）。

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| frpc 连不上 frps | connection refused | 检查防火墙是否放行 7000 端口 |
| proxychains 不生效 | 还是直连 | 确认配置文件路径正确，用 proxychains4 |
| nmap 扫描失败 | 超时或报错 | 必须用 `-sT` TCP 连接扫描 |
| socks5 代理不通 | curl 超时 | 检查 frpc 的 plugin 配置是否正确 |
| 端口冲突 | 1080 已被占用 | 换一个端口，同时修改 frpc 和 proxychains 配置 |

---

## 💡 知识卡片速查

### frp 常用配置

| 配置项 | 说明 | 示例 |
|--------|------|------|
| `bindPort` | frps 监听端口 | 7000 |
| `serverAddr` | frps 地址 | 192.168.1.100 |
| `remotePort` | 代理对外暴露端口 | 1080 |
| `type` | 代理类型 | tcp/udp/http |

### proxychains 配置

```bash
# /etc/proxychains4.conf 关键配置
dynamic_chain    # 动态链（推荐）
proxy_dns        # DNS 也走代理
socks5 127.0.0.1 1080
```

### 常用代理工具对比

| 工具 | 特点 | 适用场景 |
|------|------|----------|
| **frp** | 功能全面，配置简单 | 通用隧道 |
| **chisel** | 单文件，HTTP 隧道 | 绕防火墙 |
| **ssh** | 系统自带 | 临时隧道 |
| **nps** | Web 管理界面 | 长期控制 |

---

## ❓ 常见问题

**Q1：frp 和 ssh 隧道有什么区别？**

A1：ssh 需要目标开放 22 端口且有凭据；frp 是独立程序，只要能出网就行。frp 功能更丰富，支持多种代理类型。

**Q2：为什么 nmap 要用 -sT 而不是 -sS？**

A2：proxychains 在应用层工作，只能代理完整的 TCP 连接。-sS 发送原始 SYN 包，不经过应用层，所以无法被代理。

**Q3：如何隐藏 frp 流量？**

A3：可以使用 frp 的 TLS 加密，或者配合 WebSocket 伪装成正常 HTTPS 流量。

---

## 🚀 明日预告

**Day 063：SSH 隧道与端口转发**

明天你将：
- 学习 SSH 本地转发和远程转发
- 使用 SSH 动态转发建立 socks 代理
- 对比 SSH 隧道和 frp 的优劣

**准备工作**：确保实验环境的 SSH 服务正常运行。

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> 代理隧道是内网渗透的第一课。没有隧道，你就是个在门外干瞪眼的菜鸟。
>
> frp 配置简单但功能强大，是实战中最常用的工具之一。记住：先搭隧道，再搞渗透。
>
> 今天只是入门，后面还有更多花样：多级代理、协议隧道、流量伪装...慢慢来。

```bash
# 今日通关后执行
echo "Day 062 Complete! frp 隧道搭建成功！"
```
