---
title: Day003：网络与协议基础 - IP、ICMP 与路由基础
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: b912c
date: 2026-01-25
updated: 2026-01-25
---

# Day003：网络与协议基础 - IP、ICMP 与路由基础

- **日期**：2026-01-25
- **周次**：第 1 周
- **模块**：网络与协议基础
- **主题**：IP、ICMP 与路由基础
- **预计学习时间**：2.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- 理解 IP 寻址与子网划分（能手动计算子网）
- 掌握 Ping/Traceroute 的用途与差异
- 理解路由表的基本结构和查询过程
- **了解 ICMP 协议的常见安全问题**
- **初步理解路由安全的重要性**

<!--more-->

## 📚 完整学习内容（必读）

本节包含今天需要学习的全部知识点，请认真阅读并理解。

### 一、概念理解

#### 3.1.1 IP 地址的基本概念
- **IP（Internet Protocol）地址**是网络层的逻辑地址，相当于互联网上的门牌号。
- **版本**：
  - **IPv4**：32 位，如 `192.168.1.1`，目前最常用，但地址已耗尽。
  - **IPv6**：128 位，如 `2001:db8::1`，用于解决地址耗尽问题。
- **作用**：标识网络中的主机和路由器，确保数据包能准确送达目的地。

#### 3.1.2 ICMP 协议简介
- **ICMP（Internet Control Message Protocol）**：互联网控制报文协议。
- **它是 IP 的贴身小秘书**：IP 协议只管发包，不管能不能送到。如果发包失败了（比如路断了、找不到人），谁来汇报？就是 ICMP。
- **用途**：网络诊断（Ping）、错误报告（目的不可达）、路由重定向。

#### 3.1.3 路由的基本概念
- **路由（Routing）**：数据包从源主机到目的主机跨越多个网络的过程，就像开车用导航规划路线。
- **路由器（Router）**：连接不同网络（如你的家庭局域网和互联网）的设备，它负责查看“地图”（路由表），决定数据包往哪个接口发。
- **跳（Hop）**：数据包每经过一个路由器就算一跳。

### 二、原理讲解

#### 3.2.1 子网划分原理（难点突破）
子网划分是为了高效利用 IP 地址，防止浪费。
- **子网掩码（Subnet Mask）**：决定了 IP 地址中哪部分是**网络号**（小区名），哪部分是**主机号**（门牌号）。
- **逻辑与运算**：
  - IP 地址：`192.168.1.5` (二进制 11000000.10101000.00000001.00000101)
  - 掩码：`255.255.255.0` (二进制 11111111.11111111.11111111.00000000)
  - **结果（网络地址）**：`192.168.1.0`
- **示例**：将一个 C 类网络 `192.168.1.0/24` 划分为两个子网。
  - 借用主机位第一位作为子网位（掩码变长 1 位，变成 /25）。
  - 子网 1：`192.168.1.0` ~ `192.168.1.127` (掩码 255.255.255.128)
  - 子网 2：`192.168.1.128` ~ `192.168.1.255` (掩码 255.255.255.128)

#### 3.2.2 Ping 工作原理
Ping 是基于 ICMP 协议的最常用工具。
1. **请求**：主机 A 发送 `ICMP Echo Request`（类型 8）报文给主机 B。
2. **回复**：主机 B 收到后，原样把数据打包，回复 `ICMP Echo Reply`（类型 0）报文。
3. **统计**：主机 A 计算一来一回用了多久（RTT），如果有去无回就是“超时”（Packet Loss）。

#### 3.2.3 Traceroute 工作原理
Traceroute（Windows 下叫 tracert）用于追踪数据包经过了哪些路由器。它利用了 IP 头部的 **TTL（Time To Live）** 字段。
1. **探测第一跳**：发送 TTL=1 的包。第一个路由器收到后，TTL 减 1 变成 0，丢弃包，并回复 `ICMP Time Exceeded`（超时）。源主机收到了，就知道第一个路由器的 IP。
2. **探测第二跳**：发送 TTL=2 的包。经过第一个路由器（TTL=1），到达第二个路由器（TTL=0），回复超时。源主机知道第二个路由器的 IP。
3. **循环**：依次增加 TTL，直到到达目的地。

#### 3.2.4 路由表工作机制
路由表是路由器的“地图”。
- **包含信息**：目的网络、掩码、下一跳地址（Next Hop）、出接口。
- **最长匹配原则**：如果一个 IP 地址匹配多条路由条目，选择掩码最长（最精确）的那一条。
  - 目的 IP：10.1.1.1
  - 路由 A：10.0.0.0/8
  - 路由 B：10.1.0.0/16 （选这个，因为更精确）
- **默认路由**（0.0.0.0/0）：如果查不到具体的路，就走这条“兜底”的路（通常指向互联网出口）。

### 三、技术细节

#### 3.3.1 IP 数据包格式
```
┌─────────────┬─────────────┬─────┬─────┬─────────────┐
│ 版本+首部长 │ 服务类型    │总长度│标识 │标志+片偏移│
│ (1 字节)    │ (1 字节)    │(2)  │(2)  │ (2 字节)   │
├─────────────┼─────────────┼─────┼─────┼─────────────┤
│TTL          │ 协议        │首部校验和│源 IP 地址  │
│ (1 字节)    │ (1 字节)    │(2)  │ (4 字节)   │
├─────────────┼─────────────┼─────┼─────┼─────────────┤
│目的 IP 地址 │ 选项        │填充 │ 数据        │
│ (4 字节)    │ (可变)      │(可变)│ (可变)     │
└─────────────┴─────────────┴─────┴─────────────┘
```
- **TTL**：生存时间，防止数据包在网络中无限循环（路由环路）。每过一个路由器减 1。
- **协议**：指出数据部分是 TCP (6) 还是 UDP (17) 还是 ICMP (1)。

#### 3.3.2 ICMP 报文类型
- **Echo Request (8)** / **Echo Reply (0)**：Ping 命令使用。
- **Destination Unreachable (3)**：目的不可达，原因代码很多（如端口不可达、网络不可达）。
- **Time Exceeded (11)**：TTL 超时，Traceroute 使用。

#### 3.3.3 路由表示例
```
目标网络        子网掩码        网关            接口
0.0.0.0         0.0.0.0         192.168.1.1     以太网 (默认路由)
192.168.1.0     255.255.255.0   在链路上       以太网 (直连路由)
127.0.0.0       255.0.0.0       在链路上       环回   (本地回环)
```

### 四、进阶知识（选学）

#### 3.4.1 CIDR（无类域间路由）
- **CIDR (Classless Inter-Domain Routing)**：打破了传统的 A/B/C 类地址划分限制。
- **斜杠表示法**：`192.168.1.0/24`，`/24` 表示前 24 位是网络位。
- **超网（Supernetting）**：CIDR 不仅可以划分子网，还可以把多个小网络合并成一个大网络（路由汇总），减小路由表体积。

#### 3.4.2 路由协议分类
- **静态路由**：管理员手动一条条配置，稳定但维护麻烦，适合小公司。
- **动态路由**：路由器之间自己“聊天”交换地图，自动适应网络变化。
  - **IGP (内部网关协议)**：企业内部用，如 OSPF (链路状态)、RIP (距离向量)。
  - **EGP (外部网关协议)**：互联网运营商之间用，主要是 BGP。

#### 3.4.3 ICMP 安全考虑
- **Ping of Death**：发送超大尺寸的 ICMP 包导致死机（现在的系统已修复）。
- **ICMP Tunneling**：把数据藏在 ICMP 的数据部分里偷运出去（隐蔽信道）。
- **Smurf 攻击**：伪造受害者的 IP 向广播地址发 Ping，所有人都回复受害者，造成拥堵。
- **策略**：现代防火墙通常会限制或禁止 ICMP 流量，所以 Ping 不通不代表服务器挂了。

### 五、本日知识点速查表

| 序号 | 核心概念 | 关键点 | 备注 |
|------|----------|--------|------|
| 1 | IP 地址 | 网络层逻辑地址 | IPv4/IPv6 |
| 2 | 子网掩码 | 区分网络位/主机位 | 决定子网大小 |
| 3 | TTL | 生存时间 | 防止环路，Traceroute 核心 |
| 4 | 默认路由 | 0.0.0.0/0 | 最后的一根救命稻草 |
| 5 | 下一跳 | 路由路径上的下一站 | 必须是直连的 |

---

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 1 周：网络与协议基础
│   ├── Day001：网络总览、模型与安全基石
│   ├── Day002：以太网、MAC、ARP 与安全风险
│   └── Day003：IP、ICMP 与路由安全基础
│       ├── 核心概念：IP地址、子网掩码、路由表、**ICMP安全、路由劫持**
│       ├── 实践技能：Ping 诊断、Traceroute 路径分析、子网计算
│       └── 关联知识点：CIDR、TTL、ICMP类型
└── 后续衔接
    └── Day004：传输层：TCP 三次握手与四次挥手
```

### 今日关键词

`IP地址` · `子网掩码` · `Ping` · `Traceroute` · `路由` · **`ICMP安全`** · **`路由劫持`**

---

## 🔧 实践任务（合法授权范围内）

> ⚠️ **安全提示**：所有任务必须在合法授权的实验环境中进行，禁止对未授权目标进行任何测试。

请按顺序完成以下任务：

### 任务 1：环境准备与本机 IP 配置确认（5 分钟）

查看本机 IP 配置，确认自己所在的网段，并思考公网/内网 IP 的区别。

**操作步骤**：
1.  打开终端/命令行
2.  输入命令：`ipconfig` (Windows) 或 `ifconfig` (Linux/Mac)
3.  观察输出结果：找到 IPv4 地址、子网掩码、默认网关。
4.  记录下这些信息，并思考：你的 IP 是公网 IP 还是内网 IP？如何判断？
5.  截图保存。

### 任务 2：核心实验：多级 Ping 诊断与 ICMP 报文分析（30 分钟）

测试网络连通性，理解不同 Ping 目标的含义，并思考 ICMP 报文的安全性。

**操作步骤**：
1.  **Ping 本机环回地址**：`ping 127.0.0.1`
    - *目的*：检查 TCP/IP 协议栈是否安装正常。
2.  **Ping 本机 IP**：`ping <你的本机IP>`
    - *目的*：检查网卡驱动是否工作正常。
3.  **Ping 网关地址**：`ping <你的网关IP>` (例如 192.168.1.1)
    - *目的*：检查到路由器的线路是否通畅。
4.  **Ping 公共 DNS**：`ping 8.8.8.8` (Google DNS)
    - *目的*：检查是否能上互联网。
5.  **记录**每次 Ping 的结果和往返时间 (time=xxms)。
6.  **思考**：为什么有些网站可以访问，但 Ping 不通？这在安全上意味着什么？

**预期结果**：
- 结果 1：应该全部通畅，且本地 Ping 时间 < 1ms。
- 结果 2：如果 Ping 8.8.8.8 只有几十毫秒，说明网速不错；如果超时，可能断网或目标限制 ICMP。

### 任务 3：进阶挑战：Traceroute 路径分析与路由安全思考（15 分钟）

使用 Traceroute 分析数据包去往 Google DNS (8.8.8.8) 的路径，并思考路由过程中的安全风险。

**操作步骤**：
1.  Windows：`tracert 8.8.8.8`
2.  Linux/Mac：`traceroute 8.8.8.8`
3.  观察经过的路由器数量（跳数）和每个跳的 IP 地址。
4.  **思考**：
    - 中间路由器出现 `* * *` 通常是什么原因？这对 Traceroute 诊断有什么影响？
    - 如果 Traceroute 结果中出现了意料之外的 IP 地址，或者路径突然变长，这可能意味着什么安全问题？（例如：**路由劫持**的初步思考）

---

## 📝 巩固练习（题目与复盘）

完成以下练习来检验你的学习效果。

### 练习 1：概念理解（5 分钟）

解释 IP 地址和 MAC 地址的区别及其各自的作用。

**参考答案**（完成后对照）：
- **MAC 地址**：物理地址，烧在网卡上，全球唯一，用于**局域网内**两点之间的传输（二层）。
- **IP 地址**：逻辑地址，由管理员分配，可变，用于**互联网上**端到端的寻址（三层）。
- *比喻*：MAC 是身份证号，IP 是收货地址。快递员（路由器）看收货地址（IP）送货，到了小区（局域网）大门，再喊身份证号（MAC）领包裹。

### 练习 2：子网计算与安全思考（10 分钟）

计算 `192.168.1.0/24` 网络的可用主机地址范围。
**扩展思考**：子网划分在网络隔离和安全管理上有何作用？

**参考答案**（完成后对照）：
- **网络地址**：`192.168.1.0`（主机位全 0，不能用）。
- **广播地址**：`192.168.1.255`（主机位全 1，不能用）。
- **可用范围**：`192.168.1.1` 到 `192.168.1.254`。
- **总数**：254 个。
- **扩展思考**：子网划分可以将一个大的网络分成多个小的、独立的网络。这有助于：
    -   **隔离广播域**，减少网络拥堵。
    -   **限制攻击范围**：如果一个子网被攻破，攻击者无法直接访问其他子网的资源。
    -   **实施更精细的安全策略**：例如，为不同子网配置不同的防火墙规则和访问权限。

### 练习 3：Traceroute 与安全风险（10 分钟）

描述 Traceroute 如何确定网络路径。
**扩展思考**：除了 Traceroute 提到的中间路由器可能禁用了 ICMP 回复外，还有哪些情况会导致 Traceroute 的结果不准确或具有误导性？这可能被攻击者利用吗？

**参考答案**（完成后对照）：
它利用了 IP 包的 **TTL (Time To Live)** 机制。
1. 先发一个 TTL=1 的包，第一跳路由器收到后 TTL 归零，丢包并回传“超时”消息，这样就拿到了第一跳的 IP。
2. 再发 TTL=2 的包，穿过第一跳，在第二跳“超时”，拿到第二跳 IP。
3. 依次递增，直到到达终点。
**扩展思考**：
-   **负载均衡**：如果路径中有负载均衡设备，每次请求可能会走不同的路径，导致结果不一致。
-   **防火墙/IPS**：更复杂的安全设备可能会拦截或修改 TTL，导致 Traceroute 结果失真。
-   **路由策略**：某些 ISP 可能有特殊的路由策略，使 Traceroute 结果看起来不合逻辑。
-   **攻击者利用**：攻击者可能通过伪造 ICMP 消息或篡改路由表（如 BGP 劫持）来误导 Traceroute，隐藏其真实路径，或将流量重定向到恶意服务器。这被称为**路由劫持**或**BGP 劫持**。

### 练习 4：深度思考（10 分钟）

路由器在处理数据包时，除了查看目标 IP 地址，还会根据什么来决定转发路径？（提示：回顾路由表的工作机制）

**参考答案**（完成后对照）：
路由器会根据**路由表**来决定转发路径。路由表通常包含以下信息：
-   **目的网络**：数据包要去的网络地址。
-   **子网掩码**：用来精确匹配目的网络。
-   **下一跳地址 (Next Hop)**：数据包应该发送给哪个相邻的路由器。
-   **出接口 (Outgoing Interface)**：数据包应该从哪个端口发出。
当数据包到达路由器时，路由器会查找路由表，并遵循**最长匹配原则**来选择最精确的路由条目。如果找不到精确匹配的条目，则会使用**默认路由**。

---

## ✅ 评估标准（达成判定）

请对照以下标准检查你的学习成果：

- [x] 能正确解释路由表各项的含义
- [x] 能使用 Ping 和 Traceroute 进行基本网络诊断
- [x] 理解子网划分的基本原理（能算出网络地址和广播地址）
- [x] **能说出至少 2 种 ICMP 协议相关的安全问题**
- [x] **能初步思考 Traceroute 结果可能存在的安全风险（如路由劫持）**

### 自检清单

完成学习后，请检查以下项目：

- [ ] **概念理解**：能用自己的话解释今天学到的核心概念（包括 ICMP 安全和路由安全）
- [ ] **实际应用**：能计算简单的子网，并进行 Ping/Traceroute 诊断
- [ ] **动手能力**：能独立完成 Ping 和 Tracert
- [ ] **安全意识**：能对 ICMP 和路由过程中的潜在安全风险有初步认识
- [ ] **时间管理**：能在 2.5 小时内完成今日学习内容

### 学习进度自评

| 评估项目 | 1-5 星 | 备注 |
|----------|--------|------|
| 概念理解 | ⭐⭐⭐⭐⭐ | 是否明白了为什么有了 MAC 还要 IP？**是否了解 ICMP 协议并非绝对安全？** |
| 动手能力 | ⭐⭐⭐⭐⭐ | Tracert 看到路径了吗？ |
| 时间控制 | ⭐⭐⭐⭐⭐ | 子网计算是否花了太多时间？ |
| 学习兴趣 | ⭐⭐⭐⭐⭐ | 觉得网络寻址神奇吗？**对路由劫持等概念是否产生了好奇？** |

---

## 📊 学习成果记录（由学习者填写）

### 学习信息

| 项目 | 内容 |
|------|------|
| 学习日期 | 2026-01-25 |
| 学习时长 | ___ 小时 |
| 完成情况 | ⬜ 已完成 / ⬜ 部分完成 / ⬜ 未完成 |

### 实践任务完成记录

| 任务 | 完成状态 | 关键证据/截图 | 用时 |
|------|----------|---------------|------|
| 任务 1 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：ipconfig | ___ 分钟 |
| 任务 2 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 记录：各级 Ping 延时 | ___ 分钟 |
| 任务 3 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：路由路径追踪 | ___ 分钟 |

### 命令/代码记录

```bash
# 记录你今天使用的命令
ping 127.0.0.1
ping 8.8.8.8
tracert 8.8.8.8

# 记录重要的输出结果
Reply from 8.8.8.8: bytes=32 time=45ms TTL=116
Tracing route to dns.google [8.8.8.8]...
```

### 今日总结与反思

**今日收获**（用 3-5 句话总结今天学到了什么）：

_例如：今天学会了怎么算子网掩码，以前看到 /24 /25 就头大，现在终于懂了。还知道了 Traceroute 原来是靠欺负 TTL 来探测路径的，太聪明了。_

**遇到的问题与解决**：

_例如：算二进制的时候老是算错，后来发现用计算器辅助校验比较好。_

**明日待深化的问题**：

_例如：动态路由协议 OSPF 具体是怎么计算路径的？_

---

## 💡 知识卡片速查

### 核心概念速记

| 概念 | 定义 | 举例 |
|------|------|------|
| **IP** | 互联网协议 | 送快递的信封 |
| **ICMP** | 互联网控制报文协议 | 快递公司的投诉和查询电话 |
| **TTL** | 生存时间 | 快递的保质期，过期销毁 |
| **CIDR** | 无类域间路由 | `/24` 这种写法 |

### 常用命令速查

| 场景 | 命令 (Windows) | 命令 (Linux) | 说明 |
|------|----------------|--------------|------|
| 网络诊断 | `ping <ip>` | `ping <ip>` | 检查连通性 |
| 路径追踪 | `tracert <ip>` | `traceroute <ip>` | 查看经过的路由器 |
| 查看路由表 | `route print` | `ip route` | 查看本机路由规则 |

### 常见错误与解决

| 错误现象 | 可能原因 | 解决方法 |
|----------|----------|----------|
| Ping 127.0.0.1 不通 | 系统协议栈损坏 | 重装 TCP/IP 协议或重置网络 |
| Tracert 全是 * * * | 路径上的防火墙禁用了 ICMP | 正常现象，不代表网络不通 |

---

## ❓ 常见问题与解答

**Q1：为什么 Ping 不通百度，但我能打开百度网页？**

A1：因为有些服务器或者防火墙为了安全（防扫、防攻击），特意配置了“禁止 ICMP 回显”。也就是它收到了你的 Ping，但故意不理你。但 HTTP（网页）端口是开的，所以能访问。

**Q2：127.0.0.1 和 0.0.0.0 有什么区别？**

A2：
- **127.0.0.1**：本地回环地址，代表“我自己”，数据包不离开网卡。
- **0.0.0.0**：
  - 作为源地址时：表示“本机”（DHCP 请求时用）。
  - 作为目的地址时（路由表中）：表示“任意地址”（默认路由）。
  - 监听端口时：表示“监听本机所有网卡的 IP”。

**Q3：网关为什么要设成 192.168.1.1？可以是别的吗？**

A3：可以。网关就是一个局域网内部可以访问的 IP，只要跟你的电脑在同一个子网就行。通常习惯用第一个（.1）或最后一个（.254）IP 做网关，方便记忆。

---

## 🚀 下一步学习预告

**明日主题预告**：Day004 - 传输层：TCP 三次握手与四次挥手

**学习重点预告**：
- TCP 的可靠性机制
- 三次握手（建立连接）
- 四次挥手（断开连接）
- UDP 与 TCP 的区别

**今日学习为明日做铺垫**：
- IP 负责把包送到门口，明天学习的 TCP 负责把包完好无损地交到应用程序手里。

---

## 📖 参考资料

- 📖 官方文档：[RFC 791 - Internet Protocol](https://tools.ietf.org/html/rfc791)
- 🎥 视频教程：B站搜索 "IP 地址与子网划分"
- 🛠️ 实践靶场：[Subnetting Practice](https://subnettingpractice.com/) (练手好去处)
- 📚 参考书籍：《TCP/IP 详解 卷1》第 3 章

---

> 💬 **学习提示**：
> 1. 建议按照文档顺序学习，不要跳跃
> 2. 每个知识点理解后再进行下一步
> 3. 实践任务一定要亲手做，不要只看
> 4. 遇到问题先思考，再查阅资料，最后再问
> 5. 坚持每天完成学习任务并记录成果，90 天后你会感谢现在的自己！
>
> ```bash
> git add daily/Day003.md
> git commit -m "Day003: 完成学习与记录"
> ```
