---
title: Day010：安全协议与加密 - HTTPS 抓包与安全特性
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 7bf8d
date: 2026-02-01
updated: 2026-02-01
---

# Day010：安全协议与加密 - HTTPS 抓包与安全特性

- **日期**：2026-02-01
- **周次**：第 2 周
- **模块**：安全协议与加密
- **主题**：HTTPS 抓包与安全特性
- **预计学习时间**：2.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- 认识 HTTPS 加密不可见正文的特性（与 HTTP 对比）
- 理解 HSTS 的作用及其如何防止降级攻击
- 掌握在 Wireshark 中分析 HTTPS 流量的基本方法
- **理解中间人攻击 (MITM) 的原理及抓包分析的局限性**
- **了解移动端证书固定 (Pinning) 及其对安全测试的影响**

<!--more-->

## 📚 完整学习内容（必读）

本节包含今天需要学习的全部知识点，请认真阅读并理解。

### 一、概念理解

#### 10.1.1 为什么抓包看不到 HTTPS 内容？
- **现象**：你在 Wireshark 里抓 HTTP 包，可以直接看到 `GET /login.php?user=admin`。但抓 HTTPS 包，只能看到一堆乱码（Application Data）。
- **原因**：HTTPS 在传输层之上加了一层 TLS。Wireshark 抓到的是网卡上的电信号，此时数据已经被 TLS 加密了。
- **怎么才能看到**：
  1.  **拥有私钥**：如果你是服务器管理员，把私钥导入 Wireshark（仅限 RSA 算法，且不支持 PFS）。
  2.  **拥有会话密钥**：浏览器可以导出 `SSLKEYLOGFILE`，Wireshark 读取这个日志文件，就能解密（通用方法）。
  3.  **中间人代理**：使用 Burp Suite 或 Fiddler，让它们伪装成服务器和客户端握手（需要安装伪造的根证书）。

#### 10.1.2 中间人攻击 (MITM, Man-In-The-Middle)
- **原理**：黑客悄悄插在你和服务器中间。
  - 你 <-> 黑客（伪装成服务器）：建立加密连接 A。
  - 黑客（伪装成你）<-> 服务器：建立加密连接 B。
- **防范**：核心靠**证书体系**。如果黑客拿不出受信任的证书，浏览器就会报警。

#### 10.1.3 HSTS (HTTP Strict Transport Security)
- **场景**：你第一次在地址栏输入 `baidu.com`（没写 https://），浏览器默认先发一个 HTTP 请求（不安全）。黑客可以在这一瞬间把你劫持到一个假的 HTTP 网站（SSL 剥离攻击）。
- **作用**：HSTS 告诉浏览器：“这个网站必须只能用 HTTPS 访问！以后就算用户输入 HTTP，你也**自动在浏览器内部转换**成 HTTPS 再发出去，别发 HTTP 请求。”
- **Header**：`Strict-Transport-Security: max-age=31536000; includeSubDomains`

### 二、原理讲解

#### 10.2.1 HTTPS 抓包分析流程
在 Wireshark 中，一个标准的 HTTPS 交互包含：

1.  **TCP 三次握手**（明文）：SYN, SYN+ACK, ACK。
2.  **TLS 握手**（部分明文）：
    - `Client Hello`（明文）：看 SNI（域名）、随机数。
    - `Server Hello`（明文）：看选中的加密套件。
    - `Certificate`（部分明文）：可以看到证书信息。
    - `Client Key Exchange`（加密/密文）：预主密钥。
3.  **TLS Application Data**（密文）：这里面包裹的才是 HTTP 请求和响应。在 Wireshark 里只显示为一堆二进制数据。
4.  **TCP 四次挥手**（明文）。

#### 10.2.2 常见的 HTTPS 安全配置
- **强制 HTTPS**：HTTP 301 重定向到 HTTPS。
- **Secure Cookie**：Cookie 加上 `Secure` 标记，禁止在 HTTP 下传输。
- **HttpOnly Cookie**：Cookie 加上 `HttpOnly` 标记，禁止 JavaScript 读取（防 XSS）。
- **HSTS**：强制客户端只发起 HTTPS 请求。

### 三、技术细节

#### 10.3.1 Wireshark 解密 HTTPS（SSLKEYLOGFILE 大法）
这是一种**被动解密**方法，不会破坏连接，非常适合分析。

1.  配置环境变量 `SSLKEYLOGFILE` 指向一个本地文件（如 `d:\tls.log`）。
2.  重启 Chrome/Edge。浏览器会将每次会话的密钥写入这个文件。
3.  在 Wireshark 中设置：`Edit -> Preferences -> Protocols -> TLS -> (Pre)-Master-Secret log filename`，选择该文件。
4.  神奇的事情发生了：原本显示 `Application Data` 的包，现在变成了绿色的 `HTTP/2` 或 `HTTP` 明文！

#### 10.3.2 证书固定 (Certificate Pinning)
- **概念**：App 内置了服务器证书的指纹。
- **作用**：即使你手机里安装了 Fiddler 的伪造根证书，App 发现服务器发来的证书指纹和内置的不一样，依然拒绝连接。
- **影响**：这使得抓取手机 App 的包变得很困难（需要 Hook 绕过）。

### 四、进阶知识（选学）

#### 10.4.1 协议降级攻击
- 黑客拦截流量，把 Client Hello 里的 TLS 1.2/1.3 修改为 SSL 3.0。
- 服务器被迫使用不安全的 SSL 3.0。
- 黑客利用 SSL 3.0 的漏洞（如 POODLE）破解加密。
- **防范**：服务器和客户端都应当彻底禁用老旧协议。

#### 10.4.2 HTTP/2 与 HTTPS
- HTTP/2 协议（多路复用、头部压缩）在浏览器实现中**强制要求**使用 HTTPS。
- 所以现在为了性能升级到 HTTP/2，就必须上 HTTPS。

### 五、本日知识点速查表

| 序号 | 核心概念 | 关键点 | 备注 |
|------|----------|--------|------|
| 1 | Application Data | TLS 包裹的有效载荷 | 抓包看到的是乱码 |
| 2 | MITM | 中间人攻击 | 拦截并篡改 |
| 3 | HSTS | 强制 HTTPS | 响应头控制 |
| 4 | SSLKEYLOGFILE | 解密密钥日志 | Wireshark 解密神器 |

---

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 2 周：安全协议与加密
│   ├── Day009：证书与信任链
│   └── Day010：HTTPS 抓包与安全特性
│       ├── 核心概念：MITM、HSTS
│       ├── 实践技能：Wireshark 解密 HTTPS (原理)
│       └── 关联知识点：App 抓包难点
```

### 今日关键词

`Encryption` · `HSTS` · `Wireshark` · `MITM`

---

## 🔧 实践任务（合法授权范围内）

> ⚠️ **安全提示**：所有任务必须在合法授权的实验环境中进行，禁止对未授权目标进行任何测试。

请按顺序完成以下任务：

### 任务 1：环境准备（5 分钟）

观察浏览器的 HSTS 列表。

**操作步骤**：
1. Chrome 浏览器地址栏输入：`chrome://net-internals/#hsts`。
2. 在 **Query HSTS/PKP domain** 输入框中，输入 `baidu.com` 或 `google.com`。
3. 点击 Query。
4. 观察输出：如果看到 `Found` 和 `mode: FORCE_HTTPS`，说明浏览器已经记住了这个域名必须用 HTTPS。

### 任务 2：核心实验（30 分钟）

Wireshark 抓取并分析 HTTPS 握手细节。

**操作步骤**：
1. 打开 Wireshark，开始捕获。
2. 访问 `https://www.example.com`。
3. 停止捕获，过滤 `tcp.port == 443`。
4. 找到 `Application Data` 数据包。
   - 尝试在下方详情栏查看内容，确认全是乱码。
   - 这证明了 HTTPS 确实在保护你的数据。
5. 找到 `Server Hello` 数据包。
   - 查看它选了什么加密套件（Cipher Suite）。

### 任务 3：进阶挑战（选做，15 分钟）

尝试配置 SSLKEYLOGFILE 解密流量（选做，因为需要重启浏览器）。

**操作步骤**：
1. Windows 设置系统环境变量 `SSLKEYLOGFILE` 为 `C:\temp\ssl.log`。
2. 彻底关闭并重启 Chrome。
3. 打开 Wireshark，设置 TLS Log file 路径。
4. 再次抓包访问 HTTPS 网站。
5. 观察是否能看到明文的 HTTP 请求。

---

## 📝 巩固练习（题目与复盘）

完成以下练习来检验你的学习效果。

### 练习 1：概念理解（5 分钟）

为什么 HTTP 抓包可以直接看到密码，而 HTTPS 抓包不行？

**参考答案**（完成后对照）：
HTTP 是明文传输协议，数据在网线上传输时就是 ASCII 码，抓包工具直接读取显示。HTTPS 在 HTTP 之下加了 TLS 层，数据在发出去之前先被加密成乱码，抓包工具抓到的是密文，没有密钥无法还原成明文。

### 练习 2：实操应用（10 分钟）

简述 HSTS 是如何防止 SSL 剥离攻击的？

**参考答案**（完成后对照）：
SSL 剥离攻击通常发生在用户首次输入 `http://` 时，黑客拦截请求并阻止跳转到 HTTPS。
如果启用了 HSTS，服务器在第一次响应中加上 HSTS 头。浏览器收到后，会把这个域名记入“HSTS 列表”。以后用户哪怕输入 `http://xxx`，浏览器也会**在本地内部**直接拦截，强制改成 `https://xxx` 再发出去。这样黑客就没有任何机会接触到明文的 HTTP 请求了。

### 练习 3：深度思考（10 分钟）

如果我安装了 Fiddler 并信任了它的根证书，为什么有些手机 App 还是抓不到包？

**参考答案**（完成后对照）：
这通常是因为 App 启用了**证书固定 (Certificate Pinning)**（也叫 SSL Pinning）。App 代码里写死了“我只认服务器原本的那张证书（的指纹）”。虽然操作系统信任了 Fiddler 的证书，但 App 自己做了一层额外的校验，发现 Fiddler 发来的证书指纹不对，就直接断开连接。解决方法通常是使用 Frida 等工具 Hook 掉 App 内的校验函数。

---

## ✅ 评估标准（达成判定）

请对照以下标准检查你的学习成果：

- [x] 能解释为什么 Wireshark 默认看不到 HTTPS 内容
- [x] 知道 HSTS 是干什么的
- [x] 能在 Wireshark 中区分握手包和应用数据包

### 自检清单

完成学习后，请检查以下项目：

- [ ] **概念理解**：能解释中间人攻击的原理
- [ ] **实际应用**：能检查一个网站是否开启了 HSTS
- [ ] **动手能力**：能过滤出 HTTPS 的 Application Data
- [ ] **时间管理**：能在 2.5 小时内完成今日学习内容

### 学习进度自评

| 评估项目 | 1-5 星 | 备注 |
|----------|--------|------|
| 概念理解 | ⭐⭐⭐⭐⭐ | HSTS 很有用 |
| 动手能力 | ⭐⭐⭐⭐⭐ | 解密 HTTPS 有点难 |
| 学习兴趣 | ⭐⭐⭐⭐⭐ | 想学怎么抓 App 的包 |

---

## 📊 学习成果记录（由学习者填写）

### 学习信息

| 项目 | 内容 |
|------|------|
| 学习日期 | 2026-02-01 |
| 学习时长 | ___ 小时 |
| 完成情况 | ⬜ 已完成 / ⬜ 部分完成 / ⬜ 未完成 |

### 实践任务完成记录

| 任务 | 完成状态 | 关键证据/截图 | 用时 |
|------|----------|---------------|------|
| 任务 1 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：HSTS 查询结果 | ___ 分钟 |
| 任务 2 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：加密的 Application Data | ___ 分钟 |
| 任务 3 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 记录：是否解密成功 | ___ 分钟 |

### 命令/代码记录

```bash
# 记录你今天使用的命令
chrome://net-internals/#hsts
```

### 今日总结与反思

**今日收获**（用 3-5 句话总结今天学到了什么）：

_例如：今天明白了为什么 HTTPS 是安全的，抓包看到的确实全是乱码。了解了 HSTS 这个强大的安全头，以后配服务器一定要加上。还知道了 App 抓包难是因为有 SSL Pinning。_

**遇到的问题与解决**：

_例如：配置 SSLKEYLOGFILE 没生效，后来发现是因为 Chrome 后台进程没杀干净，完全重启电脑后就好了。_

**明日待深化的问题**：

_例如：HTTPS 的知识学完了，接下来该学什么了？好像该进入 Linux 系统的学习了。（第二周后半程进入 Linux 基础）_

---

## 💡 知识卡片速查

### 核心概念速记

| 概念 | 定义 | 举例 |
|------|------|------|
| **Application Data** | 应用数据 | 加密后的 HTTP 正文 |
| **MITM** | 中间人攻击 | 窃听与篡改 |
| **HSTS** | 严格传输安全 | 强制浏览器用 HTTPS |
| **SSL Pinning** | 证书固定 | 只认指定的证书 |

### 常用命令速查

| 场景 | 命令 | 说明 |
|------|------|------|
| Wireshark 过滤 | `tcp.port==443` | 只看 HTTPS 流量 |
| Wireshark 过滤 | `tls.handshake` | 只看握手包 |

---

## 🚀 下一步学习预告

**明日主题预告**：Day011 - Linux 基础：常用命令与权限管理

**学习重点预告**：
- Linux 目录结构
- 文件操作 (ls, cd, cp, mv, rm)
- 权限管理 (chmod, chown)

**今日学习为明日做铺垫**：
- 协议部分告一段落，明天开始我们将进入黑客最重要的战场——Linux 操作系统。

---

## 📖 参考资料

- 📖 官方文档：[RFC 6797 - HSTS](https://tools.ietf.org/html/rfc6797)
- 🎥 视频教程：B站搜索 "Wireshark 解密 HTTPS"
- 🛠️ 实践工具：Wireshark, Chrome

---

> 💬 **学习提示**：
> 1. 建议按照文档顺序学习，不要跳跃
> 2. 每个知识点理解后再进行下一步
> 3. 实践任务一定要亲手做，不要只看
> 4. 遇到问题先思考，再查阅资料，最后再问
> 5. 坚持每天完成学习任务并记录成果，90 天后你会感谢现在的自己！
>
> ```bash
> git add daily/Day010.md
> git commit -m "Day010: 完成学习与记录"
> ```
