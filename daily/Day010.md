# Day010：安全协议与加密 - HTTPS 抓包与安全特性

- 日期：2026-01-03
- 周次：第 2 周

## 学习目标

学完今天你应该能做到：

- 能用一句话解释：**为什么抓包看不到 HTTPS 正文**，但仍然能分析出很多“元信息”
- 能在 Wireshark 里定位并说明：
  - **TLS 握手**（ClientHello/ServerHello/Certificate）在哪里
  - **应用层协议协商**（ALPN：`h2`/`http/1.1`）在哪里
  - **加密后的应用数据**（Application Data）是什么
- 能用 3 条信息描述一次 HTTPS 会话：访问域名（SNI/Host）、TLS 版本/密码套件、证书主体/颁发者/有效期
- 理解 **HSTS** 的作用、工作方式与限制（理论 + 可观察证据）
- 理解 **中间人攻击（MITM）** 在 HTTPS 下为什么更难成功，以及常见“失败点/防护点”（仅理论，严禁对未授权目标尝试）

## 学习内容

### 1️⃣ 你为什么看不到 HTTPS 正文（但仍然能分析）

一句话：

- HTTPS = HTTP + TLS；**HTTP 报文在 TLS 之后变成密文**，抓包只能看到加密后的字节流。

但注意：看不到“正文”，不代表什么都看不到。你仍然能看到（这就是 HTTPS 流量分析的重点）：

- **服务器 IP/端口**（连接到了谁）
- **SNI（ClientHello 里）**：客户端想访问哪个域名
- **证书链**：服务器声称自己是谁（Subject/Issuer/Validity）
- **TLS 版本与套件/密钥交换信息**：安全强度/兼容性线索
- **ALPN**：最后用的是 HTTP/2（`h2`）还是 HTTP/1.1
- **包大小/方向/时间间隔**：可做性能、行为、异常判断（但不能直接读内容）

### 2️⃣ Wireshark 里 HTTPS 的“可见点”清单

你今天只要牢记这 4 类就够：

1. **握手**（`tls.handshake`）：可见协商参数、证书
2. **Change Cipher Spec / Finished**：握手结束（TLS1.3 结构会和 1.2 不同）
3. **Application Data**：从这里开始基本都是密文（HTTP 正文藏在这里）
4. **告警/失败**（`tls.alert_message`）：握手失败或连接被终止的线索

### 3️⃣ HTTP/2、HTTP/3 与你在抓包里的体现

- **HTTP/1.1 vs HTTP/2**：常见通过 **ALPN** 协商（在 TLS ClientHello/ServerHello 里）
- **HTTP/3**：跑在 QUIC/UDP 之上，抓包里你会看到 `quic`/`udp.port==443`；传统 `tls`/`tcp.port==443` 的视角会不一样

今天先把范围收敛：优先抓 `tcp.port==443` 的 HTTPS（TLS over TCP）。

### 4️⃣ HSTS（HTTP Strict Transport Security）是什么

HSTS 的核心是：

- 网站通过响应头告诉浏览器：**未来一段时间内，访问我时必须用 HTTPS**（不允许降级到 HTTP）。

你能在抓包/命令行里看到的“证据”：

- 响应头：`Strict-Transport-Security: max-age=...; includeSubDomains; preload`

HSTS 的价值（防什么）：

- 防止用户首次输入 `http://` 被中间人诱导降级（SSL Stripping）的那类风险

HSTS 的限制（你要记住的边界）：

- **“第一次访问”问题**：如果浏览器第一次从未通过 HTTPS 成功拿到 HSTS 头，就可能仍有窗口期（靠 preload 列表可以缓解）
- HSTS 不能解决“证书被错误签发/客户端被装了恶意根证书”等更深层问题

### 5️⃣ 中间人攻击（MITM）在 HTTPS 下为什么更难（仅理论）

MITM 想成功，通常需要做到至少一条：

- 拿到一个对该域名“看起来可信”的证书（被受信任 CA 签发，或客户端信任库被植入恶意根）
- 或者让用户忽略证书警告（社工）

因此防护重点也在这几处：

- 正确的证书链校验（Day009）
- HSTS（强制 HTTPS）
- 及时更新系统/浏览器信任库与策略
- 企业环境使用代理/自签根时，需要明确告知与合规管理（否则就是“合法的 MITM”）

## 实践任务（合法授权范围内）

> 目标：证明你“看不到正文”，但能把一次 HTTPS 会话说清楚（证据链：Wireshark + curl）。

### 任务 1：Wireshark 抓一次 HTTPS，并定位 4 个关键点

1. 打开 Wireshark，选择活动网卡开始抓包
2. 浏览器访问：`https://www.bing.com/`（或你常用的 HTTPS 站点）
3. 停止抓包

显示过滤器（建议按顺序做）：

- 只看 443 TCP：`tcp.port == 443`
- 只看 TLS：`tls`
- 只看握手：`tls.handshake`
- ClientHello：`tls.handshake.type == 1`
- ServerHello：`tls.handshake.type == 2`
- Certificate：`tls.handshake.type == 11`
- 告警：`tls.alert_message`

你要在“学习成果”里写清楚并截图：

- 一条 ClientHello（能看到 SNI/ALPN 任意一个即可）
- 一条 ServerHello（能看到选定版本/套件任意一个即可）
- 一条 Certificate（Subject/Issuer/Validity 任意一个即可）
- 一段 Application Data（证明正文已经是密文）

### 任务 2：用 curl 找 2 类证据（HSTS + 协议能力线索）

更稳定的写法（PowerShell 友好）：

```powershell
curl.exe -I --silent --show-error --location https://www.bing.com/
```

你重点找：

- 是否存在 `Strict-Transport-Security`（如果站点有 HSTS）
- 是否出现 `Alt-Svc: h3=...`（提示可能支持 HTTP/3）

如果你想看更详细的协商输出：

```powershell
curl.exe -Iv --silent --show-error https://www.bing.com/
```

### 任务 3：对比两个站点（可选加分）

选两个站点（例如 `bing.com` 和 `github.com`），对比：

- 证书 Issuer 是否不同
- 是否都返回 HSTS
- ALPN 协商结果是否一致（`h2` vs `http/1.1`）

## 巩固练习（题与复盘）

### 题目 1：为什么抓包看不到 HTTPS 正文？

**思路**：先讲“正文在哪一层”，再讲“为什么加密后就看不到”。

**标准答案**：

- HTTPS 的 HTTP 请求/响应正文属于应用层数据，它在 TLS 握手完成后会被加密封装进 **TLS Application Data**。
- 抓包只能看到网络上传输的密文与元信息（IP/端口、握手、证书、包长与时序），因此无法直接读取正文。

### 题目 2：既然看不到正文，抓包分析 HTTPS 还有什么意义？

**思路**：列举“仍可见的证据”与“能解决的问题”。

**标准答案**：

- 仍可见：SNI/证书链/TLS 版本与套件/ALPN/流量方向与时序/告警信息。
- 能做：确认连的是谁、证书是否异常、是否降级/协商失败、是否疑似被企业代理、性能瓶颈（握手慢/重传多）等。

### 练习：解释 HSTS 的效果与限制

**思路**：一句话讲效果 + 两条限制。

**标准答案**：

- 效果：浏览器收到 `Strict-Transport-Security` 后，会在 `max-age` 指定时间内强制对该域名使用 HTTPS，阻止 HTTP 降级。
- 限制：首次访问窗口期（没拿到 HSTS 前仍可能被降级）；以及如果客户端信任库被植入恶意根/证书误签，HSTS 也不能单独解决。

## 评估标准（达成判定）

- 能在 Wireshark 中定位：ClientHello / ServerHello / Certificate / Application Data（至少各 1 条证据）
- 能解释：为什么看不到正文，但能基于握手与元信息做分析
- 能说明：HSTS 的作用与限制，并能在输出中找到 `Strict-Transport-Security`（若目标站点具备）
- 能给出 3 条 MITM 想成功需要满足的条件/防护点（仅理论）

## 学习成果达成情况（由学习者填写）

### 截图与证据

- Wireshark 截图（至少 4 张）：
  1.  ClientHello（SNI/ALPN 任意一个）
  2.  ServerHello（选定版本/套件任意一个）
  3.  Certificate（Subject/Issuer/Validity 任意一个）
  4.  Application Data（证明正文是密文）

### 关键命令与输出

- 命令：
  - `curl.exe -I --silent --show-error --location https://...`
  - （可选）`curl.exe -Iv --silent --show-error https://...`
- 输出关键行摘录：
  - Strict-Transport-Security：
  - Alt-Svc（如有）：

### 结论与反思

- 今天你确认到的 1 个事实证据（来自抓包/输出，不是“感觉”）：
- 你遇到的 1 个坑（例如：抓不到握手/走了 QUIC/输出差异）：
- 明天你想继续深挖的 1 个问题（比如：HTTP/3 在抓包里怎么判定）：

（示例填写，你可以先照抄再改成自己的）

- 今天你确认到的 1 个事实证据：
  - 我在 `curl.exe -I --silent --show-error --location https://github.com/` 的输出里看到了：
    - `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`
    - `Alt-Svc: h3=":443"; ma=...`
      这证明该站点启用了 HSTS，并且通过 Alt-Svc 暗示支持 HTTP/3。
- 我遇到的 1 个坑：
  - 我一开始只用 `tcp.port == 443` 过滤，结果发现有些站点/浏览器可能会走 QUIC（UDP 443），导致我“抓不到想要的握手”。后来我用 `udp.port == 443` / `quic` 再确认是否走了 HTTP/3。
- 明天想继续深挖的 1 个问题：
  - 同一个站点在不同访问方式（浏览器 vs curl）下，ALPN/协议协商是否一致？我能不能在 Wireshark 的 ClientHello/ServerHello 里找到 ALPN 的证据并对上？

---

## 参考答案（含思路，集中作答）

### 题目 1：为什么抓包看不到 HTTPS 正文？

**思路**：正文在哪（HTTP）→ 被谁包住（TLS）→ 加密后叫什么（Application Data）。

**答案**：HTTPS 的 HTTP 正文在 TLS 握手完成后会被加密封装进 TLS Application Data，抓包只能看到密文与元信息，因此看不到明文正文。

### 题目 2：抓不到明文还能分析什么？

**思路**：列“仍可见的信息” → 对应“能解决的问题”。

**答案**：仍可以分析 SNI、证书链、TLS 版本/套件、ALPN、告警、时序与包长等，用于判断连通性/协商失败/证书异常/是否被代理/性能问题。

### 练习：HSTS 的效果与限制

**思路**：效果一句话 + 两条限制。

**答案**：HSTS 通过 `Strict-Transport-Security` 让浏览器在 `max-age` 内强制 HTTPS、防止降级；限制是首次访问窗口期与“信任根被污染/证书误签”等更深层问题仍可能绕过。
