---
title: Day073：内网渗透 - 痕迹清理与反取证
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: 5af67
date: 2026-01-28
updated: 2026-01-28
---

# Day073：内网渗透 - 痕迹清理与反取证

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | 痕迹清理与反取证 |
| **预计时间** | 3 小时 |
| **难度等级** | ⭐⭐⭐⭐ 中高级 |

---

## 🔥 今日痛点场景

> **场景**：渗透测试结束，客户要求你清理所有留下的痕迹。或者你发现蓝队开始调查，需要快速消除证据。
>
> **问题**：哪些地方会留下痕迹？如何有效清理？
>
> **今天的任务**：了解取证分析的关注点，学习痕迹清理技术。

---

## 🎯 今日目标

- [ ] 了解常见的取证分析点
- [ ] 掌握 Windows 痕迹清理
- [ ] 掌握 Linux 痕迹清理
- [ ] 理解反取证技术

**闯关条件**：能够系统性地清理攻击痕迹。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：了解取证关注点（20 分钟）

**取证人员会查看**：

| 类型 | Windows | Linux |
|------|---------|-------|
| 系统日志 | Event Logs | /var/log/* |
| 登录记录 | Security.evtx | wtmp, lastlog |
| 命令历史 | PowerShell 历史 | .bash_history |
| 网络连接 | 防火墙日志 | netstat, iptables |
| 文件操作 | 预读取、跳转列表 | access/modify time |
| 进程信息 | 内存、Prefetch | /proc, core dump |

---

### 任务 2：Windows 日志清理（40 分钟）

**使用 wevtutil**：

```cmd
:: 清除安全日志
wevtutil cl Security

:: 清除系统日志
wevtutil cl System

:: 清除应用程序日志
wevtutil cl Application

:: 清除 PowerShell 日志
wevtutil cl "Windows PowerShell"
wevtutil cl "Microsoft-Windows-PowerShell/Operational"

:: 清除所有日志
for /F "tokens=*" %1 in ('wevtutil.exe el') DO wevtutil.exe cl "%1"
```

**使用 PowerShell**：

```powershell
# 清除所有事件日志
Get-EventLog -LogName * | ForEach { Clear-EventLog $_.Log }

# 清除 PowerShell 历史
Remove-Item (Get-PSReadlineOption).HistorySavePath

# 清除 Recent 文件
Remove-Item -Path "$env:APPDATA\Microsoft\Windows\Recent\*" -Force
```

---

### 任务 3：清理 Windows 其他痕迹（30 分钟）

**Prefetch 文件**：

```cmd
:: 删除预读取文件
del /q /f C:\Windows\Prefetch\*
```

**跳转列表**：

```cmd
:: 删除跳转列表
del /q /f "%APPDATA%\Microsoft\Windows\Recent\AutomaticDestinations\*"
del /q /f "%APPDATA%\Microsoft\Windows\Recent\CustomDestinations\*"
```

**临时文件**：

```cmd
:: 删除临时文件
del /q /f /s %TEMP%\*
del /q /f /s C:\Windows\Temp\*
```

**网络历史**：

```cmd
:: 清除 DNS 缓存
ipconfig /flushdns

:: 清除 ARP 缓存
netsh interface ip delete arpcache
```

---

### 任务 4：Linux 痕迹清理（40 分钟）

**命令历史**：

```bash
# 清除当前会话历史
history -c
history -w

# 清除历史文件
cat /dev/null > ~/.bash_history
cat /dev/null > /root/.bash_history

# 禁用历史记录
unset HISTFILE
export HISTSIZE=0
```

**系统日志**：

```bash
# 清除认证日志
cat /dev/null > /var/log/auth.log
cat /dev/null > /var/log/secure

# 清除系统日志
cat /dev/null > /var/log/syslog
cat /dev/null > /var/log/messages

# 清除登录记录
cat /dev/null > /var/log/wtmp
cat /dev/null > /var/log/btmp
cat /dev/null > /var/log/lastlog
```

**使用 shred 安全删除**：

```bash
# 安全删除文件（覆写多次）
shred -vfz -n 5 /var/log/auth.log
```

---

### 任务 5：时间戳操作（20 分钟）

**Windows**：

```powershell
# 修改文件时间
(Get-Item C:\backdoor.exe).CreationTime = "2020-01-01 12:00:00"
(Get-Item C:\backdoor.exe).LastWriteTime = "2020-01-01 12:00:00"
(Get-Item C:\backdoor.exe).LastAccessTime = "2020-01-01 12:00:00"
```

**Linux**：

```bash
# 修改访问和修改时间
touch -t 202001011200.00 /tmp/backdoor

# 复制其他文件的时间戳
touch -r /bin/ls /tmp/backdoor
```

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 理解取证分析关注点 | ⬜ |
| Windows 日志清理成功 | ⬜ |
| Windows 痕迹清理成功 | ⬜ |
| Linux 痕迹清理成功 | ⬜ |
| 时间戳修改成功 | ⬜ |

---

## 📖 底层补课（做完实验再看）

### 清理 vs 不清理

| 场景 | 建议 |
|------|------|
| 授权渗透测试 | 测试后清理，但需在报告中记录 |
| 红蓝对抗 | 按规则决定是否清理 |
| 非授权攻击 | 不讨论（违法） |

### 无法完全清理的痕迹

- 物理内存（直到重启）
- 网络流量日志（对端）
- SIEM 已采集的日志
- 磁盘底层数据（需要覆写）

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 权限不足 | 无法清除 | 需要管理员权限 |
| 日志远程备份 | 清不干净 | 日志转发到 SIEM 就清不掉了 |
| 文件被占用 | 删除失败 | 停止相关服务或重启 |

---

## 💡 知识卡片速查

### 快速清理命令

| 系统 | 目标 | 命令 |
|------|------|------|
| Windows | 日志 | `wevtutil cl Security` |
| Windows | Prefetch | `del C:\Windows\Prefetch\*` |
| Linux | 历史 | `history -c && cat /dev/null > ~/.bash_history` |
| Linux | 日志 | `cat /dev/null > /var/log/auth.log` |

---

## 🚀 明日预告

**Day 074：内网渗透 - Week 11-12 综合实战**

明天你将：
- 完成内网渗透综合实战
- 从信息收集到域控攻击
- 完成完整攻击链

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> 痕迹清理是双刃剑。知道怎么清理，也就知道怎么检测。
>
> 作为渗透测试者，清理痕迹是基本素养；作为防御者，了解这些技术才能更好地检测攻击。
>
> 记住：在授权测试中，所有操作都要记录。清理痕迹不等于隐瞒行为。

```bash
echo "Day 073 Complete! 痕迹清理技术掌握！"
```
