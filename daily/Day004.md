---
title: Day004：网络与协议基础 - TCP/UDP 与会话
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 3f65f
date: 2026-01-26
updated: 2026-01-26
---

# Day004：网络与协议基础 - TCP/UDP 与会话

- **日期**：2026-01-26
- **周次**：第 1 周
- **模块**：网络与协议基础
- **主题**：TCP/UDP 与会话
- **预计学习时间**：2.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- 掌握 TCP 三次握手与四次挥手（能画出状态图）
- 理解 UDP 的无连接特性与适用场景
- 能使用 Wireshark 抓包并分析 TCP 连接过程
- **了解 TCP/UDP 协议相关的安全问题（如 SYN Flood、端口扫描）**
- **理解端口在网络安全中的重要性**

<!--more-->

## 📚 完整学习内容（必读）

本节包含今天需要学习的全部知识点，请认真阅读并理解。

### 一、概念理解

#### 4.1.1 TCP 协议特点
- **TCP（Transmission Control Protocol）**：传输控制协议。
- **特点**：
  - **面向连接**：传数据前必须先建立连接（打电话先拨号）。
  - **可靠传输**：保证数据不丢、不乱、不错（挂号信）。
  - **流量控制**：根据对方接收能力调整发送速度（别喂太快，噎着了）。
- **适用**：网页 (HTTP)、邮件 (SMTP)、文件传输 (FTP)。

#### 4.1.2 UDP 协议特点
- **UDP（User Datagram Protocol）**：用户数据报协议。
- **特点**：
  - **无连接**：想发就发，不打招呼（发短信）。
  - **不可靠**：丢了不管，乱了不管。
  - **速度快**：头部开销小，延迟低。
- **适用**：视频会议、网络游戏、DNS 查询、DHCP。

#### 4.1.3 端口的概念
- **端口（Port）**：如果说 IP 是电脑的地址，端口就是电脑里不同应用程序的“门牌号”。
- **范围**：0-65535。
- **知名端口 (0-1023)**：
  - HTTP: 80
  - HTTPS: 443
  - SSH: 22
  - FTP: 21
- **注册端口 (1024-49151)**：MySQL (3306), RDP (3389)。
- **动态端口 (49152-65535)**：客户端发起连接时随机使用。

### 二、原理讲解

#### 4.2.1 TCP 三次握手建立连接（重点）
**情景模拟**：A 想和 B 说话。
1. **第一次（SYN）**：
   - A -> B：**“你好，我想跟你说话，能听到吗？”**
   - *技术*：发送 SYN=1, seq=x。客户端进入 SYN_SENT。
2. **第二次（SYN+ACK）**：
   - B -> A：**“能听到，我也想跟你说话，你能听到我吗？”**
   - *技术*：发送 SYN=1, ACK=1, ack=x+1, seq=y。服务端进入 SYN_RECV。
3. **第三次（ACK）**：
   - A -> B：**“能听到，那我们开始聊吧。”**
   - *技术*：发送 ACK=1, ack=y+1。双方进入 ESTABLISHED。

**为什么是三次？**
- 为了防止已失效的连接请求突然又传到了服务端，产生错误。
- 只有三次才能确认双方的**发送能力**和**接收能力**都正常。

#### 4.2.2 TCP 四次挥手关闭连接（重点）
**情景模拟**：A 聊完了，想挂电话。
1. **第一次（FIN）**：
   - A -> B：**“我说完了，我要挂了。”** (A 进入 FIN_WAIT_1)
2. **第二次（ACK）**：
   - B -> A：**“知道了，你等会儿，我还没说完。”** (B 进入 CLOSE_WAIT，A 收到后进入 FIN_WAIT_2)
   - *注意*：此时 A 不能发数据，但能收数据（半关闭状态）。
3. **第三次（FIN）**：
   - B -> A：**“好了，我也说完了，挂吧。”** (B 进入 LAST_ACK)
4. **第四次（ACK）**：
   - A -> B：**“好的，再见。”** (A 进入 TIME_WAIT，B 收到后 CLOSED)

**为什么是四次？**
- 因为 TCP 是全双工的。A 说完了，B 不一定说完，所以 B 的 ACK 和 FIN 通常分开发送。

#### 4.2.3 TCP 状态机（常见面试点）
- **LISTEN**：服务端启动，监听端口，等待连接。
- **ESTABLISHED**：连接已建立，正在传输数据。
- **TIME_WAIT**：主动关闭方在发送最后一个 ACK 后，还要等 2MSL（报文最大生存时间的2倍），确保 B 收到了 ACK，防止旧包干扰新连接。

#### 4.2.4 会话标识（五元组）
操作系统用**五元组**来唯一标识一条连接：
- `{源 IP, 源端口, 目的 IP, 目的端口, 协议 (TCP/UDP)}`
- 只要其中任何一个不同，就是两个不同的连接。

### 三、技术细节

#### 4.3.1 TCP 头部格式
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│源端口(16)   │目的端口(16) │序列号(32)   │确认号(32)   │
├─────────────┼─────────────┼─────┼─────┼─────────────┤
│首部长度(4)  │保留(6)      │标志 │窗口大小(16) │
├─────────────┼─────────────┼─────┼─────┼─────────────┤
│校验和(16)   │紧急指针(16)│选项 │填充 │ 数据      │
└─────────────┴─────────────┴─────┴─────┴─────────────┘
```
- **序列号 (Seq)**：给每个字节编号，解决乱码和丢包。
- **确认号 (Ack)**：期望收到对方下一个报文的序列号，“这个号之前的数据我都收到了”。

#### 4.3.2 TCP 标志位
- **SYN**：发起新连接。
- **ACK**：确认收到。
- **FIN**：释放连接。
- **RST**：重置连接（强制断开，通常因为报错）。
- **PSH**：有数据，请尽快交给应用层，别缓存了。

#### 4.3.3 UDP 头部格式
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│源端口(16)   │目的端口(16) │长度(16)     │校验和(16)   │
└─────────────┴─────────────┴─────────────┴─────────────┘
```
- 非常简单，只有 8 字节，所以快。

### 四、进阶知识（选学）

#### 4.4.1 TCP 拥塞控制
为了防止网络堵死，TCP 有一套复杂的机制：
- **慢启动**：刚开始发慢点，试探网络情况，没问题就指数级加速。
- **拥塞避免**：速度快到一定程度，改为线性加速，小心翼翼。
- **快重传/快恢复**：如果丢包了，别急着从头开始慢启动，先降一点速试试。

#### 4.4.2 TCP 与 UDP 的选择
| 特性 | TCP | UDP |
| :--- | :--- | :--- |
| **连接** | 面向连接 | 无连接 |
| **可靠性** | 可靠 (重传、排序) | 不可靠 (丢包不管) |
| **速度** | 慢 (握手、确认) | 快 |
| **开销** | 大 (头部20字节+) | 小 (头部8字节) |
| **场景** | 网页、文件、邮件 | 视频、语音、DNS |

### 五、本日知识点速查表

| 序号 | 核心概念 | 关键点 | 备注 |
|------|----------|--------|------|
| 1 | 三次握手 | SYN -> SYN+ACK -> ACK | 建立连接 |
| 2 | 四次挥手 | FIN -> ACK -> FIN -> ACK | 断开连接 |
| 3 | SYN | 同步位 | 发起连接请求 |
| 4 | FIN | 结束位 | 申请断开连接 |
| 5 | TIME_WAIT | 2MSL 等待 | 主动关闭方最后的状态 |

---

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 1 周：网络与协议基础
│   ├── Day003：IP、ICMP 与路由安全基础
│   └── Day004：TCP/UDP 与会话安全
│       ├── 核心概念：三次握手、四次挥手、端口、**SYN Flood、端口扫描**
│       ├── 实践技能：Wireshark 分析 TCP 流、Netstat 查看端口
│       └── 关联知识点：Socket、拥塞控制
└── 后续衔接
    └── Day005：应用层：HTTP 协议详解
```

### 今日关键词

`TCP` · `UDP` · `三次握手` · `四次挥手` · `端口` · **`SYN Flood`** · **`端口扫描`**

---

## 🔧 实践任务（合法授权范围内）

> ⚠️ **安全提示**：所有任务必须在合法授权的实验环境中进行，禁止对未授权目标进行任何测试。

请按顺序完成以下任务：

### 任务 1：环境准备与开放端口侦察（10 分钟）

查看系统开放端口使用情况，了解哪些程序在联网，并初步判断潜在的安全风险。

**操作步骤**：
1.  打开终端/命令行
2.  输入命令：
    - Windows: `netstat -ano` (查看所有连接，包括进程 ID)
    - Linux/Mac: `netstat -tunlp` (查看所有 TCP/UDP 监听端口，包括进程)
3.  观察输出结果：
    - `Local Address` 是本机 IP 和端口。
    - `Foreign Address` 是连接到的远程 IP 和端口。
    - `State` 是连接状态（ESTABLISHED, LISTENING 等）。
    - **思考**：哪些端口是常用的服务端口（如 22, 80, 443, 3389）？有没有陌生进程在监听端口？端口扫描的原理是什么？
4.  截图保存。

### 任务 2：核心实验：Wireshark 观察 TCP 握手与安全思考（30 分钟）

使用 Wireshark 观察 TCP 握手过程，并思考三次握手过程可能被利用的安全问题。

**操作步骤**：
1.  打开 Wireshark，选择正在上网的网卡，开始捕获。
2.  在过滤器栏输入 `tcp.flags.syn==1 || tcp.flags.ack==1`，回车（可以更精确地过滤握手包）。
3.  打开浏览器，访问一个简单的 HTTP 网站（如 `http://example.com`，HTTPS 会加密，但握手过程是一样的）。
4.  停止捕获。
5.  寻找握手包：
    - **第一次**：只有 SYN 标志位是 1。
    - **第二次**：SYN 和 ACK 标志位都是 1。
    - **第三次**：只有 ACK 标志位是 1。
    - *技巧*：右键任意一个包，选择“追踪流 -> TCP 流”，可以看到完整的对话。
6.  **思考**：
    - 如果攻击者只发送 SYN 包，不完成第三次 ACK，会发生什么？这对应哪种攻击（**SYN Flood**）？
    - 你能通过 Wireshark 识别出这种攻击的迹象吗（大量只发 SYN 的包）？

**预期结果**：
- 结果 1：你应该能清晰地看到那三行握手包。
- 结果 2：你能够初步理解 SYN Flood 攻击的原理。

### 任务 3：进阶挑战：TCP 和 UDP 流量对比与安全考量（20 分钟）

对比 TCP 和 UDP 的差异，并通过实际操作加深理解，并思考其在安全中的应用。

**操作步骤**：
1.  **TCP 流量**：访问网站、下载文件，观察 Wireshark 里大量的 TCP 包，有握手，有数据传输，有 ACK 确认。
2.  **UDP 流量**：打开命令行，输入 `nslookup www.baidu.com`。
    - 在 Wireshark 里过滤 `udp` 或 `dns`。
    - 你会发现只有一来一回两个包：一个 DNS 查询（Query），一个 DNS 响应（Response）。没有握手，也没有挥手。
3.  **思考**：为什么 DNS 查询选择 UDP？如果 DNS 服务被攻击（如 **DNS 欺骗/缓存投毒**），会带来什么安全问题？为什么很多 DDoS 攻击会利用 UDP 协议进行放大？

---

## 📝 巩固练习（题目与复盘）

完成以下练习来检验你的学习效果。

### 练习 1：概念理解（5 分钟）

详细描述 TCP 三次握手的每一步及其作用。

**参考答案**（完成后对照）：
1. **SYN**：客户端发给服务端，说“我想连你，我的初始序号是 X”。（作用：告知发起意图和初始序号）
2. **SYN+ACK**：服务端回给客户端，说“收到，我也想连你，我的初始序号是 Y，确认收到 X（ack=X+1）”。（作用：确认收到，并告知服务端初始序号）
3. **ACK**：客户端回给服务端，说“收到你的 Y 了（ack=Y+1）”。（作用：确认连接建立）

### 练习 2：安全场景辨析（10 分钟）

请思考并回答：
1.  **场景 A**：你收到防火墙告警，显示有大量来自同一源 IP 的 SYN 包发往你的服务器，但没有后续的 ACK 包。这可能是什么攻击？攻击者为什么这样做？
2.  **场景 B**：你在公司内网发现一台未知的电脑，使用 `netstat` 命令看到它开放了 80 和 443 端口，但你公司的 Web 服务通常部署在公网。这可能意味着什么？
3.  **场景 C**：如果攻击者能控制一个 DNS 服务器，他可以通过 UDP 协议进行哪些常见的网络攻击？

**参考答案**（完成后对照）：
1.  **场景 A**：这很可能是 **SYN Flood 攻击**。攻击者发送大量 SYN 包，但不完成三次握手，导致服务器保持大量半开连接，耗尽服务器资源，使其无法响应正常用户的请求。目的是造成**拒绝服务（DoS）**。
2.  **场景 B**：这可能意味着该未知电脑正在运行某种 Web 服务，可能是一个恶意的服务器（如钓鱼网站、C2 服务器）或未授权的服务。你需要进一步调查该设备的来源和用途。
3.  **场景 C**：
    -   **DNS 欺骗/缓存投毒**：攻击者可以返回错误的 IP 地址给用户，将用户重定向到恶意网站。
    -   **DNS 放大攻击**：攻击者向开放的 DNS 服务器发送小请求，伪造源 IP 为受害者 IP，DNS 服务器返回大响应给受害者，造成拒绝服务攻击。

### 练习 3：实操应用（10 分钟）

解释为什么 TCP 需要四次挥手而不是三次？

**参考答案**（完成后对照）：
因为 TCP 连接是**全双工**的（双向通道）。客户端发 FIN 只是说“我不发数据了”，但他还能收数据。服务端收到 FIN 后，先回 ACK 确认，然后继续把没传完的数据传完。等服务端也说“我不发了”，再发 FIN。所以中间的 ACK 和 FIN 通常是分两步发的，加起来就是四次。

### 练习 4：深度思考（10 分钟）

列举 TCP 和 UDP 的主要区别，并给出各自适用的应用场景。

**参考答案**（完成后对照）：
- **TCP**：可靠、面向连接、慢。适合：网页浏览、邮件发送、文件下载（不能丢包）。
- **UDP**：不可靠、无连接、快。适合：视频通话、直播、竞技游戏（丢一帧画面没关系，卡顿才要命）、DNS 查询。

---

## ✅ 评估标准（达成判定）

请对照以下标准检查你的学习成果：

- [x] 能准确描述 TCP 连接建立和关闭的过程
- [x] 能解释 TCP 和 UDP 的区别及其适用场景
- [x] 能在抓包中识别 TCP 状态和关键报文（SYN, FIN, ACK）
- [x] **能识别端口扫描、SYN Flood 等常见 TCP/UDP 攻击的原理**
- [x] **能初步思考 DNS 欺骗等 UDP 相关安全问题**

### 自检清单

完成学习后，请检查以下项目：

- [ ] **概念理解**：能画出三次握手图，并解释 TCP/UDP 的安全风险
- [ ] **实际应用**：能用 Wireshark 抓到握手包，并用 `netstat` 查看开放端口
- [ ] **动手能力**：能独立完成实践任务不需要提示
- [ ] **安全意识**：能对开放端口和网络连接保持警惕，初步识别异常
- [ ] **时间管理**：能在 2.5 小时内完成今日学习内容

### 学习进度自评

| 评估项目 | 1-5 星 | 备注 |
|----------|--------|------|
| 概念理解 | ⭐⭐⭐⭐⭐ | 是否明白了为什么 UDP 不可靠？**是否理解 SYN Flood 的危害？** |
| 动手能力 | ⭐⭐⭐⭐⭐ | 抓包成功了吗？**是否能识别可疑的端口？** |
| 时间控制 | ⭐⭐⭐⭐⭐ | 状态机是否看晕了？ |
| 学习兴趣 | ⭐⭐⭐⭐⭐ | 觉得协议设计精妙吗？**对 TCP/UDP 的攻防是否产生了兴趣？** |

---

## 📊 学习成果记录（由学习者填写）

### 学习信息

| 项目 | 内容 |
|------|------|
| 学习日期 | 2026-01-26 |
| 学习时长 | ___ 小时 |
| 完成情况 | ⬜ 已完成 / ⬜ 部分完成 / ⬜ 未完成 |

### 实践任务完成记录

| 任务 | 完成状态 | 关键证据/截图 | 用时 |
|------|----------|---------------|------|
| 任务 1 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：netstat 结果 | ___ 分钟 |
| 任务 2 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：三次握手包 | ___ 分钟 |
| 任务 3 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 记录：TCP/UDP 对比 | ___ 分钟 |

### 命令/代码记录

```bash
# 记录你今天使用的命令
netstat -ano
nslookup www.baidu.com

# 记录重要的输出结果
TCP    192.168.1.5:54321    1.2.3.4:80     ESTABLISHED
```

### 今日总结与反思

**今日收获**（用 3-5 句话总结今天学到了什么）：

_例如：今天彻底搞懂了三次握手，原来中间那次是把 ACK 和 SYN 合并了。抓包看到真实的 SYN 报文感觉很神奇。_

**遇到的问题与解决**：

_例如：Wireshark 包太多了看不清，后来学会了用 `tcp.flags.syn==1` 来过滤，一下子就清爽了。_

**明日待深化的问题**：

_例如：如果第三次握手的 ACK 丢了会发生什么？_

---

## 💡 知识卡片速查

### 核心概念速记

| 概念 | 定义 | 举例 |
|------|------|------|
| **三次握手** | 建立连接 | 你好 - 你好 - 好的 |
| **四次挥手** | 断开连接 | 再见 - 好的 - 再见 - 好的 |
| **SYN** | 同步 | 发起连接的信号 |
| **FIN** | 结束 | 断开连接的信号 |

### 常用命令速查

| 场景 | 命令 (Windows) | 命令 (Linux) | 说明 |
|------|----------------|--------------|------|
| 查看端口 | `netstat -ano` | `netstat -tunlp` | 查看谁在占用端口 |
| 查 DNS | `nslookup` | `dig` | 测试 UDP 连接 |

### 常见错误与解决

| 错误现象 | 可能原因 | 解决方法 |
|----------|----------|----------|
| 端口被占用 | 之前的程序没关干净 | 找到 PID，用 `taskkill /PID <id>` 杀掉 |
| 抓不到包 | 选错了网卡 | 检查 Wireshark 接口列表，选有流量波动的那个 |

---

## ❓ 常见问题与解答

**Q1：为什么建立连接是三次握手，关闭却是四次？**

A1：因为建立连接时，服务端的应答（ACK）和同步（SYN）可以放在一个包里发（SYN+ACK）。但关闭连接时，服务端收到 FIN 只表示客户端不发了，服务端可能还有数据要发，所以只能先回 ACK，等数据发完了，再发 FIN，得分开。

**Q2：如果出现大量的 TIME_WAIT 状态会怎样？**

A2：说明你的服务器主动关闭了大量连接（通常是高并发短连接场景）。TIME_WAIT 会占用端口资源，如果太多，可能会导致端口耗尽，无法建立新连接。可以通过调整内核参数优化。

**Q3：UDP 真的完全不可靠吗？**

A3：UDP 协议本身不保证可靠性，但应用层可以自己实现可靠性。比如 QUIC 协议（HTTP/3 的底层）就是基于 UDP 的，但它自己在应用层实现了重传和排序，既快又可靠。

---

## 🚀 下一步学习预告

**明日主题预告**：Day005 - 应用层：HTTP 协议详解

**学习重点预告**：
- HTTP 请求与响应结构
- 常见的状态码（200, 404, 500）
- HTTP 头部字段分析
- GET 与 POST 的区别

**今日学习为明日做铺垫**：
- TCP 是路，HTTP 是路上的车。明天我们将拆开这些车，看看里面装了什么货。

---

## 📖 参考资料

- 📖 官方文档：[RFC 793 - TCP](https://tools.ietf.org/html/rfc793)
- 🎥 视频教程：B站搜索 "TCP 三次握手动画"
- 🛠️ 实践靶场：Wireshark 抓包实战
- 📚 参考书籍：《Wireshark 网络分析就这么简单》

---

> 💬 **学习提示**：
> 1. 建议按照文档顺序学习，不要跳跃
> 2. 每个知识点理解后再进行下一步
> 3. 实践任务一定要亲手做，不要只看
> 4. 遇到问题先思考，再查阅资料，最后再问
> 5. 坚持每天完成学习任务并记录成果，90 天后你会感谢现在的自己！
>
> ```bash
> git add daily/Day004.md
> git commit -m "Day004: 完成学习与记录"
> ```
