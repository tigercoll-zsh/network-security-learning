# Day017：操作系统与脚本 - Shell/PowerShell 脚本入门与批处理（傻瓜版能照做）

- 日期：2026-01-10
- 周次：第3周

## 学习目标

学完今天你应该能做到：

- 用一句话解释：**管道**、**重定向**、**变量**、**循环**分别是干嘛的
- 写一个“能重复跑”的日志整理脚本（PowerShell 版，Windows 直接可用）
- 把结果输出成 CSV（后面 Day019/Day020 做枚举时直接能复用）

## 学习内容

### 1️⃣ 管道 vs 重定向：你只要抓住一个区别

- 管道 `|`：把“上一条命令的输出对象/文本”传给下一条命令
- 重定向 `>`/`>>`：把输出写到文件

### 2️⃣ PowerShell 跟 Bash 最大差异（新手最容易踩坑）

- PowerShell 管道里传的是“对象”，不是纯文本（这反而更强）
- 所以你常见的套路是：`Select-Object` / `Where-Object` / `Group-Object`

## 实践任务（合法授权范围内）

> 今天做一个“假日志”演练：不依赖真实系统日志，确保你一定能跑通。

### 任务 1（必做）：生成一份练习日志文件

在项目根目录运行（会生成 `scripts/day017-demo.log`）：

```powershell
$logPath = "scripts/day017-demo.log"
New-Item -ItemType Directory -Force -Path (Split-Path $logPath) | Out-Null

@(
	"2025-12-31 10:00:01 INFO user=alice action=login",
	"2025-12-31 10:00:05 WARN user=bob action=login_failed",
	"2025-12-31 10:01:10 ERROR user=bob action=login_failed",
	"2025-12-31 10:01:12 INFO user=alice action=logout",
	"2025-12-31 10:02:20 ERROR user=carol action=timeout"
) | Set-Content -Encoding UTF8 $logPath

Get-Content $logPath
```

### 任务 2（必做）：统计每种“级别”（INFO/WARN/ERROR）出现次数

```powershell
$logPath = "scripts/day017-demo.log"

Get-Content $logPath |
	ForEach-Object {
		if ($_ -match "^(?<ts>\S+\s+\S+)\s+(?<level>INFO|WARN|ERROR)\s+(?<msg>.*)$") {
			[PSCustomObject]@{
				Time  = $Matches.ts
				Level = $Matches.level
				Msg   = $Matches.msg
			}
		}
	} |
	Group-Object Level |
	Select-Object Name, Count |
	Sort-Object Name
```

### 任务 3（必做）：导出 CSV（以后你就能喂给 Excel/脚本）

```powershell
$logPath = "scripts/day017-demo.log"
$outCsv = "scripts/day017-summary.csv"

$rows = Get-Content $logPath |
	ForEach-Object {
		if ($_ -match "^(?<ts>\S+\s+\S+)\s+(?<level>INFO|WARN|ERROR)\s+(?<msg>.*)$") {
			[PSCustomObject]@{
				Time  = $Matches.ts
				Level = $Matches.level
				Msg   = $Matches.msg
			}
		}
	}

$rows | Export-Csv -NoTypeInformation -Encoding UTF8 $outCsv
Get-Item $outCsv | Select-Object FullName, Length
```

## 巩固练习（题与复盘）

### 题 1：描述管道与重定向的区别

**思路**：一句话讲“传给下一个命令” vs “写到文件”。

### 题 2：写一个带函数与循环的实用脚本（最小可用版）

**要求**：

- 写一个函数 `Parse-LogLine`
- 遍历每行并输出对象

## 评估标准（达成判定）

- 你能生成 demo 日志文件
- 你能统计 Level 次数并截图
- 你能导出 CSV 文件并能打开查看

## 学习成果达成情况（由学习者填写）

### 截图与证据

- [ ] `Get-Content scripts/day017-demo.log` 输出截图
- [ ] `Group-Object Level` 统计结果截图
- [ ] `scripts/day017-summary.csv` 文件存在证据（路径/大小）

### 关键命令与输出

- 统计结果：
- CSV 路径：

### 结论与反思

- 我今天最重要的收获是：
- 我踩的坑（例如正则没匹配上）：
- 我明天要复用脚本到哪里：

## 集中参考答案（含思路）

### 题 1 参考答案

- 管道 `|` 用于把上一个命令的输出传给下一个命令继续处理。
- 重定向 `>`/`>>` 用于把输出写到文件（覆盖/追加）。

### 题 2 参考答案（示例）

```powershell
function Parse-LogLine {
	param([string]$Line)
	if ($Line -match "^(?<ts>\S+\s+\S+)\s+(?<level>INFO|WARN|ERROR)\s+(?<msg>.*)$") {
		return [PSCustomObject]@{
			Time=$Matches.ts; Level=$Matches.level; Msg=$Matches.msg
		}
	}
}

Get-Content "scripts/day017-demo.log" | ForEach-Object { Parse-LogLine $_ } | Where-Object { $_ }
```

## 学习成果示例填写（可照抄）

- 我导出了 `scripts/day017-summary.csv`，以后做枚举/扫描的输出也能用同样方式转成结构化表。
