# Day008：安全协议与加密 - TLS 概念与握手

- 日期：2026-01-01
- 周次：第 2 周

## 学习目标

学完今天你应该能做到这些（更直观的达成标准）：

- 能用自己的话讲清楚：TLS 握手在“协商什么”，以及为什么 HTTPS 比 HTTP 安全
- 能在 Wireshark 里指出并解释：ClientHello、ServerHello、Certificate、Finished 分别在干什么
- 能把 3 个常见概念放到正确位置：证书链校验、SNI、ALPN
- 遇到“TLS 握手失败”时，能按层次给出排查方向（网络 → 版本/套件 → 证书 → 环境/策略）

## 项目进展与近期操作结果（放到目标下面）

为了把“学习”变成“可追踪的产出”，这里记录你最近一段时间做过的关键动作与结果（相当于今日学习的上下文）：

- **多账号推送已打通**：当前仓库使用两个远程（`origin` + `backup`），通过 SSH Host alias 解决了“用错 key 导致权限被拒绝”的问题。
- **自动化辅助**：已创建 `git-push.ps1`，支持交互式/参数式选择推送到 `origin`/`backup`/两者，并可在检测到未提交改动时引导提交。
- **内容推进**：已完成并完善了 Day005（DNS）、Day006（HTTP）、Day007（Wireshark 综合分析）、Day008（TLS 概念与握手）的学习卡结构与可复现实操。
- **最近一次已验证的上传结果**：Day007 已提交并分别推送到两个远程（`origin` 与 `backup`），推送成功。

你今天的重点，就是在此基础上把 Day008 的“实践证据”（抓包截图/命令行输出）补齐，然后提交并同步推送到两个远程，让进度在 GitHub 上可见。

## 学习内容

### 1️⃣ TLS 解决了什么问题

对比明文 HTTP：TLS 主要提供三件事（安全三性）：

1. **机密性（Confidentiality）**：内容加密后旁路窃听者看不懂
2. **完整性（Integrity）**：中间人篡改会被检测
3. **身份认证（Authentication）**：通过证书证明“你连的是谁”

HTTPS = HTTP + TLS。

### 2️⃣ TLS 版本：你需要记住的结论

- TLS 1.0/1.1：已被主流浏览器/服务器逐步禁用（安全性与合规原因）
- TLS 1.2：仍大量存在
- TLS 1.3：更现代、握手更短、默认更安全（弱算法被清理）

### 3️⃣ 密码套件（Cipher Suite）到底在描述什么

在 TLS 1.2 里，一个密码套件通常描述：

- **密钥交换/协商**（如 ECDHE）
- **身份认证**（证书类型，如 RSA/ECDSA）
- **对称加密算法**（如 AES-GCM / ChaCha20-Poly1305）
- **摘要/认证算法**（现代多为 AEAD，MAC 方式减少）

在 TLS 1.3 里，套件的概念被简化，协议强制使用（更少的、更安全的）组合。

### 4️⃣ TLS 1.2 握手（经典版，认识角色）

抓包里你经常会看到这些消息（简化）：

1. **ClientHello**：客户端发起；包含支持的版本、套件、扩展（SNI/ALPN…）
2. **ServerHello**：服务器选择版本与套件
3. **Certificate**：服务器证书链
4. （可选）ServerKeyExchange / CertificateRequest
5. **ClientKeyExchange**：客户端发协商需要的数据
6. **ChangeCipherSpec + Finished**：切换到加密通道并完成握手

> 记住：TLS 1.2 的握手消息更“长”，而 TLS 1.3 进行了合并与精简。

### 5️⃣ TLS 1.3 握手（更短、更现代）

典型流程（简化）：

1. **ClientHello**（内含 key_share 等扩展，提前做密钥协商）
2. **ServerHello**（选定参数后，后续握手消息多会加密）
3. **EncryptedExtensions**
4. **Certificate**（服务器证书，通常在加密通道里发送）
5. **CertificateVerify**
6. **Finished**

### 6️⃣ 证书链校验：握手里“最常见的失败点”

客户端会做这些检查：

- 证书是否在有效期内（NotBefore/NotAfter）
- 域名是否匹配（SAN/CN）
- 证书链是否能构建到受信根 CA（中间证书是否齐全）
- 是否被吊销（OCSP/CRL，具体取决于环境策略）

### 7️⃣ SNI & ALPN：抓包里常见的两个扩展

- **SNI（Server Name Indication）**：在 ClientHello 里告诉服务器“我想访问哪个域名”，用于同 IP 多站点。
- **ALPN（Application-Layer Protocol Negotiation）**：协商应用层协议（如 HTTP/2 的 `h2` 或 `http/1.1`）。

## 实践任务（合法授权范围内）

> 目标：用“抓包 + 命令行”两条证据链，确认一次 TLS 握手里关键消息与证书信息。

### 任务 1：Wireshark 抓取一次 HTTPS 握手并标注

1. 打开 Wireshark，选择活动网卡开始抓包
2. 在浏览器访问一个 HTTPS 网站（例如：`https://www.bing.com/` 或 `https://www.github.com/`）
3. 停止抓包

常用显示过滤器：

- 只看 TLS：`tls`
- 只看 443：`tcp.port == 443`
- 只看握手：`tls.handshake`
- 只看 ClientHello：`tls.handshake.type == 1`
- 只看 ServerHello：`tls.handshake.type == 2`

标注要点（写进你的学习成果里）：

- 找到一次 ClientHello：记录 SNI（目标域名）、ALPN（h2/http1.1）、支持的版本/套件（能看到多少写多少）
- 找到一次 ServerHello：记录最终选择的版本/套件
- 找到 Certificate：记录证书主题（Subject）、颁发者（Issuer）、有效期

### 任务 2：用命令行查看证书/握手信息

#### 方案 A（优先）：OpenSSL（若你环境有）

（示例以 443 为例）

- `openssl s_client -connect www.bing.com:443 -servername www.bing.com -tls1_2`

你重点看：

- 证书链（是否包含中间证书）
- `Protocol`/`Cipher`（最终使用的版本与套件）

#### 方案 B（无需 openssl）：Windows 自带 curl

- `curl.exe -Iv https://www.bing.com/`

你重点看：

- 是否显示 TLS 版本与握手摘要信息（不同 Windows 版本输出略有差异）
- 证书相关提示/重定向位置

## 巩固练习（题与复盘）

### 题目：前向保密（PFS）的意义是什么？

**PFS（Perfect Forward Secrecy）** 的核心意义：

- 即使将来服务器的长期私钥泄露，攻击者也**不能**解密过去抓到的历史会话数据。

原因（用一句话解释）：

- 会话密钥来自每次握手的临时密钥交换（例如 ECDHE），不是直接由长期私钥决定。

一句话复述模板：

- **PFS 的价值**：哪怕服务器私钥以后泄露，历史抓包也解不开。

### 练习：解释一次握手失败的常见原因（按层次排查）

1. **网络/连通性问题（TLS 还没开始）**

- TCP 443 不通、超时、被防火墙/代理拦截

2. **版本/套件不兼容（ClientHello 阶段）**

- TLS 版本不匹配（例如服务器只接受 TLS1.2+）
- Cipher Suites 没有交集
- SNI 缺失或错误（同 IP 多站点情况下）

3. **证书验证失败（最常见）**

- 证书过期/未生效
- 域名不匹配（SAN/CN 不包含访问域名）
- 证书链不完整（缺中间证书）
- CA 不受信任（自签/企业 CA 未导入信任）

4. **密钥协商失败 / 环境问题**

- 客户端/服务器时间不准导致证书校验异常
- 中间设备对 TLS1.3 支持差（可尝试强制 TLS1.2 验证定位）

5. **策略要求（mTLS 等）**

- 服务器要求客户端证书（mTLS），未提供则失败

快速定位方法（非常实用）：

- 看不到 **ClientHello**：大概率是网络/443 连接就失败
- 有 ClientHello 没有 ServerHello：多半是版本/套件/SNI/中间设备问题
- 有 ServerHello 但后面报错：多半是证书校验、时间不准、mTLS 等

## 评估标准（达成判定）

- 能在抓包中定位：ClientHello / ServerHello / Certificate（至少各 1 条证据）
- 能在命令行输出中定位：TLS 版本、Cipher、证书链（至少 1 条证据）
- 能说明 PFS 的意义，以及为什么偏好 ECDHE 类套件

## 学习成果达成情况（由学习者填写）

### 截图与证据

- Wireshark 截图（至少 3 张）：
  1.  ClientHello（能看到 SNI/ALPN 任意一个即可）
  2.  ServerHello（能看到最终选择的版本/套件任意一个即可）
  3.  Certificate（能看到 Subject/Issuer/Validity 任意一个即可）

### 关键命令与输出

- 命令（写你实际用的）：
- 输出关键行摘录：
  - TLS Version：
  - Cipher：
  - Cert Subject/Issuer：

### 结论与反思

- 今天你确认到的 1 个事实证据（来自抓包或命令行）：
- 你认为 TLS 握手失败最常见的原因是哪类？你会怎么排查？
