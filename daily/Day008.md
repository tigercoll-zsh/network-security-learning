---
title: Day008：安全协议与加密 - TLS 概念与握手
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 6619f
date: 2026-01-30
updated: 2026-01-30
---

# Day008：安全协议与加密 - TLS 概念与握手

- **日期**：2026-01-30
- **周次**：第 2 周
- **模块**：安全协议与加密
- **主题**：TLS 概念与握手
- **预计学习时间**：2.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- 理解 TLS 握手流程与密码套件的作用
- 识别握手中的关键消息（ClientHello/ServerHello 等）
- 能看懂 Wireshark 中的 TLS 握手包
- **理解前向保密 (PFS) 的重要性及其实现机制**
- **了解常见 TLS 安全风险（如版本降级）及最佳实践**

<!--more-->

## 📚 完整学习内容（必读）

本节包含今天需要学习的全部知识点，请认真阅读并理解。

### 一、概念理解

#### 8.1.1 TLS 协议简介
- **TLS (Transport Layer Security)**：传输层安全协议，是互联网通信安全的基石。
- **前身**：SSL (Secure Socket Layer)。SSL 3.0 已不安全，现在说的 SSL 基本上都指 TLS。
- **位置**：位于 TCP (传输层) 和 HTTP (应用层) 之间。HTTP 骑在 TLS 上就成了 HTTPS。
- **核心目标**：
  1.  **保密性**：别人看不懂（加密）。
  2.  **完整性**：别人改不了（校验）。
  3.  **认证**：确定你是你（证书）。

#### 8.1.2 为什么需要 TLS？
- 假设你在咖啡厅连 WiFi 上网（HTTP）：
  - 黑客可以**窃听**：看到你的账号密码。
  - 黑客可以**篡改**：在网页里插入广告或病毒代码。
  - 黑客可以**冒充**：做一个假的淘宝网，骗你输入密码。
- TLS 完美解决了这三个问题。

#### 8.1.3 TLS 版本现状
- **SSL 1.0/2.0/3.0**：老古董，已被废弃，有严重漏洞 (如 POODLE)。
- **TLS 1.0/1.1**：已停止支持，不推荐使用。
- **TLS 1.2**：目前的主流标准，兼容性好。
- **TLS 1.3**：最新标准 (2018年发布)，更快（握手只需 1 RTT）、更安全（废弃了弱加密算法）。

#### 8.1.4 密码套件 (Cipher Suite)
- **定义**：TLS 握手时，双方要商量好一套“加密套餐”。
- **格式**：`TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256`
- **解读**：
  - **Protocol**: TLS
  - **Key Exchange (密钥交换)**: ECDHE (椭圆曲线 Diffie-Hellman 临时版，支持前向保密)
  - **Authentication (身份验证)**: RSA (证书签名算法)
  - **Encryption (对称加密)**: AES_128_GCM (用 128 位密钥的 AES GCM 模式加密数据)
  - **MAC (完整性校验)**: SHA256 (哈希算法)

### 二、原理讲解

#### 8.2.1 TLS 1.2 握手流程（详细拆解）
TLS 握手就是“相亲”的过程，双方交换信息，确认身份，最后商量出一个只有两个人知道的秘密（会话密钥）。

1.  **Client Hello (客户端打招呼)**
    - 客户端说：“你好！我支持 TLS 1.2 和 1.3。我支持这些密码套件：[RSA, ECDHE...]。给你一个**随机数 A**。”
2.  **Server Hello (服务端回应)**
    - 服务端说：“你好！那我们就用 TLS 1.2 吧。密码套件选 ECDHE-RSA-AES。给你一个**随机数 B**。”
3.  **Certificate (亮身份证)**
    - 服务端说：“这是我的身份证（数字证书），里面有我的公钥，你查查是不是真的。”
4.  **Server Key Exchange (服务端给参数)**
    - 服务端说：“为了生成最终密钥，这是 ECDHE 算法需要的参数，我签了名，你收好。”
5.  **Server Hello Done (话说完了)**
    - 服务端说：“我发完了，该你了。”
6.  **Client Key Exchange (客户端给参数)**
    - 客户端验证证书通过后，说：“这是我的 ECDHE 参数。”（此时双方都有了算出同一个**预主密钥**的所有材料）。
7.  **Change Cipher Spec (准备切换)**
    - 双方各自计算出**会话密钥**。
    - 客户端说：“以后发的消息我都用这个密钥加密了哦。”
8.  **Finished (握手结束)**
    - 客户端发一条加密消息：“你解密看看，验证一下对不对。”
    - 服务端也回一条加密消息：“我也解开了，没问题。”

*注意：TLS 1.3 简化了流程，把 Hello 和 Key Exchange 合并了，速度更快。*

#### 8.2.2 为什么这么复杂？
- **防止重放攻击**：随机数 A 和 B 保证了每次连接都是独一无二的。
- **前向保密 (PFS)**：使用 ECDHE 而不是直接用 RSA 传密钥，意味着即使服务器的长期私钥（证书私钥）以后被偷了，黑客也解不开以前抓到的流量包（因为每次会话的密钥都是临时生成的）。

### 三、技术细节

#### 8.3.1 关键报文结构
- **Record Layer (记录层)**：TLS 的最外层包装。
  - `Content Type`：表明里面装的是什么。
    - 20: ChangeCipherSpec
    - 21: Alert (报错)
    - 22: Handshake (握手数据)
    - 23: Application Data (真正的加密后的 HTTP 数据)
- **Handshake Protocol (握手协议)**：
  - `ClientHello` 包含最重要的 `Random` (32字节) 和 `Cipher Suites` 列表。

#### 8.3.2 SNI (Server Name Indication)
- **问题**：一台服务器上托管了 10 个网站（www.a.com, www.b.com），它们共享同一个 IP。
- **现象**：TLS 握手发生在 HTTP 请求之前。服务端收到 Client Hello 时，还不知道你想访问哪个域名，该返回哪张证书？
- **解决**：客户端在 Client Hello 的扩展字段里带上 `Server Name: www.a.com`，告诉服务端：“我要访问 a 网站，请给我 a 的证书。”

### 四、进阶知识（选学）

#### 8.4.1 TLS 1.3 的 0-RTT
- **RTT (Round Trip Time)**：往返时延。
- **1.2**：握手需要 2 个 RTT。
- **1.3**：握手只需要 1 个 RTT。
- **0-RTT**：如果你之前访问过这个网站，客户端可以把第一次握手的参数缓存下来。下次访问时，直接在 Client Hello 后面跟着发加密的 HTTP 数据，不需要等服务端回应。这叫“0-RTT 恢复”。（虽然快，但有重放攻击风险）。

### 五、本日知识点速查表

| 序号 | 核心概念 | 关键点 | 备注 |
|------|----------|--------|------|
| 1 | TLS | 传输层安全协议 | 取代了 SSL |
| 2 | 密码套件 | 加密算法组合 | 协商怎么加密 |
| 3 | Client Hello | 握手第一步 | 带随机数和套件列表 |
| 4 | SNI | 扩展字段 | 告诉服务器我想访问哪个域名 |
| 5 | 前向保密 (PFS) | 临时密钥交换 | 私钥泄露不影响历史数据 |

---

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 1 周：网络与协议基础 (已完成)
└── 第 2 周：安全协议与加密
    ├── Day008：TLS 概念、握手与安全
    │   ├── 核心概念：加密套件、SNI、**PFS、Downgrade Attack**
    │   ├── 实践技能：OpenSSL 测试、Wireshark 分析
    │   └── 关联知识点：PKI、证书、Heartbleed
    ├── Day009：证书与信任链
    └── Day010：HTTPS 安全特性
```

### 今日关键词

`TLS` · `握手` · `Cipher Suite` · `SNI` · **`PFS`** · **`Heartbleed`**

---

## 🔧 实践任务（合法授权范围内）

> ⚠️ **安全提示**：所有任务必须在合法授权的实验环境中进行，禁止对未授权目标进行任何测试。

请按顺序完成以下任务：

### 任务 1：环境准备与加密套件侦察（5 分钟）

查看百度使用了什么加密套件，并评估其安全性。

**操作步骤**：
1.  打开 Chrome 浏览器，访问 `https://www.baidu.com`。
2.  按 `F12` 打开开发者工具，切换到 **Security (安全)** 面板。
3.  如果看不到 Security 面板，点击右上角的 `>>` 更多图标寻找。
4.  观察 **Connection** 部分的信息，例如 `TLS 1.2`，`ECDHE_RSA`，`AES_128_GCM`。
5.  **思考**：为什么是 `ECDHE` 而不是 `RSA`？这代表它支持什么安全特性（PFS）？
6.  截图保存。

### 任务 2：核心实验：使用 OpenSSL 手动握手与安全测试（30 分钟）

使用 `openssl` 命令行工具像“黑客”一样手动发起 TLS 连接，并测试服务器对不同协议版本的支持情况。

**操作步骤**：
1.  打开终端（Linux/Mac/WSL）。
2.  **正常握手**：
    ```bash
    openssl s_client -connect www.baidu.com:443
    ```
    - *观察*：`SSL-Session` 中的 `Protocol` 和 `Cipher`。
3.  **测试旧协议（版本降级测试）**：
    尝试强制使用 TLS 1.0 或 TLS 1.1 连接（现代服务器通常会拒绝）：
    ```bash
    openssl s_client -connect www.baidu.com:443 -tls1
    openssl s_client -connect www.baidu.com:443 -tls1_1
    ```
4.  **思考**：如果服务器允许 TLS 1.0 连接，意味着什么？黑客可以利用这一点发动什么攻击（如 POODLE）？

**预期结果**：
- 结果 1：正常握手应成功，显示详细的证书链和会话信息。
- 结果 2：强制使用过时协议（TLS 1.0/1.1）连接配置良好的服务器应失败，提示 `handshake failure` 或类似错误。

### 任务 3：进阶挑战：Wireshark 捕获 TLS 握手与 SNI 分析（15 分钟）

在 Wireshark 中捕获并过滤 TLS 握手包，重点观察 SNI 扩展。

**操作步骤**：
1.  打开 Wireshark，开始捕获。
2.  过滤器输入 `tls.handshake.type == 1` (只看 Client Hello)。
3.  访问 `https://www.baidu.com`。
4.  在 Wireshark 中找到 Client Hello 包，展开 `Transport Layer Security` -> `TLSv1.2 Record Layer` -> `Handshake Protocol` -> `Extension: server_name`。
5.  确认你能看到 `Server Name: www.baidu.com`。
6.  **思考**：SNI 也是明文传输的，这对隐私有什么影响？（监听者虽然看不见内容，但知道你访问了哪个网站）。

---

## 📝 巩固练习（题目与复盘）

完成以下练习来检验你的学习效果。

### 练习 1：概念理解（5 分钟）

简述 TLS 握手中 Random (随机数) 的作用。

**参考答案**（完成后对照）：
TLS 握手中有两个随机数（Client Random 和 Server Random）。它们的作用是参与生成最终的“会话密钥”（Master Secret）。此外，随机数每次不同，还能有效防止“重放攻击”（Replay Attack），即黑客截获昨天的加密包今天再发一遍，服务端会发现随机数不对而拒绝。

### 练习 2：安全故障排除（10 分钟）

如果握手时服务器返回错误 `Handshake Failure` 或 `Protocol Version Not Supported`，可能是什么原因？这也可能暗示了什么安全策略？

**参考答案**（完成后对照）：
通常是因为客户端和服务器“谈崩了”。
1.  **版本不匹配**：比如客户端只支持 TLS 1.2，服务器只支持 TLS 1.0（太老）或只支持 TLS 1.3（太新）。
2.  **密码套件不匹配**：客户端提供的加密算法列表，服务器一个都不支持。
3.  **安全策略**：服务器可能配置了**强安全策略**，拒绝所有使用弱加密算法（如 RC4, DES）或旧协议版本（SSL 3.0, TLS 1.0）的连接，这是为了防止降级攻击。

### 练习 3：深度思考（10 分钟）

为什么有了 RSA 还要用 ECDHE 进行密钥交换？这与“前向保密”有什么关系？

**参考答案**（完成后对照）：
-   **RSA 密钥交换**：客户端生成预主密钥，用服务器公钥加密发给服务器。**缺点**：如果服务器私钥泄露，黑客可以解密所有历史流量。
-   **ECDHE 密钥交换**：双方临时生成一对公私钥，用算法算出共享密钥。服务器的长期私钥只用来签名（证明身份），不参与密钥生成。
-   **关系**：ECDHE 提供了**完美前向保密 (PFS)**。即使长期私钥泄露，也解不开之前的历史流量，因为每次会话的密钥都是临时生成的，且没有在网络上传输过。

### 练习 4：安全风险分析（10 分钟）

什么是“版本降级攻击”？攻击者是如何利用它的？如何防御？

**参考答案**（完成后对照）：
-   **定义**：攻击者干扰 TLS 握手过程，欺骗客户端和服务器，让它们误以为对方不支持新版本的 TLS，从而被迫使用旧的、不安全的版本（如 SSL 3.0）。
-   **利用**：一旦降级成功，攻击者就可以利用旧协议中的已知漏洞（如 POODLE 攻击 SSL 3.0）来破解加密通信。
-   **防御**：服务器端禁用所有旧的不安全协议（SSL 3.0, TLS 1.0, TLS 1.1），客户端使用 `TLS_FALLBACK_SCSV` 机制来检测降级尝试。

---

## ✅ 评估标准（达成判定）

请对照以下标准检查你的学习成果：

- [x] 知道 Client Hello 是握手的第一步
- [x] 知道 SNI 是用来解决“单 IP 多域名”证书问题的
- [x] 能在浏览器或命令行查看网站使用的 TLS 版本和加密套件
- [x] **能解释前向保密 (PFS) 的含义和价值**
- [x] **了解为什么需要禁用旧的 TLS 版本**

### 自检清单

完成学习后，请检查以下项目：

- [ ] **概念理解**：能画出简单的 TLS 握手流程图，并标出密钥交换的位置
- [ ] **实际应用**：能用 openssl 检查网站证书和支持的协议版本
- [ ] **动手能力**：在 Wireshark 中看到了 server_name 字段
- [ ] **安全意识**：能识别使用了弱加密套件或旧 TLS 版本的潜在风险
- [ ] **时间管理**：能在 2.5 小时内完成今日学习内容

### 学习进度自评

| 评估项目 | 1-5 星 | 备注 |
|----------|--------|------|
| 概念理解 | ⭐⭐⭐⭐⭐ | 握手流程有点绕，多看两遍图。**PFS 理解了吗？** |
| 动手能力 | ⭐⭐⭐⭐⭐ | openssl 命令很酷。**能测试服务器是否支持 TLS 1.0 吗？** |
| 学习兴趣 | ⭐⭐⭐⭐⭐ | 原来加密是这么商量出来的。**对加密算法有兴趣吗？** |

---

## 📊 学习成果记录（由学习者填写）

### 学习信息

| 项目 | 内容 |
|------|------|
| 学习日期 | 2026-01-30 |
| 学习时长 | ___ 小时 |
| 完成情况 | ⬜ 已完成 / ⬜ 部分完成 / ⬜ 未完成 |

### 实践任务完成记录

| 任务 | 完成状态 | 关键证据/截图 | 用时 |
|------|----------|---------------|------|
| 任务 1 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：Chrome 安全面板 | ___ 分钟 |
| 任务 2 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 记录：openssl 输出 | ___ 分钟 |
| 任务 3 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：Wireshark SNI | ___ 分钟 |

### 命令/代码记录

```bash
# 记录你今天使用的命令
openssl s_client -connect www.baidu.com:443
```

### 今日总结与反思

**今日收获**（用 3-5 句话总结今天学到了什么）：

_例如：今天学习了 TLS 握手，终于明白了 HTTPS 建立连接的过程。原来在传输数据前，客户端和服务器要先进行这么复杂的协商。学会了用 openssl 命令来调试 SSL 连接，感觉比浏览器看得更清楚。_

**遇到的问题与解决**：

_例如：Wireshark 抓包一开始全是加密的数据，后来过滤 `tls.handshake` 才能看清握手过程。_

**明日待深化的问题**：

_例如：证书到底是怎么签发的？中间人攻击到底是怎么绕过证书的？（明天学习证书信任链）_

---

## 💡 知识卡片速查

### 核心概念速记

| 概念 | 定义 | 举例 |
|------|------|------|
| **TLS** | 传输层安全 | 互联网的保镖 |
| **Handshake** | 握手 | 建立连接前的谈判 |
| **Cipher Suite** | 密码套件 | 加密算法套餐 |
| **SNI** | 服务器名称指示 | 告诉服务器我要访问谁 |

### 常用命令速查

| 场景 | 命令 | 说明 |
|------|------|------|
| 测试 HTTPS | `openssl s_client -connect host:443` | 类似于 telnet 但支持 SSL |
| 查看证书 | `openssl x509 -text -noout -in cert.pem` | 解读证书文件 |

---

## 🚀 下一步学习预告

**明日主题预告**：Day009 - 安全协议与加密：证书与信任链

**学习重点预告**：
- 数字证书包含什么？
- 什么是根证书和中间证书？
- 浏览器怎么验证证书是真的？

**今日学习为明日做铺垫**：
- 今天我们也提到了“服务端发证书”，明天我们将把这张“身份证”拿在显微镜下仔细研究。

---

## 📖 参考资料

- 📖 官方文档：[RFC 5246 - The TLS Protocol Version 1.2](https://tools.ietf.org/html/rfc5246)
- 🎥 视频教程：B站搜索 "TLS 1.2 握手详解"
- 🛠️ 实践工具：OpenSSL, Wireshark

---

> 💬 **学习提示**：
> 1. 建议按照文档顺序学习，不要跳跃
> 2. 每个知识点理解后再进行下一步
> 3. 实践任务一定要亲手做，不要只看
> 4. 遇到问题先思考，再查阅资料，最后再问
> 5. 坚持每天完成学习任务并记录成果，90 天后你会感谢现在的自己！
>
> ```bash
> git add daily/Day008.md
> git commit -m "Day008: 完成学习与记录"
> ```
