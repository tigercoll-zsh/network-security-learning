# Day009：安全协议与加密 - 证书与信任链

- 日期：2026-01-02
- 周次：第 2 周

## 学习目标

学完今天你应该能做到：

- 说清 **证书（X.509）在证明什么**：证明“某个公钥属于某个域名/组织”，并由谁背书
- 说清 **CA/中间证书/根证书** 的角色，以及“链验证”为什么能建立信任
- 能用 **Windows 自带工具**（无需 OpenSSL）拿到一个站点证书，并提取关键字段：SAN、Issuer、Validity、Key Usage
- （可选）会用 **OpenSSL** 做同样的检查，并理解 `verify`/`s_client` 的输出含义
- 能列出 3 类常见失败原因：**域名不匹配 / 链不完整或不被信任 / 证书过期或被撤销（策略相关）**

## 学习内容

### 1️⃣ 证书到底是什么（X.509 的一句话定义）

证书可以理解为：

- **一张“公钥身份证”**：把 _主体身份（域名/组织）_ 和 _公钥_ 绑定起来
- 由 **签发者（Issuer，通常是 CA）** 用自己的私钥签名背书

你真正验证的不是“证书长得像不像”，而是：

1. 证书上的域名是不是我访问的域名（SAN 优先）
2. 证书是否在有效期内
3. 颁发者是否可信（能不能一路追溯到受信任的根 CA）

### 2️⃣ CN、SAN、Key Usage：最常用的字段（面试/实战高频）

- **Subject**：证书主体，谁的证书
- **CN（Common Name）**：早期用来放域名，但现在 **不再推荐只靠 CN 匹配**
- **SAN（Subject Alternative Name）**：现代浏览器匹配域名的主要依据（可包含多个域名/通配符）
- **Issuer**：谁签发的（中间 CA / 根 CA）
- **Validity**：Not Before / Not After（时间不准会导致校验失败）
- **Key Usage / Extended Key Usage**：这把公钥允许干什么（如 Server Authentication）

### 3️⃣ 证书链（Chain）/信任链（Trust Chain）怎么工作

基本结构（从服务器发给客户端的常见顺序）：

- 站点证书（Leaf / End-Entity）
- 1~N 个中间证书（Intermediate CA）
- （根证书 Root CA **通常不会**由服务器发给你，客户端系统里本来就有）

链验证的核心逻辑：

- 用“上一级证书”的公钥，验证“下一级证书”的签名是否正确
- 一直验证到“我本机信任的根 CA”则信任成立

### 4️⃣ 撤销：CRL / OCSP（你需要记住的结论）

- **CRL**：证书撤销列表（列表可能大、更新慢）
- **OCSP**：在线查询某张证书是否被撤销（受网络/策略影响）
- 实际是否“强制检查撤销”，取决于浏览器/系统/组织策略，所以现实里常见的失败点仍是：域名/有效期/链不完整。

## 实践任务（合法授权范围内）

> 目标：用“无需 OpenSSL”也能完成证书关键字段核验；有 OpenSSL 更好。

### 任务 1（无需 OpenSSL）：用 curl 抓取握手与证书信息

1. 选一个 HTTPS 站点（示例：`https://www.bing.com/`）
2. 执行（只请求头，带详细信息）：

说明：在 Windows PowerShell 里，`curl.exe` 的进度条/部分输出可能会被显示为 `NativeCommandError`，看起来像“报错”，但通常并不影响你拿到 TLS/HTTP 头信息。

更稳定的写法（不显示进度条，只看关键信息）：

```powershell
curl.exe -I --silent --show-error --location https://www.bing.com/
```

如果你还想看更详细的协商信息，再用：

```powershell
curl.exe -Iv --silent --show-error https://www.bing.com/
```

你要记录到“学习成果”里的信息（不同 Windows 版本输出略不同，能看到多少写多少）：

- TLS 版本/协商摘要（如有）
- 证书相关提示（如有）
- 重定向位置（如有）

### 任务 2（无需 OpenSSL）：用 PowerShell 获取站点证书并导出到文件

下面脚本会连接站点、取出服务器证书并导出为 `.cer`（DER），然后用系统工具查看：

```powershell
$hostName = "www.bing.com"
$tcp = New-Object System.Net.Sockets.TcpClient($hostName, 443)
$ssl = New-Object System.Net.Security.SslStream($tcp.GetStream(), $false, ({$true}))
$ssl.AuthenticateAsClient($hostName)
$cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($ssl.RemoteCertificate)
$path = "day009_$($hostName.Replace('.','_')).cer"
[System.IO.File]::WriteAllBytes($path, $cert.Export([System.Security.Cryptography.X509Certificates.X509ContentType]::Cert))
$cert | Format-List Subject, Issuer, NotBefore, NotAfter, Thumbprint
Write-Host "Exported to $path"
$ssl.Dispose(); $tcp.Close()
```

接着查看证书详细信息（系统自带）：

```powershell
certutil -dump .\day009_www_bing_com.cer
```

你重点找这些字段并摘录：

- Subject / Issuer
- Validity（NotBefore/NotAfter）
- SAN（Subject Alternative Name）
- EKU（如 Server Authentication）

### 任务 3（可选，有 OpenSSL 时）：查看链与验证结果

1. 直接看握手与证书链：

- `openssl s_client -connect www.bing.com:443 -servername www.bing.com -showcerts`

2. 验证链（需要你把中间证书/根证书准备成文件时才更完整）：

- `openssl verify -CAfile <root_or_bundle.pem> <leaf.pem>`

你要理解的输出关键词：

- `Verify return code: 0 (ok)`：链验证通过
- 其他非 0：要么链不完整、要么不受信任、要么用途/名称/时间有问题

### 任务 4（与 Wireshark 联动）：从抓包里对应到“证书链”

在 Wireshark 里过滤：

- `tls.handshake.type == 11`（Certificate）

找到 `Certificate` 消息后：

- 看证书列表里有几张（leaf + intermediates）
- 记录 leaf 的 Subject / Issuer / Validity
- 对照你在 PowerShell/certutil 中看到的字段是否一致

## 巩固练习（题与复盘）

### 题目 1：为何不再使用“仅 CN”做域名匹配？

要点：

- 现代证书允许一个证书覆盖多个域名/通配符，**SAN 才是标准位置**
- 浏览器实现与标准（RFC/CA/B Baseline Requirements）逐步要求以 SAN 为准
- 只看 CN 容易产生兼容性与安全边界问题

一句话回答模板：

- **现在以 SAN 为准**，CN 主要是历史兼容字段，不能再作为唯一匹配依据。

### 题目 2：链验证失败的 3 个典型原因是什么？

- 缺中间证书（服务器没发全）
- 客户端缺根 CA/企业 CA（不受信任）
- 时间不准或证书过期（NotBefore/NotAfter）

### 练习：给定证书，指出有效期与用途

从 `certutil -dump` 或证书查看器里找到：

- NotBefore / NotAfter
- Enhanced Key Usage（Server Authentication / Client Authentication 等）

## 评估标准（达成判定）

- 能说清“证书证明的是什么”，以及 CA/中间/根的关系
- 能从证书中定位并解释：SAN、Issuer、Validity、EKU/Key Usage（至少 4 项）
- 能用 Windows 工具导出并 `certutil -dump` 查看证书
- 能给出链验证失败的分层排查思路（链不完整 / 不受信任 / 时间与域名）

## 学习成果达成情况（由学习者填写）

### 截图与证据

- `certutil -dump` 关键字段截图或复制粘贴：
  - Subject：
  - Issuer：
  - Validity（NotBefore/NotAfter）：
  - SAN：
  - EKU：

### 关键命令与输出

- 命令：
  - `curl.exe -Iv https://...`
  - PowerShell 导出证书脚本（是否成功导出 `.cer`）：
  - `certutil -dump .\xxx.cer`
- 输出关键行摘录：
  - 证书指纹（Thumbprint）：
  - SAN 关键行：
  - Validity：

### 结论与反思

- 今天你确认到的 1 个事实证据（来自输出，不是“感觉”）：
- 你遇到的 1 个坑（例如：时间不准/站点重定向/输出差异）：
- 明天（Day010）你最想带着去验证的一个问题：
