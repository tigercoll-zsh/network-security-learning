---
title: Day021：操作系统与脚本 - 第 3 周综合实验与测评（OS+枚举+脚本，傻瓜版能照做）
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 96499f8c
date: 2026-01-14 00:00:00
updated: 2026-01-14 00:00:00

---
# Day021：操作系统与脚本 - 第 3 周综合实验与测评（OS+枚举+脚本，傻瓜版能照做）

- 日期：2026-01-14
- 周次：第 3 周

## 学习目标

今天把第 3 周收口，你应该能做到：

- **主机侧**：能给出 Windows/Linux 各 5 条加固项，**并能编写脚本自动检查这些项**
- **网络侧**：能对"授权目标"做一次端口/服务枚举，**识别潜在的高危服务**
- **脚本侧**：能编写自动化工具将扫描结果整理成结构化文件（CSV/JSON），**辅助威胁猎杀**
- **报告侧**：输出一份完整的第 3 周周报（含证据链、风险评估、改进建议）

---

<!--more-->

## 一、第 3 周知识地图

```
第 3 周：系统安全与脚本自动化
├─ 系统安全基础
│   ├─ Linux：权限(rwx/SUID)、用户(sudo)、日志(journalctl)、防火墙(ufw)
│   └─ Windows：UAC、ACL、事件日志(4624/4625)、PowerShell 审计
│
├─ 脚本编程基础
│   ├─ PowerShell：Cmdlet、Pipeline、对象操作、日志分析脚本
│   └─ Python：文件操作、正则、网络请求(urllib)、POC 编写
│
└─ 信息收集实战
    ├─ 端口扫描：Nmap (-sS/-sT)、端口状态、防火墙规避
    └─ 服务枚举：Banner 获取、版本探测、漏洞关联、蜜罐识别
```

---

## 二、10 个易错点对照表（安全专家版）

| 易错点 | 错误做法 | 正确做法 | 后果 |
|--------|----------|----------|------|
| **1. 未记录授权** | 直接扫描内网主机 | 先获取书面授权，记录扫描窗口 | 可能违反公司政策/触发 IDS |
| **2. sudo 配置错误** | `user ALL=(ALL) NOPASSWD: ALL` | 仅授权必要命令，且需要密码 | 普通账号可无密码提权 |
| **3. 防火墙全开** | 关闭 Windows 防火墙 | 保持开启，按需放通 | 所有端口暴露 |
| **4. RDP 对公网开放** | 3389 端口允许 Any | 仅允许 VPN/堡垒机 IP | 成为暴力破解目标 |
| **5. 密码策略太弱** | 无复杂性要求，无锁定策略 | 12 位+复杂性+5 次锁定 | 容易被暴力破解 |
| **6. 日志未启用** | 未开启进程创建审计（4688） | `auditpol /set /category:*` | 无法溯源攻击行为 |
| **7. Banner 直接信任** | 看到 Apache 就认为是 Apache | 交叉验证（curl+Nmap） | 可能被伪装 Banner 误导 |
| **8. 异常处理缺失** | `except: pass`（吞掉错误） | 输出错误信息+解决建议 | 脚本出错无法排查 |
| **9. 全端口扫描无节制** | 直接 `-p-` 扫描生产环境 | 先 `--top-ports 100` 测试 | 可能触发限流/DoS |
| **10. 结果未脱敏** | 日志中包含真实 IP/账号 | 导出前替换为 `192.168.1.X`/`user_A` | 泄露敏感信息 |

---

## 三、综合实验任务

### 任务 1：Windows 自查证据（必做）

**目标**：用 PowerShell 收集 Windows 安全证据，识别 3 个以上风险点。

#### 步骤 1：审计管理员组成员
```powershell
Get-LocalGroupMember -Group "Administrators" | 
Select-Object Name, PrincipalSource, ObjectClass | 
Format-Table -AutoSize
```

**检查清单**：
- [ ] 是否有离职员工残留账号
- [ ] 是否有非 IT 人员在管理员组
- [ ] 是否有命名异常的账号（如 `temp_admin`）

#### 步骤 2：导出最近 24 小时登录事件
```powershell
# 登录成功（4624）
Get-WinEvent -FilterHashtable @{
    LogName='Security'
    ID=4624
    StartTime=(Get-Date).AddDays(-1)
} | Select-Object TimeCreated, 
    @{Name="User";Expression={$_.Properties[5].Value}},
    @{Name="LogonType";Expression={$_.Properties[8].Value}},
    @{Name="SourceIP";Expression={$_.Properties[18].Value}} | 
Export-Csv -Path ".\win_logins.csv" -NoTypeInformation

# 登录失败（4625）
Get-WinEvent -FilterHashtable @{
    LogName='Security'
    ID=4625
    StartTime=(Get-Date).AddDays(-1)
} | Select-Object TimeCreated, 
    @{Name="User";Expression={$_.Properties[5].Value}} | 
Group-Object User | Sort-Object Count -Descending | 
Select-Object -First 5 Name, Count
```

**检查清单**：
- [ ] 是否有非预期的 RDP 登录（登录类型 10）
- [ ] 是否有大量失败登录（可能是暴力破解）
- [ ] 是否有非工作时间的登录

#### 步骤 3：检查防火墙入站规则
```powershell
Get-NetFirewallRule -Direction Inbound -Enabled True -Action Allow | 
Select-Object DisplayName, Profile, 
    @{Name="LocalPort";Expression={(Get-NetFirewallPortFilter -AssociatedNetFirewallRule $_).LocalPort}},
    @{Name="RemoteAddress";Expression={(Get-NetFirewallAddressFilter -AssociatedNetFirewallRule $_).RemoteAddress}} | 
Where-Object {$_.LocalPort -ne $null} | 
Export-Csv -Path ".\win_firewall.csv" -NoTypeInformation
```

**检查清单**：
- [ ] RDP（3389）是否限制 IP
- [ ] SMB（445）是否对公网开放
- [ ] 是否有"Any"远程地址的高危端口

#### 步骤 4：盘点监听端口
```powershell
Get-NetTCPConnection -State Listen | 
Select-Object LocalAddress, LocalPort, State,
    @{Name="ProcessName";Expression={(Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue).ProcessName}},
    @{Name="ProcessPath";Expression={(Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue).Path}} | 
Export-Csv -Path ".\win_ports.csv" -NoTypeInformation
```

**检查清单**：
- [ ] 是否有意外的高端口监听（如 4444/5555）
- [ ] 进程路径是否在 `AppData`/`Temp`
- [ ] 进程名是否伪装成系统进程

#### 步骤 5：整理 Windows 风险清单
| 风险项 | 发现证据 | 风险等级 | 改进建议 |
|--------|----------|----------|----------|
| 管理员组成员过多 | 有 3 个非 IT 账号 | ⚠️ 中 | 移除非必要账号 |
| RDP 对所有 IP 开放 | 防火墙规则 RemoteAddress=Any | 🚨 高 | 限制为 VPN IP 段 |
| ... | ... | ... | ... |

---

### 任务 2：Linux 自查证据（可选，需自建 VM）

**目标**：用命令行收集 Linux 安全证据。

#### 步骤 1：检查关键文件权限
```bash
ls -l /etc/shadow /etc/passwd /etc/sudoers
```

**检查清单**：
- [ ] `/etc/shadow` 权限是否为 600 或 000
- [ ] `/etc/passwd` 是否可被所有人读取（644）
- [ ] `/etc/sudoers` 权限是否为 440 或 400

#### 步骤 2：审计 sudo 权限
```bash
sudo grep -v '^#' /etc/sudoers | grep -v '^$'
sudo ls -la /etc/sudoers.d/
```

**检查清单**：
- [ ] 是否有 `NOPASSWD: ALL`（极不安全）
- [ ] 是否有非 IT 人员拥有 sudo 权限

#### 步骤 3：盘点监听端口
```bash
sudo ss -lntup
```

**检查清单**：
- [ ] 是否有意外的高端口监听
- [ ] SSH（22）是否监听在 `0.0.0.0`（所有网卡）
- [ ] 数据库端口（3306/5432）是否对外暴露

#### 步骤 4：查看最近登录记录
```bash
last -n 20
lastb -n 20  # 失败登录
```

**检查清单**：
- [ ] 是否有非预期的 IP 登录
- [ ] 是否有大量失败登录

#### 步骤 5：整理 Linux 风险清单
| 风险项 | 发现证据 | 风险等级 | 改进建议 |
|--------|----------|----------|----------|
| /etc/shadow 权限 644 | `ls -l` 输出 | 🚨 极高 | `chmod 600 /etc/shadow` |
| MySQL 监听 0.0.0.0:3306 | `ss -lntup` | 🚨 高 | 改为 127.0.0.1 或限制 IP |
| ... | ... | ... | ... |

---

### 任务 3：授权目标枚举证据（必做）

**目标**：对一个合法目标（本机/VM）做端口扫描+服务枚举。

#### 步骤 1：记录授权信息
```
目标：127.0.0.1（本机）
授权类型：自建环境
扫描窗口：2026-01-14 14:00 - 14:30
目的：第 3 周综合实验，学习端口扫描与服务枚举
```

#### 步骤 2：执行扫描
```bash
nmap -sT -sV --top-ports 1000 -oX scan.xml 127.0.0.1
```

#### 步骤 3：用 Python 脚本解析结果
```python
import xml.etree.ElementTree as ET
import csv

tree = ET.parse("scan.xml")
root = tree.getroot()

results = []
for host in root.findall("host"):
    ip = host.find("address").get("addr")
    ports_elem = host.find("ports")
    if ports_elem is None:
        continue
    for port in ports_elem.findall("port"):
        portid = port.get("portid")
        state = port.find("state").get("state")
        service = port.find("service")
        service_name = service.get("name", "unknown") if service is not None else "unknown"
        version = service.get("product", "") if service is not None else ""
        results.append([ip, portid, state, service_name, version])

with open("scan_results.csv", "w", newline="", encoding="utf-8") as f:
    writer = csv.writer(f)
    writer.writerow(["IP", "Port", "State", "Service", "Version"])
    writer.writerows(results)

print(f"✅ 已导出 {len(results)} 条结果")
```

#### 步骤 4：整理服务清单
| IP | Port | State | Service | Version | 风险等级 |
|----|------|-------|---------|---------|----------|
| 127.0.0.1 | 135 | open | msrpc | - | ⚠️ 中 |
| 127.0.0.1 | 445 | open | microsoft-ds | - | 🚨 高 |
| 127.0.0.1 | 3389 | open | ms-wbt-server | - | 🚨 高 |

---

### 任务 4：脚本侧实战（必做）

**目标**：编写一个"自动化基线检查工具"，能重复使用。

#### 需求
1.  **Windows (PowerShell)**：
    -   检查是否禁用了 Guest 账户
    -   检查是否启用了防火墙
    -   检查 RDP 端口是否为 3389（提示风险）
    -   输出结果为 JSON

#### 参考实现（PowerShell）
```powershell
function Get-SecurityBaseline {
    $guest = Get-LocalUser -Name "Guest"
    $firewall = Get-NetFirewallProfile | Where-Object Enabled -eq True
    $rdp = Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

    [PSCustomObject]@{
        GuestDisabled = -not $guest.Enabled
        FirewallEnabled = $firewall.Count -gt 0
        RDPPort = $rdp.PortNumber
        IsRDPDefault = $rdp.PortNumber -eq 3389
    }
}

$result = Get-SecurityBaseline
$result | ConvertTo-Json | Out-File "baseline_report.json"
Write-Output "✅ 基线检查完成，报告已生成"
```

#### 进阶挑战（Python）
编写一个 Python 脚本，读取 Nmap 的 XML 结果，自动筛选出所有 `http` 服务，并调用 `curl` 获取其 Title。

```python
# 伪代码思路
# 1. 解析 XML 找到所有 service name="http" 的端口
# 2. 拼接 URL (http://ip:port)
# 3. urllib.request 请求
# 4. 正则提取 <title>...</title>
```

---

## 四、第 3 周周报模板

### 周报标题
```
第 3 周学习周报：操作系统与脚本
学习者：[你的姓名]
日期：2026-01-14
```

### 一、学习概览

**本周学习主题**：
- Day015：Linux 安全基础（权限/用户/服务/日志/防火墙）
- Day016：Windows 安全基础（UAC/事件日志/防火墙/策略）
- Day017：PowerShell 脚本（管道/循环/函数/错误处理）
- Day018：Python 脚本（文件/正则/JSON/HTTP）
- Day019：Nmap 端口扫描（-sS/-sT/端口状态/导出）
- Day020：服务枚举（HTTP/SSH/MySQL/Banner 交叉验证）
- Day021：综合实验（本周知识整合）

**总学习时长**：约 14 小时
**完成任务数**：7 天 × 5 个任务 = 35 个任务

---

### 二、关键发现与证据

#### Windows 主机自查
| 风险项 | 发现证据 | 风险等级 | 改进建议 |
|--------|----------|----------|----------|
| [示例] 管理员组成员过多 | 有 3 个非 IT 账号 | ⚠️ 中 | 移除非必要账号 |
| ... | ... | ... | ... |

#### Linux 主机自查（如有）
| 风险项 | 发现证据 | 风险等级 | 改进建议 |
|--------|----------|----------|----------|
| [示例] /etc/shadow 权限 644 | `ls -l` 输出 | 🚨 极高 | `chmod 600 /etc/shadow` |
| ... | ... | ... | ... |

#### 端口扫描与服务枚举
| IP | Port | Service | Version | 风险等级 |
|----|------|---------|---------|----------|
| 127.0.0.1 | 3389 | ms-wbt-server | - | 🚨 高 |
| ... | ... | ... | ... | ... |

---

### 三、已完成的加固措施

1. ✅ [示例] 移除了管理员组中的离职员工账号 `bob`
2. ✅ [示例] 配置了账户锁定策略（5 次失败锁定 30 分钟）
3. ✅ [示例] 限制 RDP（3389）仅允许内网 IP 段访问
4. ...

---

### 四、脚本工具输出

**工具 1**：日志统计工具（Python）
- 功能：统计每个用户的操作次数
- 输入：demo.log
- 输出：user_stats.csv
- 代码行数：约 30 行
- 可复用性：✅ 高（可用于 Day019/Day020 的日志分析）

**工具 2**：Nmap 结果解析器（PowerShell）
- 功能：从 Nmap 文本输出提取端口/服务/版本
- 输入：day019_scan.txt
- 输出：scan_summary.csv
- 代码行数：约 15 行
- 可复用性：✅ 高

---

### 五、知识盲区与改进计划

#### 本周遇到的困难
1. [示例] PowerShell 的对象管道概念理解不深，需要多练习
2. [示例] 正则表达式语法容易忘记，需要建立速查表
3. ...

#### 下周改进计划
1. 每天至少写 1 个完整脚本（PowerShell 或 Python）
2. 建立个人的"常用正则表达式库"
3. 复习 Day015-016 的加固清单，应用到实际环境

---

### 六、评估标准达成情况

- ✅ 能给出 Windows/Linux 各 5 条加固项（并有证据）
- ✅ 能对授权目标做一次端口/服务枚举并导出结果
- ✅ 能用脚本整理输出为 CSV/JSON
- ✅ 能输出一份完整的周报（含证据链）

---

### 七、附件清单

- [x] `win_logins.csv`（Windows 登录事件）
- [x] `win_firewall.csv`（防火墙规则）
- [x] `win_ports.csv`（监听端口）
- [x] `scan.xml`（Nmap 扫描结果）
- [x] `scan_results.csv`（解析后的服务清单）
- [x] `user_stats.csv`（日志统计结果）
- [x] 脚本代码（`analyze_log.py`/`parse_nmap.ps1`）

---

## 五、巩固练习

### 练习 1：设计一套 Windows 加固方案

**场景**：新上线一台 Windows Server 2019，需要加固。

**参考答案**（15 条）：
1. 禁用或重命名默认 `Administrator` 账号
2. 最小化管理员组成员
3. 启用密码复杂性（12 位+大小写+数字+符号）
4. 启用账户锁定策略（5 次失败锁定 30 分钟）
5. 禁用 Guest 账户
6. 启用 Windows 自动更新
7. 防火墙默认拒绝入站，按需放通
8. RDP（3389）仅允许 VPN/堡垒机 IP
9. 禁用 SMBv1
10. 禁用不必要的服务（Telnet/FTP）
11. 启用安全审计（4624/4625/4688/4720/7045）
12. 日志至少保留 90 天
13. 启用 Windows Defender 实时保护
14. 配置 AppLocker 白名单
15. 定期审计管理员组成员和登录日志

---

### 练习 2：设计一套 Linux 加固方案

**参考答案**（15 条）：
1. 禁用 root 直接登录（`PermitRootLogin no`）
2. 使用 SSH 密钥认证，禁用密码登录
3. `/etc/shadow` 权限设为 600 或 000
4. 最小化 sudo 权限，避免 `NOPASSWD: ALL`
5. 禁用不必要的服务（`systemctl disable telnet`）
6. 监听端口仅绑定必要网卡（不用 `0.0.0.0`）
7. 启用 UFW/firewalld，默认拒绝入站
8. SSH 端口改为非标准端口（如 2222）
9. 配置 fail2ban 防暴力破解
10. 日志至少保留 90 天
11. 定期检查 `/etc/passwd`、`/etc/shadow` 完整性
12. 禁用不必要的 SUID 程序
13. 启用 SELinux/AppArmor
14. 定期更新系统补丁（`apt update && apt upgrade`）
15. 审计 cron 任务和 systemd timer

---

## 六、评估标准

- ✅ 完成 Windows 或 Linux 主机自查，**并识别出至少 2 个高危配置**
- ✅ 完成授权目标的端口扫描+服务枚举，**并能关联出潜在漏洞**
- ✅ 写出至少 1 个可复用的**安全辅助脚本**（PowerShell 基线检查或 Python 自动化探测）
- ✅ 输出一份完整的第 3 周周报，**包含明确的风险评估和加固建议**
- ✅ **理解并能实践"最小权限"和"纵深防御"原则**

---

## 七、参考资料

- [CIS Windows Server 2019 Benchmark](https://www.cisecurity.org/benchmark/microsoft_windows_server)
- [CIS Ubuntu Linux 20.04 Benchmark](https://www.cisecurity.org/benchmark/ubuntu_linux)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)

---

## 八、学习成果达成情况（由学习者填写）

### Windows 自查证据
- [ ] 管理员组成员截图
- [ ] 登录事件 CSV 文件
- [ ] 防火墙规则 CSV 文件
- [ ] 监听端口 CSV 文件

### Linux 自查证据（如有）
- [ ] 关键文件权限截图
- [ ] sudo 配置截图
- [ ] 监听端口截图
- [ ] 登录记录截图

### 端口扫描证据
- [ ] Nmap 扫描结果（XML 或文本）
- [ ] 解析后的服务清单（CSV）

### 脚本工具
- [ ] 日志统计工具代码
- [ ] Nmap 解析工具代码

### 周报
- [ ] 完整的第 3 周周报（Markdown 或 Word）

---

**恭喜！你已完成第 3 周的学习。下周我们将进入第 4 周：Web 应用安全基础！** 🎉
