---
title: Day041：XXE 与不安全反序列化 - 结构化数据解析风险
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 81317
date: 2026-03-04
updated: 2026-03-04
---

# Day041：XXE 与不安全反序列化 - 结构化数据解析风险

- **日期**：2026-03-04
- **周次**：第 6 周
- **模块**：Web 漏洞进阶
- **主题**：XML 外部实体 (XXE) 与反序列化基础
- **预计学习时间**：3.5 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- **挖掘 XXE 漏洞**：理解 DTD 实体声明，掌握有回显和无回显（Blind XXE）的文件读取与 SSRF。
- **理解反序列化原理**：掌握 PHP (`serialize/unserialize`) 与 Python (`pickle/json`) 反序列化的底层机制。
- **构建初级 PoC**：学会利用 PHP 魔术方法 (`__destruct`, `__wakeup`) 构造简单的攻击链实现 RCE。

<!--more-->

---

## 📚 完整学习内容（必读）

### 一、XML 外部实体注入 (XXE)

XML 是一种用于传输数据的格式。当服务器允许解析 XML 且未禁用“外部实体”时，漏洞便产生了。

#### 1.1 核心原理：DTD 实体
- **内部实体**：`<!ENTITY name "value">`
- **外部实体**：`<!ENTITY name SYSTEM "file:///etc/passwd">`
  - 如果在 XML 中调用 `&name;`，解析器会尝试读取系统文件并填充到该位置。

#### 1.2 攻击场景
1.  **文件读取**：读取配置文件、`/etc/passwd` 等。
2.  **内网探测 (SSRF)**：利用 `SYSTEM "http://192.168.1.1/..."` 探测内网端口。
3.  **Blind XXE (带外利用)**：当页面无回显时，利用外部 DTD 将读取到的内容发送到攻击者的服务器（如 dnslog 或 Web 接口）。

#### 1.3 进阶：利用 PHP 伪协议读取源码
由于 XML 无法直接读取包含 `<` 等字符的 PHP 源码（会破坏 XML 结构），需使用 Base64 编码：
`<!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=config.php">`

---

### 二、不安全的反序列化 (Insecure Deserialization)

序列化是将“对象”转为“字符串”的过程；反序列化则是逆过程。

#### 2.1 PHP 反序列化
- **序列化格式**：`O:4:"User":1:{s:8:"username";s:5:"admin";}`。
- **触发点：魔术方法**：
  - `__construct()`：对象创建时调用。
  - `__destruct()`：对象销毁时调用（攻击者的最爱）。
  - `__wakeup()`：反序列化执行前调用。
- **漏洞本质**：攻击者通过控制反序列化的字符串，改变对象的属性值，并诱导程序在执行魔术方法时触发危险函数（如 `eval`, `system`, `file_put_contents`）。

#### 2.2 Python 反序列化 (Pickle)
- **底层**：Pickle 是一种基于栈的虚拟机操作码。
- **RCE 示例**：
  ```python
  import pickle
  import os
  class Evil:
      def __reduce__(self):
          return (os.system, ('whoami',))
  print(pickle.dumps(Evil()))
  ```
  - 当 `pickle.loads()` 执行这段数据时，会直接执行 `whoami`。

---

## 🗺️ 知识图谱

```
结构化数据安全
├── XXE (XML External Entity)
│   ├── DTD 实体声明
│   ├── 协议利用 (file, http, php)
│   └── Blind XXE (OOB 攻击)
└── 反序列化 (Deserialization)
    ├── PHP 反序列化 (serialize/unserialize)
    │   └── 魔术方法攻击链 (POP Chain)
    ├── Python 反序列化 (Pickle/PyYAML)
    └── Java 反序列化 (初识, 原理)
```

---

## 🔧 实践任务

### 任务 1：XXE 有回显读取敏感文件 (40 分钟)
**环境**：本地搭建一个接收 XML POST 请求的 PHP 页面（使用 `libxml_disable_entity_loader(false)`）。
**要求**：
1. 构造一个 XML Payload，成功读取服务器的 `C:\windows\win.ini` (Windows) 或 `/etc/passwd` (Linux)。
2. 使用 `php://filter` 协议读取该 PHP 页面自身的源代码。

### 任务 2：PHP 反序列化攻击链构建 (60 分钟)
**情景**：给定以下不安全代码：
```php
class FileCleaner {
    public $filename;
    public function __destruct() {
        unlink($this->filename);
    }
}
unserialize($_GET['data']);
```
**要求**：
1. 分析该代码的风险：`__destruct` 会在脚本结束时删除 `$filename`。
2. 构造一个序列化字符串，实现：当代码执行反序列化后，自动删除服务器上的 `config.php` 文件。
3. 扩展思考：如果 `unlink` 换成 `include`，该如何实现 RCE？

---

## 📝 巩固练习

### 练习 1：判断题
**题目**：只要在 PHP 中使用 `libxml_disable_entity_loader(true)`，就能完全防御 XXE 漏洞。对吗？
**参考答案**：**正确**（针对绝大多数现代 PHP 环境）。该函数禁用了外部实体的加载，从根源切断了 XXE 的攻击路径。但在 PHP 8.0+ 中，XML 外部实体默认就是禁用的，更加安全。

### 练习 2：简答题
**题目**：什么是 PHP 反序列化中的 POP 链 (Property-Oriented Programming)？
**参考答案**：POP 链是指由于单个类的魔术方法无法直接实现攻击目标，攻击者利用多个类之间的属性引用关系，将不同的魔术方法（如 `__get`, `__call`, `__toString`）串联起来，形成一条从受控输入到危险函数执行的完整路径。

---

## ✅ 评估标准

- [ ] 我理解并能手写基础的 DTD 外部实体声明。
- [ ] 我能看懂 PHP 序列化后的字符串含义（类名、长度、属性名等）。
- [ ] 我掌握了 Python Pickle 反序列化导致 RCE 的基本逻辑。

---

## 💡 知识卡片速查

### 反序列化防御“金律”
1.  **绝不反序列化不受信任的数据**：这是最根本的防御。
2.  **签名校验**：如果必须传输序列化数据，应使用 HMAC 进行签名，防止 Payload 被篡改。
3.  **使用安全格式**：优先使用 JSON 或 Protobuf 等不支持复杂对象行为的纯数据格式。
4.  **黑名单机制**：虽然不完美，但可以过滤已知的危险类。

---

> 💬 **老师寄语**：
> XXE 让数据“反客为主”，反序列化让对象“借尸还魂”。掌握这两个漏洞，你才真正触及了现代 Web 应用逻辑的核心地带。

```bash
git add daily/Day041.md
git commit -m "Day041: 完成 XXE 与不安全反序列化入门"
```
