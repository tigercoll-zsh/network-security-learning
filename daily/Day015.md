---
title: Day015：操作系统与脚本 - Linux 安全基础
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 3ca7da61
date: 2026-01-08 00:00:00
updated: 2026-01-08 00:00:00

---
# Day015：操作系统与脚本 - Linux 安全基础

- 日期：2026-01-08
- 周次：第 3 周

## 学习目标

学完今天你应该能做到：

- 能用一句话解释 Linux 安全三件套：**用户/组**、**权限**、**服务**
- 看懂 `-rwxr-xr-x` 权限字符串，能算出 `755/644`
- **理解并能查找特殊权限（SUID/SGID）带来的提权风险**
- 在"自建或明确授权"的 Linux 环境里完成最小加固动作：
  - 新建普通用户并配置 sudo（**遵循最小权限原则**）
  - 理解"禁止 root 直接登录"的原理（谨慎实施）
  - 查看安全日志并识别关键事件（登录成功/失败/sudo 使用）
  - 盘点监听端口（**攻击面最小化**）
- 输出一份 Linux 加固清单（至少 10 条可执行措施）

> **环境说明**：没有 Linux 也能学！可用 WSL/虚拟机/云主机，或者先把"概念/命令/清单"整理出来。

<!--more-->

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 2 周：安全协议与加密 (已完成)
└── 第 3 周：Linux 系统安全
    ├── Day015：用户与权限管理基础
    │   ├── 核心概念：rwx、SUID、sudo
    │   ├── 实践技能：chmod/chown、服务管理、日志审计
    │   └── 关联知识点：最小权限原则、攻击面管理
    ├── Day016：Linux 文件系统安全
    └── Day017：Linux 进程与计划任务
```

### 今日关键词

`rwx` · `SUID` · `sudo` · `systemctl` · `journalctl` · **`最小权限`** · **`攻击面`**

---

## 📚 完整学习内容

### 1️⃣ Linux 权限模型：3 类人 × 3 种权限 = 9 位权限位

#### 基础权限（必须掌握）

Linux 文件权限看 **3 类人**：

| 类别 | 符号 | 含义 | 示例 |
|------|------|------|------|
| **Owner** | `u` | 文件拥有者（创建者或被 chown 指定） | root、alice、www-data |
| **Group** | `g` | 文件所属组（同组用户共享权限） | wheel、developers、www-data |
| **Others** | `o` | 其他所有人（非 owner 非 group） | 系统上的其他用户 |

每类人有 **3 个权限位**：

| 权限 | 符号 | 数值 | 文件含义 | 目录含义 |
|------|------|------|----------|----------|
| **Read** | `r` | 4 | 可读取文件内容 | 可列出目录内容（ls） |
| **Write** | `w` | 2 | 可修改文件内容 | 可在目录中创建/删除文件 |
| **Execute** | `x` | 1 | 可执行文件（脚本/二进制） | 可进入目录（cd） |

#### 权限计算（快速记忆）

| 数字 | 二进制 | 权限 | 说明 |
|------|--------|------|------|
| **7** | 111 | `rwx` | 读+写+执行 (4+2+1) |
| **6** | 110 | `rw-` | 读+写 (4+2) |
| **5** | 101 | `r-x` | 读+执行 (4+1) |
| **4** | 100 | `r--` | 只读 (4) |
| **3** | 011 | `-wx` | 写+执行 (2+1) |
| **2** | 010 | `-w-` | 只写 (2) |
| **1** | 001 | `--x` | 只执行 (1) |
| **0** | 000 | `---` | 无权限 (0) |

**常见权限组合**：

| 权限 | 数字表示 | 典型用途 | 示例文件 |
|------|----------|----------|----------|
| `-rw-r--r--` | **644** | 普通文件（owner 可写，其他人只读） | `/etc/passwd` |
| `-rwxr-xr-x` | **755** | 可执行文件/脚本 | `/usr/bin/ls` |
| `-rw-------` | **600** | 私密文件（只有 owner 可读写） | `~/.ssh/id_rsa` |
| `-rw-r-----` | **640** | 敏感配置（owner 可写，group 可读） | `/etc/shadow` |
| `drwxr-xr-x` | **755** | 普通目录 | `/home/alice` |
| `drwx------` | **700** | 私密目录 | `~/.ssh/` |

**实战示例**：

```bash
# 查看文件权限
ls -l /etc/passwd
# 输出：-rw-r--r-- 1 root root 2847 Jan 1 12:00 /etc/passwd
#      │└┬┘└┬┘└┬┘  │  │    │    │    │
#      │ │  │  │   │  │    │    │    └─ 文件名
#      │ │  │  │   │  │    │    └─ 修改时间
#      │ │  │  │   │  │    └─ 文件大小
#      │ │  │  │   │  └─ 所属组
#      │ │  │  │   └─ 所有者
#      │ │  │  └─ others (r--) = 4
#      │ │  └─ group (r--) = 4
#      │ └─ owner (rw-) = 6
#      └─ 文件类型 (- 普通文件, d 目录, l 软链接)

ls -l /etc/shadow
# 输出：-rw-r----- 1 root shadow 1234 Jan 1 12:00 /etc/shadow
# 权限：640 (owner=rw, group=r, others=无)
# 原因：密码哈希敏感，只有 root 和 shadow 组可读
```

#### 特殊权限（进阶理解）

| 权限 | 符号 | 数值 | 作用 | 典型应用 |
|------|------|------|------|----------|
| **SUID** | `s`（owner x 位） | 4000 | 执行时以文件 owner 身份运行 | `/usr/bin/passwd`（普通用户改密码需要写 /etc/shadow） |
| **SGID** | `s`（group x 位） | 2000 | 执行时以文件 group 身份运行；目录中新建文件继承目录 group | 共享目录 |
| **Sticky Bit** | `t`（others x 位） | 1000 | 目录中只有文件 owner 才能删除自己的文件 | `/tmp`（防止用户互删文件） |

**SUID 示例**：

```bash
ls -l /usr/bin/passwd
# 输出：-rwsr-xr-x 1 root root 68208 /usr/bin/passwd
#           ↑ s 表示 SUID（4755）
# 原理：普通用户执行 passwd 时，临时获得 root 权限，可以修改 /etc/shadow
```

**危险点**：

- ❌ **SUID 滥用**：攻击者可能利用有漏洞的 SUID 程序提权
- ✅ **定期检查**：`find / -perm -4000 -type f 2>/dev/null`（查找所有 SUID 文件）

### 2️⃣ 用户与组管理：最小权限原则

#### 核心原则

- **日常用普通用户**：避免全程 root 操作（误操作 = 灾难）
- **sudo 按需提权**：需要时才提升权限，操作可审计
- **禁止 root 远程登录**：防止暴力破解（改用密钥认证 + 普通用户登录）

#### 用户管理命令

| 操作 | 命令 | 示例 |
|------|------|------|
| 新建用户 | `useradd -m <用户名>` | `sudo useradd -m alice` |
| 设置密码 | `passwd <用户名>` | `sudo passwd alice` |
| 删除用户 | `userdel -r <用户名>` | `sudo userdel -r alice`（`-r` 删除主目录） |
| 修改用户组 | `usermod -aG <组名> <用户>` | `sudo usermod -aG sudo alice` |
| 查看用户信息 | `id <用户名>` | `id alice` |
| 列出所有用户 | `cat /etc/passwd` | 查看 UID、主目录、默认 shell |

#### sudo 配置（sudoers 文件）

**基础语法**：

```bash
# 编辑 sudoers（必须用 visudo，会检查语法错误）
sudo visudo
```

**常见配置示例**：

```bash
# 1. 允许 sudo 组的所有用户执行任何命令
%sudo   ALL=(ALL:ALL) ALL
#  │     │   │   │    │
#  │     │   │   │    └─ 可执行的命令（ALL = 所有）
#  │     │   │   └─ 可切换到的组
#  │     │   └─ 可切换到的用户
#  │     └─ 可在哪些主机执行
#  └─ % 表示组名

# 2. 允许 alice 执行特定命令（无需密码）
alice   ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx
#       ↑ 重启 nginx 不需要输密码

# 3. 允许 devops 组执行所有命令（无需密码）
%devops ALL=(ALL) NOPASSWD: ALL

# 4. 只允许 alice 重启特定服务
alice   ALL=(ALL) /usr/bin/systemctl restart nginx, /usr/bin/systemctl reload nginx
```

**安全建议**：

- ✅ 用 `visudo` 编辑（防止语法错误导致 sudo 失效）
- ✅ 最小权限：只给需要的命令权限（不要全部 NOPASSWD）
- ✅ 审计日志：sudo 操作会记录到 `/var/log/auth.log`

### 3️⃣ 服务管理：攻击面最小化

#### systemd 服务管理（现代 Linux）

| 操作 | 命令 | 说明 |
|------|------|------|
| 列出所有服务 | `systemctl list-units --type=service` | 查看运行中的服务 |
| 启动服务 | `sudo systemctl start <服务名>` | `sudo systemctl start nginx` |
| 停止服务 | `sudo systemctl stop <服务名>` | `sudo systemctl stop apache2` |
| 重启服务 | `sudo systemctl restart <服务名>` | `sudo systemctl restart sshd` |
| 开机自启 | `sudo systemctl enable <服务名>` | `sudo systemctl enable nginx` |
| 禁止自启 | `sudo systemctl disable <服务名>` | `sudo systemctl disable bluetooth` |
| 查看服务状态 | `systemctl status <服务名>` | `systemctl status sshd` |
| 查看服务日志 | `journalctl -u <服务名>` | `journalctl -u sshd -n 50` |

#### 监听端口排查（攻击面盘点）

```bash
# 查看所有监听端口（推荐）
sudo ss -lntup
# -l: listening（监听）
# -n: numeric（显示 IP 而不是域名）
# -t: TCP
# -u: UDP
# -p: process（显示进程名）

# 输出示例：
# Netid  State   Local Address:Port   Process
# tcp    LISTEN  0.0.0.0:22            users:(("sshd",pid=1234))
# tcp    LISTEN  0.0.0.0:80            users:(("nginx",pid=5678))
# tcp    LISTEN  127.0.0.1:3306        users:(("mysqld",pid=9012))
#        ↑                              ↑
#     监听所有接口                   只监听本地
```

**常见端口与风险**：

| 端口 | 服务 | 风险 | 建议 |
|------|------|------|------|
| **22** | SSH | 暴力破解、弱密码 | 改端口、密钥认证、禁止 root 登录 |
| **80/443** | HTTP/HTTPS | Web 漏洞 | 及时更新、WAF、最小权限运行 |
| **3306** | MySQL | 数据库泄露 | **只监听 127.0.0.1**（不对外） |
| **5432** | PostgreSQL | 数据库泄露 | 同上 |
| **6379** | Redis | 未授权访问 | 设置密码、绑定内网 IP |
| **3389** | RDP（Windows） | 暴力破解 | Linux 一般没有，如有则关闭 |
| **445** | SMB | 勒索病毒 | Linux 一般没有，如有则关闭 |

**最小暴露原则**：

```bash
# ✅ 好：数据库只监听本地（127.0.0.1:3306）
# ❌ 坏：数据库监听所有接口（0.0.0.0:3306）

# 检查命令
sudo ss -lntp | grep :3306
# 如果看到 0.0.0.0:3306 或 :::3306，说明对外暴露了！
```

### 4️⃣ 日志审计：你的"黑匣子"

#### 常见日志位置

| 日志文件 | 内容 | 发行版 |
|----------|------|--------|
| `/var/log/auth.log` | 认证日志（登录/sudo/su） | Debian/Ubuntu |
| `/var/log/secure` | 认证日志 | RHEL/CentOS |
| `/var/log/syslog` | 系统日志 | Debian/Ubuntu |
| `/var/log/messages` | 系统日志 | RHEL/CentOS |
| `journalctl` | systemd 日志（现代系统） | 所有使用 systemd 的发行版 |

#### 关键事件识别

**1. SSH 登录成功**：

```bash
# 查看最近的 SSH 登录
sudo journalctl -u sshd | grep "Accepted"

# 示例输出：
# Jan 08 10:23:45 server sshd[12345]: Accepted publickey for alice from 192.168.1.100 port 54321 ssh2: RSA SHA256:abc123...
#                                       ↑             ↑           ↑                   ↑
#                                    认证方式      用户名        来源IP              端口
```

**2. SSH 登录失败（暴力破解线索）**：

```bash
sudo journalctl -u sshd | grep "Failed"

# 示例输出：
# Jan 08 10:25:30 server sshd[12346]: Failed password for invalid user admin from 203.0.113.45 port 43210 ssh2
#                                                             ↑           ↑            ↑
#                                                         无效用户    用户名      攻击来源IP
```

**3. sudo 使用记录**：

```bash
sudo grep "sudo" /var/log/auth.log | tail -n 20

# 示例输出：
# Jan 08 10:30:00 server sudo: alice : TTY=pts/0 ; PWD=/home/alice ; USER=root ; COMMAND=/usr/bin/apt update
#                        ↑                                                ↑               ↑
#                    谁用 sudo                                        切换到谁        执行了什么命令
```

**4. 用户创建/删除**：

```bash
sudo grep "useradd\|userdel" /var/log/auth.log

# 示例输出：
# Jan 08 11:00:00 server useradd[12347]: new user: name=bob, UID=1001, GID=1001, home=/home/bob
```

#### journalctl 高级用法

| 用途 | 命令 | 说明 |
|------|------|------|
| 查看某服务日志 | `journalctl -u sshd` | 只看 sshd 服务 |
| 查看最近 N 行 | `journalctl -n 50` | 最近 50 行 |
| 实时查看 | `journalctl -f` | 类似 `tail -f` |
| 按时间筛选 | `journalctl --since "2026-01-08 10:00"` | 10点后的日志 |
| 按优先级筛选 | `journalctl -p err` | 只看错误级别 |
| 查看启动日志 | `journalctl -b` | 本次启动的日志 |

### 5️⃣ 防火墙基础：iptables vs firewalld vs ufw

| 防火墙 | 发行版 | 特点 | 学习曲线 |
|--------|--------|------|----------|
| **iptables** | 通用 | 底层、强大、复杂 | 陡峭 |
| **firewalld** | RHEL/CentOS | 动态规则、区域管理 | 中等 |
| **ufw** | Ubuntu | 简化版 iptables，易用 | 平缓 |

#### ufw 快速入门（Ubuntu 推荐）

```bash
# 1. 启用防火墙
sudo ufw enable

# 2. 查看状态
sudo ufw status

# 3. 允许特定端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# 4. 允许特定 IP 访问特定端口
sudo ufw allow from 192.168.1.0/24 to any port 22

# 5. 拒绝特定端口
sudo ufw deny 3306/tcp   # MySQL

# 6. 删除规则
sudo ufw delete allow 80/tcp

# 7. 重置所有规则
sudo ufw reset
```

## 实践任务（合法授权范围内）

> ⚠️ **重要提醒**：所有操作只在**自建/明确授权**的 Linux 环境执行！

### 任务 0（准备环境，三选一）

| 方案 | 难度 | 成本 | 说明 |
|------|------|------|------|
| **A. WSL** | ⭐ | 免费 | Windows 10/11 自带，适合学习 |
| **B. VirtualBox/VMware** | ⭐⭐ | 免费 | 需要下载 ISO（推荐 Ubuntu 22.04 LTS） |
| **C. 云主机** | ⭐⭐⭐ | 按量付费 | AWS/阿里云轻量服务器（注意关机节约成本） |

**WSL 快速安装**（推荐）：

```powershell
# Windows PowerShell（管理员）
wsl --install -d Ubuntu-22.04

# 安装完成后，设置用户名和密码
# 进入 WSL：直接在命令行输入 `wsl` 或 `ubuntu`
```

### 任务 1（必做）：文件权限识别与转换

#### 步骤 1：查看敏感文件权限与 SUID 风险

```bash
# 查看 /etc/passwd（用户信息）
ls -l /etc/passwd

# 查看 /etc/shadow（密码哈希）
ls -l /etc/shadow

# 查找系统中的 SUID 文件（提权风险点）
find / -perm -4000 -type f 2>/dev/null | head -n 5
```

**你要记录的内容**：

| 文件 | 权限（符号） | 权限（数字） | 所有者 | 所属组 | 为什么这样设置？ |
|------|--------------|--------------|--------|--------|------------------|
| `/etc/passwd` | `-rw-r--r--` | 644 | root | root | 用户信息公开可读，但只有 root 可写 |
| `/etc/shadow` | `-rw-r-----` | 640 | root | shadow | 密码哈希敏感，只有 root 和 shadow 组可读 |
| `/usr/bin/passwd` | `-rwsr-xr-x` | 4755 | root | root | **SUID**：允许普通用户以 root 身份修改自己的密码 |

#### 步骤 2：权限计算练习

手动计算以下权限：

1. `-rwxr-x---` = ?
2. `-rw-rw-r--` = ?
3. `drwx------` = ?

<details>
<summary>答案</summary>

1. `750`（owner=7, group=5, others=0）
2. `664`（owner=6, group=6, others=4）
3. `700`（目录，owner=7, group=0, others=0）
</details>

### 任务 2（必做）：创建用户并配置 sudo

#### 步骤 1：创建新用户

```bash
# 创建用户（-m 创建主目录）
sudo useradd -m -s /bin/bash alice
#            │  │
#            │  └─ 指定默认 shell
#            └─ 创建 /home/alice

# 设置密码
sudo passwd alice
# 输入两次密码（建议：P@ssw0rd!123）
```

#### 步骤 2：将用户加入 sudo 组

```bash
# Ubuntu/Debian
sudo usermod -aG sudo alice

# RHEL/CentOS
sudo usermod -aG wheel alice
```

#### 步骤 3：验证配置

```bash
# 查看用户信息
id alice
# 输出应包含：groups=...,27(sudo),...

# 切换到新用户测试 sudo
su - alice
# 输入 alice 的密码

# 测试 sudo
sudo whoami
# 输入 alice 的密码
# 输出：root（说明 sudo 生效）
```

**你要提交的证据**：

- [ ] `id alice` 的输出截图（能看到 sudo 组）
- [ ] `sudo whoami` 的输出（显示 root）

### 任务 3（必做）：盘点监听端口（攻击面评估）

```bash
# 查看所有监听端口
sudo ss -lntup | column -t

# 或者用更详细的输出
sudo ss -lntup | awk 'NR==1 || /LISTEN/ {print $0}' | column -t
```

**你要分析的内容**：

| 端口 | 协议 | 进程名 | 监听地址 | 是否需要对外？ | 风险评估 |
|------|------|--------|----------|----------------|----------|
| 22 | TCP | sshd | 0.0.0.0 | ✅ 是（远程管理） | 高（改端口/密钥认证） |
| 80 | TCP | nginx | 0.0.0.0 | ✅ 是（Web 服务） | 中（及时更新） |
| 3306 | TCP | mysqld | **0.0.0.0** | ❌ 否（应该 127.0.0.1） | **高风险！** |

**修复示例**（MySQL 只监听本地）：

```bash
# 编辑 MySQL 配置
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# 找到 bind-address 行，改为：
bind-address = 127.0.0.1

# 重启 MySQL
sudo systemctl restart mysql

# 验证
sudo ss -lntp | grep :3306
# 应该看到 127.0.0.1:3306（不是 0.0.0.0）
```

### 任务 4（必做）：查看认证日志

#### 方案 A：journalctl（推荐）

```bash
# 查看 SSH 服务日志（最近 50 行）
sudo journalctl -u ssh -n 50 --no-pager

# 筛选登录成功事件
sudo journalctl -u ssh | grep "Accepted"

# 筛选登录失败事件
sudo journalctl -u ssh | grep "Failed"

# 查看今天的 sudo 使用记录
sudo journalctl --since today | grep sudo
```

#### 方案 B：传统日志文件

```bash
# Ubuntu/Debian
sudo tail -n 50 /var/log/auth.log

# RHEL/CentOS
sudo tail -n 50 /var/log/secure

# 筛选 SSH 登录
sudo grep "sshd.*Accepted" /var/log/auth.log

# 筛选 sudo 使用
sudo grep "sudo.*COMMAND" /var/log/auth.log
```

**你要提取的信息**：

1. **最近一次成功登录**：
   - 用户名：
   - 来源 IP：
   - 认证方式（password/publickey）：
   - 时间：

2. **最近一次 sudo 使用**：
   - 用户名：
   - 执行的命令：
   - 时间：

3. **异常事件**（如果有）：
   - 失败登录次数：
   - 来源 IP（是否陌生）：

### 任务 5（可选）：配置 ufw 防火墙

```bash
# 1. 安装 ufw（Ubuntu 一般自带）
sudo apt install ufw

# 2. 查看当前状态
sudo ufw status verbose

# 3. 设置默认策略（拒绝所有入站，允许所有出站）
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 4. 允许 SSH（⚠️ 先允许 SSH，否则会把自己锁死！）
sudo ufw allow 22/tcp

# 5. 启用防火墙
sudo ufw enable

# 6. 验证规则
sudo ufw status numbered
```

**扩展练习**：

- 只允许特定 IP 段访问 SSH：`sudo ufw allow from 192.168.1.0/24 to any port 22`
- 允许 HTTP/HTTPS：`sudo ufw allow 80/tcp; sudo ufw allow 443/tcp`
- 拒绝特定 IP：`sudo ufw deny from 203.0.113.45`

## 巩固练习（题与复盘）

### 题 1：权限转换（必做）

将以下权限互相转换：

| 符号表示 | 数字表示 |
|----------|----------|
| `-rwxr-xr-x` | ? |
| `-rw-r-----` | ? |
| `drwx------` | ? |
| `?` | 644 |
| `?` | 750 |
| `?` | 600 |

### 题 2：安全场景判断（必做）

判断以下配置是否安全，如果不安全，写出正确配置：

1. `/etc/shadow` 权限是 `644`
2. 一个名为 `vim` 的程序被设置了 SUID 权限 (`-rwsr-xr-x`)
3. MySQL 监听 `0.0.0.0:3306`
4. 所有用户都在 sudoers 中配置了 `NOPASSWD: ALL`
5. SSH 配置 `PermitRootLogin yes`

### 题 3：写一份 Linux 加固清单（10 条以上）

从以下角度写：账号管理、权限控制、服务管理、网络安全、日志审计。

### 题 4（进阶）：设计一个 sudo 权限方案

场景：你的团队有 3 类人员：

- **开发人员**（developers）：需要重启 Web 服务（nginx/apache2）
- **DBA**（dba）：需要重启数据库服务（mysql/postgresql）
- **运维人员**（ops）：需要所有权限

写出 sudoers 配置。

## 评估标准（达成判定）

| 评估项 | 达成标准 | 检查方法 |
|--------|----------|----------|
| **权限理解** | 能正确转换 rwx ↔ 数字，**并识别 SUID 风险** | 检查题 1/2 答案 |
| **用户管理** | 成功创建用户并配置 sudo，**遵循最小权限** | 检查任务 2 截图 |
| **攻击面盘点** | 输出监听端口清单并评估风险，**识别对外暴露服务** | 检查任务 3 分析表 |
| **日志审计** | 能找到 SSH 登录/sudo 使用记录，**识别暴力破解迹象** | 检查任务 4 提取信息 |
| **加固意识** | 输出 10+ 条加固清单，**涵盖账号/网络/服务安全** | 检查题 3 清单 |

**达成判定**：

- ✅ **优秀**（5/5）：完成所有任务 + 题 1-4 全部完成 + 清单 15+ 条
- ✅ **良好**（4/5）：完成 4 个必做任务 + 题 1-3 完成 + 清单 10+ 条
- ✅ **合格**（3/5）：完成 3 个必做任务 + 题 1-2 完成 + 清单 5+ 条

## 学习成果达成情况（由学习者填写）

### 截图与证据

- [ ] 任务 1：`ls -l /etc/shadow` 权限截图
- [ ] 任务 2：`id alice` 输出截图（含 sudo 组）
- [ ] 任务 2：`sudo whoami` 输出截图（显示 root）
- [ ] 任务 3：`ss -lntup` 监听端口截图
- [ ] 任务 4：`journalctl -u ssh | grep Accepted` 截图
- [ ] 任务 5（可选）：`ufw status` 截图

### 关键命令与输出

**权限查看**：

```
/etc/passwd: -rw-r--r-- (644)
/etc/shadow: -rw-r----- (640)
~/.ssh/id_rsa: -rw------- (600)
```

**监听端口**：

```
端口 22: sshd (0.0.0.0) - 需要对外
端口 80: nginx (0.0.0.0) - 需要对外
端口 3306: mysqld (127.0.0.1) - 只监听本地 ✅
```

**日志摘要**：

```
最近登录：alice from 192.168.1.100 (publickey)
最近 sudo：alice executed /usr/bin/apt update
```

### 权限转换练习（题 1 答案）

| 符号表示 | 数字表示 |
|----------|----------|
| `-rwxr-xr-x` | **755** |
| `-rw-r-----` | **640** |
| `drwx------` | **700** |
| `-rw-r--r--` | **644** |
| `-rwxr-x---` | **750** |
| `-rw-------` | **600** |

### 安全场景判断（题 2 答案）

1. ❌ **不安全**：`/etc/shadow` 权限 644
   - ✅ **正确**：应该是 640（`-rw-r-----`），只有 root 和 shadow 组可读
   - **原因**：密码哈希敏感，所有用户可读会泄露

2. ❌ **极度危险**：`vim` 程序有 SUID 权限
   - ✅ **正确**：绝不应给编辑器设置 SUID
   - **原因**：如果 vim 有 SUID，任何用户都可以用它编辑 `/etc/shadow` 或 `/etc/sudoers`，直接提权为 root！

3. ❌ **不安全**：MySQL 监听 0.0.0.0:3306
   - ✅ **正确**：应该监听 127.0.0.1:3306（只本地访问）
   - **修复**：编辑 `/etc/mysql/mysql.conf.d/mysqld.cnf`，设置 `bind-address = 127.0.0.1`

4. ❌ **不安全**：所有用户 `NOPASSWD: ALL`
   - ✅ **正确**：最小权限原则，只给需要的命令权限
   - **示例**：`alice ALL=(ALL) /usr/bin/systemctl restart nginx`

5. ❌ **不安全**：SSH 配置 `PermitRootLogin yes`
   - ✅ **正确**：应该设置为 `PermitRootLogin no`
   - **修复**：编辑 `/etc/ssh/sshd_config`，重启 sshd

### Linux 加固清单（题 3 答案）

#### 账号管理（5 条）

1. ✅ **禁止 root 远程登录**：`PermitRootLogin no` in `/etc/ssh/sshd_config`
2. ✅ **使用密钥认证**：禁用密码登录（`PasswordAuthentication no`）
3. ✅ **定期审计用户**：删除不再需要的账号（`userdel -r <user>`）
4. ✅ **强制密码策略**：安装 `libpam-pwquality`，配置最小长度/复杂度
5. ✅ **锁定长期未登录账号**：`usermod -L <user>`（锁定）或删除

#### 权限控制（3 条）

6. ✅ **敏感文件权限**：
   - `/etc/shadow`: 640
   - `~/.ssh/id_*`: 600
   - `/etc/sudoers`: 440
7. ✅ **定期检查 SUID 文件**：`find / -perm -4000 -type f 2>/dev/null`
8. ✅ **sudo 最小权限**：不要用 `NOPASSWD: ALL`，精确到具体命令

#### 服务管理（3 条）

9. ✅ **关闭不需要的服务**：`systemctl disable <service>`
10. ✅ **最小暴露原则**：数据库只监听 127.0.0.1
11. ✅ **及时更新补丁**：`apt update && apt upgrade`（或 `yum update`）

#### 网络安全（4 条）

12. ✅ **配置防火墙**：ufw/firewalld，默认拒绝入站
13. ✅ **修改 SSH 默认端口**：改为非 22 端口（如 2222）
14. ✅ **SSH 限制来源 IP**：`AllowUsers alice@192.168.1.0/24`
15. ✅ **安装 fail2ban**：自动封禁暴力破解 IP

#### 日志审计（3 条）

16. ✅ **集中日志管理**：配置 rsyslog 发送到日志服务器
17. ✅ **定期检查日志**：每天查看 `/var/log/auth.log` 是否有异常
18. ✅ **启用审计系统**：安装 `auditd`，记录文件访问/命令执行

### sudo 权限方案（题 4 答案）

```bash
# 编辑 sudoers
sudo visudo

# 1. 开发人员组（只能重启 Web 服务）
%developers ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx, \
                                  /usr/bin/systemctl reload nginx, \
                                  /usr/bin/systemctl restart apache2, \
                                  /usr/bin/systemctl reload apache2

# 2. DBA 组（只能管理数据库服务）
%dba ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart mysql, \
                          /usr/bin/systemctl restart postgresql, \
                          /usr/bin/systemctl status mysql, \
                          /usr/bin/systemctl status postgresql

# 3. 运维人员组（所有权限，但需要密码）
%ops ALL=(ALL) ALL

# 4. 审计（可选）：记录所有 sudo 命令到单独日志
Defaults logfile="/var/log/sudo.log"
Defaults log_input, log_output
```

**安全要点**：

- 开发/DBA 用 `NOPASSWD`（频繁操作，但范围受限）
- 运维需要密码（权限大，增加一层验证）
- 所有 sudo 操作都会记录到日志

### 结论与反思

**我今天搞清楚了**：

- Linux 权限模型：3 类人（owner/group/others）× 3 种权限（rwx）= 9 位权限位
- 权限数字表示：r=4, w=2, x=1，快速计算（如 644 = rw-r--r--）
- 特殊权限：SUID/SGID/Sticky Bit 的作用与风险
- sudo 配置：最小权限原则，不要滥用 `NOPASSWD: ALL`
- 攻击面盘点：用 `ss -lntup` 查看监听端口，数据库不要监听 0.0.0.0
- 日志审计：journalctl 查看 SSH 登录/sudo 使用记录

**我差点搞混的是**：

- 以为 `/etc/shadow` 权限 644 没问题（其实应该是 640）
- 以为 SSH 私钥权限 644 可以用（SSH 会拒绝权限过宽的私钥）
- 以为 MySQL 监听 0.0.0.0 没关系（其实应该只监听 127.0.0.1）

**明天我要继续补的是**：

- Windows 安全基础（UAC、事件日志、防火墙）
- PowerShell 脚本自动化（日志分析、CSV 导出）
- 实际搭建一个 fail2ban 防暴力破解

**本次学习耗时**：约 \_\_\_ 小时

**掌握程度自评**：

- [ ] 😕 只看懂了概念，没动手
- [ ] 🙂 完成了部分任务（WSL 环境搭建成功）
- [ ] 😃 完成了所有必做任务并理解原理
- [ ] 🤩 额外研究了 SELinux/AppArmor/auditd

## 集中参考答案（含思路）

### 题 1 参考答案（权限转换）

**方法**：每 3 位权限为一组，rwx 对应 421：

```
-rwxr-xr-x
 └┬┘└┬┘└┬┘
  7  5  5  = 755

-rw-r-----
 └┬┘└┬┘└┬┘
  6  4  0  = 640

drwx------
 └┬┘└┬┘└┬┘
  7  0  0  = 700（d 表示目录）

644 → rw-r--r-- (6=rw, 4=r, 4=r)
750 → rwxr-x--- (7=rwx, 5=rx, 0=无)
600 → rw------- (6=rw, 0=无, 0=无)
```

### 题 2 参考答案（详见上方"安全场景判断"）

### 题 3 参考答案（详见上方"Linux 加固清单"，共 18 条）

### 题 4 参考答案（详见上方"sudo 权限方案"）

## 学习成果示例填写（可照抄）

### 截图与证据（示例）

- `images/day015_shadow_perm.png`：`/etc/shadow` 权限 `-rw-r-----` (640)
- `images/day015_user_sudo.png`：`id alice` 输出包含 `sudo` 组
- `images/day015_ports.png`：`ss -lntup` 显示端口 22/80，MySQL 只监听 127.0.0.1
- `images/day015_ssh_log.png`：`journalctl -u ssh | grep Accepted` 显示登录记录

### 关键命令与输出（示例）

```bash
# 权限查看
-rw-r--r-- 1 root root 2847 /etc/passwd  (644)
-rw-r----- 1 root shadow 1234 /etc/shadow  (640)
-rw------- 1 alice alice 1679 /home/alice/.ssh/id_rsa  (600)

# 监听端口
tcp LISTEN 0.0.0.0:22 sshd
tcp LISTEN 0.0.0.0:80 nginx
tcp LISTEN 127.0.0.1:3306 mysqld  ✅ 只监听本地

# 日志摘要
Accepted publickey for alice from 192.168.1.100 port 54321
sudo: alice : COMMAND=/usr/bin/apt update
```

### 反思（示例）

- 我以前装完 Linux 就不管了，现在知道要盘点监听端口、检查权限、看日志。
- 下次我会先建普通用户 + sudo，再考虑禁止 root 登录，避免把自己锁死。
- 最大收获：**攻击面最小化** = 关闭不需要的服务 + 数据库只监听本地 + 防火墙默认拒绝。
