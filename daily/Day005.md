---
title: Day005：网络与协议基础 - DNS 工作流
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: 5035d
date: 2026-01-27
updated: 2026-01-27
---

# Day005：网络与协议基础 - DNS 工作流

- **日期**：2026-01-27
- **周次**：第 1 周
- **模块**：网络与协议基础
- **主题**：DNS 工作流
- **预计学习时间**：2 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- 理解解析流程与常见记录类型（A/AAAA/CNAME/MX/TXT）
- 能使用命令查询域名的详细信息
- 能抓包与解释一次 DNS 解析过程

<!--more-->

## 📚 完整学习内容（必读）

本节包含今天需要学习的全部知识点，请认真阅读并理解。

### 一、概念理解

#### 5.1.1 DNS 的作用
- **DNS（Domain Name System）域名系统**：互联网的电话簿。
- **作用**：人类擅长记名字（如 `www.baidu.com`），机器擅长记数字（如 `110.242.68.3`）。DNS 负责把名字翻译成数字。
- **重要性**：DNS 挂了，你就只能通过 IP 访问网站，基本等于断网。

#### 5.1.2 DNS 层次结构（倒树状结构）
- **根域名服务器 (.)**：全球只有 13 组，是所有解析的起点。
- **顶级域（TLD）服务器**：管理 `.com`, `.cn`, `.org` 等后缀。
- **权威域名服务器**：管理具体域名（如 `baidu.com`）的服务器，由企业自己或云厂商维护，它是最终说了算的。
- **本地 DNS 服务器 (Local DNS)**：通常是你的运营商（ISP）提供的，或者是公共 DNS（如 8.8.8.8）。它负责帮你跑腿查询。

#### 5.1.3 DNS 解析类型
- **递归解析**：你问 Local DNS “百度的 IP 是多少？”，它帮你问了一圈，直接告诉你结果。（**全包服务**）
- **迭代解析**：Local DNS 问根服务器，根说“我不知道，你去找 .com 问”；Local DNS 又问 .com，.com 说“我不知道，你去找 baidu.com 问”。（**踢皮球服务**）

#### 5.1.4 DNS 记录类型
- **A 记录**：域名 -> IPv4 地址（最常用）。
- **AAAA 记录**：域名 -> IPv6 地址。
- **CNAME 记录**：别名 -> 真名（`www.a.com` -> `a.com`）。常用于 CDN。
- **MX 记录**：邮件交换记录，告诉发件人把邮件发给哪台服务器。
- **TXT 记录**：文本信息，常用于验证域名所有权（SSL 证书验证、反垃圾邮件 SPF）。
- **NS 记录**：告诉别人哪台服务器是这个域名的权威 DNS。

### 二、原理讲解

#### 5.2.1 DNS 解析流程（完整版）
假设你在浏览器输入 `www.example.com`：
1. **查浏览器缓存**：浏览器先看自己有没有记过。
2. **查系统缓存**：看操作系统的 `hosts` 文件和 DNS 缓存。
3. **发给 Local DNS**：如果没有，电脑就发请求给 Local DNS（如 8.8.8.8）。
4. **Local DNS 迭代查询**：
   - 问**根 (.)**：你知道 `www.example.com` 吗？根：不知道，去找 `.com`。
   - 问 **.com**：你知道 `www.example.com` 吗？.com：不知道，去找 `example.com` 的权威 DNS。
   - 问 **example.com 权威 DNS**：你知道 `www.example.com` 吗？权威：知道，IP 是 `93.184.216.34`。
5. **返回结果**：Local DNS 把 IP 告诉你，并存入缓存。

#### 5.2.2 DNS 缓存机制
- 为了不让根服务器累死，DNS 极度依赖缓存。
- **TTL（Time To Live）**：权威 DNS 告诉 Local DNS，“这个 IP 你可以记 600 秒，过期前别再来烦我”。
- **负缓存**：如果域名不存在，这个“不存在”的结果也会被缓存一段时间。

#### 5.2.3 CNAME 解析过程
1. 浏览器查 `www.a.com`。
2. DNS 返回：它是 `b.cdn.com` 的别名 (CNAME)。
3. 浏览器自动重新查 `b.cdn.com` 的 A 记录。
4. 得到最终 IP。

### 三、技术细节

#### 5.3.1 DNS 报文格式
DNS 基于 UDP 协议（端口 53），为了快；但在响应太大时（如 DNSSEC）会切换到 TCP。
```
DNS 头部 (12 字节)
┌─────────────┬─────────────┬─────────────┬─────────────┐
│标识(ID)     │标志(Flags)  │问题数       │回答数       │
├─────────────┼─────────────┼─────┼─────┼─────────────┤
│权威记录数   │附加记录数   │...          │...          │
└─────────────┴─────────────┴─────┴─────┴─────────────┘
```

#### 5.3.2 DNS 查询类型代码
- **A** = 1
- **NS** = 2
- **CNAME** = 5
- **MX** = 15
- **AAAA** = 28

#### 5.3.3 DNS 响应码
- **NOERROR (0)**：一切正常。
- **NXDOMAIN (3)**：域名不存在（Non-Existent Domain）。你输错网址时常看到这个。
- **SERVFAIL (2)**：服务器内部错误（通常是 DNS 挂了）。

#### 5.3.4 nslookup 命令用法
Windows/Linux 通用：
```bash
nslookup www.baidu.com        # 查询 A 记录（默认）
nslookup -type=MX baidu.com   # 查询邮件服务器
nslookup -type=NS baidu.com   # 查询权威 DNS
nslookup www.baidu.com 8.8.8.8 # 指定使用 8.8.8.8 进行查询
```

### 四、进阶知识（选学）

#### 5.4.1 DNS 安全问题
- **DNS 劫持**：运营商或黑客篡改 Local DNS 的解析结果，把你引到广告页或钓鱼网站。
- **DNS 缓存投毒**：攻击者向 Local DNS 发送伪造的响应，污染缓存。

#### 5.4.2 DNS over HTTPS (DoH)
- 传统的 DNS 是明文传输的，谁都能看见你访问了什么网站。
- **DoH**：把 DNS 请求加密封装在 HTTPS 流量里，外人看来你只是在访问普通的 HTTPS 网站，保护隐私。

#### 5.4.3 CDN 调度原理
CDN 利用 DNS 将用户解析到最近的服务器节点。
- 北京用户查 `www.a.com` -> 解析到北京联通节点 IP。
- 上海用户查 `www.a.com` -> 解析到上海电信节点 IP。

### 五、本日知识点速查表

| 序号 | 核心概念 | 关键点 | 备注 |
|------|----------|--------|------|
| 1 | 递归查询 | 帮我查到底 | 客户端 <-> Local DNS |
| 2 | 迭代查询 | 告诉我找谁 | Local DNS <-> 权威 DNS |
| 3 | A 记录 | 域名转 IP | 基础记录 |
| 4 | CNAME | 域名转域名 | 别名/CDN |
| 5 | TTL | 缓存时间 | 越短生效越快，压力越大 |

---

## 🗺️ 知识图谱

### 今日内容在整体知识体系中的位置

```
网络安全学习路径
├── 第 1 周：网络与协议基础
│   ├── Day003：IP、ICMP 与路由基础
│   ├── Day004：TCP/UDP 与会话
│   └── Day005：DNS 工作流
│       ├── 核心概念：递归/迭代、记录类型
│       ├── 实践技能：nslookup/dig、抓包分析
│       └── 关联知识点：CDN、DoH、Host碰撞
└── 后续衔接
    └── Day006：应用层：HTTP 协议详解
```

### 今日关键词

`DNS` · `解析` · `递归` · `迭代` · `缓存`

---

## 🔧 实践任务（合法授权范围内）

> ⚠️ **安全提示**：所有任务必须在合法授权的实验环境中进行，禁止对未授权目标进行任何测试。

请按顺序完成以下任务：

### 任务 1：环境准备（5 分钟）

查看本机 DNS 配置，看看是谁在为你提供解析服务。

**操作步骤**：
1. 打开终端/命令行
2. 输入命令：
   - Windows: `ipconfig /all`，找 "DNS Servers"
   - Linux/Mac: `cat /etc/resolv.conf`
3. 观察输出结果：记录下你的 DNS 服务器 IP（通常是路由器的 IP 或 运营商 IP）。
4. 截图保存。

### 任务 2：核心实验（30 分钟）

使用 nslookup 手动查询各种 DNS 记录。

**操作步骤**：
1. **查 Web 服务器 IP**：`nslookup www.baidu.com`
   - *观察*：可能会返回多个 IP（负载均衡），也可能有 `Aliases`（CNAME）。
2. **查邮件服务器**：`nslookup -type=MX baidu.com`
   - *观察*：你会看到百度用来收邮件的服务器列表。
3. **查权威 DNS**：`nslookup -type=NS baidu.com`
   - *观察*：管理百度域名的服务器是谁（通常是 `ns1.baidu.com` 等）。
4. **指定 DNS 查询**：`nslookup www.google.com 8.8.8.8`
   - *观察*：强制问 Google 的 DNS，看看结果和问本地 DNS 有什么不同。

**预期结果**：
- 结果 1：成功解析出 IP 地址。
- 结果 2：MX 记录通常会有优先级（preference），数字越小优先级越高。

### 任务 3：进阶挑战（选做，15 分钟）

抓取 DNS 查询包，看看明文的 DNS 长什么样。

**操作步骤**：
1. 打开 Wireshark，设置过滤器：`udp.port == 53`。
2. 此时不要访问网页（杂音太多）。打开命令行。
3. 清除 DNS 缓存：
   - Windows: `ipconfig /flushdns`
   - Mac: `sudo killall -HUP mDNSResponder`
4. 执行 `ping www.example.com`（Ping 之前会先解析）。
5. 停止捕获，分析 Wireshark 中的两个包：
   - **Standard query**：这是请求。
   - **Standard query response**：这是响应，展开 `Answers` 字段查看结果。

---

## 📝 巩固练习（题目与复盘）

完成以下练习来检验你的学习效果。

### 练习 1：概念理解（5 分钟）

描述完整的 DNS 解析流程，包括各级服务器的作用。

**参考答案**（完成后对照）：
1. 客户端 -> Local DNS（递归）。
2. Local DNS -> 根服务器（迭代，返回 .com 地址）。
3. Local DNS -> .com TLD 服务器（迭代，返回 example.com 地址）。
4. Local DNS -> example.com 权威服务器（迭代，返回最终 IP）。
5. Local DNS -> 客户端（返回结果）。

### 练习 2：实操应用（10 分钟）

解释 CNAME 记录的作用及其解析过程。

**参考答案**（完成后对照）：
- **作用**：起别名。比如把 `blog.me.com` 指向 `github.io`。好处是如果 `github.io` 换 IP 了，我不用改配置，自动跟随。
- **过程**：DNS 解析到 CNAME 后，不会返回 IP，而是返回新的域名，客户端（或 Local DNS）必须拿这个新域名重新跑一遍解析流程。

### 练习 3：深度思考（10 分钟）

DNS 缓存的层次有哪些？TTL 如何影响缓存？

**参考答案**（完成后对照）：
- **层次**：浏览器缓存 -> 系统缓存 (hosts) -> 路由器缓存 -> ISP Local DNS 缓存。
- **TTL 影响**：TTL 设置得长（如 24 小时），解析速度快，服务器压力小，但修改 IP 后生效慢；TTL 设置得短（如 60 秒），修改生效快（适合故障切换），但解析频繁，服务器压力大。

---

## ✅ 评估标准（达成判定）

请对照以下标准检查你的学习成果：

- [x] 能使用 nslookup 或 dig 进行各种 DNS 查询
- [x] 能在抓包中识别 DNS 查询和响应报文
- [x] 理解 DNS 解析的完整流程和各级服务器作用

### 自检清单

完成学习后，请检查以下项目：

- [ ] **概念理解**：能画出 DNS 解析流程图
- [ ] **实际应用**：知道 MX 记录是干嘛的
- [ ] **动手能力**：能用 nslookup 查任意域名
- [ ] **时间管理**：能在 2 小时内完成今日学习内容

### 学习进度自评

| 评估项目 | 1-5 星 | 备注 |
|----------|--------|------|
| 概念理解 | ⭐⭐⭐⭐⭐ | 是否分清了递归和迭代？ |
| 动手能力 | ⭐⭐⭐⭐⭐ | nslookup 用熟了吗？ |
| 时间控制 | ⭐⭐⭐⭐⭐ | 抓包顺利吗？ |
| 学习兴趣 | ⭐⭐⭐⭐⭐ | 觉得 DNS 也是个神奇的系统吗？ |

---

## 📊 学习成果记录（由学习者填写）

### 学习信息

| 项目 | 内容 |
|------|------|
| 学习日期 | 2026-01-27 |
| 学习时长 | ___ 小时 |
| 完成情况 | ⬜ 已完成 / ⬜ 部分完成 / ⬜ 未完成 |

### 实践任务完成记录

| 任务 | 完成状态 | 关键证据/截图 | 用时 |
|------|----------|---------------|------|
| 任务 1 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：本机 DNS | ___ 分钟 |
| 任务 2 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 记录：nslookup 结果 | ___ 分钟 |
| 任务 3 | ⬜ 已完成 / ⬜ 部分 / ⬜ 未做 | 截图：Wireshark DNS 包 | ___ 分钟 |

### 命令/代码记录

```bash
# 记录你今天使用的命令
nslookup www.baidu.com
ipconfig /flushdns

# 记录重要的输出结果
Non-authoritative answer:
Name:    www.baidu.com
Address: 110.242.68.3
```

### 今日总结与反思

**今日收获**（用 3-5 句话总结今天学到了什么）：

_例如：原来我们访问网站背后有这么多人在跑腿。知道了 hosts 文件可以强制指定 DNS 解析，改了它就能屏蔽广告或者上一些内网系统。_

**遇到的问题与解决**：

_例如：nslookup 有时候显示 "Non-authoritative answer"，查了才知道这是因为结果来自缓存，不是直接问的权威服务器，是正常的。_

**明日待深化的问题**：

_例如：DoH 具体是怎么配置的？浏览器里可以直接开吗？_

---

## 💡 知识卡片速查

### 核心概念速记

| 概念 | 定义 | 举例 |
|------|------|------|
| **DNS** | 域名系统 | 互联网通讯录 |
| **A 记录** | IPv4 地址 | `baidu.com` -> `1.2.3.4` |
| **CNAME** | 别名 | `www` -> `web` |
| **TTL** | 生存时间 | 缓存有效期 |

### 常用命令速查

| 场景 | 命令 (Windows/Linux) | 说明 |
|------|----------------|------|
| 简单查询 | `nslookup <域名>` | 查 IP |
| 查特定类型 | `nslookup -type=MX <域名>` | 查邮件服务器 |
| 清除缓存 | `ipconfig /flushdns` | 强制刷新 |

### 常见错误与解决

| 错误现象 | 可能原因 | 解决方法 |
|----------|----------|----------|
| NXDOMAIN | 域名输错了 | 检查拼写 |
| DNS request timed out | DNS 服务器连不上 | 换一个 DNS（如 8.8.8.8）试 |

---

## ❓ 常见问题与解答

**Q1：为什么有时候改了域名解析，要等好久才能生效？**

A1：因为全球各地的 Local DNS 都有缓存。如果你之前的 TTL 设置是 24 小时，那么最坏的情况下，要等 24 小时缓存过期后，用户才能解析到新的 IP。所以在做迁移前，通常建议提前把 TTL 改小。

**Q2：hosts 文件有什么用？**

A2：`hosts` 文件是操作系统的“本地 DNS 黑/白名单”，优先级最高。你可以用它来：
1. **屏蔽广告**：把广告域名解析到 `127.0.0.1`。
2. **开发测试**：把 `www.test.com` 解析到内网测试服务器 IP。
3. **紧急修复**：DNS 挂了的时候手动写 IP 上网。

**Q3：8.8.8.8 和 114.114.114.114 是谁？**

A3：
- **8.8.8.8**：Google 提供的全球公共 DNS，速度快，稳定。
- **114.114.114.114**：国内知名的公共 DNS，国内访问速度通常比 Google 快。

---

## 🚀 下一步学习预告

**明日主题预告**：Day006 - 应用层：HTTP 协议详解

**学习重点预告**：
- HTTP 请求方法（GET/POST）
- HTTP 状态码（200/302/404/500）
- HTTP 报文结构分析

**今日学习为明日做铺垫**：
- 今天我们找到了网站的“家”（IP），明天我们将敲门进去，看看怎么和它交流（HTTP）。

---

## 📖 参考资料

- 📖 官方文档：[RFC 1035 - DNS](https://tools.ietf.org/html/rfc1035)
- 🎥 视频教程：B站搜索 "DNS 解析过程动画"
- 🛠️ 实践工具：`dig` (Linux 下更强大的 DNS 工具)
- 📚 参考书籍：《TCP/IP 详解 卷1》第 14 章

---

> 💬 **学习提示**：
> 1. 建议按照文档顺序学习，不要跳跃
> 2. 每个知识点理解后再进行下一步
> 3. 实践任务一定要亲手做，不要只看
> 4. 遇到问题先思考，再查阅资料，最后再问
> 5. 坚持每天完成学习任务并记录成果，90 天后你会感谢现在的自己！
>
> ```bash
> git add daily/Day005.md
> git commit -m "Day005: 完成学习与记录"
> ```
